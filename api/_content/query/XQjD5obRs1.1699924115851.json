{"_path":"/posts/scrapy-fargate-sls-guide","_dir":"posts","_draft":false,"_partial":false,"_locale":"","title":"Serverless Scraping with Scrapy, AWS Lambda and Fargate â€“ a guide","description":"","date":"2019-09-07T01:25:06.000Z","language":"english","draft":false,"body":{"type":"root","children":[{"type":"element","tag":"h2","props":{"id":"running-scrapy-in-aws-lambda"},"children":[{"type":"text","value":"Running Scrapy in AWS Lambda"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We will be using the "},{"type":"element","tag":"a","props":{"href":"https://serverless.com/","rel":["nofollow"]},"children":[{"type":"text","value":"Serverless framework"}]},{"type":"text","value":" in this tutorial, as it's a good and extendable open-source framework that does much of the gruntwork of serverless applications. "},{"type":"element","tag":"a","props":{"href":"https://scrapy.org/","rel":["nofollow"]},"children":[{"type":"text","value":"Scrapy"}]},{"type":"text","value":" is a Python framework, also leading and open-source, with all the benefits that come from using a mature framework. Since only "},{"type":"element","tag":"a","props":{"href":"https://aws.amazon.com/","rel":["nofollow"]},"children":[{"type":"text","value":"Amazon Web Services"}]},{"type":"text","value":" (AWS) of the major cloud platforms support Python in serverless functions, it's a natural choice that can't go wrong since AWS has solutions for just about everything."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The code used in this guide can be found on "},{"type":"element","tag":"a","props":{"href":"https://github.com/viktorfa/scrapy-fargate-sls-guide","rel":["nofollow"]},"children":[{"type":"text","value":"github.com/viktorfa/scrapy-fargate-sls-guide"}]},{"type":"text","value":"."}]},{"type":"element","tag":"h3","props":{"id":"requirements"},"children":[{"type":"text","value":"Requirements"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"It's assumed that the reader is somewhat familiar with Scrapy and has the ability to work with the command line. Several programs need to be installed to complete this guide. An AWS account with billing enabled is necessary (although the resulting bill from completing the guide is in order of single digit cents)."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Command line tools used:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"virtualenv*"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"git*"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"npm"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"pip"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"make"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"docker"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"aws"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"* recommended, but not necessary"}]},{"type":"element","tag":"h3","props":{"id":"result"},"children":[{"type":"text","value":"Result"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Completing this guide will result with the basics of a scalable and maintainable scraper infrastructure following the "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"serverless"}]},{"type":"text","value":" paradigm with all its advantages such as low initial cost and infrastructure as code deployment. The resulting artifact will be extended in a similar fashion with a data processing pipeline in future guides."}]},{"type":"element","tag":"h2","props":{"id":"setting-up-a-crawler"},"children":[{"type":"text","value":"Setting up a crawler"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We start by making a simple Scrapy crawler that can run from a script locally, and move thinfs gradually from there."}]},{"type":"element","tag":"h3","props":{"id":"creating-the-scraper"},"children":[{"type":"text","value":"Creating the scraper"}]},{"type":"element","tag":"pre","props":{"code":"python -v # Should have python3.7\npip install Scrapy\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"python"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" -v"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D"},"children":[{"type":"text","value":" # Should have python3.7\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"pip"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" install"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" Scrapy\n"}]}]}]}]},{"type":"element","tag":"pre","props":{"code":"mkdir scrapy-serverless && cd $_\nscrapy startproject my_sls_scraper scraper\ncd scraper\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"mkdir"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" scrapy-serverless"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":" && "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":"cd"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" $_\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"scrapy"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" startproject"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" my_sls_scraper"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" scraper\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":"cd"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" scraper\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"All the code of this guide will be in the "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"scrapy-serverless/scraper"}]},{"type":"text","value":" folder, but other modules will be added in the "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"scrapy-serverless"}]},{"type":"text","value":" folder in future guides."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We will use the default Scrapy project structure. Create a simple spider in the "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"spiders"}]},{"type":"text","value":" module."}]},{"type":"element","tag":"pre","props":{"code":"# my_sls_scraper/spiders/header_spider.py\nfrom scrapy.spiders import CrawlSpider, Rule\nfrom scrapy.linkextractors import LinkExtractor\n\n\nclass HeaderSpider(CrawlSpider):\n    name = \"header_spider\"\n\n    start_urls = [\"https://scrapy.org\"]\n    allowed_domains = [\"scrapy.org\"]\n    rules = [  # Get all links on start url\n        Rule(\n            link_extractor=LinkExtractor(\n                deny=r\"\\?\",\n            ),\n            follow=False,\n            callback=\"parse_page\",\n        )\n    ]\n\n    def parse_start_url(self, response):\n        return self.parse_page(response)\n\n    def parse_page(self, response):\n        header = response.css(\"h1, h2\").extract_first(\n        ) or response.css(\"title\").extract_first() or response.url\n        return {\n            \"header\": remove_tags(header),\n            \"url\": response.url,\n        }\n","language":"python","meta":"","className":"language-python","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"# my_sls_scraper/spiders/header_spider.py\nfrom scrapy.spiders import CrawlSpider, Rule\nfrom scrapy.linkextractors import LinkExtractor\n\n\nclass HeaderSpider(CrawlSpider):\n    name = \"header_spider\"\n\n    start_urls = [\"https://scrapy.org\"]\n    allowed_domains = [\"scrapy.org\"]\n    rules = [  # Get all links on start url\n        Rule(\n            link_extractor=LinkExtractor(\n                deny=r\"\\?\",\n            ),\n            follow=False,\n            callback=\"parse_page\",\n        )\n    ]\n\n    def parse_start_url(self, response):\n        return self.parse_page(response)\n\n    def parse_page(self, response):\n        header = response.css(\"h1, h2\").extract_first(\n        ) or response.css(\"title\").extract_first() or response.url\n        return {\n            \"header\": remove_tags(header),\n            \"url\": response.url,\n        }\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Also add the following to the settings in "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"my_sls_scraper/settings.py"}]}]},{"type":"element","tag":"pre","props":{"code":"# my_sls_scraper/settings.py\n# ...\nHTTPCACHE_ENABLED = True\nHTTPCACHE_EXPIRATION_SECS = 60 * 60 * 24 * 7\nHTTPCACHE_DIR = 'httpcache'\nCLOSESPIDER_PAGECOUNT = 32\n","language":"python","meta":"","className":"language-python","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"# my_sls_scraper/settings.py\n# ...\nHTTPCACHE_ENABLED = True\nHTTPCACHE_EXPIRATION_SECS = 60 * 60 * 24 * 7\nHTTPCACHE_DIR = 'httpcache'\nCLOSESPIDER_PAGECOUNT = 32\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Test that the spider is working by running the crawler and printing the output"}]},{"type":"element","tag":"pre","props":{"code":"scrapy crawl header_spider --output \"feed/%(name)s-%(time)s.json\" --output-format json\ncat feed/$(ls feed -q | tail -1)\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"scrapy"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" crawl"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" header_spider"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" --output"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" \"feed/%(name)s-%(time)s.json\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" --output-format"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" json\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"cat"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" feed/$("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"ls"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" feed "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":"-q"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":" |"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":" tail"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" -1"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":")\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"You should see a json feed in "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"feed/header_spider-<time string>.json"}]},{"type":"text","value":" with the scraped data."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Next, we create files to launch the scraper from a script, which will be needed in Lambda and Fargate. We'll create 2 new files to make this work in different scenarios, "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"launcher.py"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"my_sls_scraper/crawl.py"}]},{"type":"text","value":"."}]},{"type":"element","tag":"pre","props":{"code":"# my_sls_scraper/crawl.py\nimport sys\nimport imp\nimport os\nimport logging\nfrom urllib.parse import urlparse\n\nfrom scrapy.spiderloader import SpiderLoader\nfrom scrapy.crawler import CrawlerProcess\nfrom scrapy.utils.project import get_project_settings\n\n# Need to \"mock\" sqlite for the process to not crash in AWS Lambda / Amazon Linux\nsys.modules[\"sqlite\"] = imp.new_module(\"sqlite\")\nsys.modules[\"sqlite3.dbapi2\"] = imp.new_module(\"sqlite.dbapi2\")\n\n\ndef is_in_aws():\n    return os.getenv('AWS_EXECUTION_ENV') is not None\n\n\ndef crawl(settings={}, spider_name=\"header_spider\", spider_kwargs={}):\n    project_settings = get_project_settings()\n    spider_loader = SpiderLoader(project_settings)\n\n    spider_cls = spider_loader.load(spider_name)\n\n    feed_uri = \"\"\n    feed_format = \"json\"\n\n    try:\n        spider_key = urlparse(spider_kwargs.get(\"start_urls\")[0]).hostname if spider_kwargs.get(\n            \"start_urls\") else urlparse(spider_cls.start_urls[0]).hostname\n    except Exception:\n        logging.exception(\"Spider or kwargs need start_urls.\")\n\n    if is_in_aws():\n        # Lambda can only write to the /tmp folder.\n        settings['HTTPCACHE_DIR'] =  \"/tmp\"\n    else:\n        feed_uri = \"file://{}/%(name)s-{}-%(time)s.json\".format(\n            os.path.join(os.getcwd(), \"feed\"),\n            spider_key,\n        )\n\n    settings['FEED_URI'] = feed_uri\n    settings['FEED_FORMAT'] = feed_format\n\n    process = CrawlerProcess({**project_settings, **settings})\n\n    process.crawl(spider_cls, **spider_kwargs)\n    process.start()\n","language":"python","meta":"","className":"language-python","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"# my_sls_scraper/crawl.py\nimport sys\nimport imp\nimport os\nimport logging\nfrom urllib.parse import urlparse\n\nfrom scrapy.spiderloader import SpiderLoader\nfrom scrapy.crawler import CrawlerProcess\nfrom scrapy.utils.project import get_project_settings\n\n# Need to \"mock\" sqlite for the process to not crash in AWS Lambda / Amazon Linux\nsys.modules[\"sqlite\"] = imp.new_module(\"sqlite\")\nsys.modules[\"sqlite3.dbapi2\"] = imp.new_module(\"sqlite.dbapi2\")\n\n\ndef is_in_aws():\n    return os.getenv('AWS_EXECUTION_ENV') is not None\n\n\ndef crawl(settings={}, spider_name=\"header_spider\", spider_kwargs={}):\n    project_settings = get_project_settings()\n    spider_loader = SpiderLoader(project_settings)\n\n    spider_cls = spider_loader.load(spider_name)\n\n    feed_uri = \"\"\n    feed_format = \"json\"\n\n    try:\n        spider_key = urlparse(spider_kwargs.get(\"start_urls\")[0]).hostname if spider_kwargs.get(\n            \"start_urls\") else urlparse(spider_cls.start_urls[0]).hostname\n    except Exception:\n        logging.exception(\"Spider or kwargs need start_urls.\")\n\n    if is_in_aws():\n        # Lambda can only write to the /tmp folder.\n        settings['HTTPCACHE_DIR'] =  \"/tmp\"\n    else:\n        feed_uri = \"file://{}/%(name)s-{}-%(time)s.json\".format(\n            os.path.join(os.getcwd(), \"feed\"),\n            spider_key,\n        )\n\n    settings['FEED_URI'] = feed_uri\n    settings['FEED_FORMAT'] = feed_format\n\n    process = CrawlerProcess({**project_settings, **settings})\n\n    process.crawl(spider_cls, **spider_kwargs)\n    process.start()\n"}]}]},{"type":"element","tag":"pre","props":{"code":"# launcher.py'\nimport sys\nimport json\n\nfrom my_sls_scraper.crawl import crawl\n\n\ndef scrape(event={}, context={}):\n    crawl(**event)\n\n\nif __name__ == \"__main__\":\n    try:\n        event = json.loads(sys.argv[1])\n    except IndexError:\n        event = {}\n    scrape(event)\n","language":"python","meta":"","className":"language-python","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"# launcher.py'\nimport sys\nimport json\n\nfrom my_sls_scraper.crawl import crawl\n\n\ndef scrape(event={}, context={}):\n    crawl(**event)\n\n\nif __name__ == \"__main__\":\n    try:\n        event = json.loads(sys.argv[1])\n    except IndexError:\n        event = {}\n    scrape(event)\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Check that you can scrape by executing "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"launcher.py"}]},{"type":"text","value":" with"}]},{"type":"element","tag":"pre","props":{"code":"python launcher.py\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"python"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" launcher.py\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If that works, the scraper is pretty much done, and we'll spend the rest of the guide on AWS and Serverless stuff."}]},{"type":"element","tag":"h2","props":{"id":"setting-up-an-aws-lambda-function"},"children":[{"type":"text","value":"Setting up an AWS Lambda function"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Initialize serverless in the same directory as "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"scrapy.cfg"}]},{"type":"text","value":" with"}]},{"type":"element","tag":"pre","props":{"code":"serverless create --template aws-python3 --name my-sls-scraper\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"serverless"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" create"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" --template"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" aws-python3"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" --name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" my-sls-scraper\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"You need to have an AWS account and created an IAM admin user to work with Serverless. If you haven't follow the steps on "},{"type":"element","tag":"a","props":{"href":"https://serverless.com/framework/docs/providers/aws/guide/credentials/","rel":["nofollow"]},"children":[{"type":"text","value":"this guide"}]},{"type":"text","value":" to get started. I like using aws profiles where you store the credentials in "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"~/.aws/credentials"}]},{"type":"text","value":", but see the link for what works best for you."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If you're not familiar with AWS and Serverless, you will run into many weird issues that are hard to debug. To mitigate that, deploy the function for every change you make in the configuration of Serverless and the scraper to make it easier to identify what causes things to break."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We'll start by deploying the dummy default Lambda function. Do it with"}]},{"type":"element","tag":"pre","props":{"code":"sls deploy -f hello\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"sls"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" deploy"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" -f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" hello\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If you use aws profiles for credentials and you have a profile called "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"my-sls-admin"}]},{"type":"text","value":", you can deploy with"}]},{"type":"element","tag":"pre","props":{"code":"sls deploy -f hello --aws-profile my-sls-admin\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"sls"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" deploy"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" -f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" hello"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" --aws-profile"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" my-sls-admin\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"or add the profile key under provider in "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"serverless.yml"}]},{"type":"text","value":"."}]},{"type":"element","tag":"pre","props":{"code":"# serverless.yml\n# ...\nprovider:\n  name: aws\nruntime: python3.7\nprofile: my-sls-admin\n# ...\n","language":"yaml","meta":"","className":"language-yaml shiki shiki-themes github-light github-dark","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D"},"children":[{"type":"text","value":"# serverless.yml\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D"},"children":[{"type":"text","value":"# ...\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"provider"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"aws\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"runtime"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"python3.7\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"profile"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"my-sls-admin\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D"},"children":[{"type":"text","value":"# ...\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When deploying, the output should be similar to"}]},{"type":"element","tag":"pre","props":{"code":"11:40 $ sls deploy\nServerless: Packaging service...\nServerless: Excluding development dependencies...\nServerless: Creating Stack...\nServerless: Checking Stack create progress...\n.....\nServerless: Stack create finished...\nServerless: Uploading CloudFormation file to S3...\nServerless: Uploading artifacts...\nServerless: Uploading service my-sls-scraper.zip file to S3 (162.74 KB)...\nServerless: Validating template...\nServerless: Updating Stack...\nServerless: Checking Stack update progress...\n...............\nServerless: Stack update finished...\nService Information\nservice: my-sls-scraper\nstage: dev\nregion: us-east-1\nstack: my-sls-scraper-dev\nresources: 5\napi keys:\n  None\nendpoints:\n  None\nfunctions:\n  hello: my-sls-scraper-dev-hello\nlayers:\n  None\nServerless: Run the \"serverless\" command to setup monitoring, troubleshooting and testing.\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"11:40 $ sls deploy\nServerless: Packaging service...\nServerless: Excluding development dependencies...\nServerless: Creating Stack...\nServerless: Checking Stack create progress...\n.....\nServerless: Stack create finished...\nServerless: Uploading CloudFormation file to S3...\nServerless: Uploading artifacts...\nServerless: Uploading service my-sls-scraper.zip file to S3 (162.74 KB)...\nServerless: Validating template...\nServerless: Updating Stack...\nServerless: Checking Stack update progress...\n...............\nServerless: Stack update finished...\nService Information\nservice: my-sls-scraper\nstage: dev\nregion: us-east-1\nstack: my-sls-scraper-dev\nresources: 5\napi keys:\n  None\nendpoints:\n  None\nfunctions:\n  hello: my-sls-scraper-dev-hello\nlayers:\n  None\nServerless: Run the \"serverless\" command to setup monitoring, troubleshooting and testing.\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"You should now see the deployed function in the "},{"type":"element","tag":"a","props":{"href":"https://console.aws.amazon.com/lambda/home","rel":["nofollow"]},"children":[{"type":"text","value":"AWS Lambda web console"}]},{"type":"text","value":". (Change your region if you don't see it!)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Verify that the function can be invoked and see its output with"}]},{"type":"element","tag":"pre","props":{"code":"sls invoke -f hello --log\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"sls"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" invoke"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" -f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" hello"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" --log\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The output should be something like"}]},{"type":"element","tag":"pre","props":{"code":"12:12 $ sls invoke -f hello --log\n{\n    \"statusCode\": 200,\n    \"body\": \"{\\\"message\\\": \\\"Go Serverless v1.0! Your function executed successfully!\\\", \\\"input\\\": {}}\"\n}\n--------------------------------------------------------------------\nSTART RequestId: f38a0d84-e974-4a00-93ab-9e2825d94003 Version: $LATEST\nEND RequestId: f38a0d84-e974-4a00-93ab-9e2825d94003\nREPORT RequestId: f38a0d84-e974-4a00-93ab-9e2825d94003  Duration: 1.62 ms   Billed Duration: 100 ms Memory Size: 1024 MB    Max Memory Used: 56 MB  Init Duration: 110.34 ms\n\nXRAY TraceId: 1-5d723275-c57192d30e2a524902b401fd   SegmentId: 5cc7e2685a1e85bc Sampled: false\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"12:12 $ sls invoke -f hello --log\n{\n    \"statusCode\": 200,\n    \"body\": \"{\\\"message\\\": \\\"Go Serverless v1.0! Your function executed successfully!\\\", \\\"input\\\": {}}\"\n}\n--------------------------------------------------------------------\nSTART RequestId: f38a0d84-e974-4a00-93ab-9e2825d94003 Version: $LATEST\nEND RequestId: f38a0d84-e974-4a00-93ab-9e2825d94003\nREPORT RequestId: f38a0d84-e974-4a00-93ab-9e2825d94003  Duration: 1.62 ms   Billed Duration: 100 ms Memory Size: 1024 MB    Max Memory Used: 56 MB  Init Duration: 110.34 ms\n\nXRAY TraceId: 1-5d723275-c57192d30e2a524902b401fd   SegmentId: 5cc7e2685a1e85bc Sampled: false\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now we'll need to package the function in a way that includes all the dependencies. Install the "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"serverless-python-requirements"}]},{"type":"text","value":" plugin with"}]},{"type":"element","tag":"pre","props":{"code":"sls plugin install --name serverless-python-requirements\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"sls"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" plugin"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" install"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" --name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" serverless-python-requirements\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"And rehaul "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"serverless.yml"}]},{"type":"text","value":"."}]},{"type":"element","tag":"pre","props":{"code":"# serverless.yml\nservice: my-sls-scraper\n\nprovider:\n  name: aws\n  runtime: python3.7\n  logRetentionInDays: 1\n\nfunctions:\n  hello:\n    handler: handler.hello\n  lambdaScrape:\n    handler: launcher.scrape\n\n# We include files by whitelisting to reduce the deployment time.\n# Just remember to add any files you create!\npackage:\n  include:\n    - handler.py\n    - launcher.py\n    - my_sls_scraper/**\n    - scrapy.cfg\n  exclude:\n    - \"./**\"\n\nplugins:\n  - serverless-python-requirements\n\ncustom:\n  pythonRequirements:\n    slim: true # Omits tests, __pycache__, *.pyc etc from dependencies\n    fileName: requirements.txt\n","language":"yaml","meta":"","className":"language-yaml shiki shiki-themes github-light github-dark","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D"},"children":[{"type":"text","value":"# serverless.yml\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"service"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"my-sls-scraper\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"provider"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"aws\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  runtime"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"python3.7\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  logRetentionInDays"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":"1\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"functions"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  hello"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    handler"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"handler.hello\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  lambdaScrape"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    handler"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"launcher.scrape\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D"},"children":[{"type":"text","value":"# We include files by whitelisting to reduce the deployment time.\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D"},"children":[{"type":"text","value":"# Just remember to add any files you create!\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"package"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  include"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"handler.py\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"launcher.py\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"my_sls_scraper/**\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"scrapy.cfg\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  exclude"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"./**\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"plugins"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"  - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"serverless-python-requirements\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"custom"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":30},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  pythonRequirements"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":31},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    slim"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":"true"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D"},"children":[{"type":"text","value":" # Omits tests, __pycache__, *.pyc etc from dependencies\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":32},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    fileName"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"requirements.txt\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Note that we added a new function "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"lambdaScrape"}]},{"type":"text","value":" that does the scraping in the Lambda function."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We also need a minimal "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"requirements.txt"}]},{"type":"text","value":" for pip requirements."}]},{"type":"element","tag":"pre","props":{"code":"# requirements.txt\nScrapy==1.7.3\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D"},"children":[{"type":"text","value":"# requirements.txt\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"Scrapy"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":"1.7"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":".3\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Try to deploy the function again and see that it works."}]},{"type":"element","tag":"pre","props":{"code":"sls deploy --verbose\nsls invoke -f hello --log\nsls invoke -f lambdaScrape --log\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"sls"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" deploy"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" --verbose\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"sls"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" invoke"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" -f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" hello"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" --log\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"sls"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" invoke"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" -f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" lambdaScrape"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" --log\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We've now created the minimal solution for serverless scraping â€“ well done! In the rest of the guide we'll set up more resources in the AWS platform to store the scraped data and run long crawls in Fargate instead of Lambda."}]},{"type":"element","tag":"h2","props":{"id":"storing-scraped-data-in-s3"},"children":[{"type":"text","value":"Storing scraped data in S3"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Storing the scraped data in S3 gives us a low-cost repository for spider outputs which can be used to further process the data. We will use the config in "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"serverless.yml"}]},{"type":"text","value":" and CloudFormation templates to create and use resources in the AWS ecosystem, so that we follow the "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"infrastructure as code"}]},{"type":"text","value":" paradigm."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Before we continue, let's install a useful plugin that lets us use "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"!Sub"}]},{"type":"text","value":" commands in out templates called "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"serverless-cloudformation-sub-variables"}]},{"type":"text","value":" and add it to our "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"serverless.yml"}]},{"type":"text","value":" with"}]},{"type":"element","tag":"pre","props":{"code":"sls plugin install --name serverless-cloudformation-sub-variables\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"sls"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" plugin"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" install"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" --name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" serverless-cloudformation-sub-variables\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Let's create the templates in a separate file called "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"s3-template.yml"}]},{"type":"text","value":" as the template will get quite large later."}]},{"type":"element","tag":"pre","props":{"code":"# s3-template.yml\nResources:\n  ScraperFeedBucket:\n    Type: AWS::S3::Bucket\n    Properties:\n      VersioningConfiguration:\n        Status: \"Enabled\"\n","language":"yaml","meta":"","className":"language-yaml shiki shiki-themes github-light github-dark","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D"},"children":[{"type":"text","value":"# s3-template.yml\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"Resources"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  ScraperFeedBucket"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"AWS::S3::Bucket\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Properties"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      VersioningConfiguration"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"        Status"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"Enabled\"\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We have to set up permissions in "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"serverless.yml"}]},{"type":"text","value":", import the template file, and pass the bucket name in an environment variable to our Lambda function.\nAdd the following IAM role statement and environment variable"}]},{"type":"element","tag":"pre","props":{"code":"# serverless.yml\nprovider:\n    # ...\n    environment:\n        FEED_BUCKET_NAME: !Ref ScraperFeedBucket\n    iamRoleStatements:\n        - Effect: \"Allow\"\n          Action:\n            - \"s3:PutObject\"\n          Resource: !Sub\n            - \"arn:aws:s3:::#{BucketName}/*\"\n            - BucketName: !Ref ScraperFeedBucket\n\nresources:\n  - AWSTemplateFormatVersion: \"2010-09-09\"\n    Transform: \"AWS::Serverless-2016-10-31\"\n  - ${file(./s3-template.yml)}\n# ...\n","language":"yaml","meta":"","className":"language-yaml shiki shiki-themes github-light github-dark","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D"},"children":[{"type":"text","value":"# serverless.yml\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"provider"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D"},"children":[{"type":"text","value":"    # ...\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    environment"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"        FEED_BUCKET_NAME"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" ScraperFeedBucket\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    iamRoleStatements"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"Effect"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"Allow\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"          Action"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"            - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"s3:PutObject\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"          Resource"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Sub\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"            - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"arn:aws:s3:::#{BucketName}/*\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"            - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"BucketName"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" ScraperFeedBucket\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"resources"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"  - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"AWSTemplateFormatVersion"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"2010-09-09\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Transform"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"AWS::Serverless-2016-10-31\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"  - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"${file(./s3-template.yml)}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D"},"children":[{"type":"text","value":"# ...\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"You can check that your configuration doesn't contain syntax errors with"}]},{"type":"element","tag":"pre","props":{"code":"sls package\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"sls"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" package\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"but the only way to check that your CloudFormation templates are valid on your current stack is to deploy it.\nBefore deploying, let's configure the crawler to store the output in S3."}]},{"type":"element","tag":"pre","props":{"code":"# my_sls_scraper/crawl.py\ndef  crawl(settings={}, spider_name=\"header_spider\", spider_kwargs={}):\n    # ...\n    if is_in_aws():\n        # Lambda can only write to the /tmp folder.\n        settings['HTTPCACHE_DIR'] = \"/tmp\"\n        feed_uri = f\"s3://{os.getenv('FEED_BUCKET_NAME')}/%(name)s-{spider_key}.json\"\n    # ...\n","language":"python","meta":"","className":"language-python","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"# my_sls_scraper/crawl.py\ndef  crawl(settings={}, spider_name=\"header_spider\", spider_kwargs={}):\n    # ...\n    if is_in_aws():\n        # Lambda can only write to the /tmp folder.\n        settings['HTTPCACHE_DIR'] = \"/tmp\"\n        feed_uri = f\"s3://{os.getenv('FEED_BUCKET_NAME')}/%(name)s-{spider_key}.json\"\n    # ...\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Scrapy uses the AWS library "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"boto3"}]},{"type":"text","value":" under the hood to store to S3. Inside a Lambda function, boto3 is always available, and credentials are automatically discovered. It will work as long as the IAM Role Statements we configured for the Lambda function are correct.\nWe don't need to timestamp the file name in S3 with "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"%(time)s"}]},{"type":"text","value":", as we configured the bucket to use versioning in our CloudFormation template, which enables us to access old spider outputs by looking at the file history."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now, deploy the function and crawl again."}]},{"type":"element","tag":"pre","props":{"code":"sls deploy -v\nsls invoke -f lambdaScrape --log\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"sls"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" deploy"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" -v\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"sls"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" invoke"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" -f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" lambdaScrape"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" --log\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"You should now find the feed output in a file if you check your "},{"type":"element","tag":"a","props":{"href":"https://s3.console.aws.amazon.com/s3/home","rel":["nofollow"]},"children":[{"type":"text","value":"S3 console"}]},{"type":"text","value":". You should also see some new info has appeared for your function in the "},{"type":"element","tag":"a","props":{"href":"https://console.aws.amazon.com/lambda/home","rel":["nofollow"]},"children":[{"type":"text","value":"Lambda console"}]},{"type":"text","value":", like the environment variable and the S3 resource.\nWhile it's absolutely recommended to set up all resources in CloudFormation templates or other infrastructure as code frameworks, the AWS console web interface is very useful for debugging and inspection."}]},{"type":"element","tag":"h2","props":{"id":"running-scrapy-in-aws-fargate"},"children":[{"type":"text","value":"Running Scrapy in AWS Fargate"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We now have a crawler that can be run from a script and uses S3 to store its output. We can run it in AWS Lambda, but we are constrained by the 15 minute execution limit.\nLambda is simply not made for long-lasting tasks, but it is possible to run long-lasting crawlers in the serverless paradigm by "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"containerizing"}]},{"type":"text","value":" our crawler and running it as a task in a managed container service such as AWS Fargate. This means we need to create a "},{"type":"element","tag":"a","props":{"href":"https://www.docker.com/","rel":["nofollow"]},"children":[{"type":"text","value":"Docker"}]},{"type":"text","value":" image of our crawler, uploading the image to an image repository â€“ we'll use Amazon Container Registry (ACR), and execute the image in a container as a task in Amazon Container Services (ECS).\nI'm dropping a lot of acronyms, and you'll see even more later. Running containers on AWS may be serverless, but it requires a lot of configuration at the moment."}]},{"type":"element","tag":"h3","props":{"id":"dockerize-it"},"children":[{"type":"text","value":"Dockerize it"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If you have Docker installed, this is the easy part. Let's create a "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"Dockerfile"}]},{"type":"text","value":" to containerize our crawler."}]},{"type":"element","tag":"pre","props":{"code":"FROM python:3.7\n\nWORKDIR /usr/src/app\n\nCOPY scrapy.cfg ./\nCOPY launcher.py ./\nCOPY my_sls_scraper ./my_sls_scraper\nCOPY requirements.txt ./\n\nRUN pip install boto3 --quiet\nRUN pip install -r requirements.txt --quiet\n\nCMD [\"python3\", \"./launcher.py\"]\n","language":"docker","meta":"","className":"language-docker","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"FROM python:3.7\n\nWORKDIR /usr/src/app\n\nCOPY scrapy.cfg ./\nCOPY launcher.py ./\nCOPY my_sls_scraper ./my_sls_scraper\nCOPY requirements.txt ./\n\nRUN pip install boto3 --quiet\nRUN pip install -r requirements.txt --quiet\n\nCMD [\"python3\", \"./launcher.py\"]\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The docker file is the recipe to put our scraper in an image. Create it and put a tag on it with"}]},{"type":"element","tag":"pre","props":{"code":"docker build -t my_sls_scraper:latest .\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"docker"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" build"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" -t"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" my_sls_scraper:latest"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" .\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"You should see an output similar to"}]},{"type":"element","tag":"pre","props":{"code":"16:55 $ docker build -t my_sls_scraper:latest .\nSending build context to Docker daemon  15.62MB\nStep 1/9 : FROM python:3.7\n ---> 60e318e4984a\nStep 2/9 : WORKDIR /usr/src/app\n ---> Using cache\n ---> 0277144c85a9\nStep 3/9 : COPY scrapy.cfg ./\n ---> c72f2df3b4d7\nRemoving intermediate container 80cf0e765353\nStep 4/9 : COPY launcher.py ./\n ---> 58e18d409bf5\nRemoving intermediate container f0726603d5fa\nStep 5/9 : COPY my_sls_scraper ./my_sls_scraper\n ---> 2be7fc4a06bb\nRemoving intermediate container aae59bff188d\nStep 6/9 : COPY requirements.txt ./\n ---> 7dbf261f3ade\nRemoving intermediate container 76033ce2ffe6\nStep 7/9 : RUN pip install boto3 --quiet\n ---> Running in 55455a2a4415\n ---> efdc47a54e36\nRemoving intermediate container 55455a2a4415\nStep 8/9 : RUN pip install -r requirements.txt --quiet\n ---> Running in e15817fd1a01\n ---> 84015af5a4ee\nRemoving intermediate container e15817fd1a01\nStep 9/9 : CMD python3 ./launcher.py\n ---> Running in 9c6fe75eb923\n ---> 05a841f9ec00\nRemoving intermediate container 9c6fe75eb923\nSuccessfully built 05a841f9ec00\nSuccessfully tagged my_sls_scraper:latest\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"16:55 $ docker build -t my_sls_scraper:latest .\nSending build context to Docker daemon  15.62MB\nStep 1/9 : FROM python:3.7\n ---> 60e318e4984a\nStep 2/9 : WORKDIR /usr/src/app\n ---> Using cache\n ---> 0277144c85a9\nStep 3/9 : COPY scrapy.cfg ./\n ---> c72f2df3b4d7\nRemoving intermediate container 80cf0e765353\nStep 4/9 : COPY launcher.py ./\n ---> 58e18d409bf5\nRemoving intermediate container f0726603d5fa\nStep 5/9 : COPY my_sls_scraper ./my_sls_scraper\n ---> 2be7fc4a06bb\nRemoving intermediate container aae59bff188d\nStep 6/9 : COPY requirements.txt ./\n ---> 7dbf261f3ade\nRemoving intermediate container 76033ce2ffe6\nStep 7/9 : RUN pip install boto3 --quiet\n ---> Running in 55455a2a4415\n ---> efdc47a54e36\nRemoving intermediate container 55455a2a4415\nStep 8/9 : RUN pip install -r requirements.txt --quiet\n ---> Running in e15817fd1a01\n ---> 84015af5a4ee\nRemoving intermediate container e15817fd1a01\nStep 9/9 : CMD python3 ./launcher.py\n ---> Running in 9c6fe75eb923\n ---> 05a841f9ec00\nRemoving intermediate container 9c6fe75eb923\nSuccessfully built 05a841f9ec00\nSuccessfully tagged my_sls_scraper:latest\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now, let's check that the image works by running it in a container on our machine with"}]},{"type":"element","tag":"pre","props":{"code":"docker run my_sls_scraper\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"docker"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" run"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" my_sls_scraper\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The crawler should run just like it has before except that the crawl output json file will be stored somewhere inside the Docker container, so you cannot see it."}]},{"type":"element","tag":"h3","props":{"id":"configure-fargate-on-aws"},"children":[{"type":"text","value":"Configure Fargate on AWS"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Let's see how a complete CloudFormation template for our purpose looks like."}]},{"type":"element","tag":"pre","props":{"code":"# fargate-template.yml\nResources:\n  FargateECSCluster:\n    Type: \"AWS::ECS::Cluster\"\n    Properties:\n      ClusterName: !Sub\n        - \"fargate-#{StackName}\"\n        - StackName: !Ref \"AWS::StackName\"\n\n  FargateLogGroup:\n    Type: \"AWS::Logs::LogGroup\"\n    Properties:\n      RetentionInDays: 1\n\n  FargateTaskRole:\n    Type: AWS::IAM::Role\n    Properties:\n      AssumeRolePolicyDocument:\n        Version: \"2012-10-17\"\n        Statement:\n          - Effect: Allow\n            Sid: \"ECS\"\n            Principal:\n              Service:\n                - ecs-tasks.amazonaws.com\n            Action:\n              - sts:AssumeRole\n      Policies:\n        - PolicyName: ScraperFeedBucketPolicy\n          PolicyDocument:\n            Statement:\n              - Effect: \"Allow\"\n                Action:\n                  - \"s3:PutObject\"\n                Resource: !Sub\n                  - \"arn:aws:s3:::#{BucketName}/*\"\n                  - BucketName: !Ref ScraperFeedBucket\n\n  FargateExecutionRole:\n    Type: AWS::IAM::Role\n    Properties:\n      ManagedPolicyArns:\n        - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy\n      AssumeRolePolicyDocument:\n        Version: \"2012-10-17\"\n        Statement:\n          - Effect: Allow\n            Sid: \"ECS\"\n            Principal:\n              Service:\n                - ecs-tasks.amazonaws.com\n            Action:\n              - sts:AssumeRole\n\n  FargateVPC:\n    Type: \"AWS::EC2::VPC\"\n    Properties:\n      CidrBlock: 10.10.10.0/24\n      Tags:\n        - Key: Name\n          Value: !Ref \"AWS::StackName\"\n  FargateSubnet:\n    Type: \"AWS::EC2::Subnet\"\n    Properties:\n      CidrBlock: 10.10.10.0/24\n      VpcId: !Ref FargateVPC\n      Tags:\n        - Key: Name\n          Value: !Ref \"AWS::StackName\"\n  FargateIGW:\n    Type: \"AWS::EC2::InternetGateway\"\n    Properties:\n      Tags:\n        - Key: Name\n          Value: !Ref \"AWS::StackName\"\n  FargateAttachGateway:\n    Type: AWS::EC2::VPCGatewayAttachment\n    Properties:\n      VpcId: !Ref FargateVPC\n      InternetGatewayId: !Ref FargateIGW\n  FargateRouteTable:\n    Type: \"AWS::EC2::RouteTable\"\n    Properties:\n      VpcId: !Ref FargateVPC\n      Tags:\n        - Key: Name\n          Value: !Ref \"AWS::StackName\"\n  FargateRoute:\n    Type: \"AWS::EC2::Route\"\n    DependsOn: FargateAttachGateway\n    Properties:\n      RouteTableId: !Ref FargateRouteTable\n      DestinationCidrBlock: 0.0.0.0/0\n      GatewayId: !Ref FargateIGW\n  FargateSubnetRouteTableAssociation:\n    Type: AWS::EC2::SubnetRouteTableAssociation\n    Properties:\n      RouteTableId: !Ref FargateRouteTable\n      SubnetId: !Ref FargateSubnet\n  FargateSG:\n    Type: \"AWS::EC2::SecurityGroup\"\n    Properties:\n      GroupDescription: \"Generated by Serverless\"\n      SecurityGroupIngress:\n        - IpProtocol: -1\n          CidrIp: 127.0.0.1/32\n      Tags:\n        - Key: Name\n          Value: !Ref \"AWS::StackName\"\n      VpcId: !Ref FargateVPC\n\n  FargateECSRepo:\n    Type: \"AWS::ECR::Repository\"\n    Properties:\n      LifecyclePolicy:\n        LifecyclePolicyText: |\n          {\n            \"rules\": [\n            {\n              \"rulePriority\": 1,\n              \"description\": \"Only keep 8 images\",\n              \"selection\": {\n                \"tagStatus\": \"any\",\n                \"countType\": \"imageCountMoreThan\",\n                \"countNumber\": 8\n              },\n              \"action\": { \"type\": \"expire\" }\n            }]\n          }\n\n  FargateECSTaskDefinition:\n    Type: \"AWS::ECS::TaskDefinition\"\n    Properties:\n      Cpu: 512\n      Memory: 1GB\n      NetworkMode: awsvpc\n      RequiresCompatibilities:\n        - \"FARGATE\"\n      ExecutionRoleArn: !GetAtt FargateExecutionRole.Arn\n      TaskRoleArn: !GetAtt FargateTaskRole.Arn\n      ContainerDefinitions:\n        - Name: scraper_container\n          Image: !Sub\n            - \"#{AccountId}.dkr.ecr.#{Region}.amazonaws.com/#{Repo}\"\n            - AccountId: !Ref AWS::AccountId\n              Region: !Ref AWS::Region\n              Repo: !Ref FargateECSRepo\n          LogConfiguration:\n            LogDriver: awslogs\n            Options:\n              awslogs-group: !Ref FargateLogGroup\n              awslogs-region: !Ref AWS::Region\n              awslogs-stream-prefix: !Ref AWS::StackName\nOutputs:\n  ECRRepo:\n    Value: !Sub\n      - \"#{AccountId}.dkr.ecr.#{Region}.amazonaws.com/#{Repo}\"\n      - AccountId: !Ref AWS::AccountId\n        Region: !Ref AWS::Region\n        Repo: !Ref FargateECSRepo\n","language":"yaml","meta":"","className":"language-yaml shiki shiki-themes github-light github-dark","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D"},"children":[{"type":"text","value":"# fargate-template.yml\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"Resources"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  FargateECSCluster"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"AWS::ECS::Cluster\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Properties"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      ClusterName"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Sub\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"fargate-#{StackName}\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"StackName"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" \"AWS::StackName\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  FargateLogGroup"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"AWS::Logs::LogGroup\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Properties"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      RetentionInDays"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":"1\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  FargateTaskRole"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"AWS::IAM::Role\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Properties"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      AssumeRolePolicyDocument"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"        Version"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"2012-10-17\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"        Statement"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"          - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"Effect"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"Allow\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"            Sid"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"ECS\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"            Principal"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"              Service"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"                - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"ecs-tasks.amazonaws.com\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"            Action"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"              - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"sts:AssumeRole\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      Policies"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"PolicyName"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"ScraperFeedBucketPolicy\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":30},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"          PolicyDocument"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":31},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"            Statement"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":32},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"              - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"Effect"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"Allow\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":33},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"                Action"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":34},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"                  - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"s3:PutObject\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":35},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"                Resource"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Sub\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":36},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"                  - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"arn:aws:s3:::#{BucketName}/*\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":37},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"                  - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"BucketName"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" ScraperFeedBucket\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":38},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":39},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  FargateExecutionRole"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":40},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"AWS::IAM::Role\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":41},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Properties"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":42},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      ManagedPolicyArns"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":43},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":44},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      AssumeRolePolicyDocument"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":45},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"        Version"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"2012-10-17\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":46},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"        Statement"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":47},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"          - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"Effect"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"Allow\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":48},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"            Sid"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"ECS\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":49},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"            Principal"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":50},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"              Service"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":51},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"                - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"ecs-tasks.amazonaws.com\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":52},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"            Action"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":53},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"              - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"sts:AssumeRole\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":54},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":55},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  FargateVPC"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":56},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"AWS::EC2::VPC\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":57},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Properties"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":58},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      CidrBlock"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"10.10.10.0/24\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":59},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      Tags"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":60},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"Key"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"Name\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":61},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"          Value"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" \"AWS::StackName\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":62},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  FargateSubnet"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":63},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"AWS::EC2::Subnet\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":64},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Properties"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":65},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      CidrBlock"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"10.10.10.0/24\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":66},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      VpcId"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" FargateVPC\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":67},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      Tags"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":68},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"Key"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"Name\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":69},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"          Value"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" \"AWS::StackName\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":70},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  FargateIGW"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":71},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"AWS::EC2::InternetGateway\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":72},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Properties"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":73},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      Tags"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":74},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"Key"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"Name\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":75},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"          Value"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" \"AWS::StackName\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":76},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  FargateAttachGateway"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":77},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"AWS::EC2::VPCGatewayAttachment\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":78},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Properties"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":79},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      VpcId"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" FargateVPC\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":80},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      InternetGatewayId"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" FargateIGW\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":81},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  FargateRouteTable"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":82},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"AWS::EC2::RouteTable\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":83},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Properties"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":84},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      VpcId"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" FargateVPC\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":85},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      Tags"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":86},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"Key"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"Name\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":87},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"          Value"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" \"AWS::StackName\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":88},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  FargateRoute"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":89},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"AWS::EC2::Route\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":90},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    DependsOn"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"FargateAttachGateway\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":91},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Properties"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":92},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      RouteTableId"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" FargateRouteTable\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":93},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      DestinationCidrBlock"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"0.0.0.0/0\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":94},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      GatewayId"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" FargateIGW\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":95},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  FargateSubnetRouteTableAssociation"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":96},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"AWS::EC2::SubnetRouteTableAssociation\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":97},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Properties"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":98},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      RouteTableId"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" FargateRouteTable\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":99},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      SubnetId"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" FargateSubnet\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":100},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  FargateSG"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":101},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"AWS::EC2::SecurityGroup\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":102},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Properties"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":103},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      GroupDescription"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"Generated by Serverless\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":104},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      SecurityGroupIngress"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":105},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"IpProtocol"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":"-1\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":106},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"          CidrIp"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"127.0.0.1/32\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":107},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      Tags"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":108},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"Key"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"Name\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":109},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"          Value"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" \"AWS::StackName\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":110},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      VpcId"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" FargateVPC\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":111},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":112},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  FargateECSRepo"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":113},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"AWS::ECR::Repository\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":114},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Properties"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":115},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      LifecyclePolicy"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":116},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"        LifecyclePolicyText"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"|\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":117},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"          {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":118},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"            \"rules\": [\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":119},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"            {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":120},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"              \"rulePriority\": 1,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":121},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"              \"description\": \"Only keep 8 images\",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":122},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"              \"selection\": {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":123},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"                \"tagStatus\": \"any\",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":124},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"                \"countType\": \"imageCountMoreThan\",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":125},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"                \"countNumber\": 8\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":126},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"              },\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":127},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"              \"action\": { \"type\": \"expire\" }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":128},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"            }]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":129},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"          }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":130},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":131},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  FargateECSTaskDefinition"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":132},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"AWS::ECS::TaskDefinition\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":133},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Properties"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":134},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      Cpu"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":"512\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":135},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      Memory"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"1GB\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":136},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      NetworkMode"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"awsvpc\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":137},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      RequiresCompatibilities"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":138},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"FARGATE\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":139},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      ExecutionRoleArn"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!GetAtt"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" FargateExecutionRole.Arn\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":140},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      TaskRoleArn"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!GetAtt"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" FargateTaskRole.Arn\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":141},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      ContainerDefinitions"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":142},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"Name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"scraper_container\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":143},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"          Image"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Sub\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":144},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"            - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"#{AccountId}.dkr.ecr.#{Region}.amazonaws.com/#{Repo}\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":145},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"            - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"AccountId"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" AWS::AccountId\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":146},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"              Region"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" AWS::Region\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":147},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"              Repo"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" FargateECSRepo\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":148},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"          LogConfiguration"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":149},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"            LogDriver"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"awslogs\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":150},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"            Options"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":151},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"              awslogs-group"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" FargateLogGroup\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":152},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"              awslogs-region"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" AWS::Region\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":153},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"              awslogs-stream-prefix"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" AWS::StackName\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":154},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"Outputs"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":155},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  ECRRepo"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":156},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Value"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Sub\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":157},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"#{AccountId}.dkr.ecr.#{Region}.amazonaws.com/#{Repo}\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":158},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"AccountId"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" AWS::AccountId\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":159},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"        Region"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" AWS::Region\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":160},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"        Repo"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" FargateECSRepo\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Credit to "},{"type":"element","tag":"a","props":{"href":"https://github.com/jolexa/fargate-from-lambda","rel":["nofollow"]},"children":[{"type":"text","value":"github.com/jolexa/fargate-from-lambda"}]},{"type":"text","value":" who inspired this CF template."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Next, we create a file with a handler to start the Fargate task"}]},{"type":"element","tag":"pre","props":{"code":"# launch_fargate.py\nimport os\nimport json\n\nimport boto3\n\n\ndef launch_fargate(event, context):\n    client = boto3.client(\"ecs\")\n\n    ECSCluster = os.environ[\"ECS_CLUSTER\"]\n    ECSSecGroup = os.environ[\"ECS_SEC_GROUP\"]\n    ECSSubnet = os.environ[\"ECS_SUBNET\"]\n    ECSTaskArn = os.environ[\"ECS_TASK_ARN\"]\n    CONTAINER_NAME = os.environ[\"CONTAINER_NAME\"]\n\n    run_task_response = client.run_task(\n        cluster=ECSCluster,\n        taskDefinition=ECSTaskArn,\n        count=1,\n        launchType=\"FARGATE\",\n        overrides={\n            \"containerOverrides\": [\n                {\n                    \"name\": CONTAINER_NAME,\n                    # We override the command so that we can pass some arguments\n                    # e.g. for running different spiders.\n                    \"command\": [\n                        \"python\",\n                        \"launcher.py\",\n                        json.dumps(event),\n                    ],\n                    \"environment\": [\n                        {\"name\": \"FEED_BUCKET_NAME\", \"value\": os.environ[\"FEED_BUCKET_NAME\"]},\n                    ]\n                }\n            ],\n        },\n        networkConfiguration={\n            \"awsvpcConfiguration\": {\n                \"subnets\": [\n                    ECSSubnet,\n                ],\n                \"securityGroups\": [\n                    ECSSecGroup,\n                ],\n                \"assignPublicIp\": \"ENABLED\"\n            },\n        },\n    )\n    return json.dumps(run_task_response, default=str)\n","language":"python","meta":"","className":"language-python","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"# launch_fargate.py\nimport os\nimport json\n\nimport boto3\n\n\ndef launch_fargate(event, context):\n    client = boto3.client(\"ecs\")\n\n    ECSCluster = os.environ[\"ECS_CLUSTER\"]\n    ECSSecGroup = os.environ[\"ECS_SEC_GROUP\"]\n    ECSSubnet = os.environ[\"ECS_SUBNET\"]\n    ECSTaskArn = os.environ[\"ECS_TASK_ARN\"]\n    CONTAINER_NAME = os.environ[\"CONTAINER_NAME\"]\n\n    run_task_response = client.run_task(\n        cluster=ECSCluster,\n        taskDefinition=ECSTaskArn,\n        count=1,\n        launchType=\"FARGATE\",\n        overrides={\n            \"containerOverrides\": [\n                {\n                    \"name\": CONTAINER_NAME,\n                    # We override the command so that we can pass some arguments\n                    # e.g. for running different spiders.\n                    \"command\": [\n                        \"python\",\n                        \"launcher.py\",\n                        json.dumps(event),\n                    ],\n                    \"environment\": [\n                        {\"name\": \"FEED_BUCKET_NAME\", \"value\": os.environ[\"FEED_BUCKET_NAME\"]},\n                    ]\n                }\n            ],\n        },\n        networkConfiguration={\n            \"awsvpcConfiguration\": {\n                \"subnets\": [\n                    ECSSubnet,\n                ],\n                \"securityGroups\": [\n                    ECSSecGroup,\n                ],\n                \"assignPublicIp\": \"ENABLED\"\n            },\n        },\n    )\n    return json.dumps(run_task_response, default=str)\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We also need to update our "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"serverless.yml"}]},{"type":"text","value":" to add some new IAM role statemants, import the CloudFormation template in "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"fargate-cf-yml"}]},{"type":"text","value":", add some env variables, include the "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"launch_fargate.py"}]},{"type":"text","value":" file, and finally add a new function for launching a Fargate task."}]},{"type":"element","tag":"pre","props":{"code":"# serverless.yml\nservice: my-sls-scraper\n\nprovider:\n  name: aws\n  runtime: python3.7\n  logRetentionInDays: 1\n\n  environment:\n    FEED_BUCKET_NAME: !Ref ScraperFeedBucket\n    ECS_CLUSTER: !GetAtt FargateECSCluster.Arn\n    ECS_TASK_ARN: !Ref FargateECSTaskDefinition\n    ECS_SUBNET: !Ref FargateSubnet\n    ECS_SEC_GROUP: !Ref FargateSG\n    CONTAINER_NAME: \"scraper_container\"\n\n  iamRoleStatements:\n    - Effect: \"Allow\"\n      Action:\n        - \"s3:PutObject\"\n      Resource: !Sub\n        - \"arn:aws:s3:::#{BucketName}/*\"\n        - BucketName: !Ref ScraperFeedBucket\n\n    - Effect: Allow\n      Action:\n        - ecs:RunTask\n      Resource:\n        - !Ref FargateECSTaskDefinition\n    - Effect: Allow\n      Action:\n        - iam:PassRole\n      Resource:\n        - !GetAtt FargateExecutionRole.Arn\n    - Effect: Allow\n      Action:\n        - iam:PassRole\n      Resource:\n        - !GetAtt FargateTaskRole.Arn\n\nfunctions:\n  hello:\n    handler: handler.hello\n  lambdaScrape:\n    handler: launcher.scrape\n  fargateScrape:\n    handler: launch_fargate.launch_fargate\n\n# We include files by whitelisting to reduce the deployment time.\n# Just remember to add any files you create!\npackage:\n  include:\n    - handler.py\n    - launcher.py\n    - launch_fargate.py\n    - my_sls_scraper/**\n    - scrapy.cfg\n  exclude:\n    - \"./**\"\n\nresources:\n  - AWSTemplateFormatVersion: \"2010-09-09\"\n    Transform: \"AWS::Serverless-2016-10-31\"\n  - ${file(./s3-template.yml)}\n  - ${file(./fargate-template.yml)}\n\nplugins:\n  - serverless-python-requirements\n  - serverless-cloudformation-sub-variables\ncustom:\n  pythonRequirements:\n    slim: true # Omits tests, __pycache__, *.pyc etc from dependencies\n    fileName: requirements.txt\n","language":"yaml","meta":"","className":"language-yaml shiki shiki-themes github-light github-dark","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D"},"children":[{"type":"text","value":"# serverless.yml\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"service"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"my-sls-scraper\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"provider"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"aws\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  runtime"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"python3.7\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  logRetentionInDays"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":"1\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  environment"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    FEED_BUCKET_NAME"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" ScraperFeedBucket\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    ECS_CLUSTER"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!GetAtt"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" FargateECSCluster.Arn\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    ECS_TASK_ARN"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" FargateECSTaskDefinition\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    ECS_SUBNET"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" FargateSubnet\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    ECS_SEC_GROUP"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" FargateSG\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    CONTAINER_NAME"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"scraper_container\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  iamRoleStatements"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"Effect"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"Allow\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      Action"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"s3:PutObject\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      Resource"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Sub\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"arn:aws:s3:::#{BucketName}/*\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"BucketName"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" ScraperFeedBucket\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"Effect"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"Allow\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      Action"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"ecs:RunTask\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      Resource"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" FargateECSTaskDefinition\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":30},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"Effect"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"Allow\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":31},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      Action"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":32},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"iam:PassRole\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":33},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      Resource"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":34},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!GetAtt"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" FargateExecutionRole.Arn\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":35},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"Effect"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"Allow\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":36},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      Action"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":37},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"iam:PassRole\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":38},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      Resource"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":39},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!GetAtt"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" FargateTaskRole.Arn\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":40},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":41},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"functions"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":42},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  hello"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":43},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    handler"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"handler.hello\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":44},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  lambdaScrape"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":45},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    handler"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"launcher.scrape\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":46},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  fargateScrape"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":47},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    handler"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"launch_fargate.launch_fargate\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":48},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":49},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D"},"children":[{"type":"text","value":"# We include files by whitelisting to reduce the deployment time.\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":50},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D"},"children":[{"type":"text","value":"# Just remember to add any files you create!\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":51},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"package"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":52},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  include"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":53},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"handler.py\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":54},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"launcher.py\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":55},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"launch_fargate.py\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":56},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"my_sls_scraper/**\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":57},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"scrapy.cfg\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":58},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  exclude"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":59},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"./**\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":60},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":61},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"resources"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":62},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"  - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"AWSTemplateFormatVersion"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"2010-09-09\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":63},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Transform"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"AWS::Serverless-2016-10-31\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":64},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"  - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"${file(./s3-template.yml)}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":65},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"  - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"${file(./fargate-template.yml)}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":66},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":67},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"plugins"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":68},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"  - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"serverless-python-requirements\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":69},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"  - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"serverless-cloudformation-sub-variables\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":70},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"custom"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":71},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  pythonRequirements"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":72},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    slim"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":"true"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D"},"children":[{"type":"text","value":" # Omits tests, __pycache__, *.pyc etc from dependencies\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":73},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    fileName"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"requirements.txt\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Once again we'll deploy and make a test run with"}]},{"type":"element","tag":"pre","props":{"code":"sls deploy -v\nsls invoke -f fargateScrape --log\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"sls"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" deploy"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" -v\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"sls"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" invoke"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" -f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" fargateScrape"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" --log\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The function should execute, but the Fargate task will fail, as we haven't uploaded our Docker image to the repository we created.\nYou can look at what we created in the "},{"type":"element","tag":"a","props":{"href":"https://console.aws.amazon.com/ecs/home","rel":["nofollow"]},"children":[{"type":"text","value":"ECS console"}]},{"type":"text","value":" and the "},{"type":"element","tag":"a","props":{"href":"https://console.aws.amazon.com/vpc/home","rel":["nofollow"]},"children":[{"type":"text","value":"VPC console"}]},{"type":"text","value":". You can see the failed task we started on "},{"type":"element","tag":"a","props":{"href":"https://console.aws.amazon.com/ecs/home?region=us-east-1#/clusters/fargate-my-sls-scraper-dev/tasks","rel":["nofollow"]},"children":[{"type":"text","value":"https://console.aws.amazon.com/ecs/home?region=us-east-1#/clusters/fargate-my-sls-scraper-dev/tasks"}]},{"type":"text","value":" if you toggle "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Stopped"}]},{"type":"text","value":" and change regions if you're not in the default us-east-1."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The final piece in the puzzle is to upload the container image, so let's create a "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"Makefile"}]},{"type":"text","value":" to make it easy to update it in the future. Maybe you need to change the variables according to your setup."}]},{"type":"element","tag":"pre","props":{"code":"# Makefile\nSTACKNAME_BASE=\"my-sls-scraper-dev\"\n# This is a region that supports AWS Fargate\nREGION=\"us-east-1\"\nPROFILE=\"my-sls-admin\"\nIMAGE_NAME=\"my_sls_scraper\"\n\nbuild:\n    docker build -t $(IMAGE_NAME):latest .\n\nretag:\n    docker tag $(IMAGE_NAME):latest \\\n        $(shell aws cloudformation --region $(REGION) --profile $(PROFILE) describe-stacks --stack-name $(STACKNAME_BASE) --query \"Stacks[0].Outputs[?OutputKey=='ECRRepo'].OutputValue\" --output text):latest\n    @exec $(shell aws ecr --region $(REGION) --profile $(PROFILE) get-login --no-include-email)\n    docker push $(shell aws cloudformation --region $(REGION) --profile $(PROFILE) describe-stacks --stack-name $(STACKNAME_BASE) --query \"Stacks[0].Outputs[?OutputKey=='ECRRepo'].OutputValue\" --output text):latest\n","language":"makefile","meta":"","className":"language-makefile","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"# Makefile\nSTACKNAME_BASE=\"my-sls-scraper-dev\"\n# This is a region that supports AWS Fargate\nREGION=\"us-east-1\"\nPROFILE=\"my-sls-admin\"\nIMAGE_NAME=\"my_sls_scraper\"\n\nbuild:\n    docker build -t $(IMAGE_NAME):latest .\n\nretag:\n    docker tag $(IMAGE_NAME):latest \\\n        $(shell aws cloudformation --region $(REGION) --profile $(PROFILE) describe-stacks --stack-name $(STACKNAME_BASE) --query \"Stacks[0].Outputs[?OutputKey=='ECRRepo'].OutputValue\" --output text):latest\n    @exec $(shell aws ecr --region $(REGION) --profile $(PROFILE) get-login --no-include-email)\n    docker push $(shell aws cloudformation --region $(REGION) --profile $(PROFILE) describe-stacks --stack-name $(STACKNAME_BASE) --query \"Stacks[0].Outputs[?OutputKey=='ECRRepo'].OutputValue\" --output text):latest\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We've already build the image, so we just need to upload it with"}]},{"type":"element","tag":"pre","props":{"code":"make retag\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"make"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" retag\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The first time pushing, this might take some time depending on how fast your internet connection is.\nYou should see an output similar to"}]},{"type":"element","tag":"pre","props":{"code":"18:17 $ make retag\ndocker tag \"my_sls_scraper\":latest \\\n    459015585648.dkr.ecr.us-east-1.amazonaws.com/my-sl-farga-afj2n785due0:latest\nLogin Succeeded\ndocker push 459015585648.dkr.ecr.us-east-1.amazonaws.com/my-sl-farga-afj2n785due0:latest\nThe push refers to a repository [459015585648.dkr.ecr.us-east-1.amazonaws.com/my-sl-farga-afj2n785due0]\n6b325179a37f: Pushed\n7c486f7d4e0e: Pushed\n5a14878ee86f: Pushed\nfb71908672f7: Pushed\nc028dbad8bfd: Pushed\n424cdf061e9d: Pushed\nbd648e09c386: Pushed\n69d95271719a: Pushed\nf88be44e4bd8: Pushed\ne505c7600391: Pushed\n4d2fd1bf072c: Pushed\n6e302bbcacce: Pushed\n97e8dd85db4e: Pushed\n74e2ede3b29c: Pushed\n6d5a64ea8f37: Pushed\n660314270d76: Pushed\nlatest: digest: sha256:f64c0ed0e5296b03645e5aed927b3af1d75faa226382ac389651519a0b14381c size: 3678\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"18:17 $ make retag\ndocker tag \"my_sls_scraper\":latest \\\n    459015585648.dkr.ecr.us-east-1.amazonaws.com/my-sl-farga-afj2n785due0:latest\nLogin Succeeded\ndocker push 459015585648.dkr.ecr.us-east-1.amazonaws.com/my-sl-farga-afj2n785due0:latest\nThe push refers to a repository [459015585648.dkr.ecr.us-east-1.amazonaws.com/my-sl-farga-afj2n785due0]\n6b325179a37f: Pushed\n7c486f7d4e0e: Pushed\n5a14878ee86f: Pushed\nfb71908672f7: Pushed\nc028dbad8bfd: Pushed\n424cdf061e9d: Pushed\nbd648e09c386: Pushed\n69d95271719a: Pushed\nf88be44e4bd8: Pushed\ne505c7600391: Pushed\n4d2fd1bf072c: Pushed\n6e302bbcacce: Pushed\n97e8dd85db4e: Pushed\n74e2ede3b29c: Pushed\n6d5a64ea8f37: Pushed\n660314270d76: Pushed\nlatest: digest: sha256:f64c0ed0e5296b03645e5aed927b3af1d75faa226382ac389651519a0b14381c size: 3678\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"and, if successful, it should be possible to scrape in Fargate by just invoking a Lambda function. Try it with"}]},{"type":"element","tag":"pre","props":{"code":"sls invoke -f fargateScrape --log\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"sls"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" invoke"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" -f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" fargateScrape"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" --log\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"It should execute successfully and exit. The logs of the crawler comes from our Fargate task and not the Lambda function, and can be seen in the "},{"type":"element","tag":"a","props":{"href":"https://console.aws.amazon.com/cloudwatch/home?region=us-east-1#logs:","rel":["nofollow"]},"children":[{"type":"text","value":"CloudWatch console"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Well done if you've made it thus far. We've made the basics of a quite sophisticated scraping infrastructure with a lot of potential. The last steps from here are optional.\nWe will set up an S3 bucket for caching responses, and in the end we'll use AWS CloudWatch to schedule automatic crawls and discuss some methods to better automate and control crawl scheduling."}]},{"type":"element","tag":"h2","props":{"id":"using-s3-as-http-cache"},"children":[{"type":"text","value":"Using S3 as HTTP cache"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Caching responses from our spider is good for faster crawls and to avoid getting banned, as well as a store of html responses that can be used for things like machine learning further down the data processing pipeline.\nScrapy comes with a file storage caching system by default, but because of the framework's great extensibility, we can quite easily make our own cache handler. Using persistent file storage is not possible in Lambda or Fargate, so we have to use an object storage like S3 or a database. We will use S3 because it's relatively easy to set up and maintain."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To do this, we first have to add a bucket to our "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"s3-template.yml"}]},{"type":"text","value":" and add IAM role permissions to our "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"fargate-template.yml"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"serverless.yml"}]},{"type":"text","value":", as well as an environment variable to the latter and to "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"launch_fargate.py"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Add an S3 bucket in the S3 template like this"}]},{"type":"element","tag":"pre","props":{"code":"# s3-template.yml\nResources:\n  ScraperFeedBucket:\n    Type: AWS::S3::Bucket\n    Properties:\n      VersioningConfiguration:\n        Status: \"Enabled\"\n  HttpCacheBucket:\n    Type: AWS::S3::Bucket\n","language":"yaml","meta":"","className":"language-yaml shiki shiki-themes github-light github-dark","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D"},"children":[{"type":"text","value":"# s3-template.yml\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"Resources"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  ScraperFeedBucket"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"AWS::S3::Bucket\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Properties"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      VersioningConfiguration"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"        Status"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"Enabled\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  HttpCacheBucket"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    Type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"AWS::S3::Bucket\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Add a policy to the Fargate template"}]},{"type":"element","tag":"pre","props":{"code":"# fargate-template.yml\n# ...\n    FargateTaskRole:\n        Type: AWS::IAM::Role\n        Properties:\n            # ...\n            Policies:\n                - PolicyName: HttpCacheBucketPolicy\n                  PolicyDocument:\n                    Statement:\n                      - PolicyName: HttpCacheBucketPolicy\n                          PolicyDocument:\n                            Statement:\n                              - Effect: \"Allow\"\n                                Action:\n                                  - \"s3:GetObject\"\n                                  - \"s3:PutObject\"\n                                  - \"s3:ListBucket\"\n                                Resource:\n                                  - !Sub\n                                    - \"arn:aws:s3:::#{BucketName}/*\"\n                                    - BucketName: !Ref HttpCacheBucket\n                                  - !Sub\n                                    - \"arn:aws:s3:::#{BucketName}\"\n                                    - BucketName: !Ref HttpCacheBucket\n","language":"yaml","meta":"","className":"language-yaml shiki shiki-themes github-light github-dark","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D"},"children":[{"type":"text","value":"# fargate-template.yml\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D"},"children":[{"type":"text","value":"# ...\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    FargateTaskRole"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"        Type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"AWS::IAM::Role\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"        Properties"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D"},"children":[{"type":"text","value":"            # ...\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"            Policies"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"                - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"PolicyName"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"HttpCacheBucketPolicy\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"                  PolicyDocument"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"                    Statement"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"                      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"PolicyName"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"HttpCacheBucketPolicy\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"                          PolicyDocument"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"                            Statement"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"                              - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"Effect"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"Allow\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"                                Action"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"                                  - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"s3:GetObject\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"                                  - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"s3:PutObject\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"                                  - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"s3:ListBucket\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"                                Resource"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"                                  - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Sub\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"                                    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"arn:aws:s3:::#{BucketName}/*\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"                                    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"BucketName"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" HttpCacheBucket\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"                                  - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Sub\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"                                    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"arn:aws:s3:::#{BucketName}\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"                                    - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"BucketName"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" HttpCacheBucket\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"and statements and env variable to our lambda functions"}]},{"type":"element","tag":"pre","props":{"code":"# serverless.yml\nprovider:\n    # ...\n    environment:\n        HTTP_CACHE_BUCKET_NAME: !Ref HttpCacheBucket\n        # ...\n    iamRoleStatements:\n        - Effect: \"Allow\"\n          Action:\n            - \"s3:GetObject\"\n            - \"s3:PutObject\"\n            - \"s3:ListBucket\"\n          Resource:\n            - !Sub\n              - \"arn:aws:s3:::#{BucketName}/*\"\n              - BucketName: !Ref HttpCacheBucket\n            - !Sub\n              - \"arn:aws:s3:::#{BucketName}\"\n              - BucketName: !Ref HttpCacheBucket\n        # ...\n","language":"yaml","meta":"","className":"language-yaml shiki shiki-themes github-light github-dark","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D"},"children":[{"type":"text","value":"# serverless.yml\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"provider"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D"},"children":[{"type":"text","value":"    # ...\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    environment"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"        HTTP_CACHE_BUCKET_NAME"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" HttpCacheBucket\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D"},"children":[{"type":"text","value":"        # ...\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    iamRoleStatements"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"        - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"Effect"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"Allow\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"          Action"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"            - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"s3:GetObject\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"            - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"s3:PutObject\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"            - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"s3:ListBucket\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"          Resource"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"            - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Sub\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"              - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"arn:aws:s3:::#{BucketName}/*\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"              - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"BucketName"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" HttpCacheBucket\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"            - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Sub\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"              - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"\"arn:aws:s3:::#{BucketName}\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"              - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"BucketName"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"!Ref"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" HttpCacheBucket\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D"},"children":[{"type":"text","value":"        # ...\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"and lastly pass the new env variable when launching the crawler task"}]},{"type":"element","tag":"pre","props":{"code":"# launch_fargate.py\n# ...\n\"environment\": [\n   {\"name\": \"FEED_BUCKET_NAME\",\n       \"value\": os.environ[\"FEED_BUCKET_NAME\"]},\n   {\"name\": \"HTTP_CACHE_BUCKET_NAME\",\n       \"value\": os.environ[\"HTTP_CACHE_BUCKET_NAME\"]},\n],\n# ...\n","language":"python","meta":"","className":"language-python","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"# launch_fargate.py\n# ...\n\"environment\": [\n   {\"name\": \"FEED_BUCKET_NAME\",\n       \"value\": os.environ[\"FEED_BUCKET_NAME\"]},\n   {\"name\": \"HTTP_CACHE_BUCKET_NAME\",\n       \"value\": os.environ[\"HTTP_CACHE_BUCKET_NAME\"]},\n],\n# ...\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To use all this configuration for some caching, we create a module with our cache implementation in the "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"my_sls_scraper"}]},{"type":"text","value":" folder, and don't forget to add an "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"__init__.py"}]},{"type":"text","value":" file in the newly created "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"extensions"}]},{"type":"text","value":" folder."}]},{"type":"element","tag":"pre","props":{"code":"# my_sls_scraper/extensions/s3cache.py\nimport boto3\nimport gzip\nimport json\nimport logging\nimport os\nfrom botocore.exceptions import ClientError\nfrom botocore.stub import Stubber\nfrom time import time\nfrom datetime import datetime\nfrom six.moves import cPickle as pickle\nfrom six.moves.urllib.parse import urlparse\nfrom scrapy.exceptions import NotConfigured\nfrom scrapy.http import Headers\nfrom scrapy.responsetypes import responsetypes\nfrom scrapy.utils.request import request_fingerprint\nfrom w3lib.http import headers_raw_to_dict, headers_dict_to_raw\n\nfrom botocore.exceptions import ClientError\nimport sys\n\nlogger = logging.getLogger(__name__)\n\n\nclass S3CacheStorage(object):\n    def __init__(self, settings):\n        urifmt = settings.get('S3CACHE_URI', '')\n        if not urifmt:\n            raise NotConfigured('S3CACHE_URI must be specified')\n\n        # Parse URI\n        u = urlparse(urifmt)\n        self.keypath_fmt = u.path[1:]\n        if not self.keypath_fmt:\n            raise NotConfigured('Could not get key path from S3CACHE_URI')\n\n        self.bucket_name = u.hostname\n        if self.bucket_name is None:\n            raise NotConfigured('Could not get bucket name from S3CACHE_URI')\n\n        self.use_gzip = settings.getbool('HTTPCACHE_GZIP')\n        self.dont_retrieve = settings.getbool('S3CACHE_DONT_RETRIEVE')\n\n        self._client = None\n        self._spider = None\n        self._keypath = None\n        self.cached_requests = []\n\n    @property\n    def _client_stubber(self):\n        return Stubber(self.client)\n\n    @property\n    def client(self):\n        \"\"\" Connect to S3 and return the connection \"\"\"\n\n        if self._client is None:\n            self._client = boto3.client('s3')\n        return self._client\n\n    @property\n    def keypath(self):\n        \"\"\" Get the keypath as specified in S3CACHE_URI \"\"\"\n        def get_uri_params(obj):\n            \"\"\"Convert an object to a dict\"\"\"\n            params = {}\n            for k in dir(obj):\n                params[k] = getattr(obj, k)\n            params['day'] = datetime.utcnow().strftime('%Y-%m-%d')\n            params['time'] = datetime.utcnow().replace(\n                microsecond=0).isoformat().replace(':', '-')\n            return params\n        if not self._keypath:\n            self._keypath = self.keypath_fmt % get_uri_params(self.spider)\n        return self._keypath\n\n    @property\n    def spider(self):\n        if not self._spider:\n            raise NotConfigured('Could not get spider! Aborting...')\n        return self._spider\n\n    def put_object_to_key(self, obj, bucket, key):\n        try:\n            obj = gzip.compress(obj) if self.use_gzip else obj\n            self.client.put_object(Body=obj, Bucket=bucket, Key=key)\n        except ClientError as e:\n            logger.warning(\n                'Failed to store cache on key {key}: {e}'.format(key=key, e=e))\n            response_code = e.response.get('Error', {}).get('Code')\n            if response_code == 'AccessDenied' or response_code == 'InvalidAccessKeyId':\n                logger.exception(\"Access denied to http cache bucket\")\n                sys.exit(1)\n\n    def get_object_from_key(self, bucket, key):\n        try:\n            response = self.client.get_object(Bucket=bucket, Key=key)\n            obj = response['Body'].read()\n            return gzip.decompress(obj) if self.use_gzip else obj\n        except ClientError as e:\n            logger.debug(\n                'Failed to retrieve cache on key {key}: {e}'.format(key=key, e=e))\n            response_code = e.response.get('Error', {}).get('Code')\n            if response_code == 'AccessDenied' or response_code == 'InvalidAccessKeyId':\n                logger.exception(\"Access denied to http cache bucket\")\n                sys.exit(1)\n\n    def open_spider(self, spider):\n        logger.debug('Using s3 cache storage in %(bucket_name)s' % {'bucket_name': self.bucket_name},\n                     extra={'spider': spider})\n        # Update spider reference\n        self._spider = spider\n\n    def close_spider(self, spider):\n        logger.info(\n            'Cache on s3 bucket {bucket} on key path {keypath}'.format(\n                bucket=self.bucket_name, keypath=self.keypath),\n            extra={'spider': spider}\n        )\n\n    def retrieve_response(self, spider, request):\n        \"\"\"Return response if present in cache, or None otherwise.\"\"\"\n        if self.dont_retrieve:\n            return\n        keyname = self._get_request_path(request)\n        keydata = self.get_object_from_key(self.bucket_name, keyname)\n        if not keydata:\n            return  # not cached\n        keydata = pickle.loads(keydata)\n        metadata = keydata['meta']\n        body = keydata['response_body']\n        rawheaders = keydata['response_headers']\n        url = metadata.get('response_url')\n        status = metadata['status']\n        headers = Headers(headers_raw_to_dict(rawheaders))\n        respcls = responsetypes.from_args(headers=headers, url=url)\n        response = respcls(url=url, headers=headers, status=status, body=body)\n        return response\n\n    def store_response(self, spider, request, response):\n        # TODO: Use a buffer instead of sending the cache files one by one\n        \"\"\"Store the given response in the cache.\"\"\"\n        keyname = self._get_request_path(request)\n        metadata = {\n            'url': request.url,\n            'method': request.method,\n            'status': response.status,\n            'response_url': response.url,\n            'timestamp': time(),\n        }\n        keydata = {\n            'meta': metadata,\n            'response_headers': headers_dict_to_raw(response.headers),\n            'response_body': response.body,\n            'request_headers': headers_dict_to_raw(request.headers),\n            'request_body': request.body\n        }\n        self.put_object_to_key(pickle.dumps(\n            keydata), self.bucket_name, keyname)\n\n    def _get_request_path(self, request):\n        key = request_fingerprint(request)\n        return '{keypath}/{key}'.format(keypath=self.keypath, key=key)\n\n","language":"python","meta":"","className":"language-python","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"# my_sls_scraper/extensions/s3cache.py\nimport boto3\nimport gzip\nimport json\nimport logging\nimport os\nfrom botocore.exceptions import ClientError\nfrom botocore.stub import Stubber\nfrom time import time\nfrom datetime import datetime\nfrom six.moves import cPickle as pickle\nfrom six.moves.urllib.parse import urlparse\nfrom scrapy.exceptions import NotConfigured\nfrom scrapy.http import Headers\nfrom scrapy.responsetypes import responsetypes\nfrom scrapy.utils.request import request_fingerprint\nfrom w3lib.http import headers_raw_to_dict, headers_dict_to_raw\n\nfrom botocore.exceptions import ClientError\nimport sys\n\nlogger = logging.getLogger(__name__)\n\n\nclass S3CacheStorage(object):\n    def __init__(self, settings):\n        urifmt = settings.get('S3CACHE_URI', '')\n        if not urifmt:\n            raise NotConfigured('S3CACHE_URI must be specified')\n\n        # Parse URI\n        u = urlparse(urifmt)\n        self.keypath_fmt = u.path[1:]\n        if not self.keypath_fmt:\n            raise NotConfigured('Could not get key path from S3CACHE_URI')\n\n        self.bucket_name = u.hostname\n        if self.bucket_name is None:\n            raise NotConfigured('Could not get bucket name from S3CACHE_URI')\n\n        self.use_gzip = settings.getbool('HTTPCACHE_GZIP')\n        self.dont_retrieve = settings.getbool('S3CACHE_DONT_RETRIEVE')\n\n        self._client = None\n        self._spider = None\n        self._keypath = None\n        self.cached_requests = []\n\n    @property\n    def _client_stubber(self):\n        return Stubber(self.client)\n\n    @property\n    def client(self):\n        \"\"\" Connect to S3 and return the connection \"\"\"\n\n        if self._client is None:\n            self._client = boto3.client('s3')\n        return self._client\n\n    @property\n    def keypath(self):\n        \"\"\" Get the keypath as specified in S3CACHE_URI \"\"\"\n        def get_uri_params(obj):\n            \"\"\"Convert an object to a dict\"\"\"\n            params = {}\n            for k in dir(obj):\n                params[k] = getattr(obj, k)\n            params['day'] = datetime.utcnow().strftime('%Y-%m-%d')\n            params['time'] = datetime.utcnow().replace(\n                microsecond=0).isoformat().replace(':', '-')\n            return params\n        if not self._keypath:\n            self._keypath = self.keypath_fmt % get_uri_params(self.spider)\n        return self._keypath\n\n    @property\n    def spider(self):\n        if not self._spider:\n            raise NotConfigured('Could not get spider! Aborting...')\n        return self._spider\n\n    def put_object_to_key(self, obj, bucket, key):\n        try:\n            obj = gzip.compress(obj) if self.use_gzip else obj\n            self.client.put_object(Body=obj, Bucket=bucket, Key=key)\n        except ClientError as e:\n            logger.warning(\n                'Failed to store cache on key {key}: {e}'.format(key=key, e=e))\n            response_code = e.response.get('Error', {}).get('Code')\n            if response_code == 'AccessDenied' or response_code == 'InvalidAccessKeyId':\n                logger.exception(\"Access denied to http cache bucket\")\n                sys.exit(1)\n\n    def get_object_from_key(self, bucket, key):\n        try:\n            response = self.client.get_object(Bucket=bucket, Key=key)\n            obj = response['Body'].read()\n            return gzip.decompress(obj) if self.use_gzip else obj\n        except ClientError as e:\n            logger.debug(\n                'Failed to retrieve cache on key {key}: {e}'.format(key=key, e=e))\n            response_code = e.response.get('Error', {}).get('Code')\n            if response_code == 'AccessDenied' or response_code == 'InvalidAccessKeyId':\n                logger.exception(\"Access denied to http cache bucket\")\n                sys.exit(1)\n\n    def open_spider(self, spider):\n        logger.debug('Using s3 cache storage in %(bucket_name)s' % {'bucket_name': self.bucket_name},\n                     extra={'spider': spider})\n        # Update spider reference\n        self._spider = spider\n\n    def close_spider(self, spider):\n        logger.info(\n            'Cache on s3 bucket {bucket} on key path {keypath}'.format(\n                bucket=self.bucket_name, keypath=self.keypath),\n            extra={'spider': spider}\n        )\n\n    def retrieve_response(self, spider, request):\n        \"\"\"Return response if present in cache, or None otherwise.\"\"\"\n        if self.dont_retrieve:\n            return\n        keyname = self._get_request_path(request)\n        keydata = self.get_object_from_key(self.bucket_name, keyname)\n        if not keydata:\n            return  # not cached\n        keydata = pickle.loads(keydata)\n        metadata = keydata['meta']\n        body = keydata['response_body']\n        rawheaders = keydata['response_headers']\n        url = metadata.get('response_url')\n        status = metadata['status']\n        headers = Headers(headers_raw_to_dict(rawheaders))\n        respcls = responsetypes.from_args(headers=headers, url=url)\n        response = respcls(url=url, headers=headers, status=status, body=body)\n        return response\n\n    def store_response(self, spider, request, response):\n        # TODO: Use a buffer instead of sending the cache files one by one\n        \"\"\"Store the given response in the cache.\"\"\"\n        keyname = self._get_request_path(request)\n        metadata = {\n            'url': request.url,\n            'method': request.method,\n            'status': response.status,\n            'response_url': response.url,\n            'timestamp': time(),\n        }\n        keydata = {\n            'meta': metadata,\n            'response_headers': headers_dict_to_raw(response.headers),\n            'response_body': response.body,\n            'request_headers': headers_dict_to_raw(request.headers),\n            'request_body': request.body\n        }\n        self.put_object_to_key(pickle.dumps(\n            keydata), self.bucket_name, keyname)\n\n    def _get_request_path(self, request):\n        key = request_fingerprint(request)\n        return '{keypath}/{key}'.format(keypath=self.keypath, key=key)\n\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The code is a slightly modified version of "},{"type":"element","tag":"a","props":{"href":"https://github.com/heylouiz/scrapy-s3-http-cache","rel":["nofollow"]},"children":[{"type":"text","value":"github.com/heylouiz/scrapy-s3-http-cache"}]},{"type":"text","value":" to work natively with AWS."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We'll add the necessary settings in "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"crawl.py"}]},{"type":"text","value":" so that we can dynamically decide which cache storage to use."}]},{"type":"element","tag":"pre","props":{"code":"# my_sls_scraper/crawl.py\ndef crawl(settings={}, spider_name=\"header_spider\", spider_kwargs={}):\n# ...\n    if (is_in_aws() and os.getenv(\"USE_S3_CACHE\") !=  \"0\") or os.getenv(\"USE_S3_CACHE\"):\n        settings[\"HTTPCACHE_STORAGE\"] =  \"my_sls_scraper.extensions.s3cache.S3CacheStorage\"\n        settings[\"S3CACHE_URI\"] =  f\"s3://{os.environ['HTTP_CACHE_BUCKET_NAME']}/cache\"\n# ...\n","language":"python","meta":"","className":"language-python","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"# my_sls_scraper/crawl.py\ndef crawl(settings={}, spider_name=\"header_spider\", spider_kwargs={}):\n# ...\n    if (is_in_aws() and os.getenv(\"USE_S3_CACHE\") !=  \"0\") or os.getenv(\"USE_S3_CACHE\"):\n        settings[\"HTTPCACHE_STORAGE\"] =  \"my_sls_scraper.extensions.s3cache.S3CacheStorage\"\n        settings[\"S3CACHE_URI\"] =  f\"s3://{os.environ['HTTP_CACHE_BUCKET_NAME']}/cache\"\n# ...\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Now we need to do a full deploy by both deploying with Serverless, and rebuild and upload our Docker image. Do that and launch the crawler using S3 as cache storage with"}]},{"type":"element","tag":"pre","props":{"code":"sls deploy -v\nmake build && make retag\nsls invoke -f fargateScrape --log\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"sls"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" deploy"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" -v\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"make"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" build"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":" && "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"make"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" retag\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"sls"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" invoke"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" -f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" fargateScrape"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" --log\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"It's probably wise to run the crawler locally after "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"sls deploy -v"}]},{"type":"text","value":" to verify that things work as they should, so you don't need to redeploy 15 times because of various typos (talking from experience).\nRun the crawler locally after finding your cache bucket name in the "},{"type":"element","tag":"a","props":{"href":"https://s3.console.aws.amazon.com/s3/home","rel":["nofollow"]},"children":[{"type":"text","value":"S3 console"}]},{"type":"text","value":" (should be similar to "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"my-sls-scraper-dev-httpcachebucket-y2mbtieyeju3"}]},{"type":"text","value":")"}]},{"type":"element","tag":"pre","props":{"code":"sls invoke local -f lambdaScrape --log -e USE_S3_CACHE=1 -e HTTP_CACHE_BUCKET_NAME=<YOUR_CACHE_BUCKET_NAME>\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"sls"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" invoke"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" local"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" -f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" lambdaScrape"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" --log"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" -e"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" USE_S3_CACHE="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" -e"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" HTTP_CACHE_BUCKET_NAME="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"YOUR_CACHE_BUCKET_NAM"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"E"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#D73A49;--shiki-dark:#F97583"},"children":[{"type":"text","value":">\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"You should now see objects appearing in the http cache S3 bucket as we run the crawler."}]},{"type":"element","tag":"h2","props":{"id":"scheduling-and-configuring-crawls"},"children":[{"type":"text","value":"Scheduling and Configuring Crawls"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"One of the advantages of using the AWS ecosystem is that it contains solutions for all common and uncommon tasks such as scheduling, event notifications, message queues, etc. The Serverless framework even makes some of this easy for beginners, so let's use it to schedule a weekly crawl with our spider."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Add a key to our function config in "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"serverless.yml"}]},{"type":"text","value":" (pay damn close attention to the indentation here, or it will not work and no warning will be given)"}]},{"type":"element","tag":"pre","props":{"code":"# serverless.yml\n# ...\nfunctions:\n  fargateScraper:\n    handler: launch_fargate.launch_fargate\nevents:\n  - schedule:\n      rate: cron(0 6 ? * MON *)\n      enabled: true\n      description:\n        Header spider every Monday morning at 6 AM UTC\n        # The input is key-value pairs accessed in the root of the event parameter of every handler function, i.e. event.get(\"spider_name\")\n      input:\n        spider_name: header_spider\n        # ...\n","language":"yaml","meta":"","className":"language-yaml shiki shiki-themes github-light github-dark","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D"},"children":[{"type":"text","value":"# serverless.yml\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D"},"children":[{"type":"text","value":"# ...\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"functions"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  fargateScraper"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    handler"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"launch_fargate.launch_fargate\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"events"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"  - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"schedule"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      rate"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"cron(0 6 ? * MON *)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      enabled"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":"true\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      description"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"        Header spider every Monday morning at 6 AM UTC\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D"},"children":[{"type":"text","value":"        # The input is key-value pairs accessed in the root of the event parameter of every handler function, i.e. event.get(\"spider_name\")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"      input"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"        spider_name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"header_spider\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D"},"children":[{"type":"text","value":"        # ...\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"After deploying, you can verify that a CloudWatch Events tab appears under triggers in the Lambda console."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Lambda console triggers","src":"/posts/scrapy-fargate-sls-guide/lambda-console-triggers.png","title":"Lambda console triggers","style":{"aspectRatio":"1263/812"}},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If you have a few spiders, configuring all the launches as scheduled events in "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"serverless.yml"}]},{"type":"text","value":" works fine. If you have a bunch of spiders, you might want to launch several spiders at the same time from a single Lambda function."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We can implement behaviour like that in another Lambda function. Let's remove the dummy function in "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"handler.py"}]}]},{"type":"element","tag":"pre","props":{"code":"# handler.py\nimport json\nfrom datetime import datetime, timedelta\nimport logging\n\nfrom launch_fargate import launch_fargate\n\n\ndef run_crawlers(event, context):\n    result = []\n    for x in filter(should_crawl, get_crawler_config()):\n        try:\n            if x.get(\"run_in_lambda\"):\n                # TODO Implement function to invoke crawl in new Lambda function\n                pass\n            else:\n                fargate_launch_response = launch_fargate(dict(\n                    spider_name=x.get(\"spider_name\"),\n                    spider_kwargs=x.get(\"spider_kwargs\"),\n                ), {})\n                result.append(fargate_launch_response)\n        except Exception:\n            logging.exception(\n                f\"Could not launch spider {x.get('spider_name')}\"\n            )\n    return result\n\n\ndef get_crawler_config():\n    # This function could make an API call to a CMS like AirTable,\n    # Strapi or DynamoDB.\n    return [\n        {\n            \"spider_name\": \"header_spider\",\n            \"spider_kwargs\": {\n                \"start_urls\": [\"https://example.com\"],\n            },\n            \"previous_crawl\": {\n                \"success_state\": True,\n                \"items_crawled\": 100,\n                \"finish_date\": datetime.now() - timedelta(days=3),\n            },\n        },\n        {\n            \"spider_name\": \"header_spider\",\n            \"spider_kwargs\": {\n                \"start_urls\": [\"https://www.ietf.org\"],\n            },\n            \"previous_crawl\": {\n                \"success_state\": True,\n                \"items_crawled\": 100,\n                \"finish_date\": datetime.now() - timedelta(hours=16),\n            },\n            \"crawl_interval_hours\": 12,\n            \"settings\": {\n                \"AUTOTHROTTLE_ENABLED\": True,\n            }|\n        },\n        {\n            \"spider_name\": \"header_spider\",\n            \"spider_kwargs\": {\n                \"start_urls\": [\"https://bitcoin.org\"],\n            },\n        },\n        {\n            \"spider_name\": \"other_spider\",\n            \"previous_crawl\": None\n        },\n    ]\n\n\ndef should_crawl(x):\n    previous_crawl = x.get(\"previous_crawl\")\n    if previous_crawl:\n        time_interval_hours = x.get(\"crawl_interval_hours\", 24*7)\n        return previous_crawl.get(\"finish_date\") + timedelta(hours=time_interval_hours) < datetime.now() or not previous_crawl.get(\"success_state\")\n    return True\n","language":"python","meta":"","className":"language-python","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"# handler.py\nimport json\nfrom datetime import datetime, timedelta\nimport logging\n\nfrom launch_fargate import launch_fargate\n\n\ndef run_crawlers(event, context):\n    result = []\n    for x in filter(should_crawl, get_crawler_config()):\n        try:\n            if x.get(\"run_in_lambda\"):\n                # TODO Implement function to invoke crawl in new Lambda function\n                pass\n            else:\n                fargate_launch_response = launch_fargate(dict(\n                    spider_name=x.get(\"spider_name\"),\n                    spider_kwargs=x.get(\"spider_kwargs\"),\n                ), {})\n                result.append(fargate_launch_response)\n        except Exception:\n            logging.exception(\n                f\"Could not launch spider {x.get('spider_name')}\"\n            )\n    return result\n\n\ndef get_crawler_config():\n    # This function could make an API call to a CMS like AirTable,\n    # Strapi or DynamoDB.\n    return [\n        {\n            \"spider_name\": \"header_spider\",\n            \"spider_kwargs\": {\n                \"start_urls\": [\"https://example.com\"],\n            },\n            \"previous_crawl\": {\n                \"success_state\": True,\n                \"items_crawled\": 100,\n                \"finish_date\": datetime.now() - timedelta(days=3),\n            },\n        },\n        {\n            \"spider_name\": \"header_spider\",\n            \"spider_kwargs\": {\n                \"start_urls\": [\"https://www.ietf.org\"],\n            },\n            \"previous_crawl\": {\n                \"success_state\": True,\n                \"items_crawled\": 100,\n                \"finish_date\": datetime.now() - timedelta(hours=16),\n            },\n            \"crawl_interval_hours\": 12,\n            \"settings\": {\n                \"AUTOTHROTTLE_ENABLED\": True,\n            }|\n        },\n        {\n            \"spider_name\": \"header_spider\",\n            \"spider_kwargs\": {\n                \"start_urls\": [\"https://bitcoin.org\"],\n            },\n        },\n        {\n            \"spider_name\": \"other_spider\",\n            \"previous_crawl\": None\n        },\n    ]\n\n\ndef should_crawl(x):\n    previous_crawl = x.get(\"previous_crawl\")\n    if previous_crawl:\n        time_interval_hours = x.get(\"crawl_interval_hours\", 24*7)\n        return previous_crawl.get(\"finish_date\") + timedelta(hours=time_interval_hours) < datetime.now() or not previous_crawl.get(\"success_state\")\n    return True\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This function makes it possible to run crawls quite intelligently. It also assumes we have more spiders and that our "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"header_spider"}]},{"type":"text","value":" can take arguments in its constructor. Let's change it to do so"}]},{"type":"element","tag":"pre","props":{"code":"# my_sls_scraper/spiders/header_spider.py\nfrom urllib.parse import urlparse\n\nfrom scrapy.spiders import CrawlSpider, Rule\nfrom scrapy.linkextractors import LinkExtractor\n\n\nclass HeaderSpider(CrawlSpider):\n    name = \"header_spider\"\n\n    start_urls = [\"https://scrapy.org\"]\n    allowed_domains = [\"scrapy.org\"]\n\n    def __init__(self, **kwargs):\n        # Enables overriding attributes for a flexible spider\n        if kwargs.get(\"start_urls\"):\n            self.start_urls = kwargs.get(\"start_urls\")\n            self.allowed_domains = list(\n                urlparse(x).hostname for x in self.start_urls\n            )\n\n        super().__init__(\n            **{k: v for k, v in kwargs.items() if not hasattr(self, k)}\n        )\n\n    rules = [  # Get all links on start url\n        Rule(\n            link_extractor=LinkExtractor(\n                deny=r\"\\?\",\n            ),\n            follow=False,\n            callback=\"parse_page\",\n        )\n    ]\n\n    def parse_start_url(self, response):\n        return self.parse_page(response)\n\n    def parse_page(self, response):\n        header = response.css(\"h1, h2\").extract_first(\n        ) or response.css(\"title\").extract_first() or response.url\n        return {\n            \"header\": remove_tags(header),\n            \"url\": response.url,\n        }\n","language":"python","meta":"","className":"language-python","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"# my_sls_scraper/spiders/header_spider.py\nfrom urllib.parse import urlparse\n\nfrom scrapy.spiders import CrawlSpider, Rule\nfrom scrapy.linkextractors import LinkExtractor\n\n\nclass HeaderSpider(CrawlSpider):\n    name = \"header_spider\"\n\n    start_urls = [\"https://scrapy.org\"]\n    allowed_domains = [\"scrapy.org\"]\n\n    def __init__(self, **kwargs):\n        # Enables overriding attributes for a flexible spider\n        if kwargs.get(\"start_urls\"):\n            self.start_urls = kwargs.get(\"start_urls\")\n            self.allowed_domains = list(\n                urlparse(x).hostname for x in self.start_urls\n            )\n\n        super().__init__(\n            **{k: v for k, v in kwargs.items() if not hasattr(self, k)}\n        )\n\n    rules = [  # Get all links on start url\n        Rule(\n            link_extractor=LinkExtractor(\n                deny=r\"\\?\",\n            ),\n            follow=False,\n            callback=\"parse_page\",\n        )\n    ]\n\n    def parse_start_url(self, response):\n        return self.parse_page(response)\n\n    def parse_page(self, response):\n        header = response.css(\"h1, h2\").extract_first(\n        ) or response.css(\"title\").extract_first() or response.url\n        return {\n            \"header\": remove_tags(header),\n            \"url\": response.url,\n        }\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"It can now scrape the headers on any site with the "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"start_urls"}]},{"type":"text","value":" argument.\nWe also have to replace the hello function in "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"serverless.yml"}]},{"type":"text","value":" to the following"}]},{"type":"element","tag":"pre","props":{"code":"# serverless.py\n# ...\nfunctions:\n  pollSpidersScrape:\n    handler: handler.run_crawlers\n    events:\n      - schedule:\n          rate: rate(2 hours)\n          enabled: true\n          description: Poll spiders every 2 hours\n  # ...\n","language":"yaml","meta":"","className":"language-yaml shiki shiki-themes github-light github-dark","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D"},"children":[{"type":"text","value":"# serverless.py\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D"},"children":[{"type":"text","value":"# ...\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"functions"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"  pollSpidersScrape"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    handler"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"handler.run_crawlers\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"    events"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":"      - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"schedule"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"          rate"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"rate(2 hours)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"          enabled"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":"true\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#22863A;--shiki-dark:#85E89D"},"children":[{"type":"text","value":"          description"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":"Poll spiders every 2 hours\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6A737D;--shiki-dark:#6A737D"},"children":[{"type":"text","value":"  # ...\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Do a full deploy and see if it works."}]},{"type":"element","tag":"pre","props":{"code":"sls deploy -v\nmake build && make retag\nsls invoke -f pollSpidersScrape --log\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"sls"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" deploy"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" -v\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"make"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" build"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#24292E;--shiki-dark:#E1E4E8"},"children":[{"type":"text","value":" && "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"make"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" retag\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"sls"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" invoke"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" -f"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" pollSpidersScrape"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" --log\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"You should now see output files for scraping "},{"type":"element","tag":"a","props":{"href":"http://www.ietf.org","rel":["nofollow"]},"children":[{"type":"text","value":"www.ietf.org"}]},{"type":"text","value":" and bitcoin.org in S3, while one container will fail because we don't have a spider called "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"other_spider"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"WARNING"}]},{"type":"text","value":"\nDon't forget to remove or stop that last function from running, as starting 3 Fargate containers every 2 hours will cost some money.\nYou can remove all resources* with"}]},{"type":"element","tag":"pre","props":{"code":"sls remove -v\n","language":"bash","meta":"","className":"language-bash shiki shiki-themes github-light github-dark","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#6F42C1;--shiki-dark:#B392F0"},"children":[{"type":"text","value":"sls"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#032F62;--shiki-dark:#9ECBFF"},"children":[{"type":"text","value":" remove"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#005CC5;--shiki-dark:#79B8FF"},"children":[{"type":"text","value":" -v\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"... and rebuild it all with another command. Infrastructure as code is pretty neat."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"* Serverless will fail to delete the buckets and ECR repository if they are not empty. So you have to manually delete all images from the repository and all objects from the scraper feed bucket and http cache bucket first."}]},{"type":"element","tag":"h2","props":{"id":"conclusion"},"children":[{"type":"text","value":"Conclusion"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This concludes this guide. I hope it was useful for understanding scraping and serverless a little better. The next part will be about setting up a Lambda function that reacts whenever a crawler feed is created in S3, do some processing on that data before it's stored in a database.\nAny feedback is welcome and don't hesitate to contact me if you're interested in the price comparison framework I'm creating."}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"running-scrapy-in-aws-lambda","depth":2,"text":"Running Scrapy in AWS Lambda","children":[{"id":"requirements","depth":3,"text":"Requirements"},{"id":"result","depth":3,"text":"Result"}]},{"id":"setting-up-a-crawler","depth":2,"text":"Setting up a crawler","children":[{"id":"creating-the-scraper","depth":3,"text":"Creating the scraper"}]},{"id":"setting-up-an-aws-lambda-function","depth":2,"text":"Setting up an AWS Lambda function"},{"id":"storing-scraped-data-in-s3","depth":2,"text":"Storing scraped data in S3"},{"id":"running-scrapy-in-aws-fargate","depth":2,"text":"Running Scrapy in AWS Fargate","children":[{"id":"dockerize-it","depth":3,"text":"Dockerize it"},{"id":"configure-fargate-on-aws","depth":3,"text":"Configure Fargate on AWS"}]},{"id":"using-s3-as-http-cache","depth":2,"text":"Using S3 as HTTP cache"},{"id":"scheduling-and-configuring-crawls","depth":2,"text":"Scheduling and Configuring Crawls"},{"id":"conclusion","depth":2,"text":"Conclusion"}]}},"_type":"markdown","_id":"content:posts:scrapy-fargate-sls-guide:index.md","_source":"content","_file":"posts/scrapy-fargate-sls-guide/index.md","_extension":"md","sitemap":{"loc":"/posts/scrapy-fargate-sls-guide","images":[]}}