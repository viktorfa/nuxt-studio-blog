<!DOCTYPE html>
<html  lang="en">
<head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Serverless Scraping with Scrapy, AWS Lambda and Fargate – a guide</title>
<meta name="twitter:card" content="summary_large_image">
<meta name="description" content="Amazing insights">
<meta property="og:description" content="Amazing insights">
<meta property="og:image" content="/social-card-preview.png">
<meta property="og:image:width" content="400">
<meta property="og:image:height" content="300">
<meta property="og:image:alt" content="An image showcasing my project.">
<meta property="og:title" content="Serverless Scraping with Scrapy, AWS Lambda and Fargate – a guide">
<link rel="preload" as="fetch" crossorigin="anonymous" href="/posts/scrapy-fargate-sls-guide/_payload.json">
<link rel="stylesheet" href="/_nuxt/entry.97ab6348.css">
<link rel="stylesheet" href="/_nuxt/DocumentDrivenNotFound.17085fcb.css">
<link rel="stylesheet" href="/_nuxt/ProseH2.b565e694.css">
<link rel="stylesheet" href="/_nuxt/ProseP.2188f7db.css">
<link rel="stylesheet" href="/_nuxt/ProseA.f70b28a1.css">
<link rel="stylesheet" href="/_nuxt/ProseH3.9316dd33.css">
<link rel="stylesheet" href="/_nuxt/ProseUl.dbdeb511.css">
<link rel="stylesheet" href="/_nuxt/ProseLi.fd79bc46.css">
<link rel="stylesheet" href="/_nuxt/ProseEm.e73a4b12.css">
<link rel="stylesheet" href="/_nuxt/ProsePre.e63e49c6.css">
<link rel="stylesheet" href="/_nuxt/ProseCode.91016173.css">
<link rel="stylesheet" href="/_nuxt/ProseCodeInline.46b97b4c.css">
<link rel="stylesheet" href="/_nuxt/ProseStrong.a06f6381.css">
<link rel="stylesheet" href="/_nuxt/ProseImg.4753ea4a.css"><style id="pinceau-runtime-hydratable">@media{.phy[--]{--puid:mmG8Wh-v;}.pv-57WdVp{max-width:var(--elements-container-maxWidth);padding-left:var(--elements-container-padding-mobile);padding-right:var(--elements-container-padding-mobile);}@media (min-width: 475px){.pv-57WdVp{padding-left:var(--elements-container-padding-xs);padding-right:var(--elements-container-padding-xs);}}@media (min-width: 640px){.pv-57WdVp{padding-left:var(--elements-container-padding-sm);padding-right:var(--elements-container-padding-sm);}}@media (min-width: 768px){.pv-57WdVp{padding-left:var(--elements-container-padding-md);padding-right:var(--elements-container-padding-md);}}} </style><style id="pinceau-theme">@media { :root {--pinceau-mq: initial; --alpine-readableLine: 68ch;--alpine-backdrop-backgroundColor: #f4f4f5b3;--prose-code-inline-padding: 0.2rem 0.375rem 0.2rem 0.375rem;--prose-code-block-backdropFilter: contrast(1);--prose-code-block-border-style: solid;--prose-code-block-border-width: 1px;--prose-tbody-tr-borderBottom-style: dashed;--prose-tbody-tr-borderBottom-width: 1px;--prose-th-textAlign: inherit;--prose-thead-borderBottom-style: solid;--prose-thead-borderBottom-width: 1px;--prose-thead-border-style: solid;--prose-thead-border-width: 0px;--prose-table-textAlign: start;--prose-hr-width: 1px;--prose-hr-style: solid;--prose-li-listStylePosition: outside;--prose-ol-li-markerColor: currentColor;--prose-ol-paddingInlineStart: 21px;--prose-ol-listStyleType: decimal;--prose-ul-li-markerColor: currentColor;--prose-ul-paddingInlineStart: 21px;--prose-ul-listStyleType: disc;--prose-blockquote-border-style: solid;--prose-blockquote-border-width: 4px;--prose-blockquote-quotes: '201C' '201D' '2018' '2019';--prose-blockquote-paddingInlineStart: 24px;--prose-a-code-color-hover: currentColor;--prose-a-code-color-static: currentColor;--prose-a-hasCode-borderBottom: none;--prose-a-border-distance: 2px;--prose-a-border-color-hover: currentColor;--prose-a-border-color-static: currentColor;--prose-a-border-style-hover: solid;--prose-a-border-style-static: dashed;--prose-a-border-width: 1px;--prose-a-color-static: inherit;--prose-a-textDecoration: none;--prose-h6-margin: 3rem 0 2rem;--prose-h5-margin: 3rem 0 2rem;--prose-h4-margin: 3rem 0 2rem;--prose-h3-margin: 3rem 0 2rem;--prose-h2-margin: 3rem 0 2rem;--prose-h1-margin: 0 0 2rem;--prose-p-fontSize: 18px;--typography-lead-loose: 2;--typography-lead-relaxed: 1.625;--typography-lead-normal: 1.5;--typography-lead-snug: 1.375;--typography-lead-tight: 1.25;--typography-lead-none: 1;--typography-lead-10: 2.5rem;--typography-lead-9: 2.25rem;--typography-lead-8: 2rem;--typography-lead-7: 1.75rem;--typography-lead-6: 1.5rem;--typography-lead-5: 1.25rem;--typography-lead-4: 1rem;--typography-lead-3: .75rem;--typography-lead-2: .5rem;--typography-lead-1: .025rem;--typography-fontWeight-black: 900;--typography-fontWeight-extrabold: 800;--typography-fontWeight-bold: 700;--typography-fontWeight-semibold: 600;--typography-fontWeight-medium: 500;--typography-fontWeight-normal: 400;--typography-fontWeight-light: 300;--typography-fontWeight-extralight: 200;--typography-fontWeight-thin: 100;--typography-fontSize-9xl: 128px;--typography-fontSize-8xl: 96px;--typography-fontSize-7xl: 72px;--typography-fontSize-6xl: 60px;--typography-fontSize-5xl: 48px;--typography-fontSize-4xl: 36px;--typography-fontSize-3xl: 30px;--typography-fontSize-2xl: 24px;--typography-fontSize-xl: 20px;--typography-fontSize-lg: 18px;--typography-fontSize-base: 16px;--typography-fontSize-sm: 14px;--typography-fontSize-xs: 12px;--typography-letterSpacing-wide: 0.025em;--typography-letterSpacing-tight: -0.025em;--typography-verticalMargin-base: 24px;--typography-verticalMargin-sm: 16px;--elements-border-secondary-hover: [object Object];--elements-backdrop-background: #fffc;--elements-backdrop-filter: saturate(200%) blur(20px);--elements-container-maxWidth: 64rem;--lead-loose: 2;--lead-relaxed: 1.625;--lead-normal: 1.5;--lead-snug: 1.375;--lead-tight: 1.25;--lead-none: 1;--lead-10: 2.5rem;--lead-9: 2.25rem;--lead-8: 2rem;--lead-7: 1.75rem;--lead-6: 1.5rem;--lead-5: 1.25rem;--lead-4: 1rem;--lead-3: .75rem;--lead-2: .5rem;--lead-1: .025rem;--letterSpacing-widest: 0.1em;--letterSpacing-wider: 0.05em;--letterSpacing-wide: 0.025em;--letterSpacing-normal: 0em;--letterSpacing-tight: -0.025em;--letterSpacing-tighter: -0.05em;--fontSize-9xl: 8rem;--fontSize-8xl: 6rem;--fontSize-7xl: 4.5rem;--fontSize-6xl: 3.75rem;--fontSize-5xl: 3rem;--fontSize-4xl: 2.25rem;--fontSize-3xl: 1.875rem;--fontSize-2xl: 1.5rem;--fontSize-xl: 1.25rem;--fontSize-lg: 1.125rem;--fontSize-base: 1rem;--fontSize-sm: 0.875rem;--fontSize-xs: 0.75rem;--fontWeight-black: 900;--fontWeight-extrabold: 800;--fontWeight-bold: 700;--fontWeight-semibold: 600;--fontWeight-medium: 500;--fontWeight-normal: 400;--fontWeight-light: 300;--fontWeight-extralight: 200;--fontWeight-thin: 100;--font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace;--font-serif: ui-serif, Georgia, Cambria, Times New Roman, Times, serif;--font-sans: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica Neue, Arial, Noto Sans, sans-serif, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol, Noto Color Emoji;--opacity-total: 1;--opacity-high: 0.8;--opacity-medium: 0.5;--opacity-soft: 0.3;--opacity-light: 0.15;--opacity-bright: 0.1;--opacity-noOpacity: 0;--borderWidth-lg: 3px;--borderWidth-md: 2px;--borderWidth-sm: 1px;--borderWidth-noBorder: 0;--space-rem-875: 0.875rem;--space-rem-625: 0.625rem;--space-rem-375: 0.375rem;--space-rem-125: 0.125rem;--space-px: 1px;--space-128: 32rem;--space-96: 24rem;--space-80: 20rem;--space-72: 18rem;--space-64: 16rem;--space-60: 15rem;--space-56: 14rem;--space-52: 13rem;--space-48: 12rem;--space-44: 11rem;--space-40: 10rem;--space-36: 9rem;--space-32: 8rem;--space-28: 7rem;--space-24: 6rem;--space-20: 5rem;--space-16: 4rem;--space-14: 3.5rem;--space-12: 3rem;--space-11: 2.75rem;--space-10: 2.5rem;--space-9: 2.25rem;--space-8: 2rem;--space-7: 1.75rem;--space-6: 1.5rem;--space-5: 1.25rem;--space-4: 1rem;--space-3: 0.75rem;--space-2: 0.5rem;--space-1: 0.25rem;--space-0: 0px;--size-full: 100%;--size-7xl: 80rem;--size-6xl: 72rem;--size-5xl: 64rem;--size-4xl: 56rem;--size-3xl: 48rem;--size-2xl: 42rem;--size-xl: 36rem;--size-lg: 32rem;--size-md: 28rem;--size-sm: 24rem;--size-xs: 20rem;--size-200: 200px;--size-104: 104px;--size-80: 80px;--size-64: 64px;--size-56: 56px;--size-48: 48px;--size-40: 40px;--size-32: 32px;--size-24: 24px;--size-20: 20px;--size-16: 16px;--size-12: 12px;--size-8: 8px;--size-6: 6px;--size-4: 4px;--size-2: 2px;--size-0: 0px;--radii-full: 9999px;--radii-3xl: 1.75rem;--radii-2xl: 1.5rem;--radii-xl: 1rem;--radii-lg: 0.75rem;--radii-md: 0.5rem;--radii-sm: 0.375rem;--radii-xs: 0.25rem;--radii-2xs: 0.125rem;--radii-none: 0px;--shadow-none: 0px 0px 0px 0px transparent;--shadow-lg: 0px 10px 15px -3px #000000, 0px 4px 6px -4px #000000;--shadow-md: 0px 4px 6px -1px #000000, 0px 2px 4px -2px #000000;--shadow-sm: 0px 1px 3px 0px #000000, 0px 1px 2px -1px #000000;--shadow-xs: 0px 1px 2px 0px #000000;--height-screen: 100vh;--width-screen: 100vw;--color-primary-900: #002e38;--color-primary-800: #005c70;--color-primary-700: #008aa9;--color-primary-600: #00b9e1;--color-primary-500: #1ad6ff;--color-primary-400: #40ddff;--color-primary-300: #66e4ff;--color-primary-200: #8deaff;--color-primary-100: #b3f1ff;--color-primary-50: #d9f8ff;--color-ruby-900: #380011;--color-ruby-800: #700021;--color-ruby-700: #a90032;--color-ruby-600: #e10043;--color-ruby-500: #ff1a5e;--color-ruby-400: #ff4079;--color-ruby-300: #ff6694;--color-ruby-200: #ff8dae;--color-ruby-100: #ffb3c9;--color-ruby-50: #ffd9e4;--color-pink-900: #380025;--color-pink-800: #70004b;--color-pink-700: #a90070;--color-pink-600: #e10095;--color-pink-500: #ff1ab2;--color-pink-400: #ff40bf;--color-pink-300: #ff66cc;--color-pink-200: #ff8dd8;--color-pink-100: #ffb3e5;--color-pink-50: #ffd9f2;--color-purple-900: #190038;--color-purple-800: #330070;--color-purple-700: #4c00a9;--color-purple-600: #6500e1;--color-purple-500: #811aff;--color-purple-400: #9640ff;--color-purple-300: #ab66ff;--color-purple-200: #c08dff;--color-purple-100: #d5b3ff;--color-purple-50: #ead9ff;--color-royalblue-900: #0b0531;--color-royalblue-800: #160a62;--color-royalblue-700: #211093;--color-royalblue-600: #2c15c4;--color-royalblue-500: #4127e8;--color-royalblue-400: #614bec;--color-royalblue-300: #806ff0;--color-royalblue-200: #a093f3;--color-royalblue-100: #c0b7f7;--color-royalblue-50: #dfdbfb;--color-indigoblue-900: #001238;--color-indigoblue-800: #002370;--color-indigoblue-700: #0035a9;--color-indigoblue-600: #0047e1;--color-indigoblue-500: #1a62ff;--color-indigoblue-400: #407cff;--color-indigoblue-300: #6696ff;--color-indigoblue-200: #8db0ff;--color-indigoblue-100: #b3cbff;--color-indigoblue-50: #d9e5ff;--color-blue-900: #002438;--color-blue-800: #004870;--color-blue-700: #006ca9;--color-blue-600: #0090e1;--color-blue-500: #1aadff;--color-blue-400: #40bbff;--color-blue-300: #66c8ff;--color-blue-200: #8dd6ff;--color-blue-100: #b3e4ff;--color-blue-50: #d9f1ff;--color-lightblue-900: #002e38;--color-lightblue-800: #005c70;--color-lightblue-700: #008aa9;--color-lightblue-600: #00b9e1;--color-lightblue-500: #1ad6ff;--color-lightblue-400: #40ddff;--color-lightblue-300: #66e4ff;--color-lightblue-200: #8deaff;--color-lightblue-100: #b3f1ff;--color-lightblue-50: #d9f8ff;--color-teal-900: #062a28;--color-teal-800: #0b544f;--color-teal-700: #117d77;--color-teal-600: #16a79e;--color-teal-500: #1cd1c6;--color-teal-400: #36e4da;--color-teal-300: #5fe9e1;--color-teal-200: #87efe9;--color-teal-100: #aff4f0;--color-teal-50: #d7faf8;--color-pear-900: #2a2b09;--color-pear-800: #545512;--color-pear-700: #7e801b;--color-pear-600: #a8aa24;--color-pear-500: #d0d32f;--color-pear-400: #d8da52;--color-pear-300: #e0e274;--color-pear-200: #e8e997;--color-pear-100: #eff0ba;--color-pear-50: #f7f8dc;--color-red-900: #380300;--color-red-800: #700700;--color-red-700: #a90a00;--color-red-600: #e10e00;--color-red-500: #ff281a;--color-red-400: #ff4c40;--color-red-300: #ff7066;--color-red-200: #ff948d;--color-red-100: #ffb7b3;--color-red-50: #ffdbd9;--color-orange-900: #381800;--color-orange-800: #702f00;--color-orange-700: #a94700;--color-orange-600: #e15e00;--color-orange-500: #ff7a1a;--color-orange-400: #ff9040;--color-orange-300: #ffa666;--color-orange-200: #ffbd8d;--color-orange-100: #ffd3b3;--color-orange-50: #ffe9d9;--color-yellow-900: #362b03;--color-yellow-800: #6d5605;--color-yellow-700: #a38108;--color-yellow-600: #daac0a;--color-yellow-500: #f5c828;--color-yellow-400: #f7d14c;--color-yellow-300: #f8da70;--color-yellow-200: #fae393;--color-yellow-100: #fcedb7;--color-yellow-50: #fdf6db;--color-green-900: #003f25;--color-green-800: #005e38;--color-green-700: #007e4a;--color-green-600: #009d5d;--color-green-500: #00bd6f;--color-green-400: #00dc82;--color-green-300: #30ffaa;--color-green-200: #83ffcc;--color-green-100: #acffdd;--color-green-50: #d6ffee;--color-gray-900: #18181B;--color-gray-800: #27272A;--color-gray-700: #3f3f46;--color-gray-600: #52525B;--color-gray-500: #71717A;--color-gray-400: #a1a1aa;--color-gray-300: #D4d4d8;--color-gray-200: #e4e4e7;--color-gray-100: #f4f4f5;--color-gray-50: #fafafa;--color-black: #0c0c0d;--color-white: #FFFFFF;--media-portrait: only screen and (orientation: portrait);--media-landscape: only screen and (orientation: landscape);--media-rm: (prefers-reduced-motion: reduce);--media-2xl: (min-width: 1536px);--media-xl: (min-width: 1280px);--media-lg: (min-width: 1024px);--media-md: (min-width: 768px);--media-sm: (min-width: 640px);--media-xs: (min-width: 475px);--alpine-body-color: var(--color-gray-800);--alpine-body-backgroundColor: var(--color-white);--prose-code-inline-fontWeight: var(--typography-fontWeight-normal);--prose-code-inline-fontSize: var(--typography-fontSize-sm);--prose-code-inline-borderRadius: var(--radii-xs);--prose-code-block-pre-padding: var(--typography-verticalMargin-sm);--prose-code-block-margin: var(--typography-verticalMargin-base) 0;--prose-code-block-fontSize: var(--typography-fontSize-sm);--prose-tbody-code-inline-fontSize: var(--typography-fontSize-sm);--prose-tbody-td-padding: var(--typography-verticalMargin-sm);--prose-th-fontWeight: var(--typography-fontWeight-semibold);--prose-th-padding: 0 var(--typography-verticalMargin-sm) var(--typography-verticalMargin-sm) var(--typography-verticalMargin-sm);--prose-table-lineHeight: var(--typography-lead-6);--prose-table-fontSize: var(--typography-fontSize-sm);--prose-table-margin: var(--typography-verticalMargin-base) 0;--prose-hr-margin: var(--typography-verticalMargin-base) 0;--prose-li-margin: var(--typography-verticalMargin-sm) 0;--prose-ol-margin: var(--typography-verticalMargin-base) 0;--prose-ul-margin: var(--typography-verticalMargin-base) 0;--prose-blockquote-margin: var(--typography-verticalMargin-base) 0;--prose-a-code-border-style: var(--prose-a-border-style-static);--prose-a-code-border-width: var(--prose-a-border-width);--prose-a-fontWeight: var(--typography-fontWeight-medium);--prose-img-margin: var(--typography-verticalMargin-base) 0;--prose-strong-fontWeight: var(--typography-fontWeight-semibold);--prose-h6-iconSize: var(--typography-fontSize-base);--prose-h6-fontWeight: var(--typography-fontWeight-semibold);--prose-h6-lineHeight: var(--typography-lead-normal);--prose-h6-fontSize: var(--typography-fontSize-lg);--prose-h5-iconSize: var(--typography-fontSize-lg);--prose-h5-fontWeight: var(--typography-fontWeight-semibold);--prose-h5-lineHeight: var(--typography-lead-snug);--prose-h5-fontSize: var(--typography-fontSize-xl);--prose-h4-iconSize: var(--typography-fontSize-lg);--prose-h4-letterSpacing: var(--typography-letterSpacing-tight);--prose-h4-fontWeight: var(--typography-fontWeight-semibold);--prose-h4-lineHeight: var(--typography-lead-snug);--prose-h4-fontSize: var(--typography-fontSize-2xl);--prose-h3-iconSize: var(--typography-fontSize-xl);--prose-h3-letterSpacing: var(--typography-letterSpacing-tight);--prose-h3-fontWeight: var(--typography-fontWeight-semibold);--prose-h3-lineHeight: var(--typography-lead-snug);--prose-h3-fontSize: var(--typography-fontSize-3xl);--prose-h2-iconSize: var(--typography-fontSize-2xl);--prose-h2-letterSpacing: var(--typography-letterSpacing-tight);--prose-h2-fontWeight: var(--typography-fontWeight-semibold);--prose-h2-lineHeight: var(--typography-lead-tight);--prose-h2-fontSize: var(--typography-fontSize-4xl);--prose-h1-iconSize: var(--typography-fontSize-3xl);--prose-h1-letterSpacing: var(--typography-letterSpacing-tight);--prose-h1-fontWeight: var(--typography-fontWeight-bold);--prose-h1-lineHeight: var(--typography-lead-tight);--prose-h1-fontSize: var(--typography-fontSize-5xl);--prose-p-br-margin: var(--typography-verticalMargin-base) 0 0 0;--prose-p-margin: var(--typography-verticalMargin-base) 0;--prose-p-lineHeight: var(--typography-lead-normal);--typography-color-primary-900: var(--color-primary-900);--typography-color-primary-800: var(--color-primary-800);--typography-color-primary-700: var(--color-primary-700);--typography-color-primary-600: var(--color-primary-600);--typography-color-primary-500: var(--color-primary-500);--typography-color-primary-400: var(--color-primary-400);--typography-color-primary-300: var(--color-primary-300);--typography-color-primary-200: var(--color-primary-200);--typography-color-primary-100: var(--color-primary-100);--typography-color-primary-50: var(--color-primary-50);--typography-font-code: var(--font-mono);--typography-font-body: var(--font-sans);--typography-font-display: var(--font-sans);--typography-body-backgroundColor: var(--color-white);--typography-body-color: var(--color-black);--elements-state-danger-borderColor-secondary: var(--color-red-200);--elements-state-danger-borderColor-primary: var(--color-red-100);--elements-state-danger-backgroundColor-secondary: var(--color-red-100);--elements-state-danger-backgroundColor-primary: var(--color-red-50);--elements-state-danger-color-secondary: var(--color-red-600);--elements-state-danger-color-primary: var(--color-red-500);--elements-state-warning-borderColor-secondary: var(--color-yellow-200);--elements-state-warning-borderColor-primary: var(--color-yellow-100);--elements-state-warning-backgroundColor-secondary: var(--color-yellow-100);--elements-state-warning-backgroundColor-primary: var(--color-yellow-50);--elements-state-warning-color-secondary: var(--color-yellow-700);--elements-state-warning-color-primary: var(--color-yellow-600);--elements-state-success-borderColor-secondary: var(--color-green-200);--elements-state-success-borderColor-primary: var(--color-green-100);--elements-state-success-backgroundColor-secondary: var(--color-green-100);--elements-state-success-backgroundColor-primary: var(--color-green-50);--elements-state-success-color-secondary: var(--color-green-600);--elements-state-success-color-primary: var(--color-green-500);--elements-state-info-borderColor-secondary: var(--color-blue-200);--elements-state-info-borderColor-primary: var(--color-blue-100);--elements-state-info-backgroundColor-secondary: var(--color-blue-100);--elements-state-info-backgroundColor-primary: var(--color-blue-50);--elements-state-info-color-secondary: var(--color-blue-600);--elements-state-info-color-primary: var(--color-blue-500);--elements-state-primary-borderColor-secondary: var(--color-primary-200);--elements-state-primary-borderColor-primary: var(--color-primary-100);--elements-state-primary-backgroundColor-secondary: var(--color-primary-100);--elements-state-primary-backgroundColor-primary: var(--color-primary-50);--elements-state-primary-color-secondary: var(--color-primary-700);--elements-state-primary-color-primary: var(--color-primary-600);--elements-surface-secondary-backgroundColor: var(--color-gray-200);--elements-surface-primary-backgroundColor: var(--color-gray-100);--elements-surface-background-base: var(--color-gray-100);--elements-border-secondary-static: var(--color-gray-200);--elements-border-primary-hover: var(--color-gray-200);--elements-border-primary-static: var(--color-gray-100);--elements-container-padding-md: var(--space-16);--elements-container-padding-sm: var(--space-12);--elements-container-padding-xs: var(--space-8);--elements-container-padding-mobile: var(--space-6);--elements-text-secondary-color-hover: var(--color-gray-700);--elements-text-secondary-color-static: var(--color-gray-500);--elements-text-primary-color-static: var(--color-gray-900);--text-6xl-lineHeight: var(--lead-none);--text-6xl-fontSize: var(--fontSize-6xl);--text-5xl-lineHeight: var(--lead-none);--text-5xl-fontSize: var(--fontSize-5xl);--text-4xl-lineHeight: var(--lead-10);--text-4xl-fontSize: var(--fontSize-4xl);--text-3xl-lineHeight: var(--lead-9);--text-3xl-fontSize: var(--fontSize-3xl);--text-2xl-lineHeight: var(--lead-8);--text-2xl-fontSize: var(--fontSize-2xl);--text-xl-lineHeight: var(--lead-7);--text-xl-fontSize: var(--fontSize-xl);--text-lg-lineHeight: var(--lead-7);--text-lg-fontSize: var(--fontSize-lg);--text-base-lineHeight: var(--lead-6);--text-base-fontSize: var(--fontSize-base);--text-sm-lineHeight: var(--lead-5);--text-sm-fontSize: var(--fontSize-sm);--text-xs-lineHeight: var(--lead-4);--text-xs-fontSize: var(--fontSize-xs);--shadow-2xl: 0px 25px 50px -12px var(--color-gray-900);--shadow-xl: 0px 20px 25px -5px var(--color-gray-400), 0px 8px 10px -6px #000000;--color-secondary-900: var(--color-gray-900);--color-secondary-800: var(--color-gray-800);--color-secondary-700: var(--color-gray-700);--color-secondary-600: var(--color-gray-600);--color-secondary-500: var(--color-gray-500);--color-secondary-400: var(--color-gray-400);--color-secondary-300: var(--color-gray-300);--color-secondary-200: var(--color-gray-200);--color-secondary-100: var(--color-gray-100);--color-secondary-50: var(--color-gray-50);--prose-a-code-background-hover: var(--typography-color-primary-50);--prose-a-code-border-color-hover: var(--typography-color-primary-500);--prose-a-color-hover: var(--typography-color-primary-500);--typography-color-secondary-900: var(--color-secondary-900);--typography-color-secondary-800: var(--color-secondary-800);--typography-color-secondary-700: var(--color-secondary-700);--typography-color-secondary-600: var(--color-secondary-600);--typography-color-secondary-500: var(--color-secondary-500);--typography-color-secondary-400: var(--color-secondary-400);--typography-color-secondary-300: var(--color-secondary-300);--typography-color-secondary-200: var(--color-secondary-200);--typography-color-secondary-100: var(--color-secondary-100);--typography-color-secondary-50: var(--color-secondary-50);--prose-code-inline-backgroundColor: var(--typography-color-secondary-100);--prose-code-inline-color: var(--typography-color-secondary-700);--prose-code-block-backgroundColor: var(--typography-color-secondary-100);--prose-code-block-color: var(--typography-color-secondary-700);--prose-code-block-border-color: var(--typography-color-secondary-200);--prose-tbody-tr-borderBottom-color: var(--typography-color-secondary-200);--prose-th-color: var(--typography-color-secondary-600);--prose-thead-borderBottom-color: var(--typography-color-secondary-200);--prose-thead-border-color: var(--typography-color-secondary-300);--prose-hr-color: var(--typography-color-secondary-200);--prose-blockquote-border-color: var(--typography-color-secondary-200);--prose-blockquote-color: var(--typography-color-secondary-500);--prose-a-code-border-color-static: var(--typography-color-secondary-400); } }@media { :root.dark {--pinceau-mq: dark; --alpine-backdrop-backgroundColor: #18181bb3;--prose-code-block-backdropFilter: contrast(1);--prose-ol-li-markerColor: currentColor;--prose-ul-li-markerColor: currentColor;--prose-a-code-color-hover: currentColor;--prose-a-code-color-static: currentColor;--prose-a-border-color-hover: currentColor;--prose-a-border-color-static: currentColor;--prose-a-color-static: inherit;--elements-backdrop-background: #0c0d0ccc;--alpine-body-color: var(--color-gray-200);--alpine-body-backgroundColor: var(--color-black);--typography-body-backgroundColor: var(--color-black);--typography-body-color: var(--color-white);--elements-state-danger-borderColor-secondary: var(--color-red-700);--elements-state-danger-borderColor-primary: var(--color-red-800);--elements-state-danger-backgroundColor-secondary: var(--color-red-800);--elements-state-danger-backgroundColor-primary: var(--color-red-900);--elements-state-danger-color-secondary: var(--color-red-200);--elements-state-danger-color-primary: var(--color-red-300);--elements-state-warning-borderColor-secondary: var(--color-yellow-700);--elements-state-warning-borderColor-primary: var(--color-yellow-800);--elements-state-warning-backgroundColor-secondary: var(--color-yellow-800);--elements-state-warning-backgroundColor-primary: var(--color-yellow-900);--elements-state-warning-color-secondary: var(--color-yellow-200);--elements-state-warning-color-primary: var(--color-yellow-400);--elements-state-success-borderColor-secondary: var(--color-green-700);--elements-state-success-borderColor-primary: var(--color-green-800);--elements-state-success-backgroundColor-secondary: var(--color-green-800);--elements-state-success-backgroundColor-primary: var(--color-green-900);--elements-state-success-color-secondary: var(--color-green-200);--elements-state-success-color-primary: var(--color-green-400);--elements-state-info-borderColor-secondary: var(--color-blue-700);--elements-state-info-borderColor-primary: var(--color-blue-800);--elements-state-info-backgroundColor-secondary: var(--color-blue-800);--elements-state-info-backgroundColor-primary: var(--color-blue-900);--elements-state-info-color-secondary: var(--color-blue-200);--elements-state-info-color-primary: var(--color-blue-400);--elements-state-primary-borderColor-secondary: var(--color-primary-700);--elements-state-primary-borderColor-primary: var(--color-primary-800);--elements-state-primary-backgroundColor-secondary: var(--color-primary-800);--elements-state-primary-backgroundColor-primary: var(--color-primary-900);--elements-state-primary-color-secondary: var(--color-primary-200);--elements-state-primary-color-primary: var(--color-primary-400);--elements-surface-secondary-backgroundColor: var(--color-gray-800);--elements-surface-primary-backgroundColor: var(--color-gray-900);--elements-surface-background-base: var(--color-gray-900);--elements-border-secondary-static: var(--color-gray-800);--elements-border-primary-hover: var(--color-gray-800);--elements-border-primary-static: var(--color-gray-900);--elements-text-secondary-color-hover: var(--color-gray-200);--elements-text-secondary-color-static: var(--color-gray-400);--elements-text-primary-color-static: var(--color-gray-50);--prose-a-code-background-hover: var(--typography-color-primary-900);--prose-a-code-border-color-hover: var(--typography-color-primary-600);--prose-a-color-hover: var(--typography-color-primary-400);--prose-code-inline-backgroundColor: var(--typography-color-secondary-800);--prose-code-inline-color: var(--typography-color-secondary-200);--prose-code-block-backgroundColor: var(--typography-color-secondary-900);--prose-code-block-color: var(--typography-color-secondary-200);--prose-code-block-border-color: var(--typography-color-secondary-800);--prose-tbody-tr-borderBottom-color: var(--typography-color-secondary-800);--prose-th-color: var(--typography-color-secondary-400);--prose-thead-borderBottom-color: var(--typography-color-secondary-800);--prose-thead-border-color: var(--typography-color-secondary-600);--prose-hr-color: var(--typography-color-secondary-800);--prose-blockquote-border-color: var(--typography-color-secondary-700);--prose-blockquote-color: var(--typography-color-secondary-400);--prose-a-code-border-color-static: var(--typography-color-secondary-600); } }</style><script>"use strict";(()=>{const a=window,e=document.documentElement,m=["dark","light"],c=window.localStorage.getItem("nuxt-color-mode")||"system";let n=c==="system"?f():c;const l=e.getAttribute("data-color-mode-forced");l&&(n=l),i(n),a["__NUXT_COLOR_MODE__"]={preference:c,value:n,getColorScheme:f,addColorScheme:i,removeColorScheme:d};function i(o){const t=""+o+"",s="";e.classList?e.classList.add(t):e.className+=" "+t,s&&e.setAttribute("data-"+s,o)}function d(o){const t=""+o+"",s="";e.classList?e.classList.remove(t):e.className=e.className.replace(new RegExp(t,"g"),""),s&&e.removeAttribute("data-"+s)}function r(o){return a.matchMedia("(prefers-color-scheme"+o+")")}function f(){if(a.matchMedia&&r("").media!=="not all"){for(const o of m)if(r(":"+o).matches)return o}return"light"}})();
</script></head>
<body ><div id="__nuxt"><div class="container pv-57WdVp pc-mmG8Wh app-layout" data-v-a9d5dfed data-v-77841c0a><!--[--><div class="nuxt-progress" style="width:0%;height:3px;opacity:0;background-size:Infinity% auto;" data-v-a9d5dfed></div><header class="right" data-v-a9d5dfed data-v-0528598b><div class="menu" data-v-0528598b><button aria-label="Navigation Menu" data-v-0528598b><svg width="24" height="24" viewBox="0 0 68 68" fill="currentColor" xmlns="http://www.w3.org/2000/svg" data-v-0528598b><path d="M8 34C8 32.1362 8 31.2044 8.30448 30.4693C8.71046 29.4892 9.48915 28.7105 10.4693 28.3045C11.2044 28 12.1362 28 14 28C15.8638 28 16.7956 28 17.5307 28.3045C18.5108 28.7105 19.2895 29.4892 19.6955 30.4693C20 31.2044 20 32.1362 20 34C20 35.8638 20 36.7956 19.6955 37.5307C19.2895 38.5108 18.5108 39.2895 17.5307 39.6955C16.7956 40 15.8638 40 14 40C12.1362 40 11.2044 40 10.4693 39.6955C9.48915 39.2895 8.71046 38.5108 8.30448 37.5307C8 36.7956 8 35.8638 8 34Z" data-v-0528598b></path><path d="M28 34C28 32.1362 28 31.2044 28.3045 30.4693C28.7105 29.4892 29.4892 28.7105 30.4693 28.3045C31.2044 28 32.1362 28 34 28C35.8638 28 36.7956 28 37.5307 28.3045C38.5108 28.7105 39.2895 29.4892 39.6955 30.4693C40 31.2044 40 32.1362 40 34C40 35.8638 40 36.7956 39.6955 37.5307C39.2895 38.5108 38.5108 39.2895 37.5307 39.6955C36.7956 40 35.8638 40 34 40C32.1362 40 31.2044 40 30.4693 39.6955C29.4892 39.2895 28.7105 38.5108 28.3045 37.5307C28 36.7956 28 35.8638 28 34Z" data-v-0528598b></path><path d="M48 34C48 32.1362 48 31.2044 48.3045 30.4693C48.7105 29.4892 49.4892 28.7105 50.4693 28.3045C51.2044 28 52.1362 28 54 28C55.8638 28 56.7956 28 57.5307 28.3045C58.5108 28.7105 59.2895 29.4892 59.6955 30.4693C60 31.2044 60 32.1362 60 34C60 35.8638 60 36.7956 59.6955 37.5307C59.2895 38.5108 58.5108 39.2895 57.5307 39.6955C56.7956 40 55.8638 40 54 40C52.1362 40 51.2044 40 50.4693 39.6955C49.4892 39.2895 48.7105 38.5108 48.3045 37.5307C48 36.7956 48 35.8638 48 34Z" data-v-0528598b></path></svg></button></div><div class="overlay" data-v-0528598b><nav data-v-0528598b data-v-f1645879><ul data-v-f1645879><!--[--><li data-v-f1645879><a href="/" class="" data-v-f1645879><span class="underline-fx" data-v-f1645879></span> Home</a></li><li data-v-f1645879><a href="/contact" class="" data-v-f1645879><span class="underline-fx" data-v-f1645879></span> Contact</a></li><li data-v-f1645879><a href="/posts" class="" data-v-f1645879><span class="underline-fx" data-v-f1645879></span> Archive</a></li><!--]--></ul></nav></div><div class="logo" data-v-0528598b><a href="/" class="" data-v-0528598b><img src="/logo-dark.svg" class="dark-img" alt="alpine" width="89" height="31" data-v-0528598b><img src="/logo.svg" class="light-img" alt="alpine" width="89" height="31" data-v-0528598b></a></div><div class="main-nav" data-v-0528598b><nav data-v-0528598b data-v-f1645879><ul data-v-f1645879><!--[--><li data-v-f1645879><a href="/" class="" data-v-f1645879><span class="underline-fx" data-v-f1645879></span> Home</a></li><li data-v-f1645879><a href="/contact" class="" data-v-f1645879><span class="underline-fx" data-v-f1645879></span> Contact</a></li><li data-v-f1645879><a href="/posts" class="" data-v-f1645879><span class="underline-fx" data-v-f1645879></span> Archive</a></li><!--]--></ul></nav></div></header><!--[--><div class="document-driven-page"><main><!--[--><div><h2 id="running-scrapy-in-aws-lambda" data-v-6d609909><a aria-current="page" href="/posts/scrapy-fargate-sls-guide#running-scrapy-in-aws-lambda" class="router-link-active router-link-exact-active" data-v-6d609909><!--[-->Running Scrapy in AWS Lambda<!--]--><!----></a></h2><p data-v-f4c85dbd><!--[-->We will be using the <a href="https://serverless.com/" rel="nofollow" data-v-d83694f9><!--[-->Serverless framework<!--]--></a> in this tutorial, as it&#39;s a good and extendable open-source framework that does much of the gruntwork of serverless applications. <a href="https://scrapy.org/" rel="nofollow" data-v-d83694f9><!--[-->Scrapy<!--]--></a> is a Python framework, also leading and open-source, with all the benefits that come from using a mature framework. Since only <a href="https://aws.amazon.com/" rel="nofollow" data-v-d83694f9><!--[-->Amazon Web Services<!--]--></a> (AWS) of the major cloud platforms support Python in serverless functions, it&#39;s a natural choice that can&#39;t go wrong since AWS has solutions for just about everything.<!--]--></p><p data-v-f4c85dbd><!--[-->The code used in this guide can be found on <a href="https://github.com/viktorfa/scrapy-fargate-sls-guide" rel="nofollow" data-v-d83694f9><!--[-->github.com/viktorfa/scrapy-fargate-sls-guide<!--]--></a>.<!--]--></p><h3 id="requirements" data-v-4af47174><a aria-current="page" href="/posts/scrapy-fargate-sls-guide#requirements" class="router-link-active router-link-exact-active" data-v-4af47174><!--[-->Requirements<!--]--><!----></a></h3><p data-v-f4c85dbd><!--[-->It&#39;s assumed that the reader is somewhat familiar with Scrapy and has the ability to work with the command line. Several programs need to be installed to complete this guide. An AWS account with billing enabled is necessary (although the resulting bill from completing the guide is in order of single digit cents).<!--]--></p><p data-v-f4c85dbd><!--[-->Command line tools used:<!--]--></p><ul data-v-b9ad2675><!--[--><li data-v-3181147b><!--[-->virtualenv*<!--]--></li><li data-v-3181147b><!--[-->git*<!--]--></li><li data-v-3181147b><!--[-->npm<!--]--></li><li data-v-3181147b><!--[-->pip<!--]--></li><li data-v-3181147b><!--[-->make<!--]--></li><li data-v-3181147b><!--[-->docker<!--]--></li><li data-v-3181147b><!--[-->aws<!--]--></li><!--]--></ul><p data-v-f4c85dbd><!--[-->* recommended, but not necessary<!--]--></p><h3 id="result" data-v-4af47174><a aria-current="page" href="/posts/scrapy-fargate-sls-guide#result" class="router-link-active router-link-exact-active" data-v-4af47174><!--[-->Result<!--]--><!----></a></h3><p data-v-f4c85dbd><!--[-->Completing this guide will result with the basics of a scalable and maintainable scraper infrastructure following the <em data-v-4353b993><!--[-->serverless<!--]--></em> paradigm with all its advantages such as low initial cost and infrastructure as code deployment. The resulting artifact will be extended in a similar fashion with a data processing pipeline in future guides.<!--]--></p><h2 id="setting-up-a-crawler" data-v-6d609909><a aria-current="page" href="/posts/scrapy-fargate-sls-guide#setting-up-a-crawler" class="router-link-active router-link-exact-active" data-v-6d609909><!--[-->Setting up a crawler<!--]--><!----></a></h2><p data-v-f4c85dbd><!--[-->We start by making a simple Scrapy crawler that can run from a script locally, and move thinfs gradually from there.<!--]--></p><h3 id="creating-the-scraper" data-v-4af47174><a aria-current="page" href="/posts/scrapy-fargate-sls-guide#creating-the-scraper" class="router-link-active router-link-exact-active" data-v-4af47174><!--[-->Creating the scraper<!--]--><!----></a></h3><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">python</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -v</span><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"> # Should have python3.7
</span></span><span class="line" line="2"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">pip</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> install</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> Scrapy
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">mkdir</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> scrapy-serverless</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8"> &amp;&amp; </span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF">cd</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> $_
</span></span><span class="line" line="2"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">scrapy</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> startproject</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> my_sls_scraper</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> scraper
</span></span><span class="line" line="3"><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF">cd</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> scraper
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->All the code of this guide will be in the <code class="" data-v-69006e27><!--[-->scrapy-serverless/scraper<!--]--></code> folder, but other modules will be added in the <code class="" data-v-69006e27><!--[-->scrapy-serverless<!--]--></code> folder in future guides.<!--]--></p><p data-v-f4c85dbd><!--[-->We will use the default Scrapy project structure. Create a simple spider in the <code class="" data-v-69006e27><!--[-->spiders<!--]--></code> module.<!--]--></p><div class="highlight-python prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-python" style=""><!--[--><code># my_sls_scraper/spiders/header_spider.py
from scrapy.spiders import CrawlSpider, Rule
from scrapy.linkextractors import LinkExtractor


class HeaderSpider(CrawlSpider):
    name = &quot;header_spider&quot;

    start_urls = [&quot;https://scrapy.org&quot;]
    allowed_domains = [&quot;scrapy.org&quot;]
    rules = [  # Get all links on start url
        Rule(
            link_extractor=LinkExtractor(
                deny=r&quot;\?&quot;,
            ),
            follow=False,
            callback=&quot;parse_page&quot;,
        )
    ]

    def parse_start_url(self, response):
        return self.parse_page(response)

    def parse_page(self, response):
        header = response.css(&quot;h1, h2&quot;).extract_first(
        ) or response.css(&quot;title&quot;).extract_first() or response.url
        return {
            &quot;header&quot;: remove_tags(header),
            &quot;url&quot;: response.url,
        }
</code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->Also add the following to the settings in <code class="" data-v-69006e27><!--[-->my_sls_scraper/settings.py<!--]--></code><!--]--></p><div class="highlight-python prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-python" style=""><!--[--><code># my_sls_scraper/settings.py
# ...
HTTPCACHE_ENABLED = True
HTTPCACHE_EXPIRATION_SECS = 60 * 60 * 24 * 7
HTTPCACHE_DIR = &#39;httpcache&#39;
CLOSESPIDER_PAGECOUNT = 32
</code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->Test that the spider is working by running the crawler and printing the output<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">scrapy</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> crawl</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> header_spider</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> --output</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> &quot;feed/%(name)s-%(time)s.json&quot;</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> --output-format</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> json
</span></span><span class="line" line="2"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">cat</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> feed/$(</span><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">ls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> feed </span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF">-q</span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583"> |</span><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0"> tail</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -1</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">)
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->You should see a json feed in <code class="" data-v-69006e27><!--[-->feed/header_spider-&lt;time string&gt;.json<!--]--></code> with the scraped data.<!--]--></p><p data-v-f4c85dbd><!--[-->Next, we create files to launch the scraper from a script, which will be needed in Lambda and Fargate. We&#39;ll create 2 new files to make this work in different scenarios, <code class="" data-v-69006e27><!--[-->launcher.py<!--]--></code> and <code class="" data-v-69006e27><!--[-->my_sls_scraper/crawl.py<!--]--></code>.<!--]--></p><div class="highlight-python prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-python" style=""><!--[--><code># my_sls_scraper/crawl.py
import sys
import imp
import os
import logging
from urllib.parse import urlparse

from scrapy.spiderloader import SpiderLoader
from scrapy.crawler import CrawlerProcess
from scrapy.utils.project import get_project_settings

# Need to &quot;mock&quot; sqlite for the process to not crash in AWS Lambda / Amazon Linux
sys.modules[&quot;sqlite&quot;] = imp.new_module(&quot;sqlite&quot;)
sys.modules[&quot;sqlite3.dbapi2&quot;] = imp.new_module(&quot;sqlite.dbapi2&quot;)


def is_in_aws():
    return os.getenv(&#39;AWS_EXECUTION_ENV&#39;) is not None


def crawl(settings={}, spider_name=&quot;header_spider&quot;, spider_kwargs={}):
    project_settings = get_project_settings()
    spider_loader = SpiderLoader(project_settings)

    spider_cls = spider_loader.load(spider_name)

    feed_uri = &quot;&quot;
    feed_format = &quot;json&quot;

    try:
        spider_key = urlparse(spider_kwargs.get(&quot;start_urls&quot;)[0]).hostname if spider_kwargs.get(
            &quot;start_urls&quot;) else urlparse(spider_cls.start_urls[0]).hostname
    except Exception:
        logging.exception(&quot;Spider or kwargs need start_urls.&quot;)

    if is_in_aws():
        # Lambda can only write to the /tmp folder.
        settings[&#39;HTTPCACHE_DIR&#39;] =  &quot;/tmp&quot;
    else:
        feed_uri = &quot;file://{}/%(name)s-{}-%(time)s.json&quot;.format(
            os.path.join(os.getcwd(), &quot;feed&quot;),
            spider_key,
        )

    settings[&#39;FEED_URI&#39;] = feed_uri
    settings[&#39;FEED_FORMAT&#39;] = feed_format

    process = CrawlerProcess({**project_settings, **settings})

    process.crawl(spider_cls, **spider_kwargs)
    process.start()
</code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><div class="highlight-python prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-python" style=""><!--[--><code># launcher.py&#39;
import sys
import json

from my_sls_scraper.crawl import crawl


def scrape(event={}, context={}):
    crawl(**event)


if __name__ == &quot;__main__&quot;:
    try:
        event = json.loads(sys.argv[1])
    except IndexError:
        event = {}
    scrape(event)
</code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->Check that you can scrape by executing <code class="" data-v-69006e27><!--[-->launcher.py<!--]--></code> with<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">python</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> launcher.py
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->If that works, the scraper is pretty much done, and we&#39;ll spend the rest of the guide on AWS and Serverless stuff.<!--]--></p><h2 id="setting-up-an-aws-lambda-function" data-v-6d609909><a aria-current="page" href="/posts/scrapy-fargate-sls-guide#setting-up-an-aws-lambda-function" class="router-link-active router-link-exact-active" data-v-6d609909><!--[-->Setting up an AWS Lambda function<!--]--><!----></a></h2><p data-v-f4c85dbd><!--[-->Initialize serverless in the same directory as <code class="" data-v-69006e27><!--[-->scrapy.cfg<!--]--></code> with<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">serverless</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> create</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> --template</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> aws-python3</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> --name</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> my-sls-scraper
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->You need to have an AWS account and created an IAM admin user to work with Serverless. If you haven&#39;t follow the steps on <a href="https://serverless.com/framework/docs/providers/aws/guide/credentials/" rel="nofollow" data-v-d83694f9><!--[-->this guide<!--]--></a> to get started. I like using aws profiles where you store the credentials in <code class="" data-v-69006e27><!--[-->~/.aws/credentials<!--]--></code>, but see the link for what works best for you.<!--]--></p><p data-v-f4c85dbd><!--[-->If you&#39;re not familiar with AWS and Serverless, you will run into many weird issues that are hard to debug. To mitigate that, deploy the function for every change you make in the configuration of Serverless and the scraper to make it easier to identify what causes things to break.<!--]--></p><p data-v-f4c85dbd><!--[-->We&#39;ll start by deploying the dummy default Lambda function. Do it with<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> deploy</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -f</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> hello
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->If you use aws profiles for credentials and you have a profile called <code class="" data-v-69006e27><!--[-->my-sls-admin<!--]--></code>, you can deploy with<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> deploy</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -f</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> hello</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> --aws-profile</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> my-sls-admin
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->or add the profile key under provider in <code class="" data-v-69006e27><!--[-->serverless.yml<!--]--></code>.<!--]--></p><div class="highlight-yaml prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-yaml shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># serverless.yml
</span></span><span class="line" line="2"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># ...
</span></span><span class="line" line="3"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">provider</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="4"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  name</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">aws
</span></span><span class="line" line="5"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">runtime</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">python3.7
</span></span><span class="line" line="6"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">profile</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">my-sls-admin
</span></span><span class="line" line="7"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># ...
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->When deploying, the output should be similar to<!--]--></p><div class="highlight-null prose-code" data-v-ef0b30fc><!----><!--[--><pre class="" style=""><!--[--><code>11:40 $ sls deploy
Serverless: Packaging service...
Serverless: Excluding development dependencies...
Serverless: Creating Stack...
Serverless: Checking Stack create progress...
.....
Serverless: Stack create finished...
Serverless: Uploading CloudFormation file to S3...
Serverless: Uploading artifacts...
Serverless: Uploading service my-sls-scraper.zip file to S3 (162.74 KB)...
Serverless: Validating template...
Serverless: Updating Stack...
Serverless: Checking Stack update progress...
...............
Serverless: Stack update finished...
Service Information
service: my-sls-scraper
stage: dev
region: us-east-1
stack: my-sls-scraper-dev
resources: 5
api keys:
  None
endpoints:
  None
functions:
  hello: my-sls-scraper-dev-hello
layers:
  None
Serverless: Run the &quot;serverless&quot; command to setup monitoring, troubleshooting and testing.
</code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->You should now see the deployed function in the <a href="https://console.aws.amazon.com/lambda/home" rel="nofollow" data-v-d83694f9><!--[-->AWS Lambda web console<!--]--></a>. (Change your region if you don&#39;t see it!)<!--]--></p><p data-v-f4c85dbd><!--[-->Verify that the function can be invoked and see its output with<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> invoke</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -f</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> hello</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> --log
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->The output should be something like<!--]--></p><div class="highlight-null prose-code" data-v-ef0b30fc><!----><!--[--><pre class="" style=""><!--[--><code>12:12 $ sls invoke -f hello --log
{
    &quot;statusCode&quot;: 200,
    &quot;body&quot;: &quot;{\&quot;message\&quot;: \&quot;Go Serverless v1.0! Your function executed successfully!\&quot;, \&quot;input\&quot;: {}}&quot;
}
--------------------------------------------------------------------
START RequestId: f38a0d84-e974-4a00-93ab-9e2825d94003 Version: $LATEST
END RequestId: f38a0d84-e974-4a00-93ab-9e2825d94003
REPORT RequestId: f38a0d84-e974-4a00-93ab-9e2825d94003  Duration: 1.62 ms   Billed Duration: 100 ms Memory Size: 1024 MB    Max Memory Used: 56 MB  Init Duration: 110.34 ms

XRAY TraceId: 1-5d723275-c57192d30e2a524902b401fd   SegmentId: 5cc7e2685a1e85bc Sampled: false
</code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->Now we&#39;ll need to package the function in a way that includes all the dependencies. Install the <code class="" data-v-69006e27><!--[-->serverless-python-requirements<!--]--></code> plugin with<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> plugin</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> install</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> --name</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> serverless-python-requirements
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->And rehaul <code class="" data-v-69006e27><!--[-->serverless.yml<!--]--></code>.<!--]--></p><div class="highlight-yaml prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-yaml shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># serverless.yml
</span></span><span class="line" line="2"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">service</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">my-sls-scraper
</span></span><span class="line" line="3"><span emptylineplaceholder="true">
</span></span><span class="line" line="4"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">provider</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="5"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  name</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">aws
</span></span><span class="line" line="6"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  runtime</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">python3.7
</span></span><span class="line" line="7"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  logRetentionInDays</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF">1
</span></span><span class="line" line="8"><span emptylineplaceholder="true">
</span></span><span class="line" line="9"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">functions</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="10"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  hello</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="11"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    handler</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">handler.hello
</span></span><span class="line" line="12"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  lambdaScrape</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="13"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    handler</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">launcher.scrape
</span></span><span class="line" line="14"><span emptylineplaceholder="true">
</span></span><span class="line" line="15"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># We include files by whitelisting to reduce the deployment time.
</span></span><span class="line" line="16"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># Just remember to add any files you create!
</span></span><span class="line" line="17"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">package</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="18"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  include</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="19"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">    - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">handler.py
</span></span><span class="line" line="20"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">    - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">launcher.py
</span></span><span class="line" line="21"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">    - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">my_sls_scraper/**
</span></span><span class="line" line="22"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">    - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">scrapy.cfg
</span></span><span class="line" line="23"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  exclude</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="24"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">    - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;./**&quot;
</span></span><span class="line" line="25"><span emptylineplaceholder="true">
</span></span><span class="line" line="26"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">plugins</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="27"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">  - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">serverless-python-requirements
</span></span><span class="line" line="28"><span emptylineplaceholder="true">
</span></span><span class="line" line="29"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">custom</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="30"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  pythonRequirements</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="31"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    slim</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF">true</span><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"> # Omits tests, __pycache__, *.pyc etc from dependencies
</span></span><span class="line" line="32"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    fileName</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">requirements.txt
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->Note that we added a new function <code class="" data-v-69006e27><!--[-->lambdaScrape<!--]--></code> that does the scraping in the Lambda function.<!--]--></p><p data-v-f4c85dbd><!--[-->We also need a minimal <code class="" data-v-69006e27><!--[-->requirements.txt<!--]--></code> for pip requirements.<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># requirements.txt
</span></span><span class="line" line="2"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">Scrapy</span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">=</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF">1.7</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">.3
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->Try to deploy the function again and see that it works.<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> deploy</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> --verbose
</span></span><span class="line" line="2"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> invoke</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -f</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> hello</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> --log
</span></span><span class="line" line="3"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> invoke</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -f</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> lambdaScrape</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> --log
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->We&#39;ve now created the minimal solution for serverless scraping – well done! In the rest of the guide we&#39;ll set up more resources in the AWS platform to store the scraped data and run long crawls in Fargate instead of Lambda.<!--]--></p><h2 id="storing-scraped-data-in-s3" data-v-6d609909><a aria-current="page" href="/posts/scrapy-fargate-sls-guide#storing-scraped-data-in-s3" class="router-link-active router-link-exact-active" data-v-6d609909><!--[-->Storing scraped data in S3<!--]--><!----></a></h2><p data-v-f4c85dbd><!--[-->Storing the scraped data in S3 gives us a low-cost repository for spider outputs which can be used to further process the data. We will use the config in <code class="" data-v-69006e27><!--[-->serverless.yml<!--]--></code> and CloudFormation templates to create and use resources in the AWS ecosystem, so that we follow the <em data-v-4353b993><!--[-->infrastructure as code<!--]--></em> paradigm.<!--]--></p><p data-v-f4c85dbd><!--[-->Before we continue, let&#39;s install a useful plugin that lets us use <code class="" data-v-69006e27><!--[-->!Sub<!--]--></code> commands in out templates called <code class="" data-v-69006e27><!--[-->serverless-cloudformation-sub-variables<!--]--></code> and add it to our <code class="" data-v-69006e27><!--[-->serverless.yml<!--]--></code> with<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> plugin</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> install</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> --name</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> serverless-cloudformation-sub-variables
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->Let&#39;s create the templates in a separate file called <code class="" data-v-69006e27><!--[-->s3-template.yml<!--]--></code> as the template will get quite large later.<!--]--></p><div class="highlight-yaml prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-yaml shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># s3-template.yml
</span></span><span class="line" line="2"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Resources</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="3"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  ScraperFeedBucket</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="4"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">AWS::S3::Bucket
</span></span><span class="line" line="5"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Properties</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="6"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      VersioningConfiguration</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="7"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">        Status</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;Enabled&quot;
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->We have to set up permissions in <code class="" data-v-69006e27><!--[-->serverless.yml<!--]--></code>, import the template file, and pass the bucket name in an environment variable to our Lambda function.
Add the following IAM role statement and environment variable<!--]--></p><div class="highlight-yaml prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-yaml shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># serverless.yml
</span></span><span class="line" line="2"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">provider</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="3"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D">    # ...
</span></span><span class="line" line="4"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    environment</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="5"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">        FEED_BUCKET_NAME</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> ScraperFeedBucket
</span></span><span class="line" line="6"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    iamRoleStatements</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="7"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Effect</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;Allow&quot;
</span></span><span class="line" line="8"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">          Action</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="9"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">            - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;s3:PutObject&quot;
</span></span><span class="line" line="10"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">          Resource</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Sub
</span></span><span class="line" line="11"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">            - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;arn:aws:s3:::#{BucketName}/*&quot;
</span></span><span class="line" line="12"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">            - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">BucketName</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> ScraperFeedBucket
</span></span><span class="line" line="13"><span emptylineplaceholder="true">
</span></span><span class="line" line="14"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">resources</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="15"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">  - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">AWSTemplateFormatVersion</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;2010-09-09&quot;
</span></span><span class="line" line="16"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Transform</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;AWS::Serverless-2016-10-31&quot;
</span></span><span class="line" line="17"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">  - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">${file(./s3-template.yml)}
</span></span><span class="line" line="18"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># ...
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->You can check that your configuration doesn&#39;t contain syntax errors with<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> package
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->but the only way to check that your CloudFormation templates are valid on your current stack is to deploy it.
Before deploying, let&#39;s configure the crawler to store the output in S3.<!--]--></p><div class="highlight-python prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-python" style=""><!--[--><code># my_sls_scraper/crawl.py
def  crawl(settings={}, spider_name=&quot;header_spider&quot;, spider_kwargs={}):
    # ...
    if is_in_aws():
        # Lambda can only write to the /tmp folder.
        settings[&#39;HTTPCACHE_DIR&#39;] = &quot;/tmp&quot;
        feed_uri = f&quot;s3://{os.getenv(&#39;FEED_BUCKET_NAME&#39;)}/%(name)s-{spider_key}.json&quot;
    # ...
</code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->Scrapy uses the AWS library <code class="" data-v-69006e27><!--[-->boto3<!--]--></code> under the hood to store to S3. Inside a Lambda function, boto3 is always available, and credentials are automatically discovered. It will work as long as the IAM Role Statements we configured for the Lambda function are correct.
We don&#39;t need to timestamp the file name in S3 with <code class="" data-v-69006e27><!--[-->%(time)s<!--]--></code>, as we configured the bucket to use versioning in our CloudFormation template, which enables us to access old spider outputs by looking at the file history.<!--]--></p><p data-v-f4c85dbd><!--[-->Now, deploy the function and crawl again.<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> deploy</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -v
</span></span><span class="line" line="2"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> invoke</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -f</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> lambdaScrape</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> --log
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->You should now find the feed output in a file if you check your <a href="https://s3.console.aws.amazon.com/s3/home" rel="nofollow" data-v-d83694f9><!--[-->S3 console<!--]--></a>. You should also see some new info has appeared for your function in the <a href="https://console.aws.amazon.com/lambda/home" rel="nofollow" data-v-d83694f9><!--[-->Lambda console<!--]--></a>, like the environment variable and the S3 resource.
While it&#39;s absolutely recommended to set up all resources in CloudFormation templates or other infrastructure as code frameworks, the AWS console web interface is very useful for debugging and inspection.<!--]--></p><h2 id="running-scrapy-in-aws-fargate" data-v-6d609909><a aria-current="page" href="/posts/scrapy-fargate-sls-guide#running-scrapy-in-aws-fargate" class="router-link-active router-link-exact-active" data-v-6d609909><!--[-->Running Scrapy in AWS Fargate<!--]--><!----></a></h2><p data-v-f4c85dbd><!--[-->We now have a crawler that can be run from a script and uses S3 to store its output. We can run it in AWS Lambda, but we are constrained by the 15 minute execution limit.
Lambda is simply not made for long-lasting tasks, but it is possible to run long-lasting crawlers in the serverless paradigm by <em data-v-4353b993><!--[-->containerizing<!--]--></em> our crawler and running it as a task in a managed container service such as AWS Fargate. This means we need to create a <a href="https://www.docker.com/" rel="nofollow" data-v-d83694f9><!--[-->Docker<!--]--></a> image of our crawler, uploading the image to an image repository – we&#39;ll use Amazon Container Registry (ACR), and execute the image in a container as a task in Amazon Container Services (ECS).
I&#39;m dropping a lot of acronyms, and you&#39;ll see even more later. Running containers on AWS may be serverless, but it requires a lot of configuration at the moment.<!--]--></p><h3 id="dockerize-it" data-v-4af47174><a aria-current="page" href="/posts/scrapy-fargate-sls-guide#dockerize-it" class="router-link-active router-link-exact-active" data-v-4af47174><!--[-->Dockerize it<!--]--><!----></a></h3><p data-v-f4c85dbd><!--[-->If you have Docker installed, this is the easy part. Let&#39;s create a <code class="" data-v-69006e27><!--[-->Dockerfile<!--]--></code> to containerize our crawler.<!--]--></p><div class="highlight-docker prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-docker" style=""><!--[--><code>FROM python:3.7

WORKDIR /usr/src/app

COPY scrapy.cfg ./
COPY launcher.py ./
COPY my_sls_scraper ./my_sls_scraper
COPY requirements.txt ./

RUN pip install boto3 --quiet
RUN pip install -r requirements.txt --quiet

CMD [&quot;python3&quot;, &quot;./launcher.py&quot;]
</code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->The docker file is the recipe to put our scraper in an image. Create it and put a tag on it with<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">docker</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> build</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -t</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> my_sls_scraper:latest</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> .
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->You should see an output similar to<!--]--></p><div class="highlight-null prose-code" data-v-ef0b30fc><!----><!--[--><pre class="" style=""><!--[--><code>16:55 $ docker build -t my_sls_scraper:latest .
Sending build context to Docker daemon  15.62MB
Step 1/9 : FROM python:3.7
 ---&gt; 60e318e4984a
Step 2/9 : WORKDIR /usr/src/app
 ---&gt; Using cache
 ---&gt; 0277144c85a9
Step 3/9 : COPY scrapy.cfg ./
 ---&gt; c72f2df3b4d7
Removing intermediate container 80cf0e765353
Step 4/9 : COPY launcher.py ./
 ---&gt; 58e18d409bf5
Removing intermediate container f0726603d5fa
Step 5/9 : COPY my_sls_scraper ./my_sls_scraper
 ---&gt; 2be7fc4a06bb
Removing intermediate container aae59bff188d
Step 6/9 : COPY requirements.txt ./
 ---&gt; 7dbf261f3ade
Removing intermediate container 76033ce2ffe6
Step 7/9 : RUN pip install boto3 --quiet
 ---&gt; Running in 55455a2a4415
 ---&gt; efdc47a54e36
Removing intermediate container 55455a2a4415
Step 8/9 : RUN pip install -r requirements.txt --quiet
 ---&gt; Running in e15817fd1a01
 ---&gt; 84015af5a4ee
Removing intermediate container e15817fd1a01
Step 9/9 : CMD python3 ./launcher.py
 ---&gt; Running in 9c6fe75eb923
 ---&gt; 05a841f9ec00
Removing intermediate container 9c6fe75eb923
Successfully built 05a841f9ec00
Successfully tagged my_sls_scraper:latest
</code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->Now, let&#39;s check that the image works by running it in a container on our machine with<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">docker</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> run</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> my_sls_scraper
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->The crawler should run just like it has before except that the crawl output json file will be stored somewhere inside the Docker container, so you cannot see it.<!--]--></p><h3 id="configure-fargate-on-aws" data-v-4af47174><a aria-current="page" href="/posts/scrapy-fargate-sls-guide#configure-fargate-on-aws" class="router-link-active router-link-exact-active" data-v-4af47174><!--[-->Configure Fargate on AWS<!--]--><!----></a></h3><p data-v-f4c85dbd><!--[-->Let&#39;s see how a complete CloudFormation template for our purpose looks like.<!--]--></p><div class="highlight-yaml prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-yaml shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># fargate-template.yml
</span></span><span class="line" line="2"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Resources</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="3"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  FargateECSCluster</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="4"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;AWS::ECS::Cluster&quot;
</span></span><span class="line" line="5"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Properties</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="6"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      ClusterName</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Sub
</span></span><span class="line" line="7"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;fargate-#{StackName}&quot;
</span></span><span class="line" line="8"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">StackName</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> &quot;AWS::StackName&quot;
</span></span><span class="line" line="9"><span emptylineplaceholder="true">
</span></span><span class="line" line="10"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  FargateLogGroup</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="11"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;AWS::Logs::LogGroup&quot;
</span></span><span class="line" line="12"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Properties</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="13"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      RetentionInDays</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF">1
</span></span><span class="line" line="14"><span emptylineplaceholder="true">
</span></span><span class="line" line="15"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  FargateTaskRole</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="16"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">AWS::IAM::Role
</span></span><span class="line" line="17"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Properties</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="18"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      AssumeRolePolicyDocument</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="19"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">        Version</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;2012-10-17&quot;
</span></span><span class="line" line="20"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">        Statement</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="21"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">          - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Effect</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">Allow
</span></span><span class="line" line="22"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">            Sid</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;ECS&quot;
</span></span><span class="line" line="23"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">            Principal</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="24"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">              Service</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="25"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">                - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">ecs-tasks.amazonaws.com
</span></span><span class="line" line="26"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">            Action</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="27"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">              - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">sts:AssumeRole
</span></span><span class="line" line="28"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      Policies</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="29"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">PolicyName</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">ScraperFeedBucketPolicy
</span></span><span class="line" line="30"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">          PolicyDocument</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="31"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">            Statement</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="32"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">              - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Effect</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;Allow&quot;
</span></span><span class="line" line="33"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">                Action</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="34"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">                  - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;s3:PutObject&quot;
</span></span><span class="line" line="35"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">                Resource</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Sub
</span></span><span class="line" line="36"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">                  - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;arn:aws:s3:::#{BucketName}/*&quot;
</span></span><span class="line" line="37"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">                  - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">BucketName</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> ScraperFeedBucket
</span></span><span class="line" line="38"><span emptylineplaceholder="true">
</span></span><span class="line" line="39"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  FargateExecutionRole</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="40"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">AWS::IAM::Role
</span></span><span class="line" line="41"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Properties</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="42"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      ManagedPolicyArns</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="43"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
</span></span><span class="line" line="44"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      AssumeRolePolicyDocument</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="45"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">        Version</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;2012-10-17&quot;
</span></span><span class="line" line="46"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">        Statement</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="47"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">          - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Effect</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">Allow
</span></span><span class="line" line="48"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">            Sid</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;ECS&quot;
</span></span><span class="line" line="49"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">            Principal</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="50"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">              Service</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="51"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">                - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">ecs-tasks.amazonaws.com
</span></span><span class="line" line="52"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">            Action</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="53"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">              - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">sts:AssumeRole
</span></span><span class="line" line="54"><span emptylineplaceholder="true">
</span></span><span class="line" line="55"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  FargateVPC</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="56"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;AWS::EC2::VPC&quot;
</span></span><span class="line" line="57"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Properties</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="58"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      CidrBlock</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">10.10.10.0/24
</span></span><span class="line" line="59"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      Tags</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="60"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Key</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">Name
</span></span><span class="line" line="61"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">          Value</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> &quot;AWS::StackName&quot;
</span></span><span class="line" line="62"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  FargateSubnet</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="63"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;AWS::EC2::Subnet&quot;
</span></span><span class="line" line="64"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Properties</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="65"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      CidrBlock</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">10.10.10.0/24
</span></span><span class="line" line="66"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      VpcId</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateVPC
</span></span><span class="line" line="67"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      Tags</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="68"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Key</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">Name
</span></span><span class="line" line="69"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">          Value</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> &quot;AWS::StackName&quot;
</span></span><span class="line" line="70"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  FargateIGW</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="71"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;AWS::EC2::InternetGateway&quot;
</span></span><span class="line" line="72"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Properties</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="73"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      Tags</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="74"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Key</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">Name
</span></span><span class="line" line="75"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">          Value</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> &quot;AWS::StackName&quot;
</span></span><span class="line" line="76"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  FargateAttachGateway</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="77"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">AWS::EC2::VPCGatewayAttachment
</span></span><span class="line" line="78"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Properties</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="79"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      VpcId</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateVPC
</span></span><span class="line" line="80"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      InternetGatewayId</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateIGW
</span></span><span class="line" line="81"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  FargateRouteTable</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="82"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;AWS::EC2::RouteTable&quot;
</span></span><span class="line" line="83"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Properties</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="84"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      VpcId</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateVPC
</span></span><span class="line" line="85"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      Tags</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="86"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Key</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">Name
</span></span><span class="line" line="87"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">          Value</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> &quot;AWS::StackName&quot;
</span></span><span class="line" line="88"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  FargateRoute</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="89"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;AWS::EC2::Route&quot;
</span></span><span class="line" line="90"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    DependsOn</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">FargateAttachGateway
</span></span><span class="line" line="91"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Properties</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="92"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      RouteTableId</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateRouteTable
</span></span><span class="line" line="93"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      DestinationCidrBlock</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">0.0.0.0/0
</span></span><span class="line" line="94"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      GatewayId</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateIGW
</span></span><span class="line" line="95"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  FargateSubnetRouteTableAssociation</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="96"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">AWS::EC2::SubnetRouteTableAssociation
</span></span><span class="line" line="97"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Properties</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="98"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      RouteTableId</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateRouteTable
</span></span><span class="line" line="99"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      SubnetId</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateSubnet
</span></span><span class="line" line="100"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  FargateSG</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="101"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;AWS::EC2::SecurityGroup&quot;
</span></span><span class="line" line="102"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Properties</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="103"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      GroupDescription</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;Generated by Serverless&quot;
</span></span><span class="line" line="104"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      SecurityGroupIngress</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="105"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">IpProtocol</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF">-1
</span></span><span class="line" line="106"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">          CidrIp</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">127.0.0.1/32
</span></span><span class="line" line="107"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      Tags</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="108"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Key</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">Name
</span></span><span class="line" line="109"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">          Value</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> &quot;AWS::StackName&quot;
</span></span><span class="line" line="110"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      VpcId</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateVPC
</span></span><span class="line" line="111"><span emptylineplaceholder="true">
</span></span><span class="line" line="112"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  FargateECSRepo</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="113"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;AWS::ECR::Repository&quot;
</span></span><span class="line" line="114"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Properties</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="115"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      LifecyclePolicy</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="116"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">        LifecyclePolicyText</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">|
</span></span><span class="line" line="117"><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">          {
</span></span><span class="line" line="118"><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">            &quot;rules&quot;: [
</span></span><span class="line" line="119"><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">            {
</span></span><span class="line" line="120"><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">              &quot;rulePriority&quot;: 1,
</span></span><span class="line" line="121"><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">              &quot;description&quot;: &quot;Only keep 8 images&quot;,
</span></span><span class="line" line="122"><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">              &quot;selection&quot;: {
</span></span><span class="line" line="123"><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">                &quot;tagStatus&quot;: &quot;any&quot;,
</span></span><span class="line" line="124"><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">                &quot;countType&quot;: &quot;imageCountMoreThan&quot;,
</span></span><span class="line" line="125"><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">                &quot;countNumber&quot;: 8
</span></span><span class="line" line="126"><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">              },
</span></span><span class="line" line="127"><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">              &quot;action&quot;: { &quot;type&quot;: &quot;expire&quot; }
</span></span><span class="line" line="128"><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">            }]
</span></span><span class="line" line="129"><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">          }
</span></span><span class="line" line="130"><span emptylineplaceholder="true">
</span></span><span class="line" line="131"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  FargateECSTaskDefinition</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="132"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;AWS::ECS::TaskDefinition&quot;
</span></span><span class="line" line="133"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Properties</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="134"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      Cpu</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF">512
</span></span><span class="line" line="135"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      Memory</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">1GB
</span></span><span class="line" line="136"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      NetworkMode</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">awsvpc
</span></span><span class="line" line="137"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      RequiresCompatibilities</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="138"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;FARGATE&quot;
</span></span><span class="line" line="139"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      ExecutionRoleArn</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!GetAtt</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateExecutionRole.Arn
</span></span><span class="line" line="140"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      TaskRoleArn</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!GetAtt</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateTaskRole.Arn
</span></span><span class="line" line="141"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      ContainerDefinitions</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="142"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Name</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">scraper_container
</span></span><span class="line" line="143"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">          Image</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Sub
</span></span><span class="line" line="144"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">            - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;#{AccountId}.dkr.ecr.#{Region}.amazonaws.com/#{Repo}&quot;
</span></span><span class="line" line="145"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">            - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">AccountId</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> AWS::AccountId
</span></span><span class="line" line="146"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">              Region</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> AWS::Region
</span></span><span class="line" line="147"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">              Repo</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateECSRepo
</span></span><span class="line" line="148"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">          LogConfiguration</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="149"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">            LogDriver</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">awslogs
</span></span><span class="line" line="150"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">            Options</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="151"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">              awslogs-group</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateLogGroup
</span></span><span class="line" line="152"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">              awslogs-region</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> AWS::Region
</span></span><span class="line" line="153"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">              awslogs-stream-prefix</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> AWS::StackName
</span></span><span class="line" line="154"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Outputs</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="155"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  ECRRepo</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="156"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Value</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Sub
</span></span><span class="line" line="157"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">      - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;#{AccountId}.dkr.ecr.#{Region}.amazonaws.com/#{Repo}&quot;
</span></span><span class="line" line="158"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">      - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">AccountId</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> AWS::AccountId
</span></span><span class="line" line="159"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">        Region</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> AWS::Region
</span></span><span class="line" line="160"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">        Repo</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateECSRepo
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->Credit to <a href="https://github.com/jolexa/fargate-from-lambda" rel="nofollow" data-v-d83694f9><!--[-->github.com/jolexa/fargate-from-lambda<!--]--></a> who inspired this CF template.<!--]--></p><p data-v-f4c85dbd><!--[-->Next, we create a file with a handler to start the Fargate task<!--]--></p><div class="highlight-python prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-python" style=""><!--[--><code># launch_fargate.py
import os
import json

import boto3


def launch_fargate(event, context):
    client = boto3.client(&quot;ecs&quot;)

    ECSCluster = os.environ[&quot;ECS_CLUSTER&quot;]
    ECSSecGroup = os.environ[&quot;ECS_SEC_GROUP&quot;]
    ECSSubnet = os.environ[&quot;ECS_SUBNET&quot;]
    ECSTaskArn = os.environ[&quot;ECS_TASK_ARN&quot;]
    CONTAINER_NAME = os.environ[&quot;CONTAINER_NAME&quot;]

    run_task_response = client.run_task(
        cluster=ECSCluster,
        taskDefinition=ECSTaskArn,
        count=1,
        launchType=&quot;FARGATE&quot;,
        overrides={
            &quot;containerOverrides&quot;: [
                {
                    &quot;name&quot;: CONTAINER_NAME,
                    # We override the command so that we can pass some arguments
                    # e.g. for running different spiders.
                    &quot;command&quot;: [
                        &quot;python&quot;,
                        &quot;launcher.py&quot;,
                        json.dumps(event),
                    ],
                    &quot;environment&quot;: [
                        {&quot;name&quot;: &quot;FEED_BUCKET_NAME&quot;, &quot;value&quot;: os.environ[&quot;FEED_BUCKET_NAME&quot;]},
                    ]
                }
            ],
        },
        networkConfiguration={
            &quot;awsvpcConfiguration&quot;: {
                &quot;subnets&quot;: [
                    ECSSubnet,
                ],
                &quot;securityGroups&quot;: [
                    ECSSecGroup,
                ],
                &quot;assignPublicIp&quot;: &quot;ENABLED&quot;
            },
        },
    )
    return json.dumps(run_task_response, default=str)
</code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->We also need to update our <code class="" data-v-69006e27><!--[-->serverless.yml<!--]--></code> to add some new IAM role statemants, import the CloudFormation template in <code class="" data-v-69006e27><!--[-->fargate-cf-yml<!--]--></code>, add some env variables, include the <code class="" data-v-69006e27><!--[-->launch_fargate.py<!--]--></code> file, and finally add a new function for launching a Fargate task.<!--]--></p><div class="highlight-yaml prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-yaml shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># serverless.yml
</span></span><span class="line" line="2"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">service</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">my-sls-scraper
</span></span><span class="line" line="3"><span emptylineplaceholder="true">
</span></span><span class="line" line="4"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">provider</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="5"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  name</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">aws
</span></span><span class="line" line="6"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  runtime</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">python3.7
</span></span><span class="line" line="7"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  logRetentionInDays</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF">1
</span></span><span class="line" line="8"><span emptylineplaceholder="true">
</span></span><span class="line" line="9"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  environment</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="10"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    FEED_BUCKET_NAME</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> ScraperFeedBucket
</span></span><span class="line" line="11"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    ECS_CLUSTER</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!GetAtt</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateECSCluster.Arn
</span></span><span class="line" line="12"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    ECS_TASK_ARN</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateECSTaskDefinition
</span></span><span class="line" line="13"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    ECS_SUBNET</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateSubnet
</span></span><span class="line" line="14"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    ECS_SEC_GROUP</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateSG
</span></span><span class="line" line="15"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    CONTAINER_NAME</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;scraper_container&quot;
</span></span><span class="line" line="16"><span emptylineplaceholder="true">
</span></span><span class="line" line="17"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  iamRoleStatements</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="18"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">    - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Effect</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;Allow&quot;
</span></span><span class="line" line="19"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      Action</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="20"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;s3:PutObject&quot;
</span></span><span class="line" line="21"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      Resource</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Sub
</span></span><span class="line" line="22"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;arn:aws:s3:::#{BucketName}/*&quot;
</span></span><span class="line" line="23"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">BucketName</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> ScraperFeedBucket
</span></span><span class="line" line="24"><span emptylineplaceholder="true">
</span></span><span class="line" line="25"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">    - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Effect</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">Allow
</span></span><span class="line" line="26"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      Action</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="27"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">ecs:RunTask
</span></span><span class="line" line="28"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      Resource</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="29"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateECSTaskDefinition
</span></span><span class="line" line="30"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">    - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Effect</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">Allow
</span></span><span class="line" line="31"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      Action</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="32"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">iam:PassRole
</span></span><span class="line" line="33"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      Resource</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="34"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!GetAtt</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateExecutionRole.Arn
</span></span><span class="line" line="35"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">    - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Effect</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">Allow
</span></span><span class="line" line="36"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      Action</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="37"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">iam:PassRole
</span></span><span class="line" line="38"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      Resource</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="39"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!GetAtt</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateTaskRole.Arn
</span></span><span class="line" line="40"><span emptylineplaceholder="true">
</span></span><span class="line" line="41"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">functions</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="42"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  hello</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="43"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    handler</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">handler.hello
</span></span><span class="line" line="44"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  lambdaScrape</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="45"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    handler</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">launcher.scrape
</span></span><span class="line" line="46"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  fargateScrape</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="47"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    handler</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">launch_fargate.launch_fargate
</span></span><span class="line" line="48"><span emptylineplaceholder="true">
</span></span><span class="line" line="49"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># We include files by whitelisting to reduce the deployment time.
</span></span><span class="line" line="50"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># Just remember to add any files you create!
</span></span><span class="line" line="51"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">package</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="52"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  include</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="53"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">    - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">handler.py
</span></span><span class="line" line="54"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">    - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">launcher.py
</span></span><span class="line" line="55"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">    - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">launch_fargate.py
</span></span><span class="line" line="56"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">    - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">my_sls_scraper/**
</span></span><span class="line" line="57"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">    - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">scrapy.cfg
</span></span><span class="line" line="58"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  exclude</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="59"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">    - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;./**&quot;
</span></span><span class="line" line="60"><span emptylineplaceholder="true">
</span></span><span class="line" line="61"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">resources</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="62"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">  - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">AWSTemplateFormatVersion</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;2010-09-09&quot;
</span></span><span class="line" line="63"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Transform</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;AWS::Serverless-2016-10-31&quot;
</span></span><span class="line" line="64"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">  - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">${file(./s3-template.yml)}
</span></span><span class="line" line="65"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">  - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">${file(./fargate-template.yml)}
</span></span><span class="line" line="66"><span emptylineplaceholder="true">
</span></span><span class="line" line="67"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">plugins</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="68"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">  - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">serverless-python-requirements
</span></span><span class="line" line="69"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">  - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">serverless-cloudformation-sub-variables
</span></span><span class="line" line="70"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">custom</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="71"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  pythonRequirements</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="72"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    slim</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF">true</span><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"> # Omits tests, __pycache__, *.pyc etc from dependencies
</span></span><span class="line" line="73"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    fileName</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">requirements.txt
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->Once again we&#39;ll deploy and make a test run with<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> deploy</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -v
</span></span><span class="line" line="2"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> invoke</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -f</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> fargateScrape</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> --log
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->The function should execute, but the Fargate task will fail, as we haven&#39;t uploaded our Docker image to the repository we created.
You can look at what we created in the <a href="https://console.aws.amazon.com/ecs/home" rel="nofollow" data-v-d83694f9><!--[-->ECS console<!--]--></a> and the <a href="https://console.aws.amazon.com/vpc/home" rel="nofollow" data-v-d83694f9><!--[-->VPC console<!--]--></a>. You can see the failed task we started on <a href="https://console.aws.amazon.com/ecs/home?region=us-east-1#/clusters/fargate-my-sls-scraper-dev/tasks" rel="nofollow" data-v-d83694f9><!--[-->https://console.aws.amazon.com/ecs/home?region=us-east-1#/clusters/fargate-my-sls-scraper-dev/tasks<!--]--></a> if you toggle <strong data-v-c6a59043><!--[-->Stopped<!--]--></strong> and change regions if you&#39;re not in the default us-east-1.<!--]--></p><p data-v-f4c85dbd><!--[-->The final piece in the puzzle is to upload the container image, so let&#39;s create a <em data-v-4353b993><!--[-->Makefile<!--]--></em> to make it easy to update it in the future. Maybe you need to change the variables according to your setup.<!--]--></p><div class="highlight-makefile prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-makefile" style=""><!--[--><code># Makefile
STACKNAME_BASE=&quot;my-sls-scraper-dev&quot;
# This is a region that supports AWS Fargate
REGION=&quot;us-east-1&quot;
PROFILE=&quot;my-sls-admin&quot;
IMAGE_NAME=&quot;my_sls_scraper&quot;

build:
    docker build -t $(IMAGE_NAME):latest .

retag:
    docker tag $(IMAGE_NAME):latest \
        $(shell aws cloudformation --region $(REGION) --profile $(PROFILE) describe-stacks --stack-name $(STACKNAME_BASE) --query &quot;Stacks[0].Outputs[?OutputKey==&#39;ECRRepo&#39;].OutputValue&quot; --output text):latest
    @exec $(shell aws ecr --region $(REGION) --profile $(PROFILE) get-login --no-include-email)
    docker push $(shell aws cloudformation --region $(REGION) --profile $(PROFILE) describe-stacks --stack-name $(STACKNAME_BASE) --query &quot;Stacks[0].Outputs[?OutputKey==&#39;ECRRepo&#39;].OutputValue&quot; --output text):latest
</code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->We&#39;ve already build the image, so we just need to upload it with<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">make</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> retag
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->The first time pushing, this might take some time depending on how fast your internet connection is.
You should see an output similar to<!--]--></p><div class="highlight-null prose-code" data-v-ef0b30fc><!----><!--[--><pre class="" style=""><!--[--><code>18:17 $ make retag
docker tag &quot;my_sls_scraper&quot;:latest \
    459015585648.dkr.ecr.us-east-1.amazonaws.com/my-sl-farga-afj2n785due0:latest
Login Succeeded
docker push 459015585648.dkr.ecr.us-east-1.amazonaws.com/my-sl-farga-afj2n785due0:latest
The push refers to a repository [459015585648.dkr.ecr.us-east-1.amazonaws.com/my-sl-farga-afj2n785due0]
6b325179a37f: Pushed
7c486f7d4e0e: Pushed
5a14878ee86f: Pushed
fb71908672f7: Pushed
c028dbad8bfd: Pushed
424cdf061e9d: Pushed
bd648e09c386: Pushed
69d95271719a: Pushed
f88be44e4bd8: Pushed
e505c7600391: Pushed
4d2fd1bf072c: Pushed
6e302bbcacce: Pushed
97e8dd85db4e: Pushed
74e2ede3b29c: Pushed
6d5a64ea8f37: Pushed
660314270d76: Pushed
latest: digest: sha256:f64c0ed0e5296b03645e5aed927b3af1d75faa226382ac389651519a0b14381c size: 3678
</code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->and, if successful, it should be possible to scrape in Fargate by just invoking a Lambda function. Try it with<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> invoke</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -f</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> fargateScrape</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> --log
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->It should execute successfully and exit. The logs of the crawler comes from our Fargate task and not the Lambda function, and can be seen in the <a href="https://console.aws.amazon.com/cloudwatch/home?region=us-east-1#logs:" rel="nofollow" data-v-d83694f9><!--[-->CloudWatch console<!--]--></a>.<!--]--></p><p data-v-f4c85dbd><!--[-->Well done if you&#39;ve made it thus far. We&#39;ve made the basics of a quite sophisticated scraping infrastructure with a lot of potential. The last steps from here are optional.
We will set up an S3 bucket for caching responses, and in the end we&#39;ll use AWS CloudWatch to schedule automatic crawls and discuss some methods to better automate and control crawl scheduling.<!--]--></p><h2 id="using-s3-as-http-cache" data-v-6d609909><a aria-current="page" href="/posts/scrapy-fargate-sls-guide#using-s3-as-http-cache" class="router-link-active router-link-exact-active" data-v-6d609909><!--[-->Using S3 as HTTP cache<!--]--><!----></a></h2><p data-v-f4c85dbd><!--[-->Caching responses from our spider is good for faster crawls and to avoid getting banned, as well as a store of html responses that can be used for things like machine learning further down the data processing pipeline.
Scrapy comes with a file storage caching system by default, but because of the framework&#39;s great extensibility, we can quite easily make our own cache handler. Using persistent file storage is not possible in Lambda or Fargate, so we have to use an object storage like S3 or a database. We will use S3 because it&#39;s relatively easy to set up and maintain.<!--]--></p><p data-v-f4c85dbd><!--[-->To do this, we first have to add a bucket to our <code class="" data-v-69006e27><!--[-->s3-template.yml<!--]--></code> and add IAM role permissions to our <code class="" data-v-69006e27><!--[-->fargate-template.yml<!--]--></code> and <code class="" data-v-69006e27><!--[-->serverless.yml<!--]--></code>, as well as an environment variable to the latter and to <code class="" data-v-69006e27><!--[-->launch_fargate.py<!--]--></code>.<!--]--></p><p data-v-f4c85dbd><!--[-->Add an S3 bucket in the S3 template like this<!--]--></p><div class="highlight-yaml prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-yaml shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># s3-template.yml
</span></span><span class="line" line="2"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Resources</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="3"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  ScraperFeedBucket</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="4"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">AWS::S3::Bucket
</span></span><span class="line" line="5"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Properties</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="6"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      VersioningConfiguration</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="7"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">        Status</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;Enabled&quot;
</span></span><span class="line" line="8"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  HttpCacheBucket</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="9"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">AWS::S3::Bucket
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->Add a policy to the Fargate template<!--]--></p><div class="highlight-yaml prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-yaml shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># fargate-template.yml
</span></span><span class="line" line="2"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># ...
</span></span><span class="line" line="3"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    FargateTaskRole</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="4"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">        Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">AWS::IAM::Role
</span></span><span class="line" line="5"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">        Properties</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="6"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D">            # ...
</span></span><span class="line" line="7"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">            Policies</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="8"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">                - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">PolicyName</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">HttpCacheBucketPolicy
</span></span><span class="line" line="9"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">                  PolicyDocument</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="10"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">                    Statement</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="11"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">                      - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">PolicyName</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">HttpCacheBucketPolicy
</span></span><span class="line" line="12"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">                          PolicyDocument</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="13"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">                            Statement</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="14"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">                              - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Effect</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;Allow&quot;
</span></span><span class="line" line="15"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">                                Action</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="16"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">                                  - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;s3:GetObject&quot;
</span></span><span class="line" line="17"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">                                  - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;s3:PutObject&quot;
</span></span><span class="line" line="18"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">                                  - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;s3:ListBucket&quot;
</span></span><span class="line" line="19"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">                                Resource</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="20"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">                                  - </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Sub
</span></span><span class="line" line="21"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">                                    - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;arn:aws:s3:::#{BucketName}/*&quot;
</span></span><span class="line" line="22"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">                                    - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">BucketName</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> HttpCacheBucket
</span></span><span class="line" line="23"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">                                  - </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Sub
</span></span><span class="line" line="24"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">                                    - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;arn:aws:s3:::#{BucketName}&quot;
</span></span><span class="line" line="25"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">                                    - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">BucketName</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> HttpCacheBucket
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->and statements and env variable to our lambda functions<!--]--></p><div class="highlight-yaml prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-yaml shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># serverless.yml
</span></span><span class="line" line="2"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">provider</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="3"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D">    # ...
</span></span><span class="line" line="4"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    environment</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="5"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">        HTTP_CACHE_BUCKET_NAME</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> HttpCacheBucket
</span></span><span class="line" line="6"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D">        # ...
</span></span><span class="line" line="7"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    iamRoleStatements</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="8"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Effect</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;Allow&quot;
</span></span><span class="line" line="9"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">          Action</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="10"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">            - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;s3:GetObject&quot;
</span></span><span class="line" line="11"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">            - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;s3:PutObject&quot;
</span></span><span class="line" line="12"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">            - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;s3:ListBucket&quot;
</span></span><span class="line" line="13"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">          Resource</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="14"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">            - </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Sub
</span></span><span class="line" line="15"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">              - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;arn:aws:s3:::#{BucketName}/*&quot;
</span></span><span class="line" line="16"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">              - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">BucketName</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> HttpCacheBucket
</span></span><span class="line" line="17"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">            - </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Sub
</span></span><span class="line" line="18"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">              - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;arn:aws:s3:::#{BucketName}&quot;
</span></span><span class="line" line="19"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">              - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">BucketName</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> HttpCacheBucket
</span></span><span class="line" line="20"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D">        # ...
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->and lastly pass the new env variable when launching the crawler task<!--]--></p><div class="highlight-python prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-python" style=""><!--[--><code># launch_fargate.py
# ...
&quot;environment&quot;: [
   {&quot;name&quot;: &quot;FEED_BUCKET_NAME&quot;,
       &quot;value&quot;: os.environ[&quot;FEED_BUCKET_NAME&quot;]},
   {&quot;name&quot;: &quot;HTTP_CACHE_BUCKET_NAME&quot;,
       &quot;value&quot;: os.environ[&quot;HTTP_CACHE_BUCKET_NAME&quot;]},
],
# ...
</code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->To use all this configuration for some caching, we create a module with our cache implementation in the <code class="" data-v-69006e27><!--[-->my_sls_scraper<!--]--></code> folder, and don&#39;t forget to add an <code class="" data-v-69006e27><!--[-->__init__.py<!--]--></code> file in the newly created <code class="" data-v-69006e27><!--[-->extensions<!--]--></code> folder.<!--]--></p><div class="highlight-python prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-python" style=""><!--[--><code># my_sls_scraper/extensions/s3cache.py
import boto3
import gzip
import json
import logging
import os
from botocore.exceptions import ClientError
from botocore.stub import Stubber
from time import time
from datetime import datetime
from six.moves import cPickle as pickle
from six.moves.urllib.parse import urlparse
from scrapy.exceptions import NotConfigured
from scrapy.http import Headers
from scrapy.responsetypes import responsetypes
from scrapy.utils.request import request_fingerprint
from w3lib.http import headers_raw_to_dict, headers_dict_to_raw

from botocore.exceptions import ClientError
import sys

logger = logging.getLogger(__name__)


class S3CacheStorage(object):
    def __init__(self, settings):
        urifmt = settings.get(&#39;S3CACHE_URI&#39;, &#39;&#39;)
        if not urifmt:
            raise NotConfigured(&#39;S3CACHE_URI must be specified&#39;)

        # Parse URI
        u = urlparse(urifmt)
        self.keypath_fmt = u.path[1:]
        if not self.keypath_fmt:
            raise NotConfigured(&#39;Could not get key path from S3CACHE_URI&#39;)

        self.bucket_name = u.hostname
        if self.bucket_name is None:
            raise NotConfigured(&#39;Could not get bucket name from S3CACHE_URI&#39;)

        self.use_gzip = settings.getbool(&#39;HTTPCACHE_GZIP&#39;)
        self.dont_retrieve = settings.getbool(&#39;S3CACHE_DONT_RETRIEVE&#39;)

        self._client = None
        self._spider = None
        self._keypath = None
        self.cached_requests = []

    @property
    def _client_stubber(self):
        return Stubber(self.client)

    @property
    def client(self):
        &quot;&quot;&quot; Connect to S3 and return the connection &quot;&quot;&quot;

        if self._client is None:
            self._client = boto3.client(&#39;s3&#39;)
        return self._client

    @property
    def keypath(self):
        &quot;&quot;&quot; Get the keypath as specified in S3CACHE_URI &quot;&quot;&quot;
        def get_uri_params(obj):
            &quot;&quot;&quot;Convert an object to a dict&quot;&quot;&quot;
            params = {}
            for k in dir(obj):
                params[k] = getattr(obj, k)
            params[&#39;day&#39;] = datetime.utcnow().strftime(&#39;%Y-%m-%d&#39;)
            params[&#39;time&#39;] = datetime.utcnow().replace(
                microsecond=0).isoformat().replace(&#39;:&#39;, &#39;-&#39;)
            return params
        if not self._keypath:
            self._keypath = self.keypath_fmt % get_uri_params(self.spider)
        return self._keypath

    @property
    def spider(self):
        if not self._spider:
            raise NotConfigured(&#39;Could not get spider! Aborting...&#39;)
        return self._spider

    def put_object_to_key(self, obj, bucket, key):
        try:
            obj = gzip.compress(obj) if self.use_gzip else obj
            self.client.put_object(Body=obj, Bucket=bucket, Key=key)
        except ClientError as e:
            logger.warning(
                &#39;Failed to store cache on key {key}: {e}&#39;.format(key=key, e=e))
            response_code = e.response.get(&#39;Error&#39;, {}).get(&#39;Code&#39;)
            if response_code == &#39;AccessDenied&#39; or response_code == &#39;InvalidAccessKeyId&#39;:
                logger.exception(&quot;Access denied to http cache bucket&quot;)
                sys.exit(1)

    def get_object_from_key(self, bucket, key):
        try:
            response = self.client.get_object(Bucket=bucket, Key=key)
            obj = response[&#39;Body&#39;].read()
            return gzip.decompress(obj) if self.use_gzip else obj
        except ClientError as e:
            logger.debug(
                &#39;Failed to retrieve cache on key {key}: {e}&#39;.format(key=key, e=e))
            response_code = e.response.get(&#39;Error&#39;, {}).get(&#39;Code&#39;)
            if response_code == &#39;AccessDenied&#39; or response_code == &#39;InvalidAccessKeyId&#39;:
                logger.exception(&quot;Access denied to http cache bucket&quot;)
                sys.exit(1)

    def open_spider(self, spider):
        logger.debug(&#39;Using s3 cache storage in %(bucket_name)s&#39; % {&#39;bucket_name&#39;: self.bucket_name},
                     extra={&#39;spider&#39;: spider})
        # Update spider reference
        self._spider = spider

    def close_spider(self, spider):
        logger.info(
            &#39;Cache on s3 bucket {bucket} on key path {keypath}&#39;.format(
                bucket=self.bucket_name, keypath=self.keypath),
            extra={&#39;spider&#39;: spider}
        )

    def retrieve_response(self, spider, request):
        &quot;&quot;&quot;Return response if present in cache, or None otherwise.&quot;&quot;&quot;
        if self.dont_retrieve:
            return
        keyname = self._get_request_path(request)
        keydata = self.get_object_from_key(self.bucket_name, keyname)
        if not keydata:
            return  # not cached
        keydata = pickle.loads(keydata)
        metadata = keydata[&#39;meta&#39;]
        body = keydata[&#39;response_body&#39;]
        rawheaders = keydata[&#39;response_headers&#39;]
        url = metadata.get(&#39;response_url&#39;)
        status = metadata[&#39;status&#39;]
        headers = Headers(headers_raw_to_dict(rawheaders))
        respcls = responsetypes.from_args(headers=headers, url=url)
        response = respcls(url=url, headers=headers, status=status, body=body)
        return response

    def store_response(self, spider, request, response):
        # TODO: Use a buffer instead of sending the cache files one by one
        &quot;&quot;&quot;Store the given response in the cache.&quot;&quot;&quot;
        keyname = self._get_request_path(request)
        metadata = {
            &#39;url&#39;: request.url,
            &#39;method&#39;: request.method,
            &#39;status&#39;: response.status,
            &#39;response_url&#39;: response.url,
            &#39;timestamp&#39;: time(),
        }
        keydata = {
            &#39;meta&#39;: metadata,
            &#39;response_headers&#39;: headers_dict_to_raw(response.headers),
            &#39;response_body&#39;: response.body,
            &#39;request_headers&#39;: headers_dict_to_raw(request.headers),
            &#39;request_body&#39;: request.body
        }
        self.put_object_to_key(pickle.dumps(
            keydata), self.bucket_name, keyname)

    def _get_request_path(self, request):
        key = request_fingerprint(request)
        return &#39;{keypath}/{key}&#39;.format(keypath=self.keypath, key=key)

</code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->The code is a slightly modified version of <a href="https://github.com/heylouiz/scrapy-s3-http-cache" rel="nofollow" data-v-d83694f9><!--[-->github.com/heylouiz/scrapy-s3-http-cache<!--]--></a> to work natively with AWS.<!--]--></p><p data-v-f4c85dbd><!--[-->We&#39;ll add the necessary settings in <code class="" data-v-69006e27><!--[-->crawl.py<!--]--></code> so that we can dynamically decide which cache storage to use.<!--]--></p><div class="highlight-python prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-python" style=""><!--[--><code># my_sls_scraper/crawl.py
def crawl(settings={}, spider_name=&quot;header_spider&quot;, spider_kwargs={}):
# ...
    if (is_in_aws() and os.getenv(&quot;USE_S3_CACHE&quot;) !=  &quot;0&quot;) or os.getenv(&quot;USE_S3_CACHE&quot;):
        settings[&quot;HTTPCACHE_STORAGE&quot;] =  &quot;my_sls_scraper.extensions.s3cache.S3CacheStorage&quot;
        settings[&quot;S3CACHE_URI&quot;] =  f&quot;s3://{os.environ[&#39;HTTP_CACHE_BUCKET_NAME&#39;]}/cache&quot;
# ...
</code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->Now we need to do a full deploy by both deploying with Serverless, and rebuild and upload our Docker image. Do that and launch the crawler using S3 as cache storage with<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> deploy</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -v
</span></span><span class="line" line="2"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">make</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> build</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8"> &amp;&amp; </span><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">make</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> retag
</span></span><span class="line" line="3"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> invoke</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -f</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> fargateScrape</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> --log
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->It&#39;s probably wise to run the crawler locally after <code class="" data-v-69006e27><!--[-->sls deploy -v<!--]--></code> to verify that things work as they should, so you don&#39;t need to redeploy 15 times because of various typos (talking from experience).
Run the crawler locally after finding your cache bucket name in the <a href="https://s3.console.aws.amazon.com/s3/home" rel="nofollow" data-v-d83694f9><!--[-->S3 console<!--]--></a> (should be similar to <code class="" data-v-69006e27><!--[-->my-sls-scraper-dev-httpcachebucket-y2mbtieyeju3<!--]--></code>)<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> invoke</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> local</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -f</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> lambdaScrape</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> --log</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -e</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> USE_S3_CACHE=</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF">1</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -e</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> HTTP_CACHE_BUCKET_NAME=</span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">&lt;</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">YOUR_CACHE_BUCKET_NAM</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">E</span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">&gt;
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->You should now see objects appearing in the http cache S3 bucket as we run the crawler.<!--]--></p><h2 id="scheduling-and-configuring-crawls" data-v-6d609909><a aria-current="page" href="/posts/scrapy-fargate-sls-guide#scheduling-and-configuring-crawls" class="router-link-active router-link-exact-active" data-v-6d609909><!--[-->Scheduling and Configuring Crawls<!--]--><!----></a></h2><p data-v-f4c85dbd><!--[-->One of the advantages of using the AWS ecosystem is that it contains solutions for all common and uncommon tasks such as scheduling, event notifications, message queues, etc. The Serverless framework even makes some of this easy for beginners, so let&#39;s use it to schedule a weekly crawl with our spider.<!--]--></p><p data-v-f4c85dbd><!--[-->Add a key to our function config in <code class="" data-v-69006e27><!--[-->serverless.yml<!--]--></code> (pay damn close attention to the indentation here, or it will not work and no warning will be given)<!--]--></p><div class="highlight-yaml prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-yaml shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># serverless.yml
</span></span><span class="line" line="2"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># ...
</span></span><span class="line" line="3"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">functions</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="4"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  fargateScraper</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="5"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    handler</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">launch_fargate.launch_fargate
</span></span><span class="line" line="6"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">events</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="7"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">  - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">schedule</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="8"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      rate</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">cron(0 6 ? * MON *)
</span></span><span class="line" line="9"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      enabled</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF">true
</span></span><span class="line" line="10"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      description</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="11"><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">        Header spider every Monday morning at 6 AM UTC
</span></span><span class="line" line="12"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D">        # The input is key-value pairs accessed in the root of the event parameter of every handler function, i.e. event.get(&quot;spider_name&quot;)
</span></span><span class="line" line="13"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      input</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="14"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">        spider_name</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">header_spider
</span></span><span class="line" line="15"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D">        # ...
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->After deploying, you can verify that a CloudWatch Events tab appears under triggers in the Lambda console.<!--]--></p><p data-v-f4c85dbd><!--[--><img title="Lambda console triggers" style="aspect-ratio:1263/812;" src="/posts/scrapy-fargate-sls-guide/lambda-console-triggers.png" alt="Lambda console triggers" data-v-80d56572><!--]--></p><p data-v-f4c85dbd><!--[-->If you have a few spiders, configuring all the launches as scheduled events in <code class="" data-v-69006e27><!--[-->serverless.yml<!--]--></code> works fine. If you have a bunch of spiders, you might want to launch several spiders at the same time from a single Lambda function.<!--]--></p><p data-v-f4c85dbd><!--[-->We can implement behaviour like that in another Lambda function. Let&#39;s remove the dummy function in <code class="" data-v-69006e27><!--[-->handler.py<!--]--></code><!--]--></p><div class="highlight-python prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-python" style=""><!--[--><code># handler.py
import json
from datetime import datetime, timedelta
import logging

from launch_fargate import launch_fargate


def run_crawlers(event, context):
    result = []
    for x in filter(should_crawl, get_crawler_config()):
        try:
            if x.get(&quot;run_in_lambda&quot;):
                # TODO Implement function to invoke crawl in new Lambda function
                pass
            else:
                fargate_launch_response = launch_fargate(dict(
                    spider_name=x.get(&quot;spider_name&quot;),
                    spider_kwargs=x.get(&quot;spider_kwargs&quot;),
                ), {})
                result.append(fargate_launch_response)
        except Exception:
            logging.exception(
                f&quot;Could not launch spider {x.get(&#39;spider_name&#39;)}&quot;
            )
    return result


def get_crawler_config():
    # This function could make an API call to a CMS like AirTable,
    # Strapi or DynamoDB.
    return [
        {
            &quot;spider_name&quot;: &quot;header_spider&quot;,
            &quot;spider_kwargs&quot;: {
                &quot;start_urls&quot;: [&quot;https://example.com&quot;],
            },
            &quot;previous_crawl&quot;: {
                &quot;success_state&quot;: True,
                &quot;items_crawled&quot;: 100,
                &quot;finish_date&quot;: datetime.now() - timedelta(days=3),
            },
        },
        {
            &quot;spider_name&quot;: &quot;header_spider&quot;,
            &quot;spider_kwargs&quot;: {
                &quot;start_urls&quot;: [&quot;https://www.ietf.org&quot;],
            },
            &quot;previous_crawl&quot;: {
                &quot;success_state&quot;: True,
                &quot;items_crawled&quot;: 100,
                &quot;finish_date&quot;: datetime.now() - timedelta(hours=16),
            },
            &quot;crawl_interval_hours&quot;: 12,
            &quot;settings&quot;: {
                &quot;AUTOTHROTTLE_ENABLED&quot;: True,
            }|
        },
        {
            &quot;spider_name&quot;: &quot;header_spider&quot;,
            &quot;spider_kwargs&quot;: {
                &quot;start_urls&quot;: [&quot;https://bitcoin.org&quot;],
            },
        },
        {
            &quot;spider_name&quot;: &quot;other_spider&quot;,
            &quot;previous_crawl&quot;: None
        },
    ]


def should_crawl(x):
    previous_crawl = x.get(&quot;previous_crawl&quot;)
    if previous_crawl:
        time_interval_hours = x.get(&quot;crawl_interval_hours&quot;, 24*7)
        return previous_crawl.get(&quot;finish_date&quot;) + timedelta(hours=time_interval_hours) &lt; datetime.now() or not previous_crawl.get(&quot;success_state&quot;)
    return True
</code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->This function makes it possible to run crawls quite intelligently. It also assumes we have more spiders and that our <code class="" data-v-69006e27><!--[-->header_spider<!--]--></code> can take arguments in its constructor. Let&#39;s change it to do so<!--]--></p><div class="highlight-python prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-python" style=""><!--[--><code># my_sls_scraper/spiders/header_spider.py
from urllib.parse import urlparse

from scrapy.spiders import CrawlSpider, Rule
from scrapy.linkextractors import LinkExtractor


class HeaderSpider(CrawlSpider):
    name = &quot;header_spider&quot;

    start_urls = [&quot;https://scrapy.org&quot;]
    allowed_domains = [&quot;scrapy.org&quot;]

    def __init__(self, **kwargs):
        # Enables overriding attributes for a flexible spider
        if kwargs.get(&quot;start_urls&quot;):
            self.start_urls = kwargs.get(&quot;start_urls&quot;)
            self.allowed_domains = list(
                urlparse(x).hostname for x in self.start_urls
            )

        super().__init__(
            **{k: v for k, v in kwargs.items() if not hasattr(self, k)}
        )

    rules = [  # Get all links on start url
        Rule(
            link_extractor=LinkExtractor(
                deny=r&quot;\?&quot;,
            ),
            follow=False,
            callback=&quot;parse_page&quot;,
        )
    ]

    def parse_start_url(self, response):
        return self.parse_page(response)

    def parse_page(self, response):
        header = response.css(&quot;h1, h2&quot;).extract_first(
        ) or response.css(&quot;title&quot;).extract_first() or response.url
        return {
            &quot;header&quot;: remove_tags(header),
            &quot;url&quot;: response.url,
        }
</code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->It can now scrape the headers on any site with the <code class="" data-v-69006e27><!--[-->start_urls<!--]--></code> argument.
We also have to replace the hello function in <code class="" data-v-69006e27><!--[-->serverless.yml<!--]--></code> to the following<!--]--></p><div class="highlight-yaml prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-yaml shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># serverless.py
</span></span><span class="line" line="2"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># ...
</span></span><span class="line" line="3"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">functions</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="4"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  pollSpidersScrape</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="5"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    handler</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">handler.run_crawlers
</span></span><span class="line" line="6"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    events</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="7"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">      - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">schedule</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="8"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">          rate</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">rate(2 hours)
</span></span><span class="line" line="9"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">          enabled</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF">true
</span></span><span class="line" line="10"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">          description</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">Poll spiders every 2 hours
</span></span><span class="line" line="11"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D">  # ...
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->Do a full deploy and see if it works.<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> deploy</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -v
</span></span><span class="line" line="2"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">make</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> build</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8"> &amp;&amp; </span><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">make</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> retag
</span></span><span class="line" line="3"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> invoke</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -f</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> pollSpidersScrape</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> --log
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->You should now see output files for scraping <a href="http://www.ietf.org" rel="nofollow" data-v-d83694f9><!--[-->www.ietf.org<!--]--></a> and bitcoin.org in S3, while one container will fail because we don&#39;t have a spider called <code class="" data-v-69006e27><!--[-->other_spider<!--]--></code>.<!--]--></p><p data-v-f4c85dbd><!--[--><strong data-v-c6a59043><!--[-->WARNING<!--]--></strong>
Don&#39;t forget to remove or stop that last function from running, as starting 3 Fargate containers every 2 hours will cost some money.
You can remove all resources* with<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> remove</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -v
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->... and rebuild it all with another command. Infrastructure as code is pretty neat.<!--]--></p><p data-v-f4c85dbd><!--[-->* Serverless will fail to delete the buckets and ECR repository if they are not empty. So you have to manually delete all images from the repository and all objects from the scraper feed bucket and http cache bucket first.<!--]--></p><h2 id="conclusion" data-v-6d609909><a aria-current="page" href="/posts/scrapy-fargate-sls-guide#conclusion" class="router-link-active router-link-exact-active" data-v-6d609909><!--[-->Conclusion<!--]--><!----></a></h2><p data-v-f4c85dbd><!--[-->This concludes this guide. I hope it was useful for understanding scraping and serverless a little better. The next part will be about setting up a Lambda function that reacts whenever a crawler feed is created in S3, do some processing on that data before it&#39;s stored in a database.
Any feedback is welcome and don&#39;t hesitate to contact me if you&#39;re interested in the price comparison framework I&#39;m creating.<!--]--></p><style>html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}</style></div><!--]--></main></div><!--]--><footer class="center" data-v-a9d5dfed data-v-654b05f0><a href="https://www.github.com/nuxt-themes/alpine" rel="noopener noreferrer" class="credits" data-v-654b05f0>Alpine</a><div class="navigation" data-v-654b05f0><nav data-v-654b05f0 data-v-f1645879><ul data-v-f1645879><!--[--><li data-v-f1645879><a href="/" class="" data-v-f1645879><span class="underline-fx" data-v-f1645879></span> Home</a></li><li data-v-f1645879><a href="/contact" class="" data-v-f1645879><span class="underline-fx" data-v-f1645879></span> Contact</a></li><li data-v-f1645879><a href="/posts" class="" data-v-f1645879><span class="underline-fx" data-v-f1645879></span> Archive</a></li><!--]--></ul></nav></div><p class="message" data-v-654b05f0>Follow me on</p><div class="icons" data-v-654b05f0><div class="social" data-v-654b05f0><!--[--><a href="https://twitter.com/vikfand" rel="noopener noreferrer" target="_blank" title="vikfand" aria-label="vikfand" data-v-bb750848><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-bb750848 style="" width="1em" height="1em" viewBox="0 0 24 24" data-v-5f091540><path fill="currentColor" d="M22 5.8a8.49 8.49 0 0 1-2.36.64a4.13 4.13 0 0 0 1.81-2.27a8.21 8.21 0 0 1-2.61 1a4.1 4.1 0 0 0-7 3.74a11.64 11.64 0 0 1-8.45-4.29a4.16 4.16 0 0 0-.55 2.07a4.09 4.09 0 0 0 1.82 3.41a4.05 4.05 0 0 1-1.86-.51v.05a4.1 4.1 0 0 0 3.3 4a3.93 3.93 0 0 1-1.1.17a4.9 4.9 0 0 1-.77-.07a4.11 4.11 0 0 0 3.83 2.84A8.22 8.22 0 0 1 3 18.34a7.93 7.93 0 0 1-1-.06a11.57 11.57 0 0 0 6.29 1.85A11.59 11.59 0 0 0 20 8.45v-.53a8.43 8.43 0 0 0 2-2.12Z"/></svg></a><a href="https://instagram.com/viktorfandersen" rel="noopener noreferrer" target="_blank" title="viktorfandersen" aria-label="viktorfandersen" data-v-bb750848><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-bb750848 style="" width="1em" height="1em" viewBox="0 0 24 24" data-v-5f091540><path fill="currentColor" d="M17.34 5.46a1.2 1.2 0 1 0 1.2 1.2a1.2 1.2 0 0 0-1.2-1.2Zm4.6 2.42a7.59 7.59 0 0 0-.46-2.43a4.94 4.94 0 0 0-1.16-1.77a4.7 4.7 0 0 0-1.77-1.15a7.3 7.3 0 0 0-2.43-.47C15.06 2 14.72 2 12 2s-3.06 0-4.12.06a7.3 7.3 0 0 0-2.43.47a4.78 4.78 0 0 0-1.77 1.15a4.7 4.7 0 0 0-1.15 1.77a7.3 7.3 0 0 0-.47 2.43C2 8.94 2 9.28 2 12s0 3.06.06 4.12a7.3 7.3 0 0 0 .47 2.43a4.7 4.7 0 0 0 1.15 1.77a4.78 4.78 0 0 0 1.77 1.15a7.3 7.3 0 0 0 2.43.47C8.94 22 9.28 22 12 22s3.06 0 4.12-.06a7.3 7.3 0 0 0 2.43-.47a4.7 4.7 0 0 0 1.77-1.15a4.85 4.85 0 0 0 1.16-1.77a7.59 7.59 0 0 0 .46-2.43c0-1.06.06-1.4.06-4.12s0-3.06-.06-4.12ZM20.14 16a5.61 5.61 0 0 1-.34 1.86a3.06 3.06 0 0 1-.75 1.15a3.19 3.19 0 0 1-1.15.75a5.61 5.61 0 0 1-1.86.34c-1 .05-1.37.06-4 .06s-3 0-4-.06a5.73 5.73 0 0 1-1.94-.3a3.27 3.27 0 0 1-1.1-.75a3 3 0 0 1-.74-1.15a5.54 5.54 0 0 1-.4-1.9c0-1-.06-1.37-.06-4s0-3 .06-4a5.54 5.54 0 0 1 .35-1.9A3 3 0 0 1 5 5a3.14 3.14 0 0 1 1.1-.8A5.73 5.73 0 0 1 8 3.86c1 0 1.37-.06 4-.06s3 0 4 .06a5.61 5.61 0 0 1 1.86.34a3.06 3.06 0 0 1 1.19.8a3.06 3.06 0 0 1 .75 1.1a5.61 5.61 0 0 1 .34 1.9c.05 1 .06 1.37.06 4s-.01 3-.06 4ZM12 6.87A5.13 5.13 0 1 0 17.14 12A5.12 5.12 0 0 0 12 6.87Zm0 8.46A3.33 3.33 0 1 1 15.33 12A3.33 3.33 0 0 1 12 15.33Z"/></svg></a><a href="https://www.linkedin.com/in/viktor-frede-andersen-31650153/" rel="noopener noreferrer" target="_blank" title="LinkedIn" aria-label="LinkedIn" data-v-bb750848><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-bb750848 style="" width="1em" height="1em" viewBox="0 0 24 24" data-v-5f091540><path fill="currentColor" d="M20.47 2H3.53a1.45 1.45 0 0 0-1.47 1.43v17.14A1.45 1.45 0 0 0 3.53 22h16.94a1.45 1.45 0 0 0 1.47-1.43V3.43A1.45 1.45 0 0 0 20.47 2ZM8.09 18.74h-3v-9h3ZM6.59 8.48a1.56 1.56 0 1 1 0-3.12a1.57 1.57 0 1 1 0 3.12Zm12.32 10.26h-3v-4.83c0-1.21-.43-2-1.52-2A1.65 1.65 0 0 0 12.85 13a2 2 0 0 0-.1.73v5h-3v-9h3V11a3 3 0 0 1 2.71-1.5c2 0 3.45 1.29 3.45 4.06Z"/></svg></a><!--]--></div><div class="color-mode-switch" data-v-654b05f0><button aria-label="Color Mode" data-v-654b05f0 data-v-fd50f6ca><span data-v-fd50f6ca></span></button></div></div></footer><!--]--></div></div></body>
</html>