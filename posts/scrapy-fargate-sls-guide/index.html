<!DOCTYPE html>
<html  lang="en">
<head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Serverless Scraping with Scrapy, AWS Lambda and Fargate – a guide</title>
<meta name="twitter:card" content="summary_large_image">
<meta name="description" content="Amazing insights">
<meta property="og:description" content="Amazing insights">
<meta property="og:image" content="/social-card-preview.png">
<meta property="og:image:width" content="400">
<meta property="og:image:height" content="300">
<meta property="og:image:alt" content="An image showcasing my project.">
<meta property="og:title" content="Serverless Scraping with Scrapy, AWS Lambda and Fargate – a guide">
<link rel="preload" as="fetch" crossorigin="anonymous" href="/posts/scrapy-fargate-sls-guide/_payload.json">
<link rel="stylesheet" href="/_nuxt/entry.97ab6348.css">
<link rel="stylesheet" href="/_nuxt/DocumentDrivenNotFound.17085fcb.css">
<link rel="stylesheet" href="/_nuxt/ProseH2.b565e694.css">
<link rel="stylesheet" href="/_nuxt/ProseP.2188f7db.css">
<link rel="stylesheet" href="/_nuxt/ProseA.f70b28a1.css">
<link rel="stylesheet" href="/_nuxt/ProseH3.9316dd33.css">
<link rel="stylesheet" href="/_nuxt/ProseUl.dbdeb511.css">
<link rel="stylesheet" href="/_nuxt/ProseLi.fd79bc46.css">
<link rel="stylesheet" href="/_nuxt/ProseEm.e73a4b12.css">
<link rel="stylesheet" href="/_nuxt/ProsePre.e63e49c6.css">
<link rel="stylesheet" href="/_nuxt/ProseCode.91016173.css">
<link rel="stylesheet" href="/_nuxt/ProseCodeInline.46b97b4c.css">
<link rel="stylesheet" href="/_nuxt/ProseStrong.a06f6381.css">
<link rel="stylesheet" href="/_nuxt/ProseImg.4753ea4a.css">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/entry.62dc2328.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/NuxtImg.6de55a98.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/document-driven.43fd56a5.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/DocumentDrivenEmpty.5ecb93ab.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/ContentRenderer.0ca18651.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/ContentRendererMarkdown.vue.488f9c10.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/DocumentDrivenNotFound.9dcee303.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/ssr.aa76f02f.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/page.10088194.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/ContentRendererMarkdown.c4163eaf.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseH2.203f4cc2.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseP.c9fbb7f1.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseA.b4523295.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseH3.0d9e0bac.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseUl.04617425.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseLi.a4de4a86.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseEm.de9b7a1b.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProsePre.149059c2.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseCode.b0afc5cd.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseCodeInline.86c62bbb.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseStrong.ddad0b1c.js">
<link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseImg.c53b783c.js">
<link rel="prefetch" as="style" href="/_nuxt/article.f53cb360.css">
<link rel="prefetch" as="script" crossorigin href="/_nuxt/article.6a7a7ba7.js">
<link rel="prefetch" as="script" crossorigin href="/_nuxt/date.824a539b.js">
<link rel="prefetch" as="script" crossorigin href="/_nuxt/default.4751ed77.js">
<link rel="prefetch" as="script" crossorigin href="/_nuxt/client-db.17ef76c9.js">
<link rel="prefetch" as="script" crossorigin href="/_nuxt/debug.25eda2a0.js">
<link rel="prefetch" as="style" href="/_nuxt/useStudio.54e83257.css">
<link rel="prefetch" as="script" crossorigin href="/_nuxt/useStudio.8381510e.js">
<link rel="prefetch" as="script" crossorigin href="/_nuxt/setup.75a1a77c.js">
<link rel="prefetch" as="style" href="/_nuxt/error-404.7910d5ca.css">
<link rel="prefetch" as="script" crossorigin href="/_nuxt/error-404.e225b14d.js">
<link rel="prefetch" as="style" href="/_nuxt/error-500.1db01289.css">
<link rel="prefetch" as="script" crossorigin href="/_nuxt/error-500.a10778fd.js">
<script type="module" src="/_nuxt/entry.62dc2328.js" crossorigin></script><style id="pinceau-runtime-hydratable">@media{.phy[--]{--puid:1VyNK9-v;}.pv-j7afj1{max-width:var(--elements-container-maxWidth);padding-left:var(--elements-container-padding-mobile);padding-right:var(--elements-container-padding-mobile);}@media (min-width: 475px){.pv-j7afj1{padding-left:var(--elements-container-padding-xs);padding-right:var(--elements-container-padding-xs);}}@media (min-width: 640px){.pv-j7afj1{padding-left:var(--elements-container-padding-sm);padding-right:var(--elements-container-padding-sm);}}@media (min-width: 768px){.pv-j7afj1{padding-left:var(--elements-container-padding-md);padding-right:var(--elements-container-padding-md);}}} </style><style id="pinceau-theme">@media { :root {--pinceau-mq: initial; --alpine-readableLine: 68ch;--alpine-backdrop-backgroundColor: #f4f4f5b3;--prose-code-inline-padding: 0.2rem 0.375rem 0.2rem 0.375rem;--prose-code-block-backdropFilter: contrast(1);--prose-code-block-border-style: solid;--prose-code-block-border-width: 1px;--prose-tbody-tr-borderBottom-style: dashed;--prose-tbody-tr-borderBottom-width: 1px;--prose-th-textAlign: inherit;--prose-thead-borderBottom-style: solid;--prose-thead-borderBottom-width: 1px;--prose-thead-border-style: solid;--prose-thead-border-width: 0px;--prose-table-textAlign: start;--prose-hr-width: 1px;--prose-hr-style: solid;--prose-li-listStylePosition: outside;--prose-ol-li-markerColor: currentColor;--prose-ol-paddingInlineStart: 21px;--prose-ol-listStyleType: decimal;--prose-ul-li-markerColor: currentColor;--prose-ul-paddingInlineStart: 21px;--prose-ul-listStyleType: disc;--prose-blockquote-border-style: solid;--prose-blockquote-border-width: 4px;--prose-blockquote-quotes: '201C' '201D' '2018' '2019';--prose-blockquote-paddingInlineStart: 24px;--prose-a-code-color-hover: currentColor;--prose-a-code-color-static: currentColor;--prose-a-hasCode-borderBottom: none;--prose-a-border-distance: 2px;--prose-a-border-color-hover: currentColor;--prose-a-border-color-static: currentColor;--prose-a-border-style-hover: solid;--prose-a-border-style-static: dashed;--prose-a-border-width: 1px;--prose-a-color-static: inherit;--prose-a-textDecoration: none;--prose-h6-margin: 3rem 0 2rem;--prose-h5-margin: 3rem 0 2rem;--prose-h4-margin: 3rem 0 2rem;--prose-h3-margin: 3rem 0 2rem;--prose-h2-margin: 3rem 0 2rem;--prose-h1-margin: 0 0 2rem;--prose-p-fontSize: 18px;--typography-lead-loose: 2;--typography-lead-relaxed: 1.625;--typography-lead-normal: 1.5;--typography-lead-snug: 1.375;--typography-lead-tight: 1.25;--typography-lead-none: 1;--typography-lead-10: 2.5rem;--typography-lead-9: 2.25rem;--typography-lead-8: 2rem;--typography-lead-7: 1.75rem;--typography-lead-6: 1.5rem;--typography-lead-5: 1.25rem;--typography-lead-4: 1rem;--typography-lead-3: .75rem;--typography-lead-2: .5rem;--typography-lead-1: .025rem;--typography-fontWeight-black: 900;--typography-fontWeight-extrabold: 800;--typography-fontWeight-bold: 700;--typography-fontWeight-semibold: 600;--typography-fontWeight-medium: 500;--typography-fontWeight-normal: 400;--typography-fontWeight-light: 300;--typography-fontWeight-extralight: 200;--typography-fontWeight-thin: 100;--typography-fontSize-9xl: 128px;--typography-fontSize-8xl: 96px;--typography-fontSize-7xl: 72px;--typography-fontSize-6xl: 60px;--typography-fontSize-5xl: 48px;--typography-fontSize-4xl: 36px;--typography-fontSize-3xl: 30px;--typography-fontSize-2xl: 24px;--typography-fontSize-xl: 20px;--typography-fontSize-lg: 18px;--typography-fontSize-base: 16px;--typography-fontSize-sm: 14px;--typography-fontSize-xs: 12px;--typography-letterSpacing-wide: 0.025em;--typography-letterSpacing-tight: -0.025em;--typography-verticalMargin-base: 24px;--typography-verticalMargin-sm: 16px;--elements-border-secondary-hover: [object Object];--elements-backdrop-background: #fffc;--elements-backdrop-filter: saturate(200%) blur(20px);--elements-container-maxWidth: 64rem;--lead-loose: 2;--lead-relaxed: 1.625;--lead-normal: 1.5;--lead-snug: 1.375;--lead-tight: 1.25;--lead-none: 1;--lead-10: 2.5rem;--lead-9: 2.25rem;--lead-8: 2rem;--lead-7: 1.75rem;--lead-6: 1.5rem;--lead-5: 1.25rem;--lead-4: 1rem;--lead-3: .75rem;--lead-2: .5rem;--lead-1: .025rem;--letterSpacing-widest: 0.1em;--letterSpacing-wider: 0.05em;--letterSpacing-wide: 0.025em;--letterSpacing-normal: 0em;--letterSpacing-tight: -0.025em;--letterSpacing-tighter: -0.05em;--fontSize-9xl: 8rem;--fontSize-8xl: 6rem;--fontSize-7xl: 4.5rem;--fontSize-6xl: 3.75rem;--fontSize-5xl: 3rem;--fontSize-4xl: 2.25rem;--fontSize-3xl: 1.875rem;--fontSize-2xl: 1.5rem;--fontSize-xl: 1.25rem;--fontSize-lg: 1.125rem;--fontSize-base: 1rem;--fontSize-sm: 0.875rem;--fontSize-xs: 0.75rem;--fontWeight-black: 900;--fontWeight-extrabold: 800;--fontWeight-bold: 700;--fontWeight-semibold: 600;--fontWeight-medium: 500;--fontWeight-normal: 400;--fontWeight-light: 300;--fontWeight-extralight: 200;--fontWeight-thin: 100;--font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace;--font-serif: ui-serif, Georgia, Cambria, Times New Roman, Times, serif;--font-sans: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica Neue, Arial, Noto Sans, sans-serif, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol, Noto Color Emoji;--opacity-total: 1;--opacity-high: 0.8;--opacity-medium: 0.5;--opacity-soft: 0.3;--opacity-light: 0.15;--opacity-bright: 0.1;--opacity-noOpacity: 0;--borderWidth-lg: 3px;--borderWidth-md: 2px;--borderWidth-sm: 1px;--borderWidth-noBorder: 0;--space-rem-875: 0.875rem;--space-rem-625: 0.625rem;--space-rem-375: 0.375rem;--space-rem-125: 0.125rem;--space-px: 1px;--space-128: 32rem;--space-96: 24rem;--space-80: 20rem;--space-72: 18rem;--space-64: 16rem;--space-60: 15rem;--space-56: 14rem;--space-52: 13rem;--space-48: 12rem;--space-44: 11rem;--space-40: 10rem;--space-36: 9rem;--space-32: 8rem;--space-28: 7rem;--space-24: 6rem;--space-20: 5rem;--space-16: 4rem;--space-14: 3.5rem;--space-12: 3rem;--space-11: 2.75rem;--space-10: 2.5rem;--space-9: 2.25rem;--space-8: 2rem;--space-7: 1.75rem;--space-6: 1.5rem;--space-5: 1.25rem;--space-4: 1rem;--space-3: 0.75rem;--space-2: 0.5rem;--space-1: 0.25rem;--space-0: 0px;--size-full: 100%;--size-7xl: 80rem;--size-6xl: 72rem;--size-5xl: 64rem;--size-4xl: 56rem;--size-3xl: 48rem;--size-2xl: 42rem;--size-xl: 36rem;--size-lg: 32rem;--size-md: 28rem;--size-sm: 24rem;--size-xs: 20rem;--size-200: 200px;--size-104: 104px;--size-80: 80px;--size-64: 64px;--size-56: 56px;--size-48: 48px;--size-40: 40px;--size-32: 32px;--size-24: 24px;--size-20: 20px;--size-16: 16px;--size-12: 12px;--size-8: 8px;--size-6: 6px;--size-4: 4px;--size-2: 2px;--size-0: 0px;--radii-full: 9999px;--radii-3xl: 1.75rem;--radii-2xl: 1.5rem;--radii-xl: 1rem;--radii-lg: 0.75rem;--radii-md: 0.5rem;--radii-sm: 0.375rem;--radii-xs: 0.25rem;--radii-2xs: 0.125rem;--radii-none: 0px;--shadow-none: 0px 0px 0px 0px transparent;--shadow-lg: 0px 10px 15px -3px #000000, 0px 4px 6px -4px #000000;--shadow-md: 0px 4px 6px -1px #000000, 0px 2px 4px -2px #000000;--shadow-sm: 0px 1px 3px 0px #000000, 0px 1px 2px -1px #000000;--shadow-xs: 0px 1px 2px 0px #000000;--height-screen: 100vh;--width-screen: 100vw;--color-primary-900: #002e38;--color-primary-800: #005c70;--color-primary-700: #008aa9;--color-primary-600: #00b9e1;--color-primary-500: #1ad6ff;--color-primary-400: #40ddff;--color-primary-300: #66e4ff;--color-primary-200: #8deaff;--color-primary-100: #b3f1ff;--color-primary-50: #d9f8ff;--color-ruby-900: #380011;--color-ruby-800: #700021;--color-ruby-700: #a90032;--color-ruby-600: #e10043;--color-ruby-500: #ff1a5e;--color-ruby-400: #ff4079;--color-ruby-300: #ff6694;--color-ruby-200: #ff8dae;--color-ruby-100: #ffb3c9;--color-ruby-50: #ffd9e4;--color-pink-900: #380025;--color-pink-800: #70004b;--color-pink-700: #a90070;--color-pink-600: #e10095;--color-pink-500: #ff1ab2;--color-pink-400: #ff40bf;--color-pink-300: #ff66cc;--color-pink-200: #ff8dd8;--color-pink-100: #ffb3e5;--color-pink-50: #ffd9f2;--color-purple-900: #190038;--color-purple-800: #330070;--color-purple-700: #4c00a9;--color-purple-600: #6500e1;--color-purple-500: #811aff;--color-purple-400: #9640ff;--color-purple-300: #ab66ff;--color-purple-200: #c08dff;--color-purple-100: #d5b3ff;--color-purple-50: #ead9ff;--color-royalblue-900: #0b0531;--color-royalblue-800: #160a62;--color-royalblue-700: #211093;--color-royalblue-600: #2c15c4;--color-royalblue-500: #4127e8;--color-royalblue-400: #614bec;--color-royalblue-300: #806ff0;--color-royalblue-200: #a093f3;--color-royalblue-100: #c0b7f7;--color-royalblue-50: #dfdbfb;--color-indigoblue-900: #001238;--color-indigoblue-800: #002370;--color-indigoblue-700: #0035a9;--color-indigoblue-600: #0047e1;--color-indigoblue-500: #1a62ff;--color-indigoblue-400: #407cff;--color-indigoblue-300: #6696ff;--color-indigoblue-200: #8db0ff;--color-indigoblue-100: #b3cbff;--color-indigoblue-50: #d9e5ff;--color-blue-900: #002438;--color-blue-800: #004870;--color-blue-700: #006ca9;--color-blue-600: #0090e1;--color-blue-500: #1aadff;--color-blue-400: #40bbff;--color-blue-300: #66c8ff;--color-blue-200: #8dd6ff;--color-blue-100: #b3e4ff;--color-blue-50: #d9f1ff;--color-lightblue-900: #002e38;--color-lightblue-800: #005c70;--color-lightblue-700: #008aa9;--color-lightblue-600: #00b9e1;--color-lightblue-500: #1ad6ff;--color-lightblue-400: #40ddff;--color-lightblue-300: #66e4ff;--color-lightblue-200: #8deaff;--color-lightblue-100: #b3f1ff;--color-lightblue-50: #d9f8ff;--color-teal-900: #062a28;--color-teal-800: #0b544f;--color-teal-700: #117d77;--color-teal-600: #16a79e;--color-teal-500: #1cd1c6;--color-teal-400: #36e4da;--color-teal-300: #5fe9e1;--color-teal-200: #87efe9;--color-teal-100: #aff4f0;--color-teal-50: #d7faf8;--color-pear-900: #2a2b09;--color-pear-800: #545512;--color-pear-700: #7e801b;--color-pear-600: #a8aa24;--color-pear-500: #d0d32f;--color-pear-400: #d8da52;--color-pear-300: #e0e274;--color-pear-200: #e8e997;--color-pear-100: #eff0ba;--color-pear-50: #f7f8dc;--color-red-900: #380300;--color-red-800: #700700;--color-red-700: #a90a00;--color-red-600: #e10e00;--color-red-500: #ff281a;--color-red-400: #ff4c40;--color-red-300: #ff7066;--color-red-200: #ff948d;--color-red-100: #ffb7b3;--color-red-50: #ffdbd9;--color-orange-900: #381800;--color-orange-800: #702f00;--color-orange-700: #a94700;--color-orange-600: #e15e00;--color-orange-500: #ff7a1a;--color-orange-400: #ff9040;--color-orange-300: #ffa666;--color-orange-200: #ffbd8d;--color-orange-100: #ffd3b3;--color-orange-50: #ffe9d9;--color-yellow-900: #362b03;--color-yellow-800: #6d5605;--color-yellow-700: #a38108;--color-yellow-600: #daac0a;--color-yellow-500: #f5c828;--color-yellow-400: #f7d14c;--color-yellow-300: #f8da70;--color-yellow-200: #fae393;--color-yellow-100: #fcedb7;--color-yellow-50: #fdf6db;--color-green-900: #003f25;--color-green-800: #005e38;--color-green-700: #007e4a;--color-green-600: #009d5d;--color-green-500: #00bd6f;--color-green-400: #00dc82;--color-green-300: #30ffaa;--color-green-200: #83ffcc;--color-green-100: #acffdd;--color-green-50: #d6ffee;--color-gray-900: #18181B;--color-gray-800: #27272A;--color-gray-700: #3f3f46;--color-gray-600: #52525B;--color-gray-500: #71717A;--color-gray-400: #a1a1aa;--color-gray-300: #D4d4d8;--color-gray-200: #e4e4e7;--color-gray-100: #f4f4f5;--color-gray-50: #fafafa;--color-black: #0c0c0d;--color-white: #FFFFFF;--media-portrait: only screen and (orientation: portrait);--media-landscape: only screen and (orientation: landscape);--media-rm: (prefers-reduced-motion: reduce);--media-2xl: (min-width: 1536px);--media-xl: (min-width: 1280px);--media-lg: (min-width: 1024px);--media-md: (min-width: 768px);--media-sm: (min-width: 640px);--media-xs: (min-width: 475px);--alpine-body-color: var(--color-gray-800);--alpine-body-backgroundColor: var(--color-white);--prose-code-inline-fontWeight: var(--typography-fontWeight-normal);--prose-code-inline-fontSize: var(--typography-fontSize-sm);--prose-code-inline-borderRadius: var(--radii-xs);--prose-code-block-pre-padding: var(--typography-verticalMargin-sm);--prose-code-block-margin: var(--typography-verticalMargin-base) 0;--prose-code-block-fontSize: var(--typography-fontSize-sm);--prose-tbody-code-inline-fontSize: var(--typography-fontSize-sm);--prose-tbody-td-padding: var(--typography-verticalMargin-sm);--prose-th-fontWeight: var(--typography-fontWeight-semibold);--prose-th-padding: 0 var(--typography-verticalMargin-sm) var(--typography-verticalMargin-sm) var(--typography-verticalMargin-sm);--prose-table-lineHeight: var(--typography-lead-6);--prose-table-fontSize: var(--typography-fontSize-sm);--prose-table-margin: var(--typography-verticalMargin-base) 0;--prose-hr-margin: var(--typography-verticalMargin-base) 0;--prose-li-margin: var(--typography-verticalMargin-sm) 0;--prose-ol-margin: var(--typography-verticalMargin-base) 0;--prose-ul-margin: var(--typography-verticalMargin-base) 0;--prose-blockquote-margin: var(--typography-verticalMargin-base) 0;--prose-a-code-border-style: var(--prose-a-border-style-static);--prose-a-code-border-width: var(--prose-a-border-width);--prose-a-fontWeight: var(--typography-fontWeight-medium);--prose-img-margin: var(--typography-verticalMargin-base) 0;--prose-strong-fontWeight: var(--typography-fontWeight-semibold);--prose-h6-iconSize: var(--typography-fontSize-base);--prose-h6-fontWeight: var(--typography-fontWeight-semibold);--prose-h6-lineHeight: var(--typography-lead-normal);--prose-h6-fontSize: var(--typography-fontSize-lg);--prose-h5-iconSize: var(--typography-fontSize-lg);--prose-h5-fontWeight: var(--typography-fontWeight-semibold);--prose-h5-lineHeight: var(--typography-lead-snug);--prose-h5-fontSize: var(--typography-fontSize-xl);--prose-h4-iconSize: var(--typography-fontSize-lg);--prose-h4-letterSpacing: var(--typography-letterSpacing-tight);--prose-h4-fontWeight: var(--typography-fontWeight-semibold);--prose-h4-lineHeight: var(--typography-lead-snug);--prose-h4-fontSize: var(--typography-fontSize-2xl);--prose-h3-iconSize: var(--typography-fontSize-xl);--prose-h3-letterSpacing: var(--typography-letterSpacing-tight);--prose-h3-fontWeight: var(--typography-fontWeight-semibold);--prose-h3-lineHeight: var(--typography-lead-snug);--prose-h3-fontSize: var(--typography-fontSize-3xl);--prose-h2-iconSize: var(--typography-fontSize-2xl);--prose-h2-letterSpacing: var(--typography-letterSpacing-tight);--prose-h2-fontWeight: var(--typography-fontWeight-semibold);--prose-h2-lineHeight: var(--typography-lead-tight);--prose-h2-fontSize: var(--typography-fontSize-4xl);--prose-h1-iconSize: var(--typography-fontSize-3xl);--prose-h1-letterSpacing: var(--typography-letterSpacing-tight);--prose-h1-fontWeight: var(--typography-fontWeight-bold);--prose-h1-lineHeight: var(--typography-lead-tight);--prose-h1-fontSize: var(--typography-fontSize-5xl);--prose-p-br-margin: var(--typography-verticalMargin-base) 0 0 0;--prose-p-margin: var(--typography-verticalMargin-base) 0;--prose-p-lineHeight: var(--typography-lead-normal);--typography-color-primary-900: var(--color-primary-900);--typography-color-primary-800: var(--color-primary-800);--typography-color-primary-700: var(--color-primary-700);--typography-color-primary-600: var(--color-primary-600);--typography-color-primary-500: var(--color-primary-500);--typography-color-primary-400: var(--color-primary-400);--typography-color-primary-300: var(--color-primary-300);--typography-color-primary-200: var(--color-primary-200);--typography-color-primary-100: var(--color-primary-100);--typography-color-primary-50: var(--color-primary-50);--typography-font-code: var(--font-mono);--typography-font-body: var(--font-sans);--typography-font-display: var(--font-sans);--typography-body-backgroundColor: var(--color-white);--typography-body-color: var(--color-black);--elements-state-danger-borderColor-secondary: var(--color-red-200);--elements-state-danger-borderColor-primary: var(--color-red-100);--elements-state-danger-backgroundColor-secondary: var(--color-red-100);--elements-state-danger-backgroundColor-primary: var(--color-red-50);--elements-state-danger-color-secondary: var(--color-red-600);--elements-state-danger-color-primary: var(--color-red-500);--elements-state-warning-borderColor-secondary: var(--color-yellow-200);--elements-state-warning-borderColor-primary: var(--color-yellow-100);--elements-state-warning-backgroundColor-secondary: var(--color-yellow-100);--elements-state-warning-backgroundColor-primary: var(--color-yellow-50);--elements-state-warning-color-secondary: var(--color-yellow-700);--elements-state-warning-color-primary: var(--color-yellow-600);--elements-state-success-borderColor-secondary: var(--color-green-200);--elements-state-success-borderColor-primary: var(--color-green-100);--elements-state-success-backgroundColor-secondary: var(--color-green-100);--elements-state-success-backgroundColor-primary: var(--color-green-50);--elements-state-success-color-secondary: var(--color-green-600);--elements-state-success-color-primary: var(--color-green-500);--elements-state-info-borderColor-secondary: var(--color-blue-200);--elements-state-info-borderColor-primary: var(--color-blue-100);--elements-state-info-backgroundColor-secondary: var(--color-blue-100);--elements-state-info-backgroundColor-primary: var(--color-blue-50);--elements-state-info-color-secondary: var(--color-blue-600);--elements-state-info-color-primary: var(--color-blue-500);--elements-state-primary-borderColor-secondary: var(--color-primary-200);--elements-state-primary-borderColor-primary: var(--color-primary-100);--elements-state-primary-backgroundColor-secondary: var(--color-primary-100);--elements-state-primary-backgroundColor-primary: var(--color-primary-50);--elements-state-primary-color-secondary: var(--color-primary-700);--elements-state-primary-color-primary: var(--color-primary-600);--elements-surface-secondary-backgroundColor: var(--color-gray-200);--elements-surface-primary-backgroundColor: var(--color-gray-100);--elements-surface-background-base: var(--color-gray-100);--elements-border-secondary-static: var(--color-gray-200);--elements-border-primary-hover: var(--color-gray-200);--elements-border-primary-static: var(--color-gray-100);--elements-container-padding-md: var(--space-16);--elements-container-padding-sm: var(--space-12);--elements-container-padding-xs: var(--space-8);--elements-container-padding-mobile: var(--space-6);--elements-text-secondary-color-hover: var(--color-gray-700);--elements-text-secondary-color-static: var(--color-gray-500);--elements-text-primary-color-static: var(--color-gray-900);--text-6xl-lineHeight: var(--lead-none);--text-6xl-fontSize: var(--fontSize-6xl);--text-5xl-lineHeight: var(--lead-none);--text-5xl-fontSize: var(--fontSize-5xl);--text-4xl-lineHeight: var(--lead-10);--text-4xl-fontSize: var(--fontSize-4xl);--text-3xl-lineHeight: var(--lead-9);--text-3xl-fontSize: var(--fontSize-3xl);--text-2xl-lineHeight: var(--lead-8);--text-2xl-fontSize: var(--fontSize-2xl);--text-xl-lineHeight: var(--lead-7);--text-xl-fontSize: var(--fontSize-xl);--text-lg-lineHeight: var(--lead-7);--text-lg-fontSize: var(--fontSize-lg);--text-base-lineHeight: var(--lead-6);--text-base-fontSize: var(--fontSize-base);--text-sm-lineHeight: var(--lead-5);--text-sm-fontSize: var(--fontSize-sm);--text-xs-lineHeight: var(--lead-4);--text-xs-fontSize: var(--fontSize-xs);--shadow-2xl: 0px 25px 50px -12px var(--color-gray-900);--shadow-xl: 0px 20px 25px -5px var(--color-gray-400), 0px 8px 10px -6px #000000;--color-secondary-900: var(--color-gray-900);--color-secondary-800: var(--color-gray-800);--color-secondary-700: var(--color-gray-700);--color-secondary-600: var(--color-gray-600);--color-secondary-500: var(--color-gray-500);--color-secondary-400: var(--color-gray-400);--color-secondary-300: var(--color-gray-300);--color-secondary-200: var(--color-gray-200);--color-secondary-100: var(--color-gray-100);--color-secondary-50: var(--color-gray-50);--prose-a-code-background-hover: var(--typography-color-primary-50);--prose-a-code-border-color-hover: var(--typography-color-primary-500);--prose-a-color-hover: var(--typography-color-primary-500);--typography-color-secondary-900: var(--color-secondary-900);--typography-color-secondary-800: var(--color-secondary-800);--typography-color-secondary-700: var(--color-secondary-700);--typography-color-secondary-600: var(--color-secondary-600);--typography-color-secondary-500: var(--color-secondary-500);--typography-color-secondary-400: var(--color-secondary-400);--typography-color-secondary-300: var(--color-secondary-300);--typography-color-secondary-200: var(--color-secondary-200);--typography-color-secondary-100: var(--color-secondary-100);--typography-color-secondary-50: var(--color-secondary-50);--prose-code-inline-backgroundColor: var(--typography-color-secondary-100);--prose-code-inline-color: var(--typography-color-secondary-700);--prose-code-block-backgroundColor: var(--typography-color-secondary-100);--prose-code-block-color: var(--typography-color-secondary-700);--prose-code-block-border-color: var(--typography-color-secondary-200);--prose-tbody-tr-borderBottom-color: var(--typography-color-secondary-200);--prose-th-color: var(--typography-color-secondary-600);--prose-thead-borderBottom-color: var(--typography-color-secondary-200);--prose-thead-border-color: var(--typography-color-secondary-300);--prose-hr-color: var(--typography-color-secondary-200);--prose-blockquote-border-color: var(--typography-color-secondary-200);--prose-blockquote-color: var(--typography-color-secondary-500);--prose-a-code-border-color-static: var(--typography-color-secondary-400); } }@media { :root.dark {--pinceau-mq: dark; --alpine-backdrop-backgroundColor: #18181bb3;--prose-code-block-backdropFilter: contrast(1);--prose-ol-li-markerColor: currentColor;--prose-ul-li-markerColor: currentColor;--prose-a-code-color-hover: currentColor;--prose-a-code-color-static: currentColor;--prose-a-border-color-hover: currentColor;--prose-a-border-color-static: currentColor;--prose-a-color-static: inherit;--elements-backdrop-background: #0c0d0ccc;--alpine-body-color: var(--color-gray-200);--alpine-body-backgroundColor: var(--color-black);--typography-body-backgroundColor: var(--color-black);--typography-body-color: var(--color-white);--elements-state-danger-borderColor-secondary: var(--color-red-700);--elements-state-danger-borderColor-primary: var(--color-red-800);--elements-state-danger-backgroundColor-secondary: var(--color-red-800);--elements-state-danger-backgroundColor-primary: var(--color-red-900);--elements-state-danger-color-secondary: var(--color-red-200);--elements-state-danger-color-primary: var(--color-red-300);--elements-state-warning-borderColor-secondary: var(--color-yellow-700);--elements-state-warning-borderColor-primary: var(--color-yellow-800);--elements-state-warning-backgroundColor-secondary: var(--color-yellow-800);--elements-state-warning-backgroundColor-primary: var(--color-yellow-900);--elements-state-warning-color-secondary: var(--color-yellow-200);--elements-state-warning-color-primary: var(--color-yellow-400);--elements-state-success-borderColor-secondary: var(--color-green-700);--elements-state-success-borderColor-primary: var(--color-green-800);--elements-state-success-backgroundColor-secondary: var(--color-green-800);--elements-state-success-backgroundColor-primary: var(--color-green-900);--elements-state-success-color-secondary: var(--color-green-200);--elements-state-success-color-primary: var(--color-green-400);--elements-state-info-borderColor-secondary: var(--color-blue-700);--elements-state-info-borderColor-primary: var(--color-blue-800);--elements-state-info-backgroundColor-secondary: var(--color-blue-800);--elements-state-info-backgroundColor-primary: var(--color-blue-900);--elements-state-info-color-secondary: var(--color-blue-200);--elements-state-info-color-primary: var(--color-blue-400);--elements-state-primary-borderColor-secondary: var(--color-primary-700);--elements-state-primary-borderColor-primary: var(--color-primary-800);--elements-state-primary-backgroundColor-secondary: var(--color-primary-800);--elements-state-primary-backgroundColor-primary: var(--color-primary-900);--elements-state-primary-color-secondary: var(--color-primary-200);--elements-state-primary-color-primary: var(--color-primary-400);--elements-surface-secondary-backgroundColor: var(--color-gray-800);--elements-surface-primary-backgroundColor: var(--color-gray-900);--elements-surface-background-base: var(--color-gray-900);--elements-border-secondary-static: var(--color-gray-800);--elements-border-primary-hover: var(--color-gray-800);--elements-border-primary-static: var(--color-gray-900);--elements-text-secondary-color-hover: var(--color-gray-200);--elements-text-secondary-color-static: var(--color-gray-400);--elements-text-primary-color-static: var(--color-gray-50);--prose-a-code-background-hover: var(--typography-color-primary-900);--prose-a-code-border-color-hover: var(--typography-color-primary-600);--prose-a-color-hover: var(--typography-color-primary-400);--prose-code-inline-backgroundColor: var(--typography-color-secondary-800);--prose-code-inline-color: var(--typography-color-secondary-200);--prose-code-block-backgroundColor: var(--typography-color-secondary-900);--prose-code-block-color: var(--typography-color-secondary-200);--prose-code-block-border-color: var(--typography-color-secondary-800);--prose-tbody-tr-borderBottom-color: var(--typography-color-secondary-800);--prose-th-color: var(--typography-color-secondary-400);--prose-thead-borderBottom-color: var(--typography-color-secondary-800);--prose-thead-border-color: var(--typography-color-secondary-600);--prose-hr-color: var(--typography-color-secondary-800);--prose-blockquote-border-color: var(--typography-color-secondary-700);--prose-blockquote-color: var(--typography-color-secondary-400);--prose-a-code-border-color-static: var(--typography-color-secondary-600); } }</style><script>"use strict";(()=>{const a=window,e=document.documentElement,m=["dark","light"],c=window.localStorage.getItem("nuxt-color-mode")||"system";let n=c==="system"?f():c;const l=e.getAttribute("data-color-mode-forced");l&&(n=l),i(n),a["__NUXT_COLOR_MODE__"]={preference:c,value:n,getColorScheme:f,addColorScheme:i,removeColorScheme:d};function i(o){const t=""+o+"",s="";e.classList?e.classList.add(t):e.className+=" "+t,s&&e.setAttribute("data-"+s,o)}function d(o){const t=""+o+"",s="";e.classList?e.classList.remove(t):e.className=e.className.replace(new RegExp(t,"g"),""),s&&e.removeAttribute("data-"+s)}function r(o){return a.matchMedia("(prefers-color-scheme"+o+")")}function f(){if(a.matchMedia&&r("").media!=="not all"){for(const o of m)if(r(":"+o).matches)return o}return"light"}})();
</script></head>
<body ><div id="__nuxt"><div class="container pv-j7afj1 pc-1VyNK9 app-layout" data-v-a9d5dfed data-v-77841c0a><!--[--><div class="nuxt-progress" style="width:0%;height:3px;opacity:0;background-size:Infinity% auto;" data-v-a9d5dfed></div><header class="right" data-v-a9d5dfed data-v-0528598b><div class="menu" data-v-0528598b><button aria-label="Navigation Menu" data-v-0528598b><svg width="24" height="24" viewBox="0 0 68 68" fill="currentColor" xmlns="http://www.w3.org/2000/svg" data-v-0528598b><path d="M8 34C8 32.1362 8 31.2044 8.30448 30.4693C8.71046 29.4892 9.48915 28.7105 10.4693 28.3045C11.2044 28 12.1362 28 14 28C15.8638 28 16.7956 28 17.5307 28.3045C18.5108 28.7105 19.2895 29.4892 19.6955 30.4693C20 31.2044 20 32.1362 20 34C20 35.8638 20 36.7956 19.6955 37.5307C19.2895 38.5108 18.5108 39.2895 17.5307 39.6955C16.7956 40 15.8638 40 14 40C12.1362 40 11.2044 40 10.4693 39.6955C9.48915 39.2895 8.71046 38.5108 8.30448 37.5307C8 36.7956 8 35.8638 8 34Z" data-v-0528598b></path><path d="M28 34C28 32.1362 28 31.2044 28.3045 30.4693C28.7105 29.4892 29.4892 28.7105 30.4693 28.3045C31.2044 28 32.1362 28 34 28C35.8638 28 36.7956 28 37.5307 28.3045C38.5108 28.7105 39.2895 29.4892 39.6955 30.4693C40 31.2044 40 32.1362 40 34C40 35.8638 40 36.7956 39.6955 37.5307C39.2895 38.5108 38.5108 39.2895 37.5307 39.6955C36.7956 40 35.8638 40 34 40C32.1362 40 31.2044 40 30.4693 39.6955C29.4892 39.2895 28.7105 38.5108 28.3045 37.5307C28 36.7956 28 35.8638 28 34Z" data-v-0528598b></path><path d="M48 34C48 32.1362 48 31.2044 48.3045 30.4693C48.7105 29.4892 49.4892 28.7105 50.4693 28.3045C51.2044 28 52.1362 28 54 28C55.8638 28 56.7956 28 57.5307 28.3045C58.5108 28.7105 59.2895 29.4892 59.6955 30.4693C60 31.2044 60 32.1362 60 34C60 35.8638 60 36.7956 59.6955 37.5307C59.2895 38.5108 58.5108 39.2895 57.5307 39.6955C56.7956 40 55.8638 40 54 40C52.1362 40 51.2044 40 50.4693 39.6955C49.4892 39.2895 48.7105 38.5108 48.3045 37.5307C48 36.7956 48 35.8638 48 34Z" data-v-0528598b></path></svg></button></div><div class="overlay" data-v-0528598b><nav data-v-0528598b data-v-f1645879><ul data-v-f1645879><!--[--><li data-v-f1645879><a href="/" class="" data-v-f1645879><span class="underline-fx" data-v-f1645879></span> Home</a></li><li data-v-f1645879><a href="/contact" class="" data-v-f1645879><span class="underline-fx" data-v-f1645879></span> Contact</a></li><li data-v-f1645879><a href="/posts" class="" data-v-f1645879><span class="underline-fx" data-v-f1645879></span> Archive</a></li><!--]--></ul></nav></div><div class="logo" data-v-0528598b><a href="/" class="" data-v-0528598b><img src="/logo-dark.svg" class="dark-img" alt="alpine" width="89" height="31" data-v-0528598b><img src="/logo.svg" class="light-img" alt="alpine" width="89" height="31" data-v-0528598b></a></div><div class="main-nav" data-v-0528598b><nav data-v-0528598b data-v-f1645879><ul data-v-f1645879><!--[--><li data-v-f1645879><a href="/" class="" data-v-f1645879><span class="underline-fx" data-v-f1645879></span> Home</a></li><li data-v-f1645879><a href="/contact" class="" data-v-f1645879><span class="underline-fx" data-v-f1645879></span> Contact</a></li><li data-v-f1645879><a href="/posts" class="" data-v-f1645879><span class="underline-fx" data-v-f1645879></span> Archive</a></li><!--]--></ul></nav></div></header><!--[--><div class="document-driven-page"><main><!--[--><div><h2 id="running-scrapy-in-aws-lambda" data-v-6d609909><a aria-current="page" href="/posts/scrapy-fargate-sls-guide#running-scrapy-in-aws-lambda" class="router-link-active router-link-exact-active" data-v-6d609909><!--[-->Running Scrapy in AWS Lambda<!--]--><!----></a></h2><p data-v-f4c85dbd><!--[-->We will be using the <a href="https://serverless.com/" rel="nofollow" data-v-d83694f9><!--[-->Serverless framework<!--]--></a> in this tutorial, as it&#39;s a good and extendable open-source framework that does much of the gruntwork of serverless applications. <a href="https://scrapy.org/" rel="nofollow" data-v-d83694f9><!--[-->Scrapy<!--]--></a> is a Python framework, also leading and open-source, with all the benefits that come from using a mature framework. Since only <a href="https://aws.amazon.com/" rel="nofollow" data-v-d83694f9><!--[-->Amazon Web Services<!--]--></a> (AWS) of the major cloud platforms support Python in serverless functions, it&#39;s a natural choice that can&#39;t go wrong since AWS has solutions for just about everything.<!--]--></p><p data-v-f4c85dbd><!--[-->The code used in this guide can be found on <a href="https://github.com/viktorfa/scrapy-fargate-sls-guide" rel="nofollow" data-v-d83694f9><!--[-->github.com/viktorfa/scrapy-fargate-sls-guide<!--]--></a>.<!--]--></p><h3 id="requirements" data-v-4af47174><a aria-current="page" href="/posts/scrapy-fargate-sls-guide#requirements" class="router-link-active router-link-exact-active" data-v-4af47174><!--[-->Requirements<!--]--><!----></a></h3><p data-v-f4c85dbd><!--[-->It&#39;s assumed that the reader is somewhat familiar with Scrapy and has the ability to work with the command line. Several programs need to be installed to complete this guide. An AWS account with billing enabled is necessary (although the resulting bill from completing the guide is in order of single digit cents).<!--]--></p><p data-v-f4c85dbd><!--[-->Command line tools used:<!--]--></p><ul data-v-b9ad2675><!--[--><li data-v-3181147b><!--[-->virtualenv*<!--]--></li><li data-v-3181147b><!--[-->git*<!--]--></li><li data-v-3181147b><!--[-->npm<!--]--></li><li data-v-3181147b><!--[-->pip<!--]--></li><li data-v-3181147b><!--[-->make<!--]--></li><li data-v-3181147b><!--[-->docker<!--]--></li><li data-v-3181147b><!--[-->aws<!--]--></li><!--]--></ul><p data-v-f4c85dbd><!--[-->* recommended, but not necessary<!--]--></p><h3 id="result" data-v-4af47174><a aria-current="page" href="/posts/scrapy-fargate-sls-guide#result" class="router-link-active router-link-exact-active" data-v-4af47174><!--[-->Result<!--]--><!----></a></h3><p data-v-f4c85dbd><!--[-->Completing this guide will result with the basics of a scalable and maintainable scraper infrastructure following the <em data-v-4353b993><!--[-->serverless<!--]--></em> paradigm with all its advantages such as low initial cost and infrastructure as code deployment. The resulting artifact will be extended in a similar fashion with a data processing pipeline in future guides.<!--]--></p><h2 id="setting-up-a-crawler" data-v-6d609909><a aria-current="page" href="/posts/scrapy-fargate-sls-guide#setting-up-a-crawler" class="router-link-active router-link-exact-active" data-v-6d609909><!--[-->Setting up a crawler<!--]--><!----></a></h2><p data-v-f4c85dbd><!--[-->We start by making a simple Scrapy crawler that can run from a script locally, and move thinfs gradually from there.<!--]--></p><h3 id="creating-the-scraper" data-v-4af47174><a aria-current="page" href="/posts/scrapy-fargate-sls-guide#creating-the-scraper" class="router-link-active router-link-exact-active" data-v-4af47174><!--[-->Creating the scraper<!--]--><!----></a></h3><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">python</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -v</span><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"> # Should have python3.7
</span></span><span class="line" line="2"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">pip</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> install</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> Scrapy
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">mkdir</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> scrapy-serverless</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8"> &amp;&amp; </span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF">cd</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> $_
</span></span><span class="line" line="2"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">scrapy</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> startproject</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> my_sls_scraper</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> scraper
</span></span><span class="line" line="3"><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF">cd</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> scraper
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->All the code of this guide will be in the <code class="" data-v-69006e27><!--[-->scrapy-serverless/scraper<!--]--></code> folder, but other modules will be added in the <code class="" data-v-69006e27><!--[-->scrapy-serverless<!--]--></code> folder in future guides.<!--]--></p><p data-v-f4c85dbd><!--[-->We will use the default Scrapy project structure. Create a simple spider in the <code class="" data-v-69006e27><!--[-->spiders<!--]--></code> module.<!--]--></p><div class="highlight-python prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-python" style=""><!--[--><code># my_sls_scraper/spiders/header_spider.py
from scrapy.spiders import CrawlSpider, Rule
from scrapy.linkextractors import LinkExtractor


class HeaderSpider(CrawlSpider):
    name = &quot;header_spider&quot;

    start_urls = [&quot;https://scrapy.org&quot;]
    allowed_domains = [&quot;scrapy.org&quot;]
    rules = [  # Get all links on start url
        Rule(
            link_extractor=LinkExtractor(
                deny=r&quot;\?&quot;,
            ),
            follow=False,
            callback=&quot;parse_page&quot;,
        )
    ]

    def parse_start_url(self, response):
        return self.parse_page(response)

    def parse_page(self, response):
        header = response.css(&quot;h1, h2&quot;).extract_first(
        ) or response.css(&quot;title&quot;).extract_first() or response.url
        return {
            &quot;header&quot;: remove_tags(header),
            &quot;url&quot;: response.url,
        }
</code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->Also add the following to the settings in <code class="" data-v-69006e27><!--[-->my_sls_scraper/settings.py<!--]--></code><!--]--></p><div class="highlight-python prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-python" style=""><!--[--><code># my_sls_scraper/settings.py
# ...
HTTPCACHE_ENABLED = True
HTTPCACHE_EXPIRATION_SECS = 60 * 60 * 24 * 7
HTTPCACHE_DIR = &#39;httpcache&#39;
CLOSESPIDER_PAGECOUNT = 32
</code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->Test that the spider is working by running the crawler and printing the output<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">scrapy</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> crawl</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> header_spider</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> --output</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> &quot;feed/%(name)s-%(time)s.json&quot;</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> --output-format</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> json
</span></span><span class="line" line="2"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">cat</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> feed/$(</span><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">ls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> feed </span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF">-q</span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583"> |</span><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0"> tail</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -1</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">)
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->You should see a json feed in <code class="" data-v-69006e27><!--[-->feed/header_spider-&lt;time string&gt;.json<!--]--></code> with the scraped data.<!--]--></p><p data-v-f4c85dbd><!--[-->Next, we create files to launch the scraper from a script, which will be needed in Lambda and Fargate. We&#39;ll create 2 new files to make this work in different scenarios, <code class="" data-v-69006e27><!--[-->launcher.py<!--]--></code> and <code class="" data-v-69006e27><!--[-->my_sls_scraper/crawl.py<!--]--></code>.<!--]--></p><div class="highlight-python prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-python" style=""><!--[--><code># my_sls_scraper/crawl.py
import sys
import imp
import os
import logging
from urllib.parse import urlparse

from scrapy.spiderloader import SpiderLoader
from scrapy.crawler import CrawlerProcess
from scrapy.utils.project import get_project_settings

# Need to &quot;mock&quot; sqlite for the process to not crash in AWS Lambda / Amazon Linux
sys.modules[&quot;sqlite&quot;] = imp.new_module(&quot;sqlite&quot;)
sys.modules[&quot;sqlite3.dbapi2&quot;] = imp.new_module(&quot;sqlite.dbapi2&quot;)


def is_in_aws():
    return os.getenv(&#39;AWS_EXECUTION_ENV&#39;) is not None


def crawl(settings={}, spider_name=&quot;header_spider&quot;, spider_kwargs={}):
    project_settings = get_project_settings()
    spider_loader = SpiderLoader(project_settings)

    spider_cls = spider_loader.load(spider_name)

    feed_uri = &quot;&quot;
    feed_format = &quot;json&quot;

    try:
        spider_key = urlparse(spider_kwargs.get(&quot;start_urls&quot;)[0]).hostname if spider_kwargs.get(
            &quot;start_urls&quot;) else urlparse(spider_cls.start_urls[0]).hostname
    except Exception:
        logging.exception(&quot;Spider or kwargs need start_urls.&quot;)

    if is_in_aws():
        # Lambda can only write to the /tmp folder.
        settings[&#39;HTTPCACHE_DIR&#39;] =  &quot;/tmp&quot;
    else:
        feed_uri = &quot;file://{}/%(name)s-{}-%(time)s.json&quot;.format(
            os.path.join(os.getcwd(), &quot;feed&quot;),
            spider_key,
        )

    settings[&#39;FEED_URI&#39;] = feed_uri
    settings[&#39;FEED_FORMAT&#39;] = feed_format

    process = CrawlerProcess({**project_settings, **settings})

    process.crawl(spider_cls, **spider_kwargs)
    process.start()
</code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><div class="highlight-python prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-python" style=""><!--[--><code># launcher.py&#39;
import sys
import json

from my_sls_scraper.crawl import crawl


def scrape(event={}, context={}):
    crawl(**event)


if __name__ == &quot;__main__&quot;:
    try:
        event = json.loads(sys.argv[1])
    except IndexError:
        event = {}
    scrape(event)
</code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->Check that you can scrape by executing <code class="" data-v-69006e27><!--[-->launcher.py<!--]--></code> with<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">python</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> launcher.py
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->If that works, the scraper is pretty much done, and we&#39;ll spend the rest of the guide on AWS and Serverless stuff.<!--]--></p><h2 id="setting-up-an-aws-lambda-function" data-v-6d609909><a aria-current="page" href="/posts/scrapy-fargate-sls-guide#setting-up-an-aws-lambda-function" class="router-link-active router-link-exact-active" data-v-6d609909><!--[-->Setting up an AWS Lambda function<!--]--><!----></a></h2><p data-v-f4c85dbd><!--[-->Initialize serverless in the same directory as <code class="" data-v-69006e27><!--[-->scrapy.cfg<!--]--></code> with<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">serverless</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> create</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> --template</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> aws-python3</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> --name</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> my-sls-scraper
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->You need to have an AWS account and created an IAM admin user to work with Serverless. If you haven&#39;t follow the steps on <a href="https://serverless.com/framework/docs/providers/aws/guide/credentials/" rel="nofollow" data-v-d83694f9><!--[-->this guide<!--]--></a> to get started. I like using aws profiles where you store the credentials in <code class="" data-v-69006e27><!--[-->~/.aws/credentials<!--]--></code>, but see the link for what works best for you.<!--]--></p><p data-v-f4c85dbd><!--[-->If you&#39;re not familiar with AWS and Serverless, you will run into many weird issues that are hard to debug. To mitigate that, deploy the function for every change you make in the configuration of Serverless and the scraper to make it easier to identify what causes things to break.<!--]--></p><p data-v-f4c85dbd><!--[-->We&#39;ll start by deploying the dummy default Lambda function. Do it with<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> deploy</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -f</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> hello
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->If you use aws profiles for credentials and you have a profile called <code class="" data-v-69006e27><!--[-->my-sls-admin<!--]--></code>, you can deploy with<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> deploy</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -f</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> hello</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> --aws-profile</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> my-sls-admin
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->or add the profile key under provider in <code class="" data-v-69006e27><!--[-->serverless.yml<!--]--></code>.<!--]--></p><div class="highlight-yaml prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-yaml shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># serverless.yml
</span></span><span class="line" line="2"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># ...
</span></span><span class="line" line="3"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">provider</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="4"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  name</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">aws
</span></span><span class="line" line="5"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">runtime</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">python3.7
</span></span><span class="line" line="6"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">profile</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">my-sls-admin
</span></span><span class="line" line="7"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># ...
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->When deploying, the output should be similar to<!--]--></p><div class="highlight-null prose-code" data-v-ef0b30fc><!----><!--[--><pre class="" style=""><!--[--><code>11:40 $ sls deploy
Serverless: Packaging service...
Serverless: Excluding development dependencies...
Serverless: Creating Stack...
Serverless: Checking Stack create progress...
.....
Serverless: Stack create finished...
Serverless: Uploading CloudFormation file to S3...
Serverless: Uploading artifacts...
Serverless: Uploading service my-sls-scraper.zip file to S3 (162.74 KB)...
Serverless: Validating template...
Serverless: Updating Stack...
Serverless: Checking Stack update progress...
...............
Serverless: Stack update finished...
Service Information
service: my-sls-scraper
stage: dev
region: us-east-1
stack: my-sls-scraper-dev
resources: 5
api keys:
  None
endpoints:
  None
functions:
  hello: my-sls-scraper-dev-hello
layers:
  None
Serverless: Run the &quot;serverless&quot; command to setup monitoring, troubleshooting and testing.
</code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->You should now see the deployed function in the <a href="https://console.aws.amazon.com/lambda/home" rel="nofollow" data-v-d83694f9><!--[-->AWS Lambda web console<!--]--></a>. (Change your region if you don&#39;t see it!)<!--]--></p><p data-v-f4c85dbd><!--[-->Verify that the function can be invoked and see its output with<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> invoke</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -f</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> hello</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> --log
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->The output should be something like<!--]--></p><div class="highlight-null prose-code" data-v-ef0b30fc><!----><!--[--><pre class="" style=""><!--[--><code>12:12 $ sls invoke -f hello --log
{
    &quot;statusCode&quot;: 200,
    &quot;body&quot;: &quot;{\&quot;message\&quot;: \&quot;Go Serverless v1.0! Your function executed successfully!\&quot;, \&quot;input\&quot;: {}}&quot;
}
--------------------------------------------------------------------
START RequestId: f38a0d84-e974-4a00-93ab-9e2825d94003 Version: $LATEST
END RequestId: f38a0d84-e974-4a00-93ab-9e2825d94003
REPORT RequestId: f38a0d84-e974-4a00-93ab-9e2825d94003  Duration: 1.62 ms   Billed Duration: 100 ms Memory Size: 1024 MB    Max Memory Used: 56 MB  Init Duration: 110.34 ms

XRAY TraceId: 1-5d723275-c57192d30e2a524902b401fd   SegmentId: 5cc7e2685a1e85bc Sampled: false
</code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->Now we&#39;ll need to package the function in a way that includes all the dependencies. Install the <code class="" data-v-69006e27><!--[-->serverless-python-requirements<!--]--></code> plugin with<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> plugin</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> install</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> --name</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> serverless-python-requirements
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->And rehaul <code class="" data-v-69006e27><!--[-->serverless.yml<!--]--></code>.<!--]--></p><div class="highlight-yaml prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-yaml shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># serverless.yml
</span></span><span class="line" line="2"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">service</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">my-sls-scraper
</span></span><span class="line" line="3"><span emptylineplaceholder="true">
</span></span><span class="line" line="4"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">provider</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="5"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  name</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">aws
</span></span><span class="line" line="6"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  runtime</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">python3.7
</span></span><span class="line" line="7"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  logRetentionInDays</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF">1
</span></span><span class="line" line="8"><span emptylineplaceholder="true">
</span></span><span class="line" line="9"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">functions</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="10"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  hello</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="11"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    handler</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">handler.hello
</span></span><span class="line" line="12"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  lambdaScrape</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="13"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    handler</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">launcher.scrape
</span></span><span class="line" line="14"><span emptylineplaceholder="true">
</span></span><span class="line" line="15"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># We include files by whitelisting to reduce the deployment time.
</span></span><span class="line" line="16"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># Just remember to add any files you create!
</span></span><span class="line" line="17"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">package</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="18"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  include</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="19"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">    - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">handler.py
</span></span><span class="line" line="20"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">    - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">launcher.py
</span></span><span class="line" line="21"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">    - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">my_sls_scraper/**
</span></span><span class="line" line="22"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">    - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">scrapy.cfg
</span></span><span class="line" line="23"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  exclude</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="24"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">    - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;./**&quot;
</span></span><span class="line" line="25"><span emptylineplaceholder="true">
</span></span><span class="line" line="26"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">plugins</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="27"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">  - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">serverless-python-requirements
</span></span><span class="line" line="28"><span emptylineplaceholder="true">
</span></span><span class="line" line="29"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">custom</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="30"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  pythonRequirements</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="31"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    slim</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF">true</span><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"> # Omits tests, __pycache__, *.pyc etc from dependencies
</span></span><span class="line" line="32"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    fileName</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">requirements.txt
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->Note that we added a new function <code class="" data-v-69006e27><!--[-->lambdaScrape<!--]--></code> that does the scraping in the Lambda function.<!--]--></p><p data-v-f4c85dbd><!--[-->We also need a minimal <code class="" data-v-69006e27><!--[-->requirements.txt<!--]--></code> for pip requirements.<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># requirements.txt
</span></span><span class="line" line="2"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">Scrapy</span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">=</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF">1.7</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">.3
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->Try to deploy the function again and see that it works.<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> deploy</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> --verbose
</span></span><span class="line" line="2"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> invoke</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -f</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> hello</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> --log
</span></span><span class="line" line="3"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> invoke</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -f</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> lambdaScrape</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> --log
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->We&#39;ve now created the minimal solution for serverless scraping – well done! In the rest of the guide we&#39;ll set up more resources in the AWS platform to store the scraped data and run long crawls in Fargate instead of Lambda.<!--]--></p><h2 id="storing-scraped-data-in-s3" data-v-6d609909><a aria-current="page" href="/posts/scrapy-fargate-sls-guide#storing-scraped-data-in-s3" class="router-link-active router-link-exact-active" data-v-6d609909><!--[-->Storing scraped data in S3<!--]--><!----></a></h2><p data-v-f4c85dbd><!--[-->Storing the scraped data in S3 gives us a low-cost repository for spider outputs which can be used to further process the data. We will use the config in <code class="" data-v-69006e27><!--[-->serverless.yml<!--]--></code> and CloudFormation templates to create and use resources in the AWS ecosystem, so that we follow the <em data-v-4353b993><!--[-->infrastructure as code<!--]--></em> paradigm.<!--]--></p><p data-v-f4c85dbd><!--[-->Before we continue, let&#39;s install a useful plugin that lets us use <code class="" data-v-69006e27><!--[-->!Sub<!--]--></code> commands in out templates called <code class="" data-v-69006e27><!--[-->serverless-cloudformation-sub-variables<!--]--></code> and add it to our <code class="" data-v-69006e27><!--[-->serverless.yml<!--]--></code> with<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> plugin</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> install</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> --name</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> serverless-cloudformation-sub-variables
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->Let&#39;s create the templates in a separate file called <code class="" data-v-69006e27><!--[-->s3-template.yml<!--]--></code> as the template will get quite large later.<!--]--></p><div class="highlight-yaml prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-yaml shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># s3-template.yml
</span></span><span class="line" line="2"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Resources</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="3"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  ScraperFeedBucket</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="4"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">AWS::S3::Bucket
</span></span><span class="line" line="5"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Properties</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="6"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      VersioningConfiguration</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="7"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">        Status</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;Enabled&quot;
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->We have to set up permissions in <code class="" data-v-69006e27><!--[-->serverless.yml<!--]--></code>, import the template file, and pass the bucket name in an environment variable to our Lambda function.
Add the following IAM role statement and environment variable<!--]--></p><div class="highlight-yaml prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-yaml shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># serverless.yml
</span></span><span class="line" line="2"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">provider</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="3"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D">    # ...
</span></span><span class="line" line="4"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    environment</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="5"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">        FEED_BUCKET_NAME</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> ScraperFeedBucket
</span></span><span class="line" line="6"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    iamRoleStatements</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="7"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Effect</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;Allow&quot;
</span></span><span class="line" line="8"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">          Action</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="9"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">            - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;s3:PutObject&quot;
</span></span><span class="line" line="10"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">          Resource</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Sub
</span></span><span class="line" line="11"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">            - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;arn:aws:s3:::#{BucketName}/*&quot;
</span></span><span class="line" line="12"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">            - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">BucketName</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> ScraperFeedBucket
</span></span><span class="line" line="13"><span emptylineplaceholder="true">
</span></span><span class="line" line="14"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">resources</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="15"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">  - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">AWSTemplateFormatVersion</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;2010-09-09&quot;
</span></span><span class="line" line="16"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Transform</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;AWS::Serverless-2016-10-31&quot;
</span></span><span class="line" line="17"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">  - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">${file(./s3-template.yml)}
</span></span><span class="line" line="18"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># ...
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->You can check that your configuration doesn&#39;t contain syntax errors with<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> package
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->but the only way to check that your CloudFormation templates are valid on your current stack is to deploy it.
Before deploying, let&#39;s configure the crawler to store the output in S3.<!--]--></p><div class="highlight-python prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-python" style=""><!--[--><code># my_sls_scraper/crawl.py
def  crawl(settings={}, spider_name=&quot;header_spider&quot;, spider_kwargs={}):
    # ...
    if is_in_aws():
        # Lambda can only write to the /tmp folder.
        settings[&#39;HTTPCACHE_DIR&#39;] = &quot;/tmp&quot;
        feed_uri = f&quot;s3://{os.getenv(&#39;FEED_BUCKET_NAME&#39;)}/%(name)s-{spider_key}.json&quot;
    # ...
</code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->Scrapy uses the AWS library <code class="" data-v-69006e27><!--[-->boto3<!--]--></code> under the hood to store to S3. Inside a Lambda function, boto3 is always available, and credentials are automatically discovered. It will work as long as the IAM Role Statements we configured for the Lambda function are correct.
We don&#39;t need to timestamp the file name in S3 with <code class="" data-v-69006e27><!--[-->%(time)s<!--]--></code>, as we configured the bucket to use versioning in our CloudFormation template, which enables us to access old spider outputs by looking at the file history.<!--]--></p><p data-v-f4c85dbd><!--[-->Now, deploy the function and crawl again.<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> deploy</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -v
</span></span><span class="line" line="2"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> invoke</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -f</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> lambdaScrape</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> --log
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->You should now find the feed output in a file if you check your <a href="https://s3.console.aws.amazon.com/s3/home" rel="nofollow" data-v-d83694f9><!--[-->S3 console<!--]--></a>. You should also see some new info has appeared for your function in the <a href="https://console.aws.amazon.com/lambda/home" rel="nofollow" data-v-d83694f9><!--[-->Lambda console<!--]--></a>, like the environment variable and the S3 resource.
While it&#39;s absolutely recommended to set up all resources in CloudFormation templates or other infrastructure as code frameworks, the AWS console web interface is very useful for debugging and inspection.<!--]--></p><h2 id="running-scrapy-in-aws-fargate" data-v-6d609909><a aria-current="page" href="/posts/scrapy-fargate-sls-guide#running-scrapy-in-aws-fargate" class="router-link-active router-link-exact-active" data-v-6d609909><!--[-->Running Scrapy in AWS Fargate<!--]--><!----></a></h2><p data-v-f4c85dbd><!--[-->We now have a crawler that can be run from a script and uses S3 to store its output. We can run it in AWS Lambda, but we are constrained by the 15 minute execution limit.
Lambda is simply not made for long-lasting tasks, but it is possible to run long-lasting crawlers in the serverless paradigm by <em data-v-4353b993><!--[-->containerizing<!--]--></em> our crawler and running it as a task in a managed container service such as AWS Fargate. This means we need to create a <a href="https://www.docker.com/" rel="nofollow" data-v-d83694f9><!--[-->Docker<!--]--></a> image of our crawler, uploading the image to an image repository – we&#39;ll use Amazon Container Registry (ACR), and execute the image in a container as a task in Amazon Container Services (ECS).
I&#39;m dropping a lot of acronyms, and you&#39;ll see even more later. Running containers on AWS may be serverless, but it requires a lot of configuration at the moment.<!--]--></p><h3 id="dockerize-it" data-v-4af47174><a aria-current="page" href="/posts/scrapy-fargate-sls-guide#dockerize-it" class="router-link-active router-link-exact-active" data-v-4af47174><!--[-->Dockerize it<!--]--><!----></a></h3><p data-v-f4c85dbd><!--[-->If you have Docker installed, this is the easy part. Let&#39;s create a <code class="" data-v-69006e27><!--[-->Dockerfile<!--]--></code> to containerize our crawler.<!--]--></p><div class="highlight-docker prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-docker" style=""><!--[--><code>FROM python:3.7

WORKDIR /usr/src/app

COPY scrapy.cfg ./
COPY launcher.py ./
COPY my_sls_scraper ./my_sls_scraper
COPY requirements.txt ./

RUN pip install boto3 --quiet
RUN pip install -r requirements.txt --quiet

CMD [&quot;python3&quot;, &quot;./launcher.py&quot;]
</code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->The docker file is the recipe to put our scraper in an image. Create it and put a tag on it with<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">docker</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> build</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -t</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> my_sls_scraper:latest</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> .
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->You should see an output similar to<!--]--></p><div class="highlight-null prose-code" data-v-ef0b30fc><!----><!--[--><pre class="" style=""><!--[--><code>16:55 $ docker build -t my_sls_scraper:latest .
Sending build context to Docker daemon  15.62MB
Step 1/9 : FROM python:3.7
 ---&gt; 60e318e4984a
Step 2/9 : WORKDIR /usr/src/app
 ---&gt; Using cache
 ---&gt; 0277144c85a9
Step 3/9 : COPY scrapy.cfg ./
 ---&gt; c72f2df3b4d7
Removing intermediate container 80cf0e765353
Step 4/9 : COPY launcher.py ./
 ---&gt; 58e18d409bf5
Removing intermediate container f0726603d5fa
Step 5/9 : COPY my_sls_scraper ./my_sls_scraper
 ---&gt; 2be7fc4a06bb
Removing intermediate container aae59bff188d
Step 6/9 : COPY requirements.txt ./
 ---&gt; 7dbf261f3ade
Removing intermediate container 76033ce2ffe6
Step 7/9 : RUN pip install boto3 --quiet
 ---&gt; Running in 55455a2a4415
 ---&gt; efdc47a54e36
Removing intermediate container 55455a2a4415
Step 8/9 : RUN pip install -r requirements.txt --quiet
 ---&gt; Running in e15817fd1a01
 ---&gt; 84015af5a4ee
Removing intermediate container e15817fd1a01
Step 9/9 : CMD python3 ./launcher.py
 ---&gt; Running in 9c6fe75eb923
 ---&gt; 05a841f9ec00
Removing intermediate container 9c6fe75eb923
Successfully built 05a841f9ec00
Successfully tagged my_sls_scraper:latest
</code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->Now, let&#39;s check that the image works by running it in a container on our machine with<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">docker</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> run</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> my_sls_scraper
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->The crawler should run just like it has before except that the crawl output json file will be stored somewhere inside the Docker container, so you cannot see it.<!--]--></p><h3 id="configure-fargate-on-aws" data-v-4af47174><a aria-current="page" href="/posts/scrapy-fargate-sls-guide#configure-fargate-on-aws" class="router-link-active router-link-exact-active" data-v-4af47174><!--[-->Configure Fargate on AWS<!--]--><!----></a></h3><p data-v-f4c85dbd><!--[-->Let&#39;s see how a complete CloudFormation template for our purpose looks like.<!--]--></p><div class="highlight-yaml prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-yaml shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># fargate-template.yml
</span></span><span class="line" line="2"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Resources</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="3"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  FargateECSCluster</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="4"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;AWS::ECS::Cluster&quot;
</span></span><span class="line" line="5"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Properties</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="6"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      ClusterName</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Sub
</span></span><span class="line" line="7"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;fargate-#{StackName}&quot;
</span></span><span class="line" line="8"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">StackName</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> &quot;AWS::StackName&quot;
</span></span><span class="line" line="9"><span emptylineplaceholder="true">
</span></span><span class="line" line="10"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  FargateLogGroup</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="11"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;AWS::Logs::LogGroup&quot;
</span></span><span class="line" line="12"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Properties</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="13"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      RetentionInDays</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF">1
</span></span><span class="line" line="14"><span emptylineplaceholder="true">
</span></span><span class="line" line="15"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  FargateTaskRole</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="16"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">AWS::IAM::Role
</span></span><span class="line" line="17"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Properties</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="18"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      AssumeRolePolicyDocument</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="19"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">        Version</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;2012-10-17&quot;
</span></span><span class="line" line="20"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">        Statement</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="21"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">          - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Effect</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">Allow
</span></span><span class="line" line="22"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">            Sid</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;ECS&quot;
</span></span><span class="line" line="23"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">            Principal</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="24"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">              Service</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="25"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">                - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">ecs-tasks.amazonaws.com
</span></span><span class="line" line="26"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">            Action</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="27"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">              - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">sts:AssumeRole
</span></span><span class="line" line="28"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      Policies</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="29"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">PolicyName</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">ScraperFeedBucketPolicy
</span></span><span class="line" line="30"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">          PolicyDocument</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="31"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">            Statement</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="32"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">              - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Effect</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;Allow&quot;
</span></span><span class="line" line="33"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">                Action</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="34"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">                  - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;s3:PutObject&quot;
</span></span><span class="line" line="35"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">                Resource</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Sub
</span></span><span class="line" line="36"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">                  - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;arn:aws:s3:::#{BucketName}/*&quot;
</span></span><span class="line" line="37"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">                  - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">BucketName</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> ScraperFeedBucket
</span></span><span class="line" line="38"><span emptylineplaceholder="true">
</span></span><span class="line" line="39"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  FargateExecutionRole</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="40"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">AWS::IAM::Role
</span></span><span class="line" line="41"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Properties</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="42"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      ManagedPolicyArns</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="43"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
</span></span><span class="line" line="44"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      AssumeRolePolicyDocument</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="45"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">        Version</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;2012-10-17&quot;
</span></span><span class="line" line="46"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">        Statement</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="47"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">          - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Effect</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">Allow
</span></span><span class="line" line="48"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">            Sid</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;ECS&quot;
</span></span><span class="line" line="49"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">            Principal</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="50"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">              Service</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="51"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">                - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">ecs-tasks.amazonaws.com
</span></span><span class="line" line="52"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">            Action</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="53"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">              - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">sts:AssumeRole
</span></span><span class="line" line="54"><span emptylineplaceholder="true">
</span></span><span class="line" line="55"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  FargateVPC</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="56"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;AWS::EC2::VPC&quot;
</span></span><span class="line" line="57"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Properties</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="58"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      CidrBlock</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">10.10.10.0/24
</span></span><span class="line" line="59"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      Tags</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="60"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Key</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">Name
</span></span><span class="line" line="61"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">          Value</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> &quot;AWS::StackName&quot;
</span></span><span class="line" line="62"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  FargateSubnet</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="63"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;AWS::EC2::Subnet&quot;
</span></span><span class="line" line="64"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Properties</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="65"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      CidrBlock</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">10.10.10.0/24
</span></span><span class="line" line="66"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      VpcId</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateVPC
</span></span><span class="line" line="67"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      Tags</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="68"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Key</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">Name
</span></span><span class="line" line="69"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">          Value</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> &quot;AWS::StackName&quot;
</span></span><span class="line" line="70"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  FargateIGW</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="71"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;AWS::EC2::InternetGateway&quot;
</span></span><span class="line" line="72"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Properties</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="73"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      Tags</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="74"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Key</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">Name
</span></span><span class="line" line="75"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">          Value</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> &quot;AWS::StackName&quot;
</span></span><span class="line" line="76"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  FargateAttachGateway</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="77"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">AWS::EC2::VPCGatewayAttachment
</span></span><span class="line" line="78"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Properties</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="79"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      VpcId</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateVPC
</span></span><span class="line" line="80"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      InternetGatewayId</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateIGW
</span></span><span class="line" line="81"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  FargateRouteTable</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="82"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;AWS::EC2::RouteTable&quot;
</span></span><span class="line" line="83"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Properties</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="84"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      VpcId</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateVPC
</span></span><span class="line" line="85"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      Tags</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="86"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Key</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">Name
</span></span><span class="line" line="87"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">          Value</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> &quot;AWS::StackName&quot;
</span></span><span class="line" line="88"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  FargateRoute</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="89"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;AWS::EC2::Route&quot;
</span></span><span class="line" line="90"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    DependsOn</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">FargateAttachGateway
</span></span><span class="line" line="91"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Properties</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="92"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      RouteTableId</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateRouteTable
</span></span><span class="line" line="93"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      DestinationCidrBlock</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">0.0.0.0/0
</span></span><span class="line" line="94"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      GatewayId</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateIGW
</span></span><span class="line" line="95"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  FargateSubnetRouteTableAssociation</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="96"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">AWS::EC2::SubnetRouteTableAssociation
</span></span><span class="line" line="97"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Properties</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="98"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      RouteTableId</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateRouteTable
</span></span><span class="line" line="99"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      SubnetId</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateSubnet
</span></span><span class="line" line="100"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  FargateSG</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="101"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;AWS::EC2::SecurityGroup&quot;
</span></span><span class="line" line="102"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Properties</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="103"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      GroupDescription</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;Generated by Serverless&quot;
</span></span><span class="line" line="104"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      SecurityGroupIngress</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="105"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">IpProtocol</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF">-1
</span></span><span class="line" line="106"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">          CidrIp</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">127.0.0.1/32
</span></span><span class="line" line="107"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      Tags</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="108"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Key</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">Name
</span></span><span class="line" line="109"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">          Value</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> &quot;AWS::StackName&quot;
</span></span><span class="line" line="110"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      VpcId</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateVPC
</span></span><span class="line" line="111"><span emptylineplaceholder="true">
</span></span><span class="line" line="112"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  FargateECSRepo</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="113"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;AWS::ECR::Repository&quot;
</span></span><span class="line" line="114"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Properties</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="115"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      LifecyclePolicy</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="116"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">        LifecyclePolicyText</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">|
</span></span><span class="line" line="117"><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">          {
</span></span><span class="line" line="118"><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">            &quot;rules&quot;: [
</span></span><span class="line" line="119"><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">            {
</span></span><span class="line" line="120"><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">              &quot;rulePriority&quot;: 1,
</span></span><span class="line" line="121"><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">              &quot;description&quot;: &quot;Only keep 8 images&quot;,
</span></span><span class="line" line="122"><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">              &quot;selection&quot;: {
</span></span><span class="line" line="123"><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">                &quot;tagStatus&quot;: &quot;any&quot;,
</span></span><span class="line" line="124"><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">                &quot;countType&quot;: &quot;imageCountMoreThan&quot;,
</span></span><span class="line" line="125"><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">                &quot;countNumber&quot;: 8
</span></span><span class="line" line="126"><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">              },
</span></span><span class="line" line="127"><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">              &quot;action&quot;: { &quot;type&quot;: &quot;expire&quot; }
</span></span><span class="line" line="128"><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">            }]
</span></span><span class="line" line="129"><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">          }
</span></span><span class="line" line="130"><span emptylineplaceholder="true">
</span></span><span class="line" line="131"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  FargateECSTaskDefinition</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="132"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;AWS::ECS::TaskDefinition&quot;
</span></span><span class="line" line="133"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Properties</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="134"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      Cpu</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF">512
</span></span><span class="line" line="135"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      Memory</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">1GB
</span></span><span class="line" line="136"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      NetworkMode</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">awsvpc
</span></span><span class="line" line="137"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      RequiresCompatibilities</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="138"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;FARGATE&quot;
</span></span><span class="line" line="139"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      ExecutionRoleArn</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!GetAtt</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateExecutionRole.Arn
</span></span><span class="line" line="140"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      TaskRoleArn</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!GetAtt</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateTaskRole.Arn
</span></span><span class="line" line="141"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      ContainerDefinitions</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="142"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Name</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">scraper_container
</span></span><span class="line" line="143"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">          Image</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Sub
</span></span><span class="line" line="144"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">            - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;#{AccountId}.dkr.ecr.#{Region}.amazonaws.com/#{Repo}&quot;
</span></span><span class="line" line="145"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">            - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">AccountId</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> AWS::AccountId
</span></span><span class="line" line="146"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">              Region</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> AWS::Region
</span></span><span class="line" line="147"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">              Repo</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateECSRepo
</span></span><span class="line" line="148"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">          LogConfiguration</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="149"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">            LogDriver</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">awslogs
</span></span><span class="line" line="150"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">            Options</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="151"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">              awslogs-group</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateLogGroup
</span></span><span class="line" line="152"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">              awslogs-region</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> AWS::Region
</span></span><span class="line" line="153"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">              awslogs-stream-prefix</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> AWS::StackName
</span></span><span class="line" line="154"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Outputs</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="155"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  ECRRepo</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="156"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Value</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Sub
</span></span><span class="line" line="157"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">      - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;#{AccountId}.dkr.ecr.#{Region}.amazonaws.com/#{Repo}&quot;
</span></span><span class="line" line="158"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">      - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">AccountId</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> AWS::AccountId
</span></span><span class="line" line="159"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">        Region</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> AWS::Region
</span></span><span class="line" line="160"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">        Repo</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateECSRepo
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->Credit to <a href="https://github.com/jolexa/fargate-from-lambda" rel="nofollow" data-v-d83694f9><!--[-->github.com/jolexa/fargate-from-lambda<!--]--></a> who inspired this CF template.<!--]--></p><p data-v-f4c85dbd><!--[-->Next, we create a file with a handler to start the Fargate task<!--]--></p><div class="highlight-python prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-python" style=""><!--[--><code># launch_fargate.py
import os
import json

import boto3


def launch_fargate(event, context):
    client = boto3.client(&quot;ecs&quot;)

    ECSCluster = os.environ[&quot;ECS_CLUSTER&quot;]
    ECSSecGroup = os.environ[&quot;ECS_SEC_GROUP&quot;]
    ECSSubnet = os.environ[&quot;ECS_SUBNET&quot;]
    ECSTaskArn = os.environ[&quot;ECS_TASK_ARN&quot;]
    CONTAINER_NAME = os.environ[&quot;CONTAINER_NAME&quot;]

    run_task_response = client.run_task(
        cluster=ECSCluster,
        taskDefinition=ECSTaskArn,
        count=1,
        launchType=&quot;FARGATE&quot;,
        overrides={
            &quot;containerOverrides&quot;: [
                {
                    &quot;name&quot;: CONTAINER_NAME,
                    # We override the command so that we can pass some arguments
                    # e.g. for running different spiders.
                    &quot;command&quot;: [
                        &quot;python&quot;,
                        &quot;launcher.py&quot;,
                        json.dumps(event),
                    ],
                    &quot;environment&quot;: [
                        {&quot;name&quot;: &quot;FEED_BUCKET_NAME&quot;, &quot;value&quot;: os.environ[&quot;FEED_BUCKET_NAME&quot;]},
                    ]
                }
            ],
        },
        networkConfiguration={
            &quot;awsvpcConfiguration&quot;: {
                &quot;subnets&quot;: [
                    ECSSubnet,
                ],
                &quot;securityGroups&quot;: [
                    ECSSecGroup,
                ],
                &quot;assignPublicIp&quot;: &quot;ENABLED&quot;
            },
        },
    )
    return json.dumps(run_task_response, default=str)
</code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->We also need to update our <code class="" data-v-69006e27><!--[-->serverless.yml<!--]--></code> to add some new IAM role statemants, import the CloudFormation template in <code class="" data-v-69006e27><!--[-->fargate-cf-yml<!--]--></code>, add some env variables, include the <code class="" data-v-69006e27><!--[-->launch_fargate.py<!--]--></code> file, and finally add a new function for launching a Fargate task.<!--]--></p><div class="highlight-yaml prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-yaml shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># serverless.yml
</span></span><span class="line" line="2"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">service</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">my-sls-scraper
</span></span><span class="line" line="3"><span emptylineplaceholder="true">
</span></span><span class="line" line="4"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">provider</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="5"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  name</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">aws
</span></span><span class="line" line="6"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  runtime</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">python3.7
</span></span><span class="line" line="7"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  logRetentionInDays</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF">1
</span></span><span class="line" line="8"><span emptylineplaceholder="true">
</span></span><span class="line" line="9"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  environment</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="10"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    FEED_BUCKET_NAME</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> ScraperFeedBucket
</span></span><span class="line" line="11"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    ECS_CLUSTER</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!GetAtt</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateECSCluster.Arn
</span></span><span class="line" line="12"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    ECS_TASK_ARN</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateECSTaskDefinition
</span></span><span class="line" line="13"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    ECS_SUBNET</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateSubnet
</span></span><span class="line" line="14"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    ECS_SEC_GROUP</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateSG
</span></span><span class="line" line="15"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    CONTAINER_NAME</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;scraper_container&quot;
</span></span><span class="line" line="16"><span emptylineplaceholder="true">
</span></span><span class="line" line="17"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  iamRoleStatements</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="18"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">    - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Effect</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;Allow&quot;
</span></span><span class="line" line="19"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      Action</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="20"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;s3:PutObject&quot;
</span></span><span class="line" line="21"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      Resource</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Sub
</span></span><span class="line" line="22"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;arn:aws:s3:::#{BucketName}/*&quot;
</span></span><span class="line" line="23"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">BucketName</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> ScraperFeedBucket
</span></span><span class="line" line="24"><span emptylineplaceholder="true">
</span></span><span class="line" line="25"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">    - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Effect</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">Allow
</span></span><span class="line" line="26"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      Action</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="27"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">ecs:RunTask
</span></span><span class="line" line="28"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      Resource</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="29"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateECSTaskDefinition
</span></span><span class="line" line="30"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">    - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Effect</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">Allow
</span></span><span class="line" line="31"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      Action</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="32"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">iam:PassRole
</span></span><span class="line" line="33"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      Resource</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="34"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!GetAtt</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateExecutionRole.Arn
</span></span><span class="line" line="35"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">    - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Effect</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">Allow
</span></span><span class="line" line="36"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      Action</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="37"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">iam:PassRole
</span></span><span class="line" line="38"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      Resource</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="39"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!GetAtt</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> FargateTaskRole.Arn
</span></span><span class="line" line="40"><span emptylineplaceholder="true">
</span></span><span class="line" line="41"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">functions</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="42"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  hello</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="43"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    handler</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">handler.hello
</span></span><span class="line" line="44"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  lambdaScrape</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="45"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    handler</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">launcher.scrape
</span></span><span class="line" line="46"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  fargateScrape</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="47"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    handler</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">launch_fargate.launch_fargate
</span></span><span class="line" line="48"><span emptylineplaceholder="true">
</span></span><span class="line" line="49"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># We include files by whitelisting to reduce the deployment time.
</span></span><span class="line" line="50"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># Just remember to add any files you create!
</span></span><span class="line" line="51"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">package</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="52"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  include</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="53"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">    - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">handler.py
</span></span><span class="line" line="54"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">    - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">launcher.py
</span></span><span class="line" line="55"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">    - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">launch_fargate.py
</span></span><span class="line" line="56"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">    - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">my_sls_scraper/**
</span></span><span class="line" line="57"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">    - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">scrapy.cfg
</span></span><span class="line" line="58"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  exclude</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="59"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">    - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;./**&quot;
</span></span><span class="line" line="60"><span emptylineplaceholder="true">
</span></span><span class="line" line="61"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">resources</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="62"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">  - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">AWSTemplateFormatVersion</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;2010-09-09&quot;
</span></span><span class="line" line="63"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Transform</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;AWS::Serverless-2016-10-31&quot;
</span></span><span class="line" line="64"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">  - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">${file(./s3-template.yml)}
</span></span><span class="line" line="65"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">  - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">${file(./fargate-template.yml)}
</span></span><span class="line" line="66"><span emptylineplaceholder="true">
</span></span><span class="line" line="67"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">plugins</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="68"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">  - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">serverless-python-requirements
</span></span><span class="line" line="69"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">  - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">serverless-cloudformation-sub-variables
</span></span><span class="line" line="70"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">custom</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="71"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  pythonRequirements</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="72"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    slim</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF">true</span><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"> # Omits tests, __pycache__, *.pyc etc from dependencies
</span></span><span class="line" line="73"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    fileName</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">requirements.txt
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->Once again we&#39;ll deploy and make a test run with<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> deploy</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -v
</span></span><span class="line" line="2"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> invoke</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -f</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> fargateScrape</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> --log
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->The function should execute, but the Fargate task will fail, as we haven&#39;t uploaded our Docker image to the repository we created.
You can look at what we created in the <a href="https://console.aws.amazon.com/ecs/home" rel="nofollow" data-v-d83694f9><!--[-->ECS console<!--]--></a> and the <a href="https://console.aws.amazon.com/vpc/home" rel="nofollow" data-v-d83694f9><!--[-->VPC console<!--]--></a>. You can see the failed task we started on <a href="https://console.aws.amazon.com/ecs/home?region=us-east-1#/clusters/fargate-my-sls-scraper-dev/tasks" rel="nofollow" data-v-d83694f9><!--[-->https://console.aws.amazon.com/ecs/home?region=us-east-1#/clusters/fargate-my-sls-scraper-dev/tasks<!--]--></a> if you toggle <strong data-v-c6a59043><!--[-->Stopped<!--]--></strong> and change regions if you&#39;re not in the default us-east-1.<!--]--></p><p data-v-f4c85dbd><!--[-->The final piece in the puzzle is to upload the container image, so let&#39;s create a <em data-v-4353b993><!--[-->Makefile<!--]--></em> to make it easy to update it in the future. Maybe you need to change the variables according to your setup.<!--]--></p><div class="highlight-makefile prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-makefile" style=""><!--[--><code># Makefile
STACKNAME_BASE=&quot;my-sls-scraper-dev&quot;
# This is a region that supports AWS Fargate
REGION=&quot;us-east-1&quot;
PROFILE=&quot;my-sls-admin&quot;
IMAGE_NAME=&quot;my_sls_scraper&quot;

build:
    docker build -t $(IMAGE_NAME):latest .

retag:
    docker tag $(IMAGE_NAME):latest \
        $(shell aws cloudformation --region $(REGION) --profile $(PROFILE) describe-stacks --stack-name $(STACKNAME_BASE) --query &quot;Stacks[0].Outputs[?OutputKey==&#39;ECRRepo&#39;].OutputValue&quot; --output text):latest
    @exec $(shell aws ecr --region $(REGION) --profile $(PROFILE) get-login --no-include-email)
    docker push $(shell aws cloudformation --region $(REGION) --profile $(PROFILE) describe-stacks --stack-name $(STACKNAME_BASE) --query &quot;Stacks[0].Outputs[?OutputKey==&#39;ECRRepo&#39;].OutputValue&quot; --output text):latest
</code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->We&#39;ve already build the image, so we just need to upload it with<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">make</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> retag
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->The first time pushing, this might take some time depending on how fast your internet connection is.
You should see an output similar to<!--]--></p><div class="highlight-null prose-code" data-v-ef0b30fc><!----><!--[--><pre class="" style=""><!--[--><code>18:17 $ make retag
docker tag &quot;my_sls_scraper&quot;:latest \
    459015585648.dkr.ecr.us-east-1.amazonaws.com/my-sl-farga-afj2n785due0:latest
Login Succeeded
docker push 459015585648.dkr.ecr.us-east-1.amazonaws.com/my-sl-farga-afj2n785due0:latest
The push refers to a repository [459015585648.dkr.ecr.us-east-1.amazonaws.com/my-sl-farga-afj2n785due0]
6b325179a37f: Pushed
7c486f7d4e0e: Pushed
5a14878ee86f: Pushed
fb71908672f7: Pushed
c028dbad8bfd: Pushed
424cdf061e9d: Pushed
bd648e09c386: Pushed
69d95271719a: Pushed
f88be44e4bd8: Pushed
e505c7600391: Pushed
4d2fd1bf072c: Pushed
6e302bbcacce: Pushed
97e8dd85db4e: Pushed
74e2ede3b29c: Pushed
6d5a64ea8f37: Pushed
660314270d76: Pushed
latest: digest: sha256:f64c0ed0e5296b03645e5aed927b3af1d75faa226382ac389651519a0b14381c size: 3678
</code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->and, if successful, it should be possible to scrape in Fargate by just invoking a Lambda function. Try it with<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> invoke</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -f</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> fargateScrape</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> --log
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->It should execute successfully and exit. The logs of the crawler comes from our Fargate task and not the Lambda function, and can be seen in the <a href="https://console.aws.amazon.com/cloudwatch/home?region=us-east-1#logs:" rel="nofollow" data-v-d83694f9><!--[-->CloudWatch console<!--]--></a>.<!--]--></p><p data-v-f4c85dbd><!--[-->Well done if you&#39;ve made it thus far. We&#39;ve made the basics of a quite sophisticated scraping infrastructure with a lot of potential. The last steps from here are optional.
We will set up an S3 bucket for caching responses, and in the end we&#39;ll use AWS CloudWatch to schedule automatic crawls and discuss some methods to better automate and control crawl scheduling.<!--]--></p><h2 id="using-s3-as-http-cache" data-v-6d609909><a aria-current="page" href="/posts/scrapy-fargate-sls-guide#using-s3-as-http-cache" class="router-link-active router-link-exact-active" data-v-6d609909><!--[-->Using S3 as HTTP cache<!--]--><!----></a></h2><p data-v-f4c85dbd><!--[-->Caching responses from our spider is good for faster crawls and to avoid getting banned, as well as a store of html responses that can be used for things like machine learning further down the data processing pipeline.
Scrapy comes with a file storage caching system by default, but because of the framework&#39;s great extensibility, we can quite easily make our own cache handler. Using persistent file storage is not possible in Lambda or Fargate, so we have to use an object storage like S3 or a database. We will use S3 because it&#39;s relatively easy to set up and maintain.<!--]--></p><p data-v-f4c85dbd><!--[-->To do this, we first have to add a bucket to our <code class="" data-v-69006e27><!--[-->s3-template.yml<!--]--></code> and add IAM role permissions to our <code class="" data-v-69006e27><!--[-->fargate-template.yml<!--]--></code> and <code class="" data-v-69006e27><!--[-->serverless.yml<!--]--></code>, as well as an environment variable to the latter and to <code class="" data-v-69006e27><!--[-->launch_fargate.py<!--]--></code>.<!--]--></p><p data-v-f4c85dbd><!--[-->Add an S3 bucket in the S3 template like this<!--]--></p><div class="highlight-yaml prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-yaml shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># s3-template.yml
</span></span><span class="line" line="2"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Resources</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="3"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  ScraperFeedBucket</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="4"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">AWS::S3::Bucket
</span></span><span class="line" line="5"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Properties</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="6"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      VersioningConfiguration</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="7"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">        Status</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;Enabled&quot;
</span></span><span class="line" line="8"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  HttpCacheBucket</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="9"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">AWS::S3::Bucket
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->Add a policy to the Fargate template<!--]--></p><div class="highlight-yaml prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-yaml shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># fargate-template.yml
</span></span><span class="line" line="2"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># ...
</span></span><span class="line" line="3"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    FargateTaskRole</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="4"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">        Type</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">AWS::IAM::Role
</span></span><span class="line" line="5"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">        Properties</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="6"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D">            # ...
</span></span><span class="line" line="7"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">            Policies</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="8"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">                - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">PolicyName</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">HttpCacheBucketPolicy
</span></span><span class="line" line="9"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">                  PolicyDocument</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="10"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">                    Statement</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="11"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">                      - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">PolicyName</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">HttpCacheBucketPolicy
</span></span><span class="line" line="12"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">                          PolicyDocument</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="13"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">                            Statement</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="14"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">                              - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Effect</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;Allow&quot;
</span></span><span class="line" line="15"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">                                Action</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="16"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">                                  - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;s3:GetObject&quot;
</span></span><span class="line" line="17"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">                                  - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;s3:PutObject&quot;
</span></span><span class="line" line="18"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">                                  - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;s3:ListBucket&quot;
</span></span><span class="line" line="19"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">                                Resource</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="20"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">                                  - </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Sub
</span></span><span class="line" line="21"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">                                    - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;arn:aws:s3:::#{BucketName}/*&quot;
</span></span><span class="line" line="22"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">                                    - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">BucketName</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> HttpCacheBucket
</span></span><span class="line" line="23"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">                                  - </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Sub
</span></span><span class="line" line="24"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">                                    - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;arn:aws:s3:::#{BucketName}&quot;
</span></span><span class="line" line="25"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">                                    - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">BucketName</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> HttpCacheBucket
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->and statements and env variable to our lambda functions<!--]--></p><div class="highlight-yaml prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-yaml shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># serverless.yml
</span></span><span class="line" line="2"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">provider</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="3"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D">    # ...
</span></span><span class="line" line="4"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    environment</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="5"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">        HTTP_CACHE_BUCKET_NAME</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> HttpCacheBucket
</span></span><span class="line" line="6"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D">        # ...
</span></span><span class="line" line="7"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    iamRoleStatements</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="8"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">        - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">Effect</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;Allow&quot;
</span></span><span class="line" line="9"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">          Action</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="10"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">            - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;s3:GetObject&quot;
</span></span><span class="line" line="11"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">            - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;s3:PutObject&quot;
</span></span><span class="line" line="12"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">            - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;s3:ListBucket&quot;
</span></span><span class="line" line="13"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">          Resource</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="14"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">            - </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Sub
</span></span><span class="line" line="15"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">              - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;arn:aws:s3:::#{BucketName}/*&quot;
</span></span><span class="line" line="16"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">              - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">BucketName</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> HttpCacheBucket
</span></span><span class="line" line="17"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">            - </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Sub
</span></span><span class="line" line="18"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">              - </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">&quot;arn:aws:s3:::#{BucketName}&quot;
</span></span><span class="line" line="19"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">              - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">BucketName</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">!Ref</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> HttpCacheBucket
</span></span><span class="line" line="20"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D">        # ...
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->and lastly pass the new env variable when launching the crawler task<!--]--></p><div class="highlight-python prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-python" style=""><!--[--><code># launch_fargate.py
# ...
&quot;environment&quot;: [
   {&quot;name&quot;: &quot;FEED_BUCKET_NAME&quot;,
       &quot;value&quot;: os.environ[&quot;FEED_BUCKET_NAME&quot;]},
   {&quot;name&quot;: &quot;HTTP_CACHE_BUCKET_NAME&quot;,
       &quot;value&quot;: os.environ[&quot;HTTP_CACHE_BUCKET_NAME&quot;]},
],
# ...
</code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->To use all this configuration for some caching, we create a module with our cache implementation in the <code class="" data-v-69006e27><!--[-->my_sls_scraper<!--]--></code> folder, and don&#39;t forget to add an <code class="" data-v-69006e27><!--[-->__init__.py<!--]--></code> file in the newly created <code class="" data-v-69006e27><!--[-->extensions<!--]--></code> folder.<!--]--></p><div class="highlight-python prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-python" style=""><!--[--><code># my_sls_scraper/extensions/s3cache.py
import boto3
import gzip
import json
import logging
import os
from botocore.exceptions import ClientError
from botocore.stub import Stubber
from time import time
from datetime import datetime
from six.moves import cPickle as pickle
from six.moves.urllib.parse import urlparse
from scrapy.exceptions import NotConfigured
from scrapy.http import Headers
from scrapy.responsetypes import responsetypes
from scrapy.utils.request import request_fingerprint
from w3lib.http import headers_raw_to_dict, headers_dict_to_raw

from botocore.exceptions import ClientError
import sys

logger = logging.getLogger(__name__)


class S3CacheStorage(object):
    def __init__(self, settings):
        urifmt = settings.get(&#39;S3CACHE_URI&#39;, &#39;&#39;)
        if not urifmt:
            raise NotConfigured(&#39;S3CACHE_URI must be specified&#39;)

        # Parse URI
        u = urlparse(urifmt)
        self.keypath_fmt = u.path[1:]
        if not self.keypath_fmt:
            raise NotConfigured(&#39;Could not get key path from S3CACHE_URI&#39;)

        self.bucket_name = u.hostname
        if self.bucket_name is None:
            raise NotConfigured(&#39;Could not get bucket name from S3CACHE_URI&#39;)

        self.use_gzip = settings.getbool(&#39;HTTPCACHE_GZIP&#39;)
        self.dont_retrieve = settings.getbool(&#39;S3CACHE_DONT_RETRIEVE&#39;)

        self._client = None
        self._spider = None
        self._keypath = None
        self.cached_requests = []

    @property
    def _client_stubber(self):
        return Stubber(self.client)

    @property
    def client(self):
        &quot;&quot;&quot; Connect to S3 and return the connection &quot;&quot;&quot;

        if self._client is None:
            self._client = boto3.client(&#39;s3&#39;)
        return self._client

    @property
    def keypath(self):
        &quot;&quot;&quot; Get the keypath as specified in S3CACHE_URI &quot;&quot;&quot;
        def get_uri_params(obj):
            &quot;&quot;&quot;Convert an object to a dict&quot;&quot;&quot;
            params = {}
            for k in dir(obj):
                params[k] = getattr(obj, k)
            params[&#39;day&#39;] = datetime.utcnow().strftime(&#39;%Y-%m-%d&#39;)
            params[&#39;time&#39;] = datetime.utcnow().replace(
                microsecond=0).isoformat().replace(&#39;:&#39;, &#39;-&#39;)
            return params
        if not self._keypath:
            self._keypath = self.keypath_fmt % get_uri_params(self.spider)
        return self._keypath

    @property
    def spider(self):
        if not self._spider:
            raise NotConfigured(&#39;Could not get spider! Aborting...&#39;)
        return self._spider

    def put_object_to_key(self, obj, bucket, key):
        try:
            obj = gzip.compress(obj) if self.use_gzip else obj
            self.client.put_object(Body=obj, Bucket=bucket, Key=key)
        except ClientError as e:
            logger.warning(
                &#39;Failed to store cache on key {key}: {e}&#39;.format(key=key, e=e))
            response_code = e.response.get(&#39;Error&#39;, {}).get(&#39;Code&#39;)
            if response_code == &#39;AccessDenied&#39; or response_code == &#39;InvalidAccessKeyId&#39;:
                logger.exception(&quot;Access denied to http cache bucket&quot;)
                sys.exit(1)

    def get_object_from_key(self, bucket, key):
        try:
            response = self.client.get_object(Bucket=bucket, Key=key)
            obj = response[&#39;Body&#39;].read()
            return gzip.decompress(obj) if self.use_gzip else obj
        except ClientError as e:
            logger.debug(
                &#39;Failed to retrieve cache on key {key}: {e}&#39;.format(key=key, e=e))
            response_code = e.response.get(&#39;Error&#39;, {}).get(&#39;Code&#39;)
            if response_code == &#39;AccessDenied&#39; or response_code == &#39;InvalidAccessKeyId&#39;:
                logger.exception(&quot;Access denied to http cache bucket&quot;)
                sys.exit(1)

    def open_spider(self, spider):
        logger.debug(&#39;Using s3 cache storage in %(bucket_name)s&#39; % {&#39;bucket_name&#39;: self.bucket_name},
                     extra={&#39;spider&#39;: spider})
        # Update spider reference
        self._spider = spider

    def close_spider(self, spider):
        logger.info(
            &#39;Cache on s3 bucket {bucket} on key path {keypath}&#39;.format(
                bucket=self.bucket_name, keypath=self.keypath),
            extra={&#39;spider&#39;: spider}
        )

    def retrieve_response(self, spider, request):
        &quot;&quot;&quot;Return response if present in cache, or None otherwise.&quot;&quot;&quot;
        if self.dont_retrieve:
            return
        keyname = self._get_request_path(request)
        keydata = self.get_object_from_key(self.bucket_name, keyname)
        if not keydata:
            return  # not cached
        keydata = pickle.loads(keydata)
        metadata = keydata[&#39;meta&#39;]
        body = keydata[&#39;response_body&#39;]
        rawheaders = keydata[&#39;response_headers&#39;]
        url = metadata.get(&#39;response_url&#39;)
        status = metadata[&#39;status&#39;]
        headers = Headers(headers_raw_to_dict(rawheaders))
        respcls = responsetypes.from_args(headers=headers, url=url)
        response = respcls(url=url, headers=headers, status=status, body=body)
        return response

    def store_response(self, spider, request, response):
        # TODO: Use a buffer instead of sending the cache files one by one
        &quot;&quot;&quot;Store the given response in the cache.&quot;&quot;&quot;
        keyname = self._get_request_path(request)
        metadata = {
            &#39;url&#39;: request.url,
            &#39;method&#39;: request.method,
            &#39;status&#39;: response.status,
            &#39;response_url&#39;: response.url,
            &#39;timestamp&#39;: time(),
        }
        keydata = {
            &#39;meta&#39;: metadata,
            &#39;response_headers&#39;: headers_dict_to_raw(response.headers),
            &#39;response_body&#39;: response.body,
            &#39;request_headers&#39;: headers_dict_to_raw(request.headers),
            &#39;request_body&#39;: request.body
        }
        self.put_object_to_key(pickle.dumps(
            keydata), self.bucket_name, keyname)

    def _get_request_path(self, request):
        key = request_fingerprint(request)
        return &#39;{keypath}/{key}&#39;.format(keypath=self.keypath, key=key)

</code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->The code is a slightly modified version of <a href="https://github.com/heylouiz/scrapy-s3-http-cache" rel="nofollow" data-v-d83694f9><!--[-->github.com/heylouiz/scrapy-s3-http-cache<!--]--></a> to work natively with AWS.<!--]--></p><p data-v-f4c85dbd><!--[-->We&#39;ll add the necessary settings in <code class="" data-v-69006e27><!--[-->crawl.py<!--]--></code> so that we can dynamically decide which cache storage to use.<!--]--></p><div class="highlight-python prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-python" style=""><!--[--><code># my_sls_scraper/crawl.py
def crawl(settings={}, spider_name=&quot;header_spider&quot;, spider_kwargs={}):
# ...
    if (is_in_aws() and os.getenv(&quot;USE_S3_CACHE&quot;) !=  &quot;0&quot;) or os.getenv(&quot;USE_S3_CACHE&quot;):
        settings[&quot;HTTPCACHE_STORAGE&quot;] =  &quot;my_sls_scraper.extensions.s3cache.S3CacheStorage&quot;
        settings[&quot;S3CACHE_URI&quot;] =  f&quot;s3://{os.environ[&#39;HTTP_CACHE_BUCKET_NAME&#39;]}/cache&quot;
# ...
</code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->Now we need to do a full deploy by both deploying with Serverless, and rebuild and upload our Docker image. Do that and launch the crawler using S3 as cache storage with<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> deploy</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -v
</span></span><span class="line" line="2"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">make</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> build</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8"> &amp;&amp; </span><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">make</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> retag
</span></span><span class="line" line="3"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> invoke</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -f</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> fargateScrape</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> --log
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->It&#39;s probably wise to run the crawler locally after <code class="" data-v-69006e27><!--[-->sls deploy -v<!--]--></code> to verify that things work as they should, so you don&#39;t need to redeploy 15 times because of various typos (talking from experience).
Run the crawler locally after finding your cache bucket name in the <a href="https://s3.console.aws.amazon.com/s3/home" rel="nofollow" data-v-d83694f9><!--[-->S3 console<!--]--></a> (should be similar to <code class="" data-v-69006e27><!--[-->my-sls-scraper-dev-httpcachebucket-y2mbtieyeju3<!--]--></code>)<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> invoke</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> local</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -f</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> lambdaScrape</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> --log</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -e</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> USE_S3_CACHE=</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF">1</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -e</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> HTTP_CACHE_BUCKET_NAME=</span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">&lt;</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">YOUR_CACHE_BUCKET_NAM</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">E</span><span style="--shiki-default:#D73A49;--shiki-dark:#F97583">&gt;
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->You should now see objects appearing in the http cache S3 bucket as we run the crawler.<!--]--></p><h2 id="scheduling-and-configuring-crawls" data-v-6d609909><a aria-current="page" href="/posts/scrapy-fargate-sls-guide#scheduling-and-configuring-crawls" class="router-link-active router-link-exact-active" data-v-6d609909><!--[-->Scheduling and Configuring Crawls<!--]--><!----></a></h2><p data-v-f4c85dbd><!--[-->One of the advantages of using the AWS ecosystem is that it contains solutions for all common and uncommon tasks such as scheduling, event notifications, message queues, etc. The Serverless framework even makes some of this easy for beginners, so let&#39;s use it to schedule a weekly crawl with our spider.<!--]--></p><p data-v-f4c85dbd><!--[-->Add a key to our function config in <code class="" data-v-69006e27><!--[-->serverless.yml<!--]--></code> (pay damn close attention to the indentation here, or it will not work and no warning will be given)<!--]--></p><div class="highlight-yaml prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-yaml shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># serverless.yml
</span></span><span class="line" line="2"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># ...
</span></span><span class="line" line="3"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">functions</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="4"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  fargateScraper</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="5"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    handler</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">launch_fargate.launch_fargate
</span></span><span class="line" line="6"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">events</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="7"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">  - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">schedule</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="8"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      rate</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">cron(0 6 ? * MON *)
</span></span><span class="line" line="9"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      enabled</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF">true
</span></span><span class="line" line="10"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      description</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="11"><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">        Header spider every Monday morning at 6 AM UTC
</span></span><span class="line" line="12"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D">        # The input is key-value pairs accessed in the root of the event parameter of every handler function, i.e. event.get(&quot;spider_name&quot;)
</span></span><span class="line" line="13"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">      input</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="14"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">        spider_name</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">header_spider
</span></span><span class="line" line="15"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D">        # ...
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->After deploying, you can verify that a CloudWatch Events tab appears under triggers in the Lambda console.<!--]--></p><p data-v-f4c85dbd><!--[--><img title="Lambda console triggers" style="aspect-ratio:1263/812;" src="/posts/scrapy-fargate-sls-guide/lambda-console-triggers.png" alt="Lambda console triggers" data-v-80d56572><!--]--></p><p data-v-f4c85dbd><!--[-->If you have a few spiders, configuring all the launches as scheduled events in <code class="" data-v-69006e27><!--[-->serverless.yml<!--]--></code> works fine. If you have a bunch of spiders, you might want to launch several spiders at the same time from a single Lambda function.<!--]--></p><p data-v-f4c85dbd><!--[-->We can implement behaviour like that in another Lambda function. Let&#39;s remove the dummy function in <code class="" data-v-69006e27><!--[-->handler.py<!--]--></code><!--]--></p><div class="highlight-python prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-python" style=""><!--[--><code># handler.py
import json
from datetime import datetime, timedelta
import logging

from launch_fargate import launch_fargate


def run_crawlers(event, context):
    result = []
    for x in filter(should_crawl, get_crawler_config()):
        try:
            if x.get(&quot;run_in_lambda&quot;):
                # TODO Implement function to invoke crawl in new Lambda function
                pass
            else:
                fargate_launch_response = launch_fargate(dict(
                    spider_name=x.get(&quot;spider_name&quot;),
                    spider_kwargs=x.get(&quot;spider_kwargs&quot;),
                ), {})
                result.append(fargate_launch_response)
        except Exception:
            logging.exception(
                f&quot;Could not launch spider {x.get(&#39;spider_name&#39;)}&quot;
            )
    return result


def get_crawler_config():
    # This function could make an API call to a CMS like AirTable,
    # Strapi or DynamoDB.
    return [
        {
            &quot;spider_name&quot;: &quot;header_spider&quot;,
            &quot;spider_kwargs&quot;: {
                &quot;start_urls&quot;: [&quot;https://example.com&quot;],
            },
            &quot;previous_crawl&quot;: {
                &quot;success_state&quot;: True,
                &quot;items_crawled&quot;: 100,
                &quot;finish_date&quot;: datetime.now() - timedelta(days=3),
            },
        },
        {
            &quot;spider_name&quot;: &quot;header_spider&quot;,
            &quot;spider_kwargs&quot;: {
                &quot;start_urls&quot;: [&quot;https://www.ietf.org&quot;],
            },
            &quot;previous_crawl&quot;: {
                &quot;success_state&quot;: True,
                &quot;items_crawled&quot;: 100,
                &quot;finish_date&quot;: datetime.now() - timedelta(hours=16),
            },
            &quot;crawl_interval_hours&quot;: 12,
            &quot;settings&quot;: {
                &quot;AUTOTHROTTLE_ENABLED&quot;: True,
            }|
        },
        {
            &quot;spider_name&quot;: &quot;header_spider&quot;,
            &quot;spider_kwargs&quot;: {
                &quot;start_urls&quot;: [&quot;https://bitcoin.org&quot;],
            },
        },
        {
            &quot;spider_name&quot;: &quot;other_spider&quot;,
            &quot;previous_crawl&quot;: None
        },
    ]


def should_crawl(x):
    previous_crawl = x.get(&quot;previous_crawl&quot;)
    if previous_crawl:
        time_interval_hours = x.get(&quot;crawl_interval_hours&quot;, 24*7)
        return previous_crawl.get(&quot;finish_date&quot;) + timedelta(hours=time_interval_hours) &lt; datetime.now() or not previous_crawl.get(&quot;success_state&quot;)
    return True
</code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->This function makes it possible to run crawls quite intelligently. It also assumes we have more spiders and that our <code class="" data-v-69006e27><!--[-->header_spider<!--]--></code> can take arguments in its constructor. Let&#39;s change it to do so<!--]--></p><div class="highlight-python prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-python" style=""><!--[--><code># my_sls_scraper/spiders/header_spider.py
from urllib.parse import urlparse

from scrapy.spiders import CrawlSpider, Rule
from scrapy.linkextractors import LinkExtractor


class HeaderSpider(CrawlSpider):
    name = &quot;header_spider&quot;

    start_urls = [&quot;https://scrapy.org&quot;]
    allowed_domains = [&quot;scrapy.org&quot;]

    def __init__(self, **kwargs):
        # Enables overriding attributes for a flexible spider
        if kwargs.get(&quot;start_urls&quot;):
            self.start_urls = kwargs.get(&quot;start_urls&quot;)
            self.allowed_domains = list(
                urlparse(x).hostname for x in self.start_urls
            )

        super().__init__(
            **{k: v for k, v in kwargs.items() if not hasattr(self, k)}
        )

    rules = [  # Get all links on start url
        Rule(
            link_extractor=LinkExtractor(
                deny=r&quot;\?&quot;,
            ),
            follow=False,
            callback=&quot;parse_page&quot;,
        )
    ]

    def parse_start_url(self, response):
        return self.parse_page(response)

    def parse_page(self, response):
        header = response.css(&quot;h1, h2&quot;).extract_first(
        ) or response.css(&quot;title&quot;).extract_first() or response.url
        return {
            &quot;header&quot;: remove_tags(header),
            &quot;url&quot;: response.url,
        }
</code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->It can now scrape the headers on any site with the <code class="" data-v-69006e27><!--[-->start_urls<!--]--></code> argument.
We also have to replace the hello function in <code class="" data-v-69006e27><!--[-->serverless.yml<!--]--></code> to the following<!--]--></p><div class="highlight-yaml prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-yaml shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># serverless.py
</span></span><span class="line" line="2"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D"># ...
</span></span><span class="line" line="3"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">functions</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="4"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">  pollSpidersScrape</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="5"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    handler</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">handler.run_crawlers
</span></span><span class="line" line="6"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">    events</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="7"><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">      - </span><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">schedule</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">:
</span></span><span class="line" line="8"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">          rate</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">rate(2 hours)
</span></span><span class="line" line="9"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">          enabled</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF">true
</span></span><span class="line" line="10"><span style="--shiki-default:#22863A;--shiki-dark:#85E89D">          description</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8">: </span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF">Poll spiders every 2 hours
</span></span><span class="line" line="11"><span style="--shiki-default:#6A737D;--shiki-dark:#6A737D">  # ...
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->Do a full deploy and see if it works.<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> deploy</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -v
</span></span><span class="line" line="2"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">make</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> build</span><span style="--shiki-default:#24292E;--shiki-dark:#E1E4E8"> &amp;&amp; </span><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">make</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> retag
</span></span><span class="line" line="3"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> invoke</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -f</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> pollSpidersScrape</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> --log
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->You should now see output files for scraping <a href="http://www.ietf.org" rel="nofollow" data-v-d83694f9><!--[-->www.ietf.org<!--]--></a> and bitcoin.org in S3, while one container will fail because we don&#39;t have a spider called <code class="" data-v-69006e27><!--[-->other_spider<!--]--></code>.<!--]--></p><p data-v-f4c85dbd><!--[--><strong data-v-c6a59043><!--[-->WARNING<!--]--></strong>
Don&#39;t forget to remove or stop that last function from running, as starting 3 Fargate containers every 2 hours will cost some money.
You can remove all resources* with<!--]--></p><div class="highlight-bash prose-code" meta data-v-ef0b30fc><!----><!--[--><pre class="language-bash shiki shiki-themes github-light github-dark" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-default:#6F42C1;--shiki-dark:#B392F0">sls</span><span style="--shiki-default:#032F62;--shiki-dark:#9ECBFF"> remove</span><span style="--shiki-default:#005CC5;--shiki-dark:#79B8FF"> -v
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-ef0b30fc data-v-2c5d870f><span class="sr-only" data-v-2c5d870f>Copy to clipboard</span><span class="icon-wrapper" data-v-2c5d870f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-2c5d870f style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-5f091540><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-f4c85dbd><!--[-->... and rebuild it all with another command. Infrastructure as code is pretty neat.<!--]--></p><p data-v-f4c85dbd><!--[-->* Serverless will fail to delete the buckets and ECR repository if they are not empty. So you have to manually delete all images from the repository and all objects from the scraper feed bucket and http cache bucket first.<!--]--></p><h2 id="conclusion" data-v-6d609909><a aria-current="page" href="/posts/scrapy-fargate-sls-guide#conclusion" class="router-link-active router-link-exact-active" data-v-6d609909><!--[-->Conclusion<!--]--><!----></a></h2><p data-v-f4c85dbd><!--[-->This concludes this guide. I hope it was useful for understanding scraping and serverless a little better. The next part will be about setting up a Lambda function that reacts whenever a crawler feed is created in S3, do some processing on that data before it&#39;s stored in a database.
Any feedback is welcome and don&#39;t hesitate to contact me if you&#39;re interested in the price comparison framework I&#39;m creating.<!--]--></p><style>html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}</style></div><!--]--></main></div><!--]--><footer class="center" data-v-a9d5dfed data-v-654b05f0><a href="https://www.github.com/nuxt-themes/alpine" rel="noopener noreferrer" class="credits" data-v-654b05f0>Alpine</a><div class="navigation" data-v-654b05f0><nav data-v-654b05f0 data-v-f1645879><ul data-v-f1645879><!--[--><li data-v-f1645879><a href="/" class="" data-v-f1645879><span class="underline-fx" data-v-f1645879></span> Home</a></li><li data-v-f1645879><a href="/contact" class="" data-v-f1645879><span class="underline-fx" data-v-f1645879></span> Contact</a></li><li data-v-f1645879><a href="/posts" class="" data-v-f1645879><span class="underline-fx" data-v-f1645879></span> Archive</a></li><!--]--></ul></nav></div><p class="message" data-v-654b05f0>Follow me on</p><div class="icons" data-v-654b05f0><div class="social" data-v-654b05f0><!--[--><a href="https://twitter.com/vikfand" rel="noopener noreferrer" target="_blank" title="vikfand" aria-label="vikfand" data-v-bb750848><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-bb750848 style="" width="1em" height="1em" viewBox="0 0 24 24" data-v-5f091540><path fill="currentColor" d="M22 5.8a8.49 8.49 0 0 1-2.36.64a4.13 4.13 0 0 0 1.81-2.27a8.21 8.21 0 0 1-2.61 1a4.1 4.1 0 0 0-7 3.74a11.64 11.64 0 0 1-8.45-4.29a4.16 4.16 0 0 0-.55 2.07a4.09 4.09 0 0 0 1.82 3.41a4.05 4.05 0 0 1-1.86-.51v.05a4.1 4.1 0 0 0 3.3 4a3.93 3.93 0 0 1-1.1.17a4.9 4.9 0 0 1-.77-.07a4.11 4.11 0 0 0 3.83 2.84A8.22 8.22 0 0 1 3 18.34a7.93 7.93 0 0 1-1-.06a11.57 11.57 0 0 0 6.29 1.85A11.59 11.59 0 0 0 20 8.45v-.53a8.43 8.43 0 0 0 2-2.12Z"/></svg></a><a href="https://instagram.com/viktorfandersen" rel="noopener noreferrer" target="_blank" title="viktorfandersen" aria-label="viktorfandersen" data-v-bb750848><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-bb750848 style="" width="1em" height="1em" viewBox="0 0 24 24" data-v-5f091540><path fill="currentColor" d="M17.34 5.46a1.2 1.2 0 1 0 1.2 1.2a1.2 1.2 0 0 0-1.2-1.2Zm4.6 2.42a7.59 7.59 0 0 0-.46-2.43a4.94 4.94 0 0 0-1.16-1.77a4.7 4.7 0 0 0-1.77-1.15a7.3 7.3 0 0 0-2.43-.47C15.06 2 14.72 2 12 2s-3.06 0-4.12.06a7.3 7.3 0 0 0-2.43.47a4.78 4.78 0 0 0-1.77 1.15a4.7 4.7 0 0 0-1.15 1.77a7.3 7.3 0 0 0-.47 2.43C2 8.94 2 9.28 2 12s0 3.06.06 4.12a7.3 7.3 0 0 0 .47 2.43a4.7 4.7 0 0 0 1.15 1.77a4.78 4.78 0 0 0 1.77 1.15a7.3 7.3 0 0 0 2.43.47C8.94 22 9.28 22 12 22s3.06 0 4.12-.06a7.3 7.3 0 0 0 2.43-.47a4.7 4.7 0 0 0 1.77-1.15a4.85 4.85 0 0 0 1.16-1.77a7.59 7.59 0 0 0 .46-2.43c0-1.06.06-1.4.06-4.12s0-3.06-.06-4.12ZM20.14 16a5.61 5.61 0 0 1-.34 1.86a3.06 3.06 0 0 1-.75 1.15a3.19 3.19 0 0 1-1.15.75a5.61 5.61 0 0 1-1.86.34c-1 .05-1.37.06-4 .06s-3 0-4-.06a5.73 5.73 0 0 1-1.94-.3a3.27 3.27 0 0 1-1.1-.75a3 3 0 0 1-.74-1.15a5.54 5.54 0 0 1-.4-1.9c0-1-.06-1.37-.06-4s0-3 .06-4a5.54 5.54 0 0 1 .35-1.9A3 3 0 0 1 5 5a3.14 3.14 0 0 1 1.1-.8A5.73 5.73 0 0 1 8 3.86c1 0 1.37-.06 4-.06s3 0 4 .06a5.61 5.61 0 0 1 1.86.34a3.06 3.06 0 0 1 1.19.8a3.06 3.06 0 0 1 .75 1.1a5.61 5.61 0 0 1 .34 1.9c.05 1 .06 1.37.06 4s-.01 3-.06 4ZM12 6.87A5.13 5.13 0 1 0 17.14 12A5.12 5.12 0 0 0 12 6.87Zm0 8.46A3.33 3.33 0 1 1 15.33 12A3.33 3.33 0 0 1 12 15.33Z"/></svg></a><a href="https://www.linkedin.com/in/viktor-frede-andersen-31650153/" rel="noopener noreferrer" target="_blank" title="LinkedIn" aria-label="LinkedIn" data-v-bb750848><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-bb750848 style="" width="1em" height="1em" viewBox="0 0 24 24" data-v-5f091540><path fill="currentColor" d="M20.47 2H3.53a1.45 1.45 0 0 0-1.47 1.43v17.14A1.45 1.45 0 0 0 3.53 22h16.94a1.45 1.45 0 0 0 1.47-1.43V3.43A1.45 1.45 0 0 0 20.47 2ZM8.09 18.74h-3v-9h3ZM6.59 8.48a1.56 1.56 0 1 1 0-3.12a1.57 1.57 0 1 1 0 3.12Zm12.32 10.26h-3v-4.83c0-1.21-.43-2-1.52-2A1.65 1.65 0 0 0 12.85 13a2 2 0 0 0-.1.73v5h-3v-9h3V11a3 3 0 0 1 2.71-1.5c2 0 3.45 1.29 3.45 4.06Z"/></svg></a><!--]--></div><div class="color-mode-switch" data-v-654b05f0><button aria-label="Color Mode" data-v-654b05f0 data-v-fd50f6ca><span data-v-fd50f6ca></span></button></div></div></footer><!--]--></div></div><script type="application/json" id="__NUXT_DATA__" data-ssr="true" data-src="/posts/scrapy-fargate-sls-guide/_payload.json">[{"state":1,"_errors":7678,"serverRendered":981,"path":7,"prerenderedAt":7680},["Reactive",2],{"$sdd-pages":3,"$sdd-surrounds":7498,"$sdd-globals":7528,"$scolor-mode":7530,"$sdd-navigation":7532,"$sicons":7662,"$ssite-config":7673},["ShallowRef",4],["ShallowReactive",5],{"/posts/scrapy-fargate-sls-guide":6},{"_path":7,"_dir":8,"_draft":9,"_partial":9,"_locale":10,"title":11,"description":10,"date":12,"language":13,"draft":9,"body":14,"_type":7490,"_id":7491,"_source":7492,"_file":7493,"_extension":7494,"sitemap":7495,"layout":7497},"/posts/scrapy-fargate-sls-guide","posts",false,"","Serverless Scraping with Scrapy, AWS Lambda and Fargate – a guide","2019-09-07T01:25:06.000Z","english",{"type":15,"children":16,"toc":7472},"root",[17,26,61,75,82,87,92,132,137,143,156,162,167,173,227,298,317,329,338,348,356,361,454,466,484,492,500,511,530,535,541,552,591,612,617,622,652,664,701,712,814,819,827,841,846,878,883,891,903,935,945,1367,1379,1391,1432,1437,1507,1512,1518,1536,1560,1591,1603,1700,1711,1966,1971,1990,1995,2003,2022,2027,2073,2095,2101,2122,2128,2140,2149,2154,2188,2193,2201,2206,2230,2235,2241,2246,4656,4670,4675,4683,4708,5651,5656,5702,5741,5753,5763,5768,5787,5792,5800,5805,5835,5848,5853,5859,5864,5892,5897,6012,6017,6359,6364,6617,6622,6630,6656,6664,6678,6690,6698,6703,6771,6797,6877,6882,6888,6893,6904,7089,7094,7105,7116,7126,7134,7146,7154,7172,7318,7323,7392,7412,7422,7445,7450,7455,7461,7466],{"type":18,"tag":19,"props":20,"children":22},"element","h2",{"id":21},"running-scrapy-in-aws-lambda",[23],{"type":24,"value":25},"text","Running Scrapy in AWS Lambda",{"type":18,"tag":27,"props":28,"children":29},"p",{},[30,32,41,43,50,52,59],{"type":24,"value":31},"We will be using the ",{"type":18,"tag":33,"props":34,"children":38},"a",{"href":35,"rel":36},"https://serverless.com/",[37],"nofollow",[39],{"type":24,"value":40},"Serverless framework",{"type":24,"value":42}," in this tutorial, as it's a good and extendable open-source framework that does much of the gruntwork of serverless applications. ",{"type":18,"tag":33,"props":44,"children":47},{"href":45,"rel":46},"https://scrapy.org/",[37],[48],{"type":24,"value":49},"Scrapy",{"type":24,"value":51}," is a Python framework, also leading and open-source, with all the benefits that come from using a mature framework. Since only ",{"type":18,"tag":33,"props":53,"children":56},{"href":54,"rel":55},"https://aws.amazon.com/",[37],[57],{"type":24,"value":58},"Amazon Web Services",{"type":24,"value":60}," (AWS) of the major cloud platforms support Python in serverless functions, it's a natural choice that can't go wrong since AWS has solutions for just about everything.",{"type":18,"tag":27,"props":62,"children":63},{},[64,66,73],{"type":24,"value":65},"The code used in this guide can be found on ",{"type":18,"tag":33,"props":67,"children":70},{"href":68,"rel":69},"https://github.com/viktorfa/scrapy-fargate-sls-guide",[37],[71],{"type":24,"value":72},"github.com/viktorfa/scrapy-fargate-sls-guide",{"type":24,"value":74},".",{"type":18,"tag":76,"props":77,"children":79},"h3",{"id":78},"requirements",[80],{"type":24,"value":81},"Requirements",{"type":18,"tag":27,"props":83,"children":84},{},[85],{"type":24,"value":86},"It's assumed that the reader is somewhat familiar with Scrapy and has the ability to work with the command line. Several programs need to be installed to complete this guide. An AWS account with billing enabled is necessary (although the resulting bill from completing the guide is in order of single digit cents).",{"type":18,"tag":27,"props":88,"children":89},{},[90],{"type":24,"value":91},"Command line tools used:",{"type":18,"tag":93,"props":94,"children":95},"ul",{},[96,102,107,112,117,122,127],{"type":18,"tag":97,"props":98,"children":99},"li",{},[100],{"type":24,"value":101},"virtualenv*",{"type":18,"tag":97,"props":103,"children":104},{},[105],{"type":24,"value":106},"git*",{"type":18,"tag":97,"props":108,"children":109},{},[110],{"type":24,"value":111},"npm",{"type":18,"tag":97,"props":113,"children":114},{},[115],{"type":24,"value":116},"pip",{"type":18,"tag":97,"props":118,"children":119},{},[120],{"type":24,"value":121},"make",{"type":18,"tag":97,"props":123,"children":124},{},[125],{"type":24,"value":126},"docker",{"type":18,"tag":97,"props":128,"children":129},{},[130],{"type":24,"value":131},"aws",{"type":18,"tag":27,"props":133,"children":134},{},[135],{"type":24,"value":136},"* recommended, but not necessary",{"type":18,"tag":76,"props":138,"children":140},{"id":139},"result",[141],{"type":24,"value":142},"Result",{"type":18,"tag":27,"props":144,"children":145},{},[146,148,154],{"type":24,"value":147},"Completing this guide will result with the basics of a scalable and maintainable scraper infrastructure following the ",{"type":18,"tag":149,"props":150,"children":151},"em",{},[152],{"type":24,"value":153},"serverless",{"type":24,"value":155}," paradigm with all its advantages such as low initial cost and infrastructure as code deployment. The resulting artifact will be extended in a similar fashion with a data processing pipeline in future guides.",{"type":18,"tag":19,"props":157,"children":159},{"id":158},"setting-up-a-crawler",[160],{"type":24,"value":161},"Setting up a crawler",{"type":18,"tag":27,"props":163,"children":164},{},[165],{"type":24,"value":166},"We start by making a simple Scrapy crawler that can run from a script locally, and move thinfs gradually from there.",{"type":18,"tag":76,"props":168,"children":170},{"id":169},"creating-the-scraper",[171],{"type":24,"value":172},"Creating the scraper",{"type":18,"tag":174,"props":175,"children":179},"pre",{"code":176,"language":177,"meta":10,"className":178,"style":10},"python -v # Should have python3.7\npip install Scrapy\n","bash","language-bash shiki shiki-themes github-light github-dark",[180],{"type":18,"tag":181,"props":182,"children":183},"code",{"__ignoreMap":10},[184,208],{"type":18,"tag":185,"props":186,"children":189},"span",{"class":187,"line":188},"line",1,[190,196,202],{"type":18,"tag":185,"props":191,"children":193},{"style":192},"--shiki-default:#6F42C1;--shiki-dark:#B392F0",[194],{"type":24,"value":195},"python",{"type":18,"tag":185,"props":197,"children":199},{"style":198},"--shiki-default:#005CC5;--shiki-dark:#79B8FF",[200],{"type":24,"value":201}," -v",{"type":18,"tag":185,"props":203,"children":205},{"style":204},"--shiki-default:#6A737D;--shiki-dark:#6A737D",[206],{"type":24,"value":207}," # Should have python3.7\n",{"type":18,"tag":185,"props":209,"children":211},{"class":187,"line":210},2,[212,216,222],{"type":18,"tag":185,"props":213,"children":214},{"style":192},[215],{"type":24,"value":116},{"type":18,"tag":185,"props":217,"children":219},{"style":218},"--shiki-default:#032F62;--shiki-dark:#9ECBFF",[220],{"type":24,"value":221}," install",{"type":18,"tag":185,"props":223,"children":224},{"style":218},[225],{"type":24,"value":226}," Scrapy\n",{"type":18,"tag":174,"props":228,"children":230},{"code":229,"language":177,"meta":10,"className":178,"style":10},"mkdir scrapy-serverless && cd $_\nscrapy startproject my_sls_scraper scraper\ncd scraper\n",[231],{"type":18,"tag":181,"props":232,"children":233},{"__ignoreMap":10},[234,263,286],{"type":18,"tag":185,"props":235,"children":236},{"class":187,"line":188},[237,242,247,253,258],{"type":18,"tag":185,"props":238,"children":239},{"style":192},[240],{"type":24,"value":241},"mkdir",{"type":18,"tag":185,"props":243,"children":244},{"style":218},[245],{"type":24,"value":246}," scrapy-serverless",{"type":18,"tag":185,"props":248,"children":250},{"style":249},"--shiki-default:#24292E;--shiki-dark:#E1E4E8",[251],{"type":24,"value":252}," && ",{"type":18,"tag":185,"props":254,"children":255},{"style":198},[256],{"type":24,"value":257},"cd",{"type":18,"tag":185,"props":259,"children":260},{"style":198},[261],{"type":24,"value":262}," $_\n",{"type":18,"tag":185,"props":264,"children":265},{"class":187,"line":210},[266,271,276,281],{"type":18,"tag":185,"props":267,"children":268},{"style":192},[269],{"type":24,"value":270},"scrapy",{"type":18,"tag":185,"props":272,"children":273},{"style":218},[274],{"type":24,"value":275}," startproject",{"type":18,"tag":185,"props":277,"children":278},{"style":218},[279],{"type":24,"value":280}," my_sls_scraper",{"type":18,"tag":185,"props":282,"children":283},{"style":218},[284],{"type":24,"value":285}," scraper\n",{"type":18,"tag":185,"props":287,"children":289},{"class":187,"line":288},3,[290,294],{"type":18,"tag":185,"props":291,"children":292},{"style":198},[293],{"type":24,"value":257},{"type":18,"tag":185,"props":295,"children":296},{"style":218},[297],{"type":24,"value":285},{"type":18,"tag":27,"props":299,"children":300},{},[301,303,308,310,315],{"type":24,"value":302},"All the code of this guide will be in the ",{"type":18,"tag":181,"props":304,"children":305},{"className":10},[306],{"type":24,"value":307},"scrapy-serverless/scraper",{"type":24,"value":309}," folder, but other modules will be added in the ",{"type":18,"tag":181,"props":311,"children":312},{"className":10},[313],{"type":24,"value":314},"scrapy-serverless",{"type":24,"value":316}," folder in future guides.",{"type":18,"tag":27,"props":318,"children":319},{},[320,322,327],{"type":24,"value":321},"We will use the default Scrapy project structure. Create a simple spider in the ",{"type":18,"tag":181,"props":323,"children":324},{"className":10},[325],{"type":24,"value":326},"spiders",{"type":24,"value":328}," module.",{"type":18,"tag":174,"props":330,"children":333},{"code":331,"language":195,"meta":10,"className":332,"style":10},"# my_sls_scraper/spiders/header_spider.py\nfrom scrapy.spiders import CrawlSpider, Rule\nfrom scrapy.linkextractors import LinkExtractor\n\n\nclass HeaderSpider(CrawlSpider):\n    name = \"header_spider\"\n\n    start_urls = [\"https://scrapy.org\"]\n    allowed_domains = [\"scrapy.org\"]\n    rules = [  # Get all links on start url\n        Rule(\n            link_extractor=LinkExtractor(\n                deny=r\"\\?\",\n            ),\n            follow=False,\n            callback=\"parse_page\",\n        )\n    ]\n\n    def parse_start_url(self, response):\n        return self.parse_page(response)\n\n    def parse_page(self, response):\n        header = response.css(\"h1, h2\").extract_first(\n        ) or response.css(\"title\").extract_first() or response.url\n        return {\n            \"header\": remove_tags(header),\n            \"url\": response.url,\n        }\n","language-python",[334],{"type":18,"tag":181,"props":335,"children":336},{"__ignoreMap":10},[337],{"type":24,"value":331},{"type":18,"tag":27,"props":339,"children":340},{},[341,343],{"type":24,"value":342},"Also add the following to the settings in ",{"type":18,"tag":181,"props":344,"children":345},{"className":10},[346],{"type":24,"value":347},"my_sls_scraper/settings.py",{"type":18,"tag":174,"props":349,"children":351},{"code":350,"language":195,"meta":10,"className":332,"style":10},"# my_sls_scraper/settings.py\n# ...\nHTTPCACHE_ENABLED = True\nHTTPCACHE_EXPIRATION_SECS = 60 * 60 * 24 * 7\nHTTPCACHE_DIR = 'httpcache'\nCLOSESPIDER_PAGECOUNT = 32\n",[352],{"type":18,"tag":181,"props":353,"children":354},{"__ignoreMap":10},[355],{"type":24,"value":350},{"type":18,"tag":27,"props":357,"children":358},{},[359],{"type":24,"value":360},"Test that the spider is working by running the crawler and printing the output",{"type":18,"tag":174,"props":362,"children":364},{"code":363,"language":177,"meta":10,"className":178,"style":10},"scrapy crawl header_spider --output \"feed/%(name)s-%(time)s.json\" --output-format json\ncat feed/$(ls feed -q | tail -1)\n",[365],{"type":18,"tag":181,"props":366,"children":367},{"__ignoreMap":10},[368,405],{"type":18,"tag":185,"props":369,"children":370},{"class":187,"line":188},[371,375,380,385,390,395,400],{"type":18,"tag":185,"props":372,"children":373},{"style":192},[374],{"type":24,"value":270},{"type":18,"tag":185,"props":376,"children":377},{"style":218},[378],{"type":24,"value":379}," crawl",{"type":18,"tag":185,"props":381,"children":382},{"style":218},[383],{"type":24,"value":384}," header_spider",{"type":18,"tag":185,"props":386,"children":387},{"style":198},[388],{"type":24,"value":389}," --output",{"type":18,"tag":185,"props":391,"children":392},{"style":218},[393],{"type":24,"value":394}," \"feed/%(name)s-%(time)s.json\"",{"type":18,"tag":185,"props":396,"children":397},{"style":198},[398],{"type":24,"value":399}," --output-format",{"type":18,"tag":185,"props":401,"children":402},{"style":218},[403],{"type":24,"value":404}," json\n",{"type":18,"tag":185,"props":406,"children":407},{"class":187,"line":210},[408,413,418,423,428,433,439,444,449],{"type":18,"tag":185,"props":409,"children":410},{"style":192},[411],{"type":24,"value":412},"cat",{"type":18,"tag":185,"props":414,"children":415},{"style":218},[416],{"type":24,"value":417}," feed/$(",{"type":18,"tag":185,"props":419,"children":420},{"style":192},[421],{"type":24,"value":422},"ls",{"type":18,"tag":185,"props":424,"children":425},{"style":218},[426],{"type":24,"value":427}," feed ",{"type":18,"tag":185,"props":429,"children":430},{"style":198},[431],{"type":24,"value":432},"-q",{"type":18,"tag":185,"props":434,"children":436},{"style":435},"--shiki-default:#D73A49;--shiki-dark:#F97583",[437],{"type":24,"value":438}," |",{"type":18,"tag":185,"props":440,"children":441},{"style":192},[442],{"type":24,"value":443}," tail",{"type":18,"tag":185,"props":445,"children":446},{"style":198},[447],{"type":24,"value":448}," -1",{"type":18,"tag":185,"props":450,"children":451},{"style":218},[452],{"type":24,"value":453},")\n",{"type":18,"tag":27,"props":455,"children":456},{},[457,459,464],{"type":24,"value":458},"You should see a json feed in ",{"type":18,"tag":181,"props":460,"children":461},{"className":10},[462],{"type":24,"value":463},"feed/header_spider-\u003Ctime string>.json",{"type":24,"value":465}," with the scraped data.",{"type":18,"tag":27,"props":467,"children":468},{},[469,471,476,478,483],{"type":24,"value":470},"Next, we create files to launch the scraper from a script, which will be needed in Lambda and Fargate. We'll create 2 new files to make this work in different scenarios, ",{"type":18,"tag":181,"props":472,"children":473},{"className":10},[474],{"type":24,"value":475},"launcher.py",{"type":24,"value":477}," and ",{"type":18,"tag":181,"props":479,"children":480},{"className":10},[481],{"type":24,"value":482},"my_sls_scraper/crawl.py",{"type":24,"value":74},{"type":18,"tag":174,"props":485,"children":487},{"code":486,"language":195,"meta":10,"className":332,"style":10},"# my_sls_scraper/crawl.py\nimport sys\nimport imp\nimport os\nimport logging\nfrom urllib.parse import urlparse\n\nfrom scrapy.spiderloader import SpiderLoader\nfrom scrapy.crawler import CrawlerProcess\nfrom scrapy.utils.project import get_project_settings\n\n# Need to \"mock\" sqlite for the process to not crash in AWS Lambda / Amazon Linux\nsys.modules[\"sqlite\"] = imp.new_module(\"sqlite\")\nsys.modules[\"sqlite3.dbapi2\"] = imp.new_module(\"sqlite.dbapi2\")\n\n\ndef is_in_aws():\n    return os.getenv('AWS_EXECUTION_ENV') is not None\n\n\ndef crawl(settings={}, spider_name=\"header_spider\", spider_kwargs={}):\n    project_settings = get_project_settings()\n    spider_loader = SpiderLoader(project_settings)\n\n    spider_cls = spider_loader.load(spider_name)\n\n    feed_uri = \"\"\n    feed_format = \"json\"\n\n    try:\n        spider_key = urlparse(spider_kwargs.get(\"start_urls\")[0]).hostname if spider_kwargs.get(\n            \"start_urls\") else urlparse(spider_cls.start_urls[0]).hostname\n    except Exception:\n        logging.exception(\"Spider or kwargs need start_urls.\")\n\n    if is_in_aws():\n        # Lambda can only write to the /tmp folder.\n        settings['HTTPCACHE_DIR'] =  \"/tmp\"\n    else:\n        feed_uri = \"file://{}/%(name)s-{}-%(time)s.json\".format(\n            os.path.join(os.getcwd(), \"feed\"),\n            spider_key,\n        )\n\n    settings['FEED_URI'] = feed_uri\n    settings['FEED_FORMAT'] = feed_format\n\n    process = CrawlerProcess({**project_settings, **settings})\n\n    process.crawl(spider_cls, **spider_kwargs)\n    process.start()\n",[488],{"type":18,"tag":181,"props":489,"children":490},{"__ignoreMap":10},[491],{"type":24,"value":486},{"type":18,"tag":174,"props":493,"children":495},{"code":494,"language":195,"meta":10,"className":332,"style":10},"# launcher.py'\nimport sys\nimport json\n\nfrom my_sls_scraper.crawl import crawl\n\n\ndef scrape(event={}, context={}):\n    crawl(**event)\n\n\nif __name__ == \"__main__\":\n    try:\n        event = json.loads(sys.argv[1])\n    except IndexError:\n        event = {}\n    scrape(event)\n",[496],{"type":18,"tag":181,"props":497,"children":498},{"__ignoreMap":10},[499],{"type":24,"value":494},{"type":18,"tag":27,"props":501,"children":502},{},[503,505,509],{"type":24,"value":504},"Check that you can scrape by executing ",{"type":18,"tag":181,"props":506,"children":507},{"className":10},[508],{"type":24,"value":475},{"type":24,"value":510}," with",{"type":18,"tag":174,"props":512,"children":514},{"code":513,"language":177,"meta":10,"className":178,"style":10},"python launcher.py\n",[515],{"type":18,"tag":181,"props":516,"children":517},{"__ignoreMap":10},[518],{"type":18,"tag":185,"props":519,"children":520},{"class":187,"line":188},[521,525],{"type":18,"tag":185,"props":522,"children":523},{"style":192},[524],{"type":24,"value":195},{"type":18,"tag":185,"props":526,"children":527},{"style":218},[528],{"type":24,"value":529}," launcher.py\n",{"type":18,"tag":27,"props":531,"children":532},{},[533],{"type":24,"value":534},"If that works, the scraper is pretty much done, and we'll spend the rest of the guide on AWS and Serverless stuff.",{"type":18,"tag":19,"props":536,"children":538},{"id":537},"setting-up-an-aws-lambda-function",[539],{"type":24,"value":540},"Setting up an AWS Lambda function",{"type":18,"tag":27,"props":542,"children":543},{},[544,546,551],{"type":24,"value":545},"Initialize serverless in the same directory as ",{"type":18,"tag":181,"props":547,"children":548},{"className":10},[549],{"type":24,"value":550},"scrapy.cfg",{"type":24,"value":510},{"type":18,"tag":174,"props":553,"children":555},{"code":554,"language":177,"meta":10,"className":178,"style":10},"serverless create --template aws-python3 --name my-sls-scraper\n",[556],{"type":18,"tag":181,"props":557,"children":558},{"__ignoreMap":10},[559],{"type":18,"tag":185,"props":560,"children":561},{"class":187,"line":188},[562,566,571,576,581,586],{"type":18,"tag":185,"props":563,"children":564},{"style":192},[565],{"type":24,"value":153},{"type":18,"tag":185,"props":567,"children":568},{"style":218},[569],{"type":24,"value":570}," create",{"type":18,"tag":185,"props":572,"children":573},{"style":198},[574],{"type":24,"value":575}," --template",{"type":18,"tag":185,"props":577,"children":578},{"style":218},[579],{"type":24,"value":580}," aws-python3",{"type":18,"tag":185,"props":582,"children":583},{"style":198},[584],{"type":24,"value":585}," --name",{"type":18,"tag":185,"props":587,"children":588},{"style":218},[589],{"type":24,"value":590}," my-sls-scraper\n",{"type":18,"tag":27,"props":592,"children":593},{},[594,596,603,605,610],{"type":24,"value":595},"You need to have an AWS account and created an IAM admin user to work with Serverless. If you haven't follow the steps on ",{"type":18,"tag":33,"props":597,"children":600},{"href":598,"rel":599},"https://serverless.com/framework/docs/providers/aws/guide/credentials/",[37],[601],{"type":24,"value":602},"this guide",{"type":24,"value":604}," to get started. I like using aws profiles where you store the credentials in ",{"type":18,"tag":181,"props":606,"children":607},{"className":10},[608],{"type":24,"value":609},"~/.aws/credentials",{"type":24,"value":611},", but see the link for what works best for you.",{"type":18,"tag":27,"props":613,"children":614},{},[615],{"type":24,"value":616},"If you're not familiar with AWS and Serverless, you will run into many weird issues that are hard to debug. To mitigate that, deploy the function for every change you make in the configuration of Serverless and the scraper to make it easier to identify what causes things to break.",{"type":18,"tag":27,"props":618,"children":619},{},[620],{"type":24,"value":621},"We'll start by deploying the dummy default Lambda function. Do it with",{"type":18,"tag":174,"props":623,"children":625},{"code":624,"language":177,"meta":10,"className":178,"style":10},"sls deploy -f hello\n",[626],{"type":18,"tag":181,"props":627,"children":628},{"__ignoreMap":10},[629],{"type":18,"tag":185,"props":630,"children":631},{"class":187,"line":188},[632,637,642,647],{"type":18,"tag":185,"props":633,"children":634},{"style":192},[635],{"type":24,"value":636},"sls",{"type":18,"tag":185,"props":638,"children":639},{"style":218},[640],{"type":24,"value":641}," deploy",{"type":18,"tag":185,"props":643,"children":644},{"style":198},[645],{"type":24,"value":646}," -f",{"type":18,"tag":185,"props":648,"children":649},{"style":218},[650],{"type":24,"value":651}," hello\n",{"type":18,"tag":27,"props":653,"children":654},{},[655,657,662],{"type":24,"value":656},"If you use aws profiles for credentials and you have a profile called ",{"type":18,"tag":181,"props":658,"children":659},{"className":10},[660],{"type":24,"value":661},"my-sls-admin",{"type":24,"value":663},", you can deploy with",{"type":18,"tag":174,"props":665,"children":667},{"code":666,"language":177,"meta":10,"className":178,"style":10},"sls deploy -f hello --aws-profile my-sls-admin\n",[668],{"type":18,"tag":181,"props":669,"children":670},{"__ignoreMap":10},[671],{"type":18,"tag":185,"props":672,"children":673},{"class":187,"line":188},[674,678,682,686,691,696],{"type":18,"tag":185,"props":675,"children":676},{"style":192},[677],{"type":24,"value":636},{"type":18,"tag":185,"props":679,"children":680},{"style":218},[681],{"type":24,"value":641},{"type":18,"tag":185,"props":683,"children":684},{"style":198},[685],{"type":24,"value":646},{"type":18,"tag":185,"props":687,"children":688},{"style":218},[689],{"type":24,"value":690}," hello",{"type":18,"tag":185,"props":692,"children":693},{"style":198},[694],{"type":24,"value":695}," --aws-profile",{"type":18,"tag":185,"props":697,"children":698},{"style":218},[699],{"type":24,"value":700}," my-sls-admin\n",{"type":18,"tag":27,"props":702,"children":703},{},[704,706,711],{"type":24,"value":705},"or add the profile key under provider in ",{"type":18,"tag":181,"props":707,"children":708},{"className":10},[709],{"type":24,"value":710},"serverless.yml",{"type":24,"value":74},{"type":18,"tag":174,"props":713,"children":717},{"code":714,"language":715,"meta":10,"className":716,"style":10},"# serverless.yml\n# ...\nprovider:\n  name: aws\nruntime: python3.7\nprofile: my-sls-admin\n# ...\n","yaml","language-yaml shiki shiki-themes github-light github-dark",[718],{"type":18,"tag":181,"props":719,"children":720},{"__ignoreMap":10},[721,729,737,751,770,788,806],{"type":18,"tag":185,"props":722,"children":723},{"class":187,"line":188},[724],{"type":18,"tag":185,"props":725,"children":726},{"style":204},[727],{"type":24,"value":728},"# serverless.yml\n",{"type":18,"tag":185,"props":730,"children":731},{"class":187,"line":210},[732],{"type":18,"tag":185,"props":733,"children":734},{"style":204},[735],{"type":24,"value":736},"# ...\n",{"type":18,"tag":185,"props":738,"children":739},{"class":187,"line":288},[740,746],{"type":18,"tag":185,"props":741,"children":743},{"style":742},"--shiki-default:#22863A;--shiki-dark:#85E89D",[744],{"type":24,"value":745},"provider",{"type":18,"tag":185,"props":747,"children":748},{"style":249},[749],{"type":24,"value":750},":\n",{"type":18,"tag":185,"props":752,"children":754},{"class":187,"line":753},4,[755,760,765],{"type":18,"tag":185,"props":756,"children":757},{"style":742},[758],{"type":24,"value":759},"  name",{"type":18,"tag":185,"props":761,"children":762},{"style":249},[763],{"type":24,"value":764},": ",{"type":18,"tag":185,"props":766,"children":767},{"style":218},[768],{"type":24,"value":769},"aws\n",{"type":18,"tag":185,"props":771,"children":773},{"class":187,"line":772},5,[774,779,783],{"type":18,"tag":185,"props":775,"children":776},{"style":742},[777],{"type":24,"value":778},"runtime",{"type":18,"tag":185,"props":780,"children":781},{"style":249},[782],{"type":24,"value":764},{"type":18,"tag":185,"props":784,"children":785},{"style":218},[786],{"type":24,"value":787},"python3.7\n",{"type":18,"tag":185,"props":789,"children":791},{"class":187,"line":790},6,[792,797,801],{"type":18,"tag":185,"props":793,"children":794},{"style":742},[795],{"type":24,"value":796},"profile",{"type":18,"tag":185,"props":798,"children":799},{"style":249},[800],{"type":24,"value":764},{"type":18,"tag":185,"props":802,"children":803},{"style":218},[804],{"type":24,"value":805},"my-sls-admin\n",{"type":18,"tag":185,"props":807,"children":809},{"class":187,"line":808},7,[810],{"type":18,"tag":185,"props":811,"children":812},{"style":204},[813],{"type":24,"value":736},{"type":18,"tag":27,"props":815,"children":816},{},[817],{"type":24,"value":818},"When deploying, the output should be similar to",{"type":18,"tag":174,"props":820,"children":822},{"code":821},"11:40 $ sls deploy\nServerless: Packaging service...\nServerless: Excluding development dependencies...\nServerless: Creating Stack...\nServerless: Checking Stack create progress...\n.....\nServerless: Stack create finished...\nServerless: Uploading CloudFormation file to S3...\nServerless: Uploading artifacts...\nServerless: Uploading service my-sls-scraper.zip file to S3 (162.74 KB)...\nServerless: Validating template...\nServerless: Updating Stack...\nServerless: Checking Stack update progress...\n...............\nServerless: Stack update finished...\nService Information\nservice: my-sls-scraper\nstage: dev\nregion: us-east-1\nstack: my-sls-scraper-dev\nresources: 5\napi keys:\n  None\nendpoints:\n  None\nfunctions:\n  hello: my-sls-scraper-dev-hello\nlayers:\n  None\nServerless: Run the \"serverless\" command to setup monitoring, troubleshooting and testing.\n",[823],{"type":18,"tag":181,"props":824,"children":825},{"__ignoreMap":10},[826],{"type":24,"value":821},{"type":18,"tag":27,"props":828,"children":829},{},[830,832,839],{"type":24,"value":831},"You should now see the deployed function in the ",{"type":18,"tag":33,"props":833,"children":836},{"href":834,"rel":835},"https://console.aws.amazon.com/lambda/home",[37],[837],{"type":24,"value":838},"AWS Lambda web console",{"type":24,"value":840},". (Change your region if you don't see it!)",{"type":18,"tag":27,"props":842,"children":843},{},[844],{"type":24,"value":845},"Verify that the function can be invoked and see its output with",{"type":18,"tag":174,"props":847,"children":849},{"code":848,"language":177,"meta":10,"className":178,"style":10},"sls invoke -f hello --log\n",[850],{"type":18,"tag":181,"props":851,"children":852},{"__ignoreMap":10},[853],{"type":18,"tag":185,"props":854,"children":855},{"class":187,"line":188},[856,860,865,869,873],{"type":18,"tag":185,"props":857,"children":858},{"style":192},[859],{"type":24,"value":636},{"type":18,"tag":185,"props":861,"children":862},{"style":218},[863],{"type":24,"value":864}," invoke",{"type":18,"tag":185,"props":866,"children":867},{"style":198},[868],{"type":24,"value":646},{"type":18,"tag":185,"props":870,"children":871},{"style":218},[872],{"type":24,"value":690},{"type":18,"tag":185,"props":874,"children":875},{"style":198},[876],{"type":24,"value":877}," --log\n",{"type":18,"tag":27,"props":879,"children":880},{},[881],{"type":24,"value":882},"The output should be something like",{"type":18,"tag":174,"props":884,"children":886},{"code":885},"12:12 $ sls invoke -f hello --log\n{\n    \"statusCode\": 200,\n    \"body\": \"{\\\"message\\\": \\\"Go Serverless v1.0! Your function executed successfully!\\\", \\\"input\\\": {}}\"\n}\n--------------------------------------------------------------------\nSTART RequestId: f38a0d84-e974-4a00-93ab-9e2825d94003 Version: $LATEST\nEND RequestId: f38a0d84-e974-4a00-93ab-9e2825d94003\nREPORT RequestId: f38a0d84-e974-4a00-93ab-9e2825d94003  Duration: 1.62 ms   Billed Duration: 100 ms Memory Size: 1024 MB    Max Memory Used: 56 MB  Init Duration: 110.34 ms\n\nXRAY TraceId: 1-5d723275-c57192d30e2a524902b401fd   SegmentId: 5cc7e2685a1e85bc Sampled: false\n",[887],{"type":18,"tag":181,"props":888,"children":889},{"__ignoreMap":10},[890],{"type":24,"value":885},{"type":18,"tag":27,"props":892,"children":893},{},[894,896,901],{"type":24,"value":895},"Now we'll need to package the function in a way that includes all the dependencies. Install the ",{"type":18,"tag":181,"props":897,"children":898},{"className":10},[899],{"type":24,"value":900},"serverless-python-requirements",{"type":24,"value":902}," plugin with",{"type":18,"tag":174,"props":904,"children":906},{"code":905,"language":177,"meta":10,"className":178,"style":10},"sls plugin install --name serverless-python-requirements\n",[907],{"type":18,"tag":181,"props":908,"children":909},{"__ignoreMap":10},[910],{"type":18,"tag":185,"props":911,"children":912},{"class":187,"line":188},[913,917,922,926,930],{"type":18,"tag":185,"props":914,"children":915},{"style":192},[916],{"type":24,"value":636},{"type":18,"tag":185,"props":918,"children":919},{"style":218},[920],{"type":24,"value":921}," plugin",{"type":18,"tag":185,"props":923,"children":924},{"style":218},[925],{"type":24,"value":221},{"type":18,"tag":185,"props":927,"children":928},{"style":198},[929],{"type":24,"value":585},{"type":18,"tag":185,"props":931,"children":932},{"style":218},[933],{"type":24,"value":934}," serverless-python-requirements\n",{"type":18,"tag":27,"props":936,"children":937},{},[938,940,944],{"type":24,"value":939},"And rehaul ",{"type":18,"tag":181,"props":941,"children":942},{"className":10},[943],{"type":24,"value":710},{"type":24,"value":74},{"type":18,"tag":174,"props":946,"children":948},{"code":947,"language":715,"meta":10,"className":716,"style":10},"# serverless.yml\nservice: my-sls-scraper\n\nprovider:\n  name: aws\n  runtime: python3.7\n  logRetentionInDays: 1\n\nfunctions:\n  hello:\n    handler: handler.hello\n  lambdaScrape:\n    handler: launcher.scrape\n\n# We include files by whitelisting to reduce the deployment time.\n# Just remember to add any files you create!\npackage:\n  include:\n    - handler.py\n    - launcher.py\n    - my_sls_scraper/**\n    - scrapy.cfg\n  exclude:\n    - \"./**\"\n\nplugins:\n  - serverless-python-requirements\n\ncustom:\n  pythonRequirements:\n    slim: true # Omits tests, __pycache__, *.pyc etc from dependencies\n    fileName: requirements.txt\n",[949],{"type":18,"tag":181,"props":950,"children":951},{"__ignoreMap":10},[952,959,976,985,996,1011,1027,1044,1052,1065,1078,1096,1109,1126,1134,1143,1152,1165,1178,1192,1205,1218,1231,1244,1257,1265,1278,1292,1300,1313,1326,1349],{"type":18,"tag":185,"props":953,"children":954},{"class":187,"line":188},[955],{"type":18,"tag":185,"props":956,"children":957},{"style":204},[958],{"type":24,"value":728},{"type":18,"tag":185,"props":960,"children":961},{"class":187,"line":210},[962,967,971],{"type":18,"tag":185,"props":963,"children":964},{"style":742},[965],{"type":24,"value":966},"service",{"type":18,"tag":185,"props":968,"children":969},{"style":249},[970],{"type":24,"value":764},{"type":18,"tag":185,"props":972,"children":973},{"style":218},[974],{"type":24,"value":975},"my-sls-scraper\n",{"type":18,"tag":185,"props":977,"children":978},{"class":187,"line":288},[979],{"type":18,"tag":185,"props":980,"children":982},{"emptyLinePlaceholder":981},true,[983],{"type":24,"value":984},"\n",{"type":18,"tag":185,"props":986,"children":987},{"class":187,"line":753},[988,992],{"type":18,"tag":185,"props":989,"children":990},{"style":742},[991],{"type":24,"value":745},{"type":18,"tag":185,"props":993,"children":994},{"style":249},[995],{"type":24,"value":750},{"type":18,"tag":185,"props":997,"children":998},{"class":187,"line":772},[999,1003,1007],{"type":18,"tag":185,"props":1000,"children":1001},{"style":742},[1002],{"type":24,"value":759},{"type":18,"tag":185,"props":1004,"children":1005},{"style":249},[1006],{"type":24,"value":764},{"type":18,"tag":185,"props":1008,"children":1009},{"style":218},[1010],{"type":24,"value":769},{"type":18,"tag":185,"props":1012,"children":1013},{"class":187,"line":790},[1014,1019,1023],{"type":18,"tag":185,"props":1015,"children":1016},{"style":742},[1017],{"type":24,"value":1018},"  runtime",{"type":18,"tag":185,"props":1020,"children":1021},{"style":249},[1022],{"type":24,"value":764},{"type":18,"tag":185,"props":1024,"children":1025},{"style":218},[1026],{"type":24,"value":787},{"type":18,"tag":185,"props":1028,"children":1029},{"class":187,"line":808},[1030,1035,1039],{"type":18,"tag":185,"props":1031,"children":1032},{"style":742},[1033],{"type":24,"value":1034},"  logRetentionInDays",{"type":18,"tag":185,"props":1036,"children":1037},{"style":249},[1038],{"type":24,"value":764},{"type":18,"tag":185,"props":1040,"children":1041},{"style":198},[1042],{"type":24,"value":1043},"1\n",{"type":18,"tag":185,"props":1045,"children":1047},{"class":187,"line":1046},8,[1048],{"type":18,"tag":185,"props":1049,"children":1050},{"emptyLinePlaceholder":981},[1051],{"type":24,"value":984},{"type":18,"tag":185,"props":1053,"children":1055},{"class":187,"line":1054},9,[1056,1061],{"type":18,"tag":185,"props":1057,"children":1058},{"style":742},[1059],{"type":24,"value":1060},"functions",{"type":18,"tag":185,"props":1062,"children":1063},{"style":249},[1064],{"type":24,"value":750},{"type":18,"tag":185,"props":1066,"children":1068},{"class":187,"line":1067},10,[1069,1074],{"type":18,"tag":185,"props":1070,"children":1071},{"style":742},[1072],{"type":24,"value":1073},"  hello",{"type":18,"tag":185,"props":1075,"children":1076},{"style":249},[1077],{"type":24,"value":750},{"type":18,"tag":185,"props":1079,"children":1081},{"class":187,"line":1080},11,[1082,1087,1091],{"type":18,"tag":185,"props":1083,"children":1084},{"style":742},[1085],{"type":24,"value":1086},"    handler",{"type":18,"tag":185,"props":1088,"children":1089},{"style":249},[1090],{"type":24,"value":764},{"type":18,"tag":185,"props":1092,"children":1093},{"style":218},[1094],{"type":24,"value":1095},"handler.hello\n",{"type":18,"tag":185,"props":1097,"children":1099},{"class":187,"line":1098},12,[1100,1105],{"type":18,"tag":185,"props":1101,"children":1102},{"style":742},[1103],{"type":24,"value":1104},"  lambdaScrape",{"type":18,"tag":185,"props":1106,"children":1107},{"style":249},[1108],{"type":24,"value":750},{"type":18,"tag":185,"props":1110,"children":1112},{"class":187,"line":1111},13,[1113,1117,1121],{"type":18,"tag":185,"props":1114,"children":1115},{"style":742},[1116],{"type":24,"value":1086},{"type":18,"tag":185,"props":1118,"children":1119},{"style":249},[1120],{"type":24,"value":764},{"type":18,"tag":185,"props":1122,"children":1123},{"style":218},[1124],{"type":24,"value":1125},"launcher.scrape\n",{"type":18,"tag":185,"props":1127,"children":1129},{"class":187,"line":1128},14,[1130],{"type":18,"tag":185,"props":1131,"children":1132},{"emptyLinePlaceholder":981},[1133],{"type":24,"value":984},{"type":18,"tag":185,"props":1135,"children":1137},{"class":187,"line":1136},15,[1138],{"type":18,"tag":185,"props":1139,"children":1140},{"style":204},[1141],{"type":24,"value":1142},"# We include files by whitelisting to reduce the deployment time.\n",{"type":18,"tag":185,"props":1144,"children":1146},{"class":187,"line":1145},16,[1147],{"type":18,"tag":185,"props":1148,"children":1149},{"style":204},[1150],{"type":24,"value":1151},"# Just remember to add any files you create!\n",{"type":18,"tag":185,"props":1153,"children":1155},{"class":187,"line":1154},17,[1156,1161],{"type":18,"tag":185,"props":1157,"children":1158},{"style":742},[1159],{"type":24,"value":1160},"package",{"type":18,"tag":185,"props":1162,"children":1163},{"style":249},[1164],{"type":24,"value":750},{"type":18,"tag":185,"props":1166,"children":1168},{"class":187,"line":1167},18,[1169,1174],{"type":18,"tag":185,"props":1170,"children":1171},{"style":742},[1172],{"type":24,"value":1173},"  include",{"type":18,"tag":185,"props":1175,"children":1176},{"style":249},[1177],{"type":24,"value":750},{"type":18,"tag":185,"props":1179,"children":1181},{"class":187,"line":1180},19,[1182,1187],{"type":18,"tag":185,"props":1183,"children":1184},{"style":249},[1185],{"type":24,"value":1186},"    - ",{"type":18,"tag":185,"props":1188,"children":1189},{"style":218},[1190],{"type":24,"value":1191},"handler.py\n",{"type":18,"tag":185,"props":1193,"children":1195},{"class":187,"line":1194},20,[1196,1200],{"type":18,"tag":185,"props":1197,"children":1198},{"style":249},[1199],{"type":24,"value":1186},{"type":18,"tag":185,"props":1201,"children":1202},{"style":218},[1203],{"type":24,"value":1204},"launcher.py\n",{"type":18,"tag":185,"props":1206,"children":1208},{"class":187,"line":1207},21,[1209,1213],{"type":18,"tag":185,"props":1210,"children":1211},{"style":249},[1212],{"type":24,"value":1186},{"type":18,"tag":185,"props":1214,"children":1215},{"style":218},[1216],{"type":24,"value":1217},"my_sls_scraper/**\n",{"type":18,"tag":185,"props":1219,"children":1221},{"class":187,"line":1220},22,[1222,1226],{"type":18,"tag":185,"props":1223,"children":1224},{"style":249},[1225],{"type":24,"value":1186},{"type":18,"tag":185,"props":1227,"children":1228},{"style":218},[1229],{"type":24,"value":1230},"scrapy.cfg\n",{"type":18,"tag":185,"props":1232,"children":1234},{"class":187,"line":1233},23,[1235,1240],{"type":18,"tag":185,"props":1236,"children":1237},{"style":742},[1238],{"type":24,"value":1239},"  exclude",{"type":18,"tag":185,"props":1241,"children":1242},{"style":249},[1243],{"type":24,"value":750},{"type":18,"tag":185,"props":1245,"children":1247},{"class":187,"line":1246},24,[1248,1252],{"type":18,"tag":185,"props":1249,"children":1250},{"style":249},[1251],{"type":24,"value":1186},{"type":18,"tag":185,"props":1253,"children":1254},{"style":218},[1255],{"type":24,"value":1256},"\"./**\"\n",{"type":18,"tag":185,"props":1258,"children":1260},{"class":187,"line":1259},25,[1261],{"type":18,"tag":185,"props":1262,"children":1263},{"emptyLinePlaceholder":981},[1264],{"type":24,"value":984},{"type":18,"tag":185,"props":1266,"children":1268},{"class":187,"line":1267},26,[1269,1274],{"type":18,"tag":185,"props":1270,"children":1271},{"style":742},[1272],{"type":24,"value":1273},"plugins",{"type":18,"tag":185,"props":1275,"children":1276},{"style":249},[1277],{"type":24,"value":750},{"type":18,"tag":185,"props":1279,"children":1281},{"class":187,"line":1280},27,[1282,1287],{"type":18,"tag":185,"props":1283,"children":1284},{"style":249},[1285],{"type":24,"value":1286},"  - ",{"type":18,"tag":185,"props":1288,"children":1289},{"style":218},[1290],{"type":24,"value":1291},"serverless-python-requirements\n",{"type":18,"tag":185,"props":1293,"children":1295},{"class":187,"line":1294},28,[1296],{"type":18,"tag":185,"props":1297,"children":1298},{"emptyLinePlaceholder":981},[1299],{"type":24,"value":984},{"type":18,"tag":185,"props":1301,"children":1303},{"class":187,"line":1302},29,[1304,1309],{"type":18,"tag":185,"props":1305,"children":1306},{"style":742},[1307],{"type":24,"value":1308},"custom",{"type":18,"tag":185,"props":1310,"children":1311},{"style":249},[1312],{"type":24,"value":750},{"type":18,"tag":185,"props":1314,"children":1316},{"class":187,"line":1315},30,[1317,1322],{"type":18,"tag":185,"props":1318,"children":1319},{"style":742},[1320],{"type":24,"value":1321},"  pythonRequirements",{"type":18,"tag":185,"props":1323,"children":1324},{"style":249},[1325],{"type":24,"value":750},{"type":18,"tag":185,"props":1327,"children":1329},{"class":187,"line":1328},31,[1330,1335,1339,1344],{"type":18,"tag":185,"props":1331,"children":1332},{"style":742},[1333],{"type":24,"value":1334},"    slim",{"type":18,"tag":185,"props":1336,"children":1337},{"style":249},[1338],{"type":24,"value":764},{"type":18,"tag":185,"props":1340,"children":1341},{"style":198},[1342],{"type":24,"value":1343},"true",{"type":18,"tag":185,"props":1345,"children":1346},{"style":204},[1347],{"type":24,"value":1348}," # Omits tests, __pycache__, *.pyc etc from dependencies\n",{"type":18,"tag":185,"props":1350,"children":1352},{"class":187,"line":1351},32,[1353,1358,1362],{"type":18,"tag":185,"props":1354,"children":1355},{"style":742},[1356],{"type":24,"value":1357},"    fileName",{"type":18,"tag":185,"props":1359,"children":1360},{"style":249},[1361],{"type":24,"value":764},{"type":18,"tag":185,"props":1363,"children":1364},{"style":218},[1365],{"type":24,"value":1366},"requirements.txt\n",{"type":18,"tag":27,"props":1368,"children":1369},{},[1370,1372,1377],{"type":24,"value":1371},"Note that we added a new function ",{"type":18,"tag":181,"props":1373,"children":1374},{"className":10},[1375],{"type":24,"value":1376},"lambdaScrape",{"type":24,"value":1378}," that does the scraping in the Lambda function.",{"type":18,"tag":27,"props":1380,"children":1381},{},[1382,1384,1389],{"type":24,"value":1383},"We also need a minimal ",{"type":18,"tag":181,"props":1385,"children":1386},{"className":10},[1387],{"type":24,"value":1388},"requirements.txt",{"type":24,"value":1390}," for pip requirements.",{"type":18,"tag":174,"props":1392,"children":1394},{"code":1393,"language":177,"meta":10,"className":178,"style":10},"# requirements.txt\nScrapy==1.7.3\n",[1395],{"type":18,"tag":181,"props":1396,"children":1397},{"__ignoreMap":10},[1398,1406],{"type":18,"tag":185,"props":1399,"children":1400},{"class":187,"line":188},[1401],{"type":18,"tag":185,"props":1402,"children":1403},{"style":204},[1404],{"type":24,"value":1405},"# requirements.txt\n",{"type":18,"tag":185,"props":1407,"children":1408},{"class":187,"line":210},[1409,1413,1418,1422,1427],{"type":18,"tag":185,"props":1410,"children":1411},{"style":249},[1412],{"type":24,"value":49},{"type":18,"tag":185,"props":1414,"children":1415},{"style":435},[1416],{"type":24,"value":1417},"=",{"type":18,"tag":185,"props":1419,"children":1420},{"style":218},[1421],{"type":24,"value":1417},{"type":18,"tag":185,"props":1423,"children":1424},{"style":198},[1425],{"type":24,"value":1426},"1.7",{"type":18,"tag":185,"props":1428,"children":1429},{"style":218},[1430],{"type":24,"value":1431},".3\n",{"type":18,"tag":27,"props":1433,"children":1434},{},[1435],{"type":24,"value":1436},"Try to deploy the function again and see that it works.",{"type":18,"tag":174,"props":1438,"children":1440},{"code":1439,"language":177,"meta":10,"className":178,"style":10},"sls deploy --verbose\nsls invoke -f hello --log\nsls invoke -f lambdaScrape --log\n",[1441],{"type":18,"tag":181,"props":1442,"children":1443},{"__ignoreMap":10},[1444,1460,1483],{"type":18,"tag":185,"props":1445,"children":1446},{"class":187,"line":188},[1447,1451,1455],{"type":18,"tag":185,"props":1448,"children":1449},{"style":192},[1450],{"type":24,"value":636},{"type":18,"tag":185,"props":1452,"children":1453},{"style":218},[1454],{"type":24,"value":641},{"type":18,"tag":185,"props":1456,"children":1457},{"style":198},[1458],{"type":24,"value":1459}," --verbose\n",{"type":18,"tag":185,"props":1461,"children":1462},{"class":187,"line":210},[1463,1467,1471,1475,1479],{"type":18,"tag":185,"props":1464,"children":1465},{"style":192},[1466],{"type":24,"value":636},{"type":18,"tag":185,"props":1468,"children":1469},{"style":218},[1470],{"type":24,"value":864},{"type":18,"tag":185,"props":1472,"children":1473},{"style":198},[1474],{"type":24,"value":646},{"type":18,"tag":185,"props":1476,"children":1477},{"style":218},[1478],{"type":24,"value":690},{"type":18,"tag":185,"props":1480,"children":1481},{"style":198},[1482],{"type":24,"value":877},{"type":18,"tag":185,"props":1484,"children":1485},{"class":187,"line":288},[1486,1490,1494,1498,1503],{"type":18,"tag":185,"props":1487,"children":1488},{"style":192},[1489],{"type":24,"value":636},{"type":18,"tag":185,"props":1491,"children":1492},{"style":218},[1493],{"type":24,"value":864},{"type":18,"tag":185,"props":1495,"children":1496},{"style":198},[1497],{"type":24,"value":646},{"type":18,"tag":185,"props":1499,"children":1500},{"style":218},[1501],{"type":24,"value":1502}," lambdaScrape",{"type":18,"tag":185,"props":1504,"children":1505},{"style":198},[1506],{"type":24,"value":877},{"type":18,"tag":27,"props":1508,"children":1509},{},[1510],{"type":24,"value":1511},"We've now created the minimal solution for serverless scraping – well done! In the rest of the guide we'll set up more resources in the AWS platform to store the scraped data and run long crawls in Fargate instead of Lambda.",{"type":18,"tag":19,"props":1513,"children":1515},{"id":1514},"storing-scraped-data-in-s3",[1516],{"type":24,"value":1517},"Storing scraped data in S3",{"type":18,"tag":27,"props":1519,"children":1520},{},[1521,1523,1527,1529,1534],{"type":24,"value":1522},"Storing the scraped data in S3 gives us a low-cost repository for spider outputs which can be used to further process the data. We will use the config in ",{"type":18,"tag":181,"props":1524,"children":1525},{"className":10},[1526],{"type":24,"value":710},{"type":24,"value":1528}," and CloudFormation templates to create and use resources in the AWS ecosystem, so that we follow the ",{"type":18,"tag":149,"props":1530,"children":1531},{},[1532],{"type":24,"value":1533},"infrastructure as code",{"type":24,"value":1535}," paradigm.",{"type":18,"tag":27,"props":1537,"children":1538},{},[1539,1541,1546,1548,1553,1555,1559],{"type":24,"value":1540},"Before we continue, let's install a useful plugin that lets us use ",{"type":18,"tag":181,"props":1542,"children":1543},{"className":10},[1544],{"type":24,"value":1545},"!Sub",{"type":24,"value":1547}," commands in out templates called ",{"type":18,"tag":181,"props":1549,"children":1550},{"className":10},[1551],{"type":24,"value":1552},"serverless-cloudformation-sub-variables",{"type":24,"value":1554}," and add it to our ",{"type":18,"tag":181,"props":1556,"children":1557},{"className":10},[1558],{"type":24,"value":710},{"type":24,"value":510},{"type":18,"tag":174,"props":1561,"children":1563},{"code":1562,"language":177,"meta":10,"className":178,"style":10},"sls plugin install --name serverless-cloudformation-sub-variables\n",[1564],{"type":18,"tag":181,"props":1565,"children":1566},{"__ignoreMap":10},[1567],{"type":18,"tag":185,"props":1568,"children":1569},{"class":187,"line":188},[1570,1574,1578,1582,1586],{"type":18,"tag":185,"props":1571,"children":1572},{"style":192},[1573],{"type":24,"value":636},{"type":18,"tag":185,"props":1575,"children":1576},{"style":218},[1577],{"type":24,"value":921},{"type":18,"tag":185,"props":1579,"children":1580},{"style":218},[1581],{"type":24,"value":221},{"type":18,"tag":185,"props":1583,"children":1584},{"style":198},[1585],{"type":24,"value":585},{"type":18,"tag":185,"props":1587,"children":1588},{"style":218},[1589],{"type":24,"value":1590}," serverless-cloudformation-sub-variables\n",{"type":18,"tag":27,"props":1592,"children":1593},{},[1594,1596,1601],{"type":24,"value":1595},"Let's create the templates in a separate file called ",{"type":18,"tag":181,"props":1597,"children":1598},{"className":10},[1599],{"type":24,"value":1600},"s3-template.yml",{"type":24,"value":1602}," as the template will get quite large later.",{"type":18,"tag":174,"props":1604,"children":1606},{"code":1605,"language":715,"meta":10,"className":716,"style":10},"# s3-template.yml\nResources:\n  ScraperFeedBucket:\n    Type: AWS::S3::Bucket\n    Properties:\n      VersioningConfiguration:\n        Status: \"Enabled\"\n",[1607],{"type":18,"tag":181,"props":1608,"children":1609},{"__ignoreMap":10},[1610,1618,1630,1642,1659,1671,1683],{"type":18,"tag":185,"props":1611,"children":1612},{"class":187,"line":188},[1613],{"type":18,"tag":185,"props":1614,"children":1615},{"style":204},[1616],{"type":24,"value":1617},"# s3-template.yml\n",{"type":18,"tag":185,"props":1619,"children":1620},{"class":187,"line":210},[1621,1626],{"type":18,"tag":185,"props":1622,"children":1623},{"style":742},[1624],{"type":24,"value":1625},"Resources",{"type":18,"tag":185,"props":1627,"children":1628},{"style":249},[1629],{"type":24,"value":750},{"type":18,"tag":185,"props":1631,"children":1632},{"class":187,"line":288},[1633,1638],{"type":18,"tag":185,"props":1634,"children":1635},{"style":742},[1636],{"type":24,"value":1637},"  ScraperFeedBucket",{"type":18,"tag":185,"props":1639,"children":1640},{"style":249},[1641],{"type":24,"value":750},{"type":18,"tag":185,"props":1643,"children":1644},{"class":187,"line":753},[1645,1650,1654],{"type":18,"tag":185,"props":1646,"children":1647},{"style":742},[1648],{"type":24,"value":1649},"    Type",{"type":18,"tag":185,"props":1651,"children":1652},{"style":249},[1653],{"type":24,"value":764},{"type":18,"tag":185,"props":1655,"children":1656},{"style":218},[1657],{"type":24,"value":1658},"AWS::S3::Bucket\n",{"type":18,"tag":185,"props":1660,"children":1661},{"class":187,"line":772},[1662,1667],{"type":18,"tag":185,"props":1663,"children":1664},{"style":742},[1665],{"type":24,"value":1666},"    Properties",{"type":18,"tag":185,"props":1668,"children":1669},{"style":249},[1670],{"type":24,"value":750},{"type":18,"tag":185,"props":1672,"children":1673},{"class":187,"line":790},[1674,1679],{"type":18,"tag":185,"props":1675,"children":1676},{"style":742},[1677],{"type":24,"value":1678},"      VersioningConfiguration",{"type":18,"tag":185,"props":1680,"children":1681},{"style":249},[1682],{"type":24,"value":750},{"type":18,"tag":185,"props":1684,"children":1685},{"class":187,"line":808},[1686,1691,1695],{"type":18,"tag":185,"props":1687,"children":1688},{"style":742},[1689],{"type":24,"value":1690},"        Status",{"type":18,"tag":185,"props":1692,"children":1693},{"style":249},[1694],{"type":24,"value":764},{"type":18,"tag":185,"props":1696,"children":1697},{"style":218},[1698],{"type":24,"value":1699},"\"Enabled\"\n",{"type":18,"tag":27,"props":1701,"children":1702},{},[1703,1705,1709],{"type":24,"value":1704},"We have to set up permissions in ",{"type":18,"tag":181,"props":1706,"children":1707},{"className":10},[1708],{"type":24,"value":710},{"type":24,"value":1710},", import the template file, and pass the bucket name in an environment variable to our Lambda function.\nAdd the following IAM role statement and environment variable",{"type":18,"tag":174,"props":1712,"children":1714},{"code":1713,"language":715,"meta":10,"className":716,"style":10},"# serverless.yml\nprovider:\n    # ...\n    environment:\n        FEED_BUCKET_NAME: !Ref ScraperFeedBucket\n    iamRoleStatements:\n        - Effect: \"Allow\"\n          Action:\n            - \"s3:PutObject\"\n          Resource: !Sub\n            - \"arn:aws:s3:::#{BucketName}/*\"\n            - BucketName: !Ref ScraperFeedBucket\n\nresources:\n  - AWSTemplateFormatVersion: \"2010-09-09\"\n    Transform: \"AWS::Serverless-2016-10-31\"\n  - ${file(./s3-template.yml)}\n# ...\n",[1715],{"type":18,"tag":181,"props":1716,"children":1717},{"__ignoreMap":10},[1718,1725,1736,1744,1756,1778,1790,1812,1824,1837,1854,1866,1890,1897,1909,1930,1947,1959],{"type":18,"tag":185,"props":1719,"children":1720},{"class":187,"line":188},[1721],{"type":18,"tag":185,"props":1722,"children":1723},{"style":204},[1724],{"type":24,"value":728},{"type":18,"tag":185,"props":1726,"children":1727},{"class":187,"line":210},[1728,1732],{"type":18,"tag":185,"props":1729,"children":1730},{"style":742},[1731],{"type":24,"value":745},{"type":18,"tag":185,"props":1733,"children":1734},{"style":249},[1735],{"type":24,"value":750},{"type":18,"tag":185,"props":1737,"children":1738},{"class":187,"line":288},[1739],{"type":18,"tag":185,"props":1740,"children":1741},{"style":204},[1742],{"type":24,"value":1743},"    # ...\n",{"type":18,"tag":185,"props":1745,"children":1746},{"class":187,"line":753},[1747,1752],{"type":18,"tag":185,"props":1748,"children":1749},{"style":742},[1750],{"type":24,"value":1751},"    environment",{"type":18,"tag":185,"props":1753,"children":1754},{"style":249},[1755],{"type":24,"value":750},{"type":18,"tag":185,"props":1757,"children":1758},{"class":187,"line":772},[1759,1764,1768,1773],{"type":18,"tag":185,"props":1760,"children":1761},{"style":742},[1762],{"type":24,"value":1763},"        FEED_BUCKET_NAME",{"type":18,"tag":185,"props":1765,"children":1766},{"style":249},[1767],{"type":24,"value":764},{"type":18,"tag":185,"props":1769,"children":1770},{"style":435},[1771],{"type":24,"value":1772},"!Ref",{"type":18,"tag":185,"props":1774,"children":1775},{"style":218},[1776],{"type":24,"value":1777}," ScraperFeedBucket\n",{"type":18,"tag":185,"props":1779,"children":1780},{"class":187,"line":790},[1781,1786],{"type":18,"tag":185,"props":1782,"children":1783},{"style":742},[1784],{"type":24,"value":1785},"    iamRoleStatements",{"type":18,"tag":185,"props":1787,"children":1788},{"style":249},[1789],{"type":24,"value":750},{"type":18,"tag":185,"props":1791,"children":1792},{"class":187,"line":808},[1793,1798,1803,1807],{"type":18,"tag":185,"props":1794,"children":1795},{"style":249},[1796],{"type":24,"value":1797},"        - ",{"type":18,"tag":185,"props":1799,"children":1800},{"style":742},[1801],{"type":24,"value":1802},"Effect",{"type":18,"tag":185,"props":1804,"children":1805},{"style":249},[1806],{"type":24,"value":764},{"type":18,"tag":185,"props":1808,"children":1809},{"style":218},[1810],{"type":24,"value":1811},"\"Allow\"\n",{"type":18,"tag":185,"props":1813,"children":1814},{"class":187,"line":1046},[1815,1820],{"type":18,"tag":185,"props":1816,"children":1817},{"style":742},[1818],{"type":24,"value":1819},"          Action",{"type":18,"tag":185,"props":1821,"children":1822},{"style":249},[1823],{"type":24,"value":750},{"type":18,"tag":185,"props":1825,"children":1826},{"class":187,"line":1054},[1827,1832],{"type":18,"tag":185,"props":1828,"children":1829},{"style":249},[1830],{"type":24,"value":1831},"            - ",{"type":18,"tag":185,"props":1833,"children":1834},{"style":218},[1835],{"type":24,"value":1836},"\"s3:PutObject\"\n",{"type":18,"tag":185,"props":1838,"children":1839},{"class":187,"line":1067},[1840,1845,1849],{"type":18,"tag":185,"props":1841,"children":1842},{"style":742},[1843],{"type":24,"value":1844},"          Resource",{"type":18,"tag":185,"props":1846,"children":1847},{"style":249},[1848],{"type":24,"value":764},{"type":18,"tag":185,"props":1850,"children":1851},{"style":435},[1852],{"type":24,"value":1853},"!Sub\n",{"type":18,"tag":185,"props":1855,"children":1856},{"class":187,"line":1080},[1857,1861],{"type":18,"tag":185,"props":1858,"children":1859},{"style":249},[1860],{"type":24,"value":1831},{"type":18,"tag":185,"props":1862,"children":1863},{"style":218},[1864],{"type":24,"value":1865},"\"arn:aws:s3:::#{BucketName}/*\"\n",{"type":18,"tag":185,"props":1867,"children":1868},{"class":187,"line":1098},[1869,1873,1878,1882,1886],{"type":18,"tag":185,"props":1870,"children":1871},{"style":249},[1872],{"type":24,"value":1831},{"type":18,"tag":185,"props":1874,"children":1875},{"style":742},[1876],{"type":24,"value":1877},"BucketName",{"type":18,"tag":185,"props":1879,"children":1880},{"style":249},[1881],{"type":24,"value":764},{"type":18,"tag":185,"props":1883,"children":1884},{"style":435},[1885],{"type":24,"value":1772},{"type":18,"tag":185,"props":1887,"children":1888},{"style":218},[1889],{"type":24,"value":1777},{"type":18,"tag":185,"props":1891,"children":1892},{"class":187,"line":1111},[1893],{"type":18,"tag":185,"props":1894,"children":1895},{"emptyLinePlaceholder":981},[1896],{"type":24,"value":984},{"type":18,"tag":185,"props":1898,"children":1899},{"class":187,"line":1128},[1900,1905],{"type":18,"tag":185,"props":1901,"children":1902},{"style":742},[1903],{"type":24,"value":1904},"resources",{"type":18,"tag":185,"props":1906,"children":1907},{"style":249},[1908],{"type":24,"value":750},{"type":18,"tag":185,"props":1910,"children":1911},{"class":187,"line":1136},[1912,1916,1921,1925],{"type":18,"tag":185,"props":1913,"children":1914},{"style":249},[1915],{"type":24,"value":1286},{"type":18,"tag":185,"props":1917,"children":1918},{"style":742},[1919],{"type":24,"value":1920},"AWSTemplateFormatVersion",{"type":18,"tag":185,"props":1922,"children":1923},{"style":249},[1924],{"type":24,"value":764},{"type":18,"tag":185,"props":1926,"children":1927},{"style":218},[1928],{"type":24,"value":1929},"\"2010-09-09\"\n",{"type":18,"tag":185,"props":1931,"children":1932},{"class":187,"line":1145},[1933,1938,1942],{"type":18,"tag":185,"props":1934,"children":1935},{"style":742},[1936],{"type":24,"value":1937},"    Transform",{"type":18,"tag":185,"props":1939,"children":1940},{"style":249},[1941],{"type":24,"value":764},{"type":18,"tag":185,"props":1943,"children":1944},{"style":218},[1945],{"type":24,"value":1946},"\"AWS::Serverless-2016-10-31\"\n",{"type":18,"tag":185,"props":1948,"children":1949},{"class":187,"line":1154},[1950,1954],{"type":18,"tag":185,"props":1951,"children":1952},{"style":249},[1953],{"type":24,"value":1286},{"type":18,"tag":185,"props":1955,"children":1956},{"style":218},[1957],{"type":24,"value":1958},"${file(./s3-template.yml)}\n",{"type":18,"tag":185,"props":1960,"children":1961},{"class":187,"line":1167},[1962],{"type":18,"tag":185,"props":1963,"children":1964},{"style":204},[1965],{"type":24,"value":736},{"type":18,"tag":27,"props":1967,"children":1968},{},[1969],{"type":24,"value":1970},"You can check that your configuration doesn't contain syntax errors with",{"type":18,"tag":174,"props":1972,"children":1974},{"code":1973,"language":177,"meta":10,"className":178,"style":10},"sls package\n",[1975],{"type":18,"tag":181,"props":1976,"children":1977},{"__ignoreMap":10},[1978],{"type":18,"tag":185,"props":1979,"children":1980},{"class":187,"line":188},[1981,1985],{"type":18,"tag":185,"props":1982,"children":1983},{"style":192},[1984],{"type":24,"value":636},{"type":18,"tag":185,"props":1986,"children":1987},{"style":218},[1988],{"type":24,"value":1989}," package\n",{"type":18,"tag":27,"props":1991,"children":1992},{},[1993],{"type":24,"value":1994},"but the only way to check that your CloudFormation templates are valid on your current stack is to deploy it.\nBefore deploying, let's configure the crawler to store the output in S3.",{"type":18,"tag":174,"props":1996,"children":1998},{"code":1997,"language":195,"meta":10,"className":332,"style":10},"# my_sls_scraper/crawl.py\ndef  crawl(settings={}, spider_name=\"header_spider\", spider_kwargs={}):\n    # ...\n    if is_in_aws():\n        # Lambda can only write to the /tmp folder.\n        settings['HTTPCACHE_DIR'] = \"/tmp\"\n        feed_uri = f\"s3://{os.getenv('FEED_BUCKET_NAME')}/%(name)s-{spider_key}.json\"\n    # ...\n",[1999],{"type":18,"tag":181,"props":2000,"children":2001},{"__ignoreMap":10},[2002],{"type":24,"value":1997},{"type":18,"tag":27,"props":2004,"children":2005},{},[2006,2008,2013,2015,2020],{"type":24,"value":2007},"Scrapy uses the AWS library ",{"type":18,"tag":181,"props":2009,"children":2010},{"className":10},[2011],{"type":24,"value":2012},"boto3",{"type":24,"value":2014}," under the hood to store to S3. Inside a Lambda function, boto3 is always available, and credentials are automatically discovered. It will work as long as the IAM Role Statements we configured for the Lambda function are correct.\nWe don't need to timestamp the file name in S3 with ",{"type":18,"tag":181,"props":2016,"children":2017},{"className":10},[2018],{"type":24,"value":2019},"%(time)s",{"type":24,"value":2021},", as we configured the bucket to use versioning in our CloudFormation template, which enables us to access old spider outputs by looking at the file history.",{"type":18,"tag":27,"props":2023,"children":2024},{},[2025],{"type":24,"value":2026},"Now, deploy the function and crawl again.",{"type":18,"tag":174,"props":2028,"children":2030},{"code":2029,"language":177,"meta":10,"className":178,"style":10},"sls deploy -v\nsls invoke -f lambdaScrape --log\n",[2031],{"type":18,"tag":181,"props":2032,"children":2033},{"__ignoreMap":10},[2034,2050],{"type":18,"tag":185,"props":2035,"children":2036},{"class":187,"line":188},[2037,2041,2045],{"type":18,"tag":185,"props":2038,"children":2039},{"style":192},[2040],{"type":24,"value":636},{"type":18,"tag":185,"props":2042,"children":2043},{"style":218},[2044],{"type":24,"value":641},{"type":18,"tag":185,"props":2046,"children":2047},{"style":198},[2048],{"type":24,"value":2049}," -v\n",{"type":18,"tag":185,"props":2051,"children":2052},{"class":187,"line":210},[2053,2057,2061,2065,2069],{"type":18,"tag":185,"props":2054,"children":2055},{"style":192},[2056],{"type":24,"value":636},{"type":18,"tag":185,"props":2058,"children":2059},{"style":218},[2060],{"type":24,"value":864},{"type":18,"tag":185,"props":2062,"children":2063},{"style":198},[2064],{"type":24,"value":646},{"type":18,"tag":185,"props":2066,"children":2067},{"style":218},[2068],{"type":24,"value":1502},{"type":18,"tag":185,"props":2070,"children":2071},{"style":198},[2072],{"type":24,"value":877},{"type":18,"tag":27,"props":2074,"children":2075},{},[2076,2078,2085,2087,2093],{"type":24,"value":2077},"You should now find the feed output in a file if you check your ",{"type":18,"tag":33,"props":2079,"children":2082},{"href":2080,"rel":2081},"https://s3.console.aws.amazon.com/s3/home",[37],[2083],{"type":24,"value":2084},"S3 console",{"type":24,"value":2086},". You should also see some new info has appeared for your function in the ",{"type":18,"tag":33,"props":2088,"children":2090},{"href":834,"rel":2089},[37],[2091],{"type":24,"value":2092},"Lambda console",{"type":24,"value":2094},", like the environment variable and the S3 resource.\nWhile it's absolutely recommended to set up all resources in CloudFormation templates or other infrastructure as code frameworks, the AWS console web interface is very useful for debugging and inspection.",{"type":18,"tag":19,"props":2096,"children":2098},{"id":2097},"running-scrapy-in-aws-fargate",[2099],{"type":24,"value":2100},"Running Scrapy in AWS Fargate",{"type":18,"tag":27,"props":2102,"children":2103},{},[2104,2106,2111,2113,2120],{"type":24,"value":2105},"We now have a crawler that can be run from a script and uses S3 to store its output. We can run it in AWS Lambda, but we are constrained by the 15 minute execution limit.\nLambda is simply not made for long-lasting tasks, but it is possible to run long-lasting crawlers in the serverless paradigm by ",{"type":18,"tag":149,"props":2107,"children":2108},{},[2109],{"type":24,"value":2110},"containerizing",{"type":24,"value":2112}," our crawler and running it as a task in a managed container service such as AWS Fargate. This means we need to create a ",{"type":18,"tag":33,"props":2114,"children":2117},{"href":2115,"rel":2116},"https://www.docker.com/",[37],[2118],{"type":24,"value":2119},"Docker",{"type":24,"value":2121}," image of our crawler, uploading the image to an image repository – we'll use Amazon Container Registry (ACR), and execute the image in a container as a task in Amazon Container Services (ECS).\nI'm dropping a lot of acronyms, and you'll see even more later. Running containers on AWS may be serverless, but it requires a lot of configuration at the moment.",{"type":18,"tag":76,"props":2123,"children":2125},{"id":2124},"dockerize-it",[2126],{"type":24,"value":2127},"Dockerize it",{"type":18,"tag":27,"props":2129,"children":2130},{},[2131,2133,2138],{"type":24,"value":2132},"If you have Docker installed, this is the easy part. Let's create a ",{"type":18,"tag":181,"props":2134,"children":2135},{"className":10},[2136],{"type":24,"value":2137},"Dockerfile",{"type":24,"value":2139}," to containerize our crawler.",{"type":18,"tag":174,"props":2141,"children":2144},{"code":2142,"language":126,"meta":10,"className":2143,"style":10},"FROM python:3.7\n\nWORKDIR /usr/src/app\n\nCOPY scrapy.cfg ./\nCOPY launcher.py ./\nCOPY my_sls_scraper ./my_sls_scraper\nCOPY requirements.txt ./\n\nRUN pip install boto3 --quiet\nRUN pip install -r requirements.txt --quiet\n\nCMD [\"python3\", \"./launcher.py\"]\n","language-docker",[2145],{"type":18,"tag":181,"props":2146,"children":2147},{"__ignoreMap":10},[2148],{"type":24,"value":2142},{"type":18,"tag":27,"props":2150,"children":2151},{},[2152],{"type":24,"value":2153},"The docker file is the recipe to put our scraper in an image. Create it and put a tag on it with",{"type":18,"tag":174,"props":2155,"children":2157},{"code":2156,"language":177,"meta":10,"className":178,"style":10},"docker build -t my_sls_scraper:latest .\n",[2158],{"type":18,"tag":181,"props":2159,"children":2160},{"__ignoreMap":10},[2161],{"type":18,"tag":185,"props":2162,"children":2163},{"class":187,"line":188},[2164,2168,2173,2178,2183],{"type":18,"tag":185,"props":2165,"children":2166},{"style":192},[2167],{"type":24,"value":126},{"type":18,"tag":185,"props":2169,"children":2170},{"style":218},[2171],{"type":24,"value":2172}," build",{"type":18,"tag":185,"props":2174,"children":2175},{"style":198},[2176],{"type":24,"value":2177}," -t",{"type":18,"tag":185,"props":2179,"children":2180},{"style":218},[2181],{"type":24,"value":2182}," my_sls_scraper:latest",{"type":18,"tag":185,"props":2184,"children":2185},{"style":218},[2186],{"type":24,"value":2187}," .\n",{"type":18,"tag":27,"props":2189,"children":2190},{},[2191],{"type":24,"value":2192},"You should see an output similar to",{"type":18,"tag":174,"props":2194,"children":2196},{"code":2195},"16:55 $ docker build -t my_sls_scraper:latest .\nSending build context to Docker daemon  15.62MB\nStep 1/9 : FROM python:3.7\n ---> 60e318e4984a\nStep 2/9 : WORKDIR /usr/src/app\n ---> Using cache\n ---> 0277144c85a9\nStep 3/9 : COPY scrapy.cfg ./\n ---> c72f2df3b4d7\nRemoving intermediate container 80cf0e765353\nStep 4/9 : COPY launcher.py ./\n ---> 58e18d409bf5\nRemoving intermediate container f0726603d5fa\nStep 5/9 : COPY my_sls_scraper ./my_sls_scraper\n ---> 2be7fc4a06bb\nRemoving intermediate container aae59bff188d\nStep 6/9 : COPY requirements.txt ./\n ---> 7dbf261f3ade\nRemoving intermediate container 76033ce2ffe6\nStep 7/9 : RUN pip install boto3 --quiet\n ---> Running in 55455a2a4415\n ---> efdc47a54e36\nRemoving intermediate container 55455a2a4415\nStep 8/9 : RUN pip install -r requirements.txt --quiet\n ---> Running in e15817fd1a01\n ---> 84015af5a4ee\nRemoving intermediate container e15817fd1a01\nStep 9/9 : CMD python3 ./launcher.py\n ---> Running in 9c6fe75eb923\n ---> 05a841f9ec00\nRemoving intermediate container 9c6fe75eb923\nSuccessfully built 05a841f9ec00\nSuccessfully tagged my_sls_scraper:latest\n",[2197],{"type":18,"tag":181,"props":2198,"children":2199},{"__ignoreMap":10},[2200],{"type":24,"value":2195},{"type":18,"tag":27,"props":2202,"children":2203},{},[2204],{"type":24,"value":2205},"Now, let's check that the image works by running it in a container on our machine with",{"type":18,"tag":174,"props":2207,"children":2209},{"code":2208,"language":177,"meta":10,"className":178,"style":10},"docker run my_sls_scraper\n",[2210],{"type":18,"tag":181,"props":2211,"children":2212},{"__ignoreMap":10},[2213],{"type":18,"tag":185,"props":2214,"children":2215},{"class":187,"line":188},[2216,2220,2225],{"type":18,"tag":185,"props":2217,"children":2218},{"style":192},[2219],{"type":24,"value":126},{"type":18,"tag":185,"props":2221,"children":2222},{"style":218},[2223],{"type":24,"value":2224}," run",{"type":18,"tag":185,"props":2226,"children":2227},{"style":218},[2228],{"type":24,"value":2229}," my_sls_scraper\n",{"type":18,"tag":27,"props":2231,"children":2232},{},[2233],{"type":24,"value":2234},"The crawler should run just like it has before except that the crawl output json file will be stored somewhere inside the Docker container, so you cannot see it.",{"type":18,"tag":76,"props":2236,"children":2238},{"id":2237},"configure-fargate-on-aws",[2239],{"type":24,"value":2240},"Configure Fargate on AWS",{"type":18,"tag":27,"props":2242,"children":2243},{},[2244],{"type":24,"value":2245},"Let's see how a complete CloudFormation template for our purpose looks like.",{"type":18,"tag":174,"props":2247,"children":2249},{"code":2248,"language":715,"meta":10,"className":716,"style":10},"# fargate-template.yml\nResources:\n  FargateECSCluster:\n    Type: \"AWS::ECS::Cluster\"\n    Properties:\n      ClusterName: !Sub\n        - \"fargate-#{StackName}\"\n        - StackName: !Ref \"AWS::StackName\"\n\n  FargateLogGroup:\n    Type: \"AWS::Logs::LogGroup\"\n    Properties:\n      RetentionInDays: 1\n\n  FargateTaskRole:\n    Type: AWS::IAM::Role\n    Properties:\n      AssumeRolePolicyDocument:\n        Version: \"2012-10-17\"\n        Statement:\n          - Effect: Allow\n            Sid: \"ECS\"\n            Principal:\n              Service:\n                - ecs-tasks.amazonaws.com\n            Action:\n              - sts:AssumeRole\n      Policies:\n        - PolicyName: ScraperFeedBucketPolicy\n          PolicyDocument:\n            Statement:\n              - Effect: \"Allow\"\n                Action:\n                  - \"s3:PutObject\"\n                Resource: !Sub\n                  - \"arn:aws:s3:::#{BucketName}/*\"\n                  - BucketName: !Ref ScraperFeedBucket\n\n  FargateExecutionRole:\n    Type: AWS::IAM::Role\n    Properties:\n      ManagedPolicyArns:\n        - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy\n      AssumeRolePolicyDocument:\n        Version: \"2012-10-17\"\n        Statement:\n          - Effect: Allow\n            Sid: \"ECS\"\n            Principal:\n              Service:\n                - ecs-tasks.amazonaws.com\n            Action:\n              - sts:AssumeRole\n\n  FargateVPC:\n    Type: \"AWS::EC2::VPC\"\n    Properties:\n      CidrBlock: 10.10.10.0/24\n      Tags:\n        - Key: Name\n          Value: !Ref \"AWS::StackName\"\n  FargateSubnet:\n    Type: \"AWS::EC2::Subnet\"\n    Properties:\n      CidrBlock: 10.10.10.0/24\n      VpcId: !Ref FargateVPC\n      Tags:\n        - Key: Name\n          Value: !Ref \"AWS::StackName\"\n  FargateIGW:\n    Type: \"AWS::EC2::InternetGateway\"\n    Properties:\n      Tags:\n        - Key: Name\n          Value: !Ref \"AWS::StackName\"\n  FargateAttachGateway:\n    Type: AWS::EC2::VPCGatewayAttachment\n    Properties:\n      VpcId: !Ref FargateVPC\n      InternetGatewayId: !Ref FargateIGW\n  FargateRouteTable:\n    Type: \"AWS::EC2::RouteTable\"\n    Properties:\n      VpcId: !Ref FargateVPC\n      Tags:\n        - Key: Name\n          Value: !Ref \"AWS::StackName\"\n  FargateRoute:\n    Type: \"AWS::EC2::Route\"\n    DependsOn: FargateAttachGateway\n    Properties:\n      RouteTableId: !Ref FargateRouteTable\n      DestinationCidrBlock: 0.0.0.0/0\n      GatewayId: !Ref FargateIGW\n  FargateSubnetRouteTableAssociation:\n    Type: AWS::EC2::SubnetRouteTableAssociation\n    Properties:\n      RouteTableId: !Ref FargateRouteTable\n      SubnetId: !Ref FargateSubnet\n  FargateSG:\n    Type: \"AWS::EC2::SecurityGroup\"\n    Properties:\n      GroupDescription: \"Generated by Serverless\"\n      SecurityGroupIngress:\n        - IpProtocol: -1\n          CidrIp: 127.0.0.1/32\n      Tags:\n        - Key: Name\n          Value: !Ref \"AWS::StackName\"\n      VpcId: !Ref FargateVPC\n\n  FargateECSRepo:\n    Type: \"AWS::ECR::Repository\"\n    Properties:\n      LifecyclePolicy:\n        LifecyclePolicyText: |\n          {\n            \"rules\": [\n            {\n              \"rulePriority\": 1,\n              \"description\": \"Only keep 8 images\",\n              \"selection\": {\n                \"tagStatus\": \"any\",\n                \"countType\": \"imageCountMoreThan\",\n                \"countNumber\": 8\n              },\n              \"action\": { \"type\": \"expire\" }\n            }]\n          }\n\n  FargateECSTaskDefinition:\n    Type: \"AWS::ECS::TaskDefinition\"\n    Properties:\n      Cpu: 512\n      Memory: 1GB\n      NetworkMode: awsvpc\n      RequiresCompatibilities:\n        - \"FARGATE\"\n      ExecutionRoleArn: !GetAtt FargateExecutionRole.Arn\n      TaskRoleArn: !GetAtt FargateTaskRole.Arn\n      ContainerDefinitions:\n        - Name: scraper_container\n          Image: !Sub\n            - \"#{AccountId}.dkr.ecr.#{Region}.amazonaws.com/#{Repo}\"\n            - AccountId: !Ref AWS::AccountId\n              Region: !Ref AWS::Region\n              Repo: !Ref FargateECSRepo\n          LogConfiguration:\n            LogDriver: awslogs\n            Options:\n              awslogs-group: !Ref FargateLogGroup\n              awslogs-region: !Ref AWS::Region\n              awslogs-stream-prefix: !Ref AWS::StackName\nOutputs:\n  ECRRepo:\n    Value: !Sub\n      - \"#{AccountId}.dkr.ecr.#{Region}.amazonaws.com/#{Repo}\"\n      - AccountId: !Ref AWS::AccountId\n        Region: !Ref AWS::Region\n        Repo: !Ref FargateECSRepo\n",[2250],{"type":18,"tag":181,"props":2251,"children":2252},{"__ignoreMap":10},[2253,2261,2272,2284,2300,2311,2327,2339,2364,2371,2383,2399,2410,2426,2433,2445,2461,2472,2484,2501,2513,2534,2551,2563,2575,2588,2600,2613,2625,2646,2658,2670,2689,2702,2715,2732,2744,2768,2776,2789,2805,2817,2830,2843,2855,2871,2883,2903,2919,2931,2943,2955,2967,2979,2987,3000,3017,3029,3047,3060,3082,3103,3116,3133,3145,3161,3183,3195,3215,3235,3248,3265,3277,3289,3309,3329,3342,3359,3371,3391,3413,3426,3443,3455,3475,3487,3507,3527,3540,3557,3575,3587,3609,3627,3648,3661,3678,3690,3710,3732,3745,3762,3774,3792,3805,3827,3845,3857,3877,3897,3917,3925,3938,3955,3967,3980,3998,4007,4016,4025,4034,4043,4052,4061,4070,4079,4088,4097,4106,4115,4123,4136,4153,4165,4183,4201,4219,4232,4245,4268,4290,4303,4325,4342,4355,4381,4403,4425,4438,4456,4469,4491,4512,4534,4547,4560,4577,4590,4614,4635],{"type":18,"tag":185,"props":2254,"children":2255},{"class":187,"line":188},[2256],{"type":18,"tag":185,"props":2257,"children":2258},{"style":204},[2259],{"type":24,"value":2260},"# fargate-template.yml\n",{"type":18,"tag":185,"props":2262,"children":2263},{"class":187,"line":210},[2264,2268],{"type":18,"tag":185,"props":2265,"children":2266},{"style":742},[2267],{"type":24,"value":1625},{"type":18,"tag":185,"props":2269,"children":2270},{"style":249},[2271],{"type":24,"value":750},{"type":18,"tag":185,"props":2273,"children":2274},{"class":187,"line":288},[2275,2280],{"type":18,"tag":185,"props":2276,"children":2277},{"style":742},[2278],{"type":24,"value":2279},"  FargateECSCluster",{"type":18,"tag":185,"props":2281,"children":2282},{"style":249},[2283],{"type":24,"value":750},{"type":18,"tag":185,"props":2285,"children":2286},{"class":187,"line":753},[2287,2291,2295],{"type":18,"tag":185,"props":2288,"children":2289},{"style":742},[2290],{"type":24,"value":1649},{"type":18,"tag":185,"props":2292,"children":2293},{"style":249},[2294],{"type":24,"value":764},{"type":18,"tag":185,"props":2296,"children":2297},{"style":218},[2298],{"type":24,"value":2299},"\"AWS::ECS::Cluster\"\n",{"type":18,"tag":185,"props":2301,"children":2302},{"class":187,"line":772},[2303,2307],{"type":18,"tag":185,"props":2304,"children":2305},{"style":742},[2306],{"type":24,"value":1666},{"type":18,"tag":185,"props":2308,"children":2309},{"style":249},[2310],{"type":24,"value":750},{"type":18,"tag":185,"props":2312,"children":2313},{"class":187,"line":790},[2314,2319,2323],{"type":18,"tag":185,"props":2315,"children":2316},{"style":742},[2317],{"type":24,"value":2318},"      ClusterName",{"type":18,"tag":185,"props":2320,"children":2321},{"style":249},[2322],{"type":24,"value":764},{"type":18,"tag":185,"props":2324,"children":2325},{"style":435},[2326],{"type":24,"value":1853},{"type":18,"tag":185,"props":2328,"children":2329},{"class":187,"line":808},[2330,2334],{"type":18,"tag":185,"props":2331,"children":2332},{"style":249},[2333],{"type":24,"value":1797},{"type":18,"tag":185,"props":2335,"children":2336},{"style":218},[2337],{"type":24,"value":2338},"\"fargate-#{StackName}\"\n",{"type":18,"tag":185,"props":2340,"children":2341},{"class":187,"line":1046},[2342,2346,2351,2355,2359],{"type":18,"tag":185,"props":2343,"children":2344},{"style":249},[2345],{"type":24,"value":1797},{"type":18,"tag":185,"props":2347,"children":2348},{"style":742},[2349],{"type":24,"value":2350},"StackName",{"type":18,"tag":185,"props":2352,"children":2353},{"style":249},[2354],{"type":24,"value":764},{"type":18,"tag":185,"props":2356,"children":2357},{"style":435},[2358],{"type":24,"value":1772},{"type":18,"tag":185,"props":2360,"children":2361},{"style":218},[2362],{"type":24,"value":2363}," \"AWS::StackName\"\n",{"type":18,"tag":185,"props":2365,"children":2366},{"class":187,"line":1054},[2367],{"type":18,"tag":185,"props":2368,"children":2369},{"emptyLinePlaceholder":981},[2370],{"type":24,"value":984},{"type":18,"tag":185,"props":2372,"children":2373},{"class":187,"line":1067},[2374,2379],{"type":18,"tag":185,"props":2375,"children":2376},{"style":742},[2377],{"type":24,"value":2378},"  FargateLogGroup",{"type":18,"tag":185,"props":2380,"children":2381},{"style":249},[2382],{"type":24,"value":750},{"type":18,"tag":185,"props":2384,"children":2385},{"class":187,"line":1080},[2386,2390,2394],{"type":18,"tag":185,"props":2387,"children":2388},{"style":742},[2389],{"type":24,"value":1649},{"type":18,"tag":185,"props":2391,"children":2392},{"style":249},[2393],{"type":24,"value":764},{"type":18,"tag":185,"props":2395,"children":2396},{"style":218},[2397],{"type":24,"value":2398},"\"AWS::Logs::LogGroup\"\n",{"type":18,"tag":185,"props":2400,"children":2401},{"class":187,"line":1098},[2402,2406],{"type":18,"tag":185,"props":2403,"children":2404},{"style":742},[2405],{"type":24,"value":1666},{"type":18,"tag":185,"props":2407,"children":2408},{"style":249},[2409],{"type":24,"value":750},{"type":18,"tag":185,"props":2411,"children":2412},{"class":187,"line":1111},[2413,2418,2422],{"type":18,"tag":185,"props":2414,"children":2415},{"style":742},[2416],{"type":24,"value":2417},"      RetentionInDays",{"type":18,"tag":185,"props":2419,"children":2420},{"style":249},[2421],{"type":24,"value":764},{"type":18,"tag":185,"props":2423,"children":2424},{"style":198},[2425],{"type":24,"value":1043},{"type":18,"tag":185,"props":2427,"children":2428},{"class":187,"line":1128},[2429],{"type":18,"tag":185,"props":2430,"children":2431},{"emptyLinePlaceholder":981},[2432],{"type":24,"value":984},{"type":18,"tag":185,"props":2434,"children":2435},{"class":187,"line":1136},[2436,2441],{"type":18,"tag":185,"props":2437,"children":2438},{"style":742},[2439],{"type":24,"value":2440},"  FargateTaskRole",{"type":18,"tag":185,"props":2442,"children":2443},{"style":249},[2444],{"type":24,"value":750},{"type":18,"tag":185,"props":2446,"children":2447},{"class":187,"line":1145},[2448,2452,2456],{"type":18,"tag":185,"props":2449,"children":2450},{"style":742},[2451],{"type":24,"value":1649},{"type":18,"tag":185,"props":2453,"children":2454},{"style":249},[2455],{"type":24,"value":764},{"type":18,"tag":185,"props":2457,"children":2458},{"style":218},[2459],{"type":24,"value":2460},"AWS::IAM::Role\n",{"type":18,"tag":185,"props":2462,"children":2463},{"class":187,"line":1154},[2464,2468],{"type":18,"tag":185,"props":2465,"children":2466},{"style":742},[2467],{"type":24,"value":1666},{"type":18,"tag":185,"props":2469,"children":2470},{"style":249},[2471],{"type":24,"value":750},{"type":18,"tag":185,"props":2473,"children":2474},{"class":187,"line":1167},[2475,2480],{"type":18,"tag":185,"props":2476,"children":2477},{"style":742},[2478],{"type":24,"value":2479},"      AssumeRolePolicyDocument",{"type":18,"tag":185,"props":2481,"children":2482},{"style":249},[2483],{"type":24,"value":750},{"type":18,"tag":185,"props":2485,"children":2486},{"class":187,"line":1180},[2487,2492,2496],{"type":18,"tag":185,"props":2488,"children":2489},{"style":742},[2490],{"type":24,"value":2491},"        Version",{"type":18,"tag":185,"props":2493,"children":2494},{"style":249},[2495],{"type":24,"value":764},{"type":18,"tag":185,"props":2497,"children":2498},{"style":218},[2499],{"type":24,"value":2500},"\"2012-10-17\"\n",{"type":18,"tag":185,"props":2502,"children":2503},{"class":187,"line":1194},[2504,2509],{"type":18,"tag":185,"props":2505,"children":2506},{"style":742},[2507],{"type":24,"value":2508},"        Statement",{"type":18,"tag":185,"props":2510,"children":2511},{"style":249},[2512],{"type":24,"value":750},{"type":18,"tag":185,"props":2514,"children":2515},{"class":187,"line":1207},[2516,2521,2525,2529],{"type":18,"tag":185,"props":2517,"children":2518},{"style":249},[2519],{"type":24,"value":2520},"          - ",{"type":18,"tag":185,"props":2522,"children":2523},{"style":742},[2524],{"type":24,"value":1802},{"type":18,"tag":185,"props":2526,"children":2527},{"style":249},[2528],{"type":24,"value":764},{"type":18,"tag":185,"props":2530,"children":2531},{"style":218},[2532],{"type":24,"value":2533},"Allow\n",{"type":18,"tag":185,"props":2535,"children":2536},{"class":187,"line":1220},[2537,2542,2546],{"type":18,"tag":185,"props":2538,"children":2539},{"style":742},[2540],{"type":24,"value":2541},"            Sid",{"type":18,"tag":185,"props":2543,"children":2544},{"style":249},[2545],{"type":24,"value":764},{"type":18,"tag":185,"props":2547,"children":2548},{"style":218},[2549],{"type":24,"value":2550},"\"ECS\"\n",{"type":18,"tag":185,"props":2552,"children":2553},{"class":187,"line":1233},[2554,2559],{"type":18,"tag":185,"props":2555,"children":2556},{"style":742},[2557],{"type":24,"value":2558},"            Principal",{"type":18,"tag":185,"props":2560,"children":2561},{"style":249},[2562],{"type":24,"value":750},{"type":18,"tag":185,"props":2564,"children":2565},{"class":187,"line":1246},[2566,2571],{"type":18,"tag":185,"props":2567,"children":2568},{"style":742},[2569],{"type":24,"value":2570},"              Service",{"type":18,"tag":185,"props":2572,"children":2573},{"style":249},[2574],{"type":24,"value":750},{"type":18,"tag":185,"props":2576,"children":2577},{"class":187,"line":1259},[2578,2583],{"type":18,"tag":185,"props":2579,"children":2580},{"style":249},[2581],{"type":24,"value":2582},"                - ",{"type":18,"tag":185,"props":2584,"children":2585},{"style":218},[2586],{"type":24,"value":2587},"ecs-tasks.amazonaws.com\n",{"type":18,"tag":185,"props":2589,"children":2590},{"class":187,"line":1267},[2591,2596],{"type":18,"tag":185,"props":2592,"children":2593},{"style":742},[2594],{"type":24,"value":2595},"            Action",{"type":18,"tag":185,"props":2597,"children":2598},{"style":249},[2599],{"type":24,"value":750},{"type":18,"tag":185,"props":2601,"children":2602},{"class":187,"line":1280},[2603,2608],{"type":18,"tag":185,"props":2604,"children":2605},{"style":249},[2606],{"type":24,"value":2607},"              - ",{"type":18,"tag":185,"props":2609,"children":2610},{"style":218},[2611],{"type":24,"value":2612},"sts:AssumeRole\n",{"type":18,"tag":185,"props":2614,"children":2615},{"class":187,"line":1294},[2616,2621],{"type":18,"tag":185,"props":2617,"children":2618},{"style":742},[2619],{"type":24,"value":2620},"      Policies",{"type":18,"tag":185,"props":2622,"children":2623},{"style":249},[2624],{"type":24,"value":750},{"type":18,"tag":185,"props":2626,"children":2627},{"class":187,"line":1302},[2628,2632,2637,2641],{"type":18,"tag":185,"props":2629,"children":2630},{"style":249},[2631],{"type":24,"value":1797},{"type":18,"tag":185,"props":2633,"children":2634},{"style":742},[2635],{"type":24,"value":2636},"PolicyName",{"type":18,"tag":185,"props":2638,"children":2639},{"style":249},[2640],{"type":24,"value":764},{"type":18,"tag":185,"props":2642,"children":2643},{"style":218},[2644],{"type":24,"value":2645},"ScraperFeedBucketPolicy\n",{"type":18,"tag":185,"props":2647,"children":2648},{"class":187,"line":1315},[2649,2654],{"type":18,"tag":185,"props":2650,"children":2651},{"style":742},[2652],{"type":24,"value":2653},"          PolicyDocument",{"type":18,"tag":185,"props":2655,"children":2656},{"style":249},[2657],{"type":24,"value":750},{"type":18,"tag":185,"props":2659,"children":2660},{"class":187,"line":1328},[2661,2666],{"type":18,"tag":185,"props":2662,"children":2663},{"style":742},[2664],{"type":24,"value":2665},"            Statement",{"type":18,"tag":185,"props":2667,"children":2668},{"style":249},[2669],{"type":24,"value":750},{"type":18,"tag":185,"props":2671,"children":2672},{"class":187,"line":1351},[2673,2677,2681,2685],{"type":18,"tag":185,"props":2674,"children":2675},{"style":249},[2676],{"type":24,"value":2607},{"type":18,"tag":185,"props":2678,"children":2679},{"style":742},[2680],{"type":24,"value":1802},{"type":18,"tag":185,"props":2682,"children":2683},{"style":249},[2684],{"type":24,"value":764},{"type":18,"tag":185,"props":2686,"children":2687},{"style":218},[2688],{"type":24,"value":1811},{"type":18,"tag":185,"props":2690,"children":2692},{"class":187,"line":2691},33,[2693,2698],{"type":18,"tag":185,"props":2694,"children":2695},{"style":742},[2696],{"type":24,"value":2697},"                Action",{"type":18,"tag":185,"props":2699,"children":2700},{"style":249},[2701],{"type":24,"value":750},{"type":18,"tag":185,"props":2703,"children":2705},{"class":187,"line":2704},34,[2706,2711],{"type":18,"tag":185,"props":2707,"children":2708},{"style":249},[2709],{"type":24,"value":2710},"                  - ",{"type":18,"tag":185,"props":2712,"children":2713},{"style":218},[2714],{"type":24,"value":1836},{"type":18,"tag":185,"props":2716,"children":2718},{"class":187,"line":2717},35,[2719,2724,2728],{"type":18,"tag":185,"props":2720,"children":2721},{"style":742},[2722],{"type":24,"value":2723},"                Resource",{"type":18,"tag":185,"props":2725,"children":2726},{"style":249},[2727],{"type":24,"value":764},{"type":18,"tag":185,"props":2729,"children":2730},{"style":435},[2731],{"type":24,"value":1853},{"type":18,"tag":185,"props":2733,"children":2735},{"class":187,"line":2734},36,[2736,2740],{"type":18,"tag":185,"props":2737,"children":2738},{"style":249},[2739],{"type":24,"value":2710},{"type":18,"tag":185,"props":2741,"children":2742},{"style":218},[2743],{"type":24,"value":1865},{"type":18,"tag":185,"props":2745,"children":2747},{"class":187,"line":2746},37,[2748,2752,2756,2760,2764],{"type":18,"tag":185,"props":2749,"children":2750},{"style":249},[2751],{"type":24,"value":2710},{"type":18,"tag":185,"props":2753,"children":2754},{"style":742},[2755],{"type":24,"value":1877},{"type":18,"tag":185,"props":2757,"children":2758},{"style":249},[2759],{"type":24,"value":764},{"type":18,"tag":185,"props":2761,"children":2762},{"style":435},[2763],{"type":24,"value":1772},{"type":18,"tag":185,"props":2765,"children":2766},{"style":218},[2767],{"type":24,"value":1777},{"type":18,"tag":185,"props":2769,"children":2771},{"class":187,"line":2770},38,[2772],{"type":18,"tag":185,"props":2773,"children":2774},{"emptyLinePlaceholder":981},[2775],{"type":24,"value":984},{"type":18,"tag":185,"props":2777,"children":2779},{"class":187,"line":2778},39,[2780,2785],{"type":18,"tag":185,"props":2781,"children":2782},{"style":742},[2783],{"type":24,"value":2784},"  FargateExecutionRole",{"type":18,"tag":185,"props":2786,"children":2787},{"style":249},[2788],{"type":24,"value":750},{"type":18,"tag":185,"props":2790,"children":2792},{"class":187,"line":2791},40,[2793,2797,2801],{"type":18,"tag":185,"props":2794,"children":2795},{"style":742},[2796],{"type":24,"value":1649},{"type":18,"tag":185,"props":2798,"children":2799},{"style":249},[2800],{"type":24,"value":764},{"type":18,"tag":185,"props":2802,"children":2803},{"style":218},[2804],{"type":24,"value":2460},{"type":18,"tag":185,"props":2806,"children":2808},{"class":187,"line":2807},41,[2809,2813],{"type":18,"tag":185,"props":2810,"children":2811},{"style":742},[2812],{"type":24,"value":1666},{"type":18,"tag":185,"props":2814,"children":2815},{"style":249},[2816],{"type":24,"value":750},{"type":18,"tag":185,"props":2818,"children":2820},{"class":187,"line":2819},42,[2821,2826],{"type":18,"tag":185,"props":2822,"children":2823},{"style":742},[2824],{"type":24,"value":2825},"      ManagedPolicyArns",{"type":18,"tag":185,"props":2827,"children":2828},{"style":249},[2829],{"type":24,"value":750},{"type":18,"tag":185,"props":2831,"children":2833},{"class":187,"line":2832},43,[2834,2838],{"type":18,"tag":185,"props":2835,"children":2836},{"style":249},[2837],{"type":24,"value":1797},{"type":18,"tag":185,"props":2839,"children":2840},{"style":218},[2841],{"type":24,"value":2842},"arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy\n",{"type":18,"tag":185,"props":2844,"children":2846},{"class":187,"line":2845},44,[2847,2851],{"type":18,"tag":185,"props":2848,"children":2849},{"style":742},[2850],{"type":24,"value":2479},{"type":18,"tag":185,"props":2852,"children":2853},{"style":249},[2854],{"type":24,"value":750},{"type":18,"tag":185,"props":2856,"children":2858},{"class":187,"line":2857},45,[2859,2863,2867],{"type":18,"tag":185,"props":2860,"children":2861},{"style":742},[2862],{"type":24,"value":2491},{"type":18,"tag":185,"props":2864,"children":2865},{"style":249},[2866],{"type":24,"value":764},{"type":18,"tag":185,"props":2868,"children":2869},{"style":218},[2870],{"type":24,"value":2500},{"type":18,"tag":185,"props":2872,"children":2874},{"class":187,"line":2873},46,[2875,2879],{"type":18,"tag":185,"props":2876,"children":2877},{"style":742},[2878],{"type":24,"value":2508},{"type":18,"tag":185,"props":2880,"children":2881},{"style":249},[2882],{"type":24,"value":750},{"type":18,"tag":185,"props":2884,"children":2886},{"class":187,"line":2885},47,[2887,2891,2895,2899],{"type":18,"tag":185,"props":2888,"children":2889},{"style":249},[2890],{"type":24,"value":2520},{"type":18,"tag":185,"props":2892,"children":2893},{"style":742},[2894],{"type":24,"value":1802},{"type":18,"tag":185,"props":2896,"children":2897},{"style":249},[2898],{"type":24,"value":764},{"type":18,"tag":185,"props":2900,"children":2901},{"style":218},[2902],{"type":24,"value":2533},{"type":18,"tag":185,"props":2904,"children":2906},{"class":187,"line":2905},48,[2907,2911,2915],{"type":18,"tag":185,"props":2908,"children":2909},{"style":742},[2910],{"type":24,"value":2541},{"type":18,"tag":185,"props":2912,"children":2913},{"style":249},[2914],{"type":24,"value":764},{"type":18,"tag":185,"props":2916,"children":2917},{"style":218},[2918],{"type":24,"value":2550},{"type":18,"tag":185,"props":2920,"children":2922},{"class":187,"line":2921},49,[2923,2927],{"type":18,"tag":185,"props":2924,"children":2925},{"style":742},[2926],{"type":24,"value":2558},{"type":18,"tag":185,"props":2928,"children":2929},{"style":249},[2930],{"type":24,"value":750},{"type":18,"tag":185,"props":2932,"children":2934},{"class":187,"line":2933},50,[2935,2939],{"type":18,"tag":185,"props":2936,"children":2937},{"style":742},[2938],{"type":24,"value":2570},{"type":18,"tag":185,"props":2940,"children":2941},{"style":249},[2942],{"type":24,"value":750},{"type":18,"tag":185,"props":2944,"children":2946},{"class":187,"line":2945},51,[2947,2951],{"type":18,"tag":185,"props":2948,"children":2949},{"style":249},[2950],{"type":24,"value":2582},{"type":18,"tag":185,"props":2952,"children":2953},{"style":218},[2954],{"type":24,"value":2587},{"type":18,"tag":185,"props":2956,"children":2958},{"class":187,"line":2957},52,[2959,2963],{"type":18,"tag":185,"props":2960,"children":2961},{"style":742},[2962],{"type":24,"value":2595},{"type":18,"tag":185,"props":2964,"children":2965},{"style":249},[2966],{"type":24,"value":750},{"type":18,"tag":185,"props":2968,"children":2970},{"class":187,"line":2969},53,[2971,2975],{"type":18,"tag":185,"props":2972,"children":2973},{"style":249},[2974],{"type":24,"value":2607},{"type":18,"tag":185,"props":2976,"children":2977},{"style":218},[2978],{"type":24,"value":2612},{"type":18,"tag":185,"props":2980,"children":2982},{"class":187,"line":2981},54,[2983],{"type":18,"tag":185,"props":2984,"children":2985},{"emptyLinePlaceholder":981},[2986],{"type":24,"value":984},{"type":18,"tag":185,"props":2988,"children":2990},{"class":187,"line":2989},55,[2991,2996],{"type":18,"tag":185,"props":2992,"children":2993},{"style":742},[2994],{"type":24,"value":2995},"  FargateVPC",{"type":18,"tag":185,"props":2997,"children":2998},{"style":249},[2999],{"type":24,"value":750},{"type":18,"tag":185,"props":3001,"children":3003},{"class":187,"line":3002},56,[3004,3008,3012],{"type":18,"tag":185,"props":3005,"children":3006},{"style":742},[3007],{"type":24,"value":1649},{"type":18,"tag":185,"props":3009,"children":3010},{"style":249},[3011],{"type":24,"value":764},{"type":18,"tag":185,"props":3013,"children":3014},{"style":218},[3015],{"type":24,"value":3016},"\"AWS::EC2::VPC\"\n",{"type":18,"tag":185,"props":3018,"children":3020},{"class":187,"line":3019},57,[3021,3025],{"type":18,"tag":185,"props":3022,"children":3023},{"style":742},[3024],{"type":24,"value":1666},{"type":18,"tag":185,"props":3026,"children":3027},{"style":249},[3028],{"type":24,"value":750},{"type":18,"tag":185,"props":3030,"children":3032},{"class":187,"line":3031},58,[3033,3038,3042],{"type":18,"tag":185,"props":3034,"children":3035},{"style":742},[3036],{"type":24,"value":3037},"      CidrBlock",{"type":18,"tag":185,"props":3039,"children":3040},{"style":249},[3041],{"type":24,"value":764},{"type":18,"tag":185,"props":3043,"children":3044},{"style":218},[3045],{"type":24,"value":3046},"10.10.10.0/24\n",{"type":18,"tag":185,"props":3048,"children":3050},{"class":187,"line":3049},59,[3051,3056],{"type":18,"tag":185,"props":3052,"children":3053},{"style":742},[3054],{"type":24,"value":3055},"      Tags",{"type":18,"tag":185,"props":3057,"children":3058},{"style":249},[3059],{"type":24,"value":750},{"type":18,"tag":185,"props":3061,"children":3063},{"class":187,"line":3062},60,[3064,3068,3073,3077],{"type":18,"tag":185,"props":3065,"children":3066},{"style":249},[3067],{"type":24,"value":1797},{"type":18,"tag":185,"props":3069,"children":3070},{"style":742},[3071],{"type":24,"value":3072},"Key",{"type":18,"tag":185,"props":3074,"children":3075},{"style":249},[3076],{"type":24,"value":764},{"type":18,"tag":185,"props":3078,"children":3079},{"style":218},[3080],{"type":24,"value":3081},"Name\n",{"type":18,"tag":185,"props":3083,"children":3085},{"class":187,"line":3084},61,[3086,3091,3095,3099],{"type":18,"tag":185,"props":3087,"children":3088},{"style":742},[3089],{"type":24,"value":3090},"          Value",{"type":18,"tag":185,"props":3092,"children":3093},{"style":249},[3094],{"type":24,"value":764},{"type":18,"tag":185,"props":3096,"children":3097},{"style":435},[3098],{"type":24,"value":1772},{"type":18,"tag":185,"props":3100,"children":3101},{"style":218},[3102],{"type":24,"value":2363},{"type":18,"tag":185,"props":3104,"children":3106},{"class":187,"line":3105},62,[3107,3112],{"type":18,"tag":185,"props":3108,"children":3109},{"style":742},[3110],{"type":24,"value":3111},"  FargateSubnet",{"type":18,"tag":185,"props":3113,"children":3114},{"style":249},[3115],{"type":24,"value":750},{"type":18,"tag":185,"props":3117,"children":3119},{"class":187,"line":3118},63,[3120,3124,3128],{"type":18,"tag":185,"props":3121,"children":3122},{"style":742},[3123],{"type":24,"value":1649},{"type":18,"tag":185,"props":3125,"children":3126},{"style":249},[3127],{"type":24,"value":764},{"type":18,"tag":185,"props":3129,"children":3130},{"style":218},[3131],{"type":24,"value":3132},"\"AWS::EC2::Subnet\"\n",{"type":18,"tag":185,"props":3134,"children":3136},{"class":187,"line":3135},64,[3137,3141],{"type":18,"tag":185,"props":3138,"children":3139},{"style":742},[3140],{"type":24,"value":1666},{"type":18,"tag":185,"props":3142,"children":3143},{"style":249},[3144],{"type":24,"value":750},{"type":18,"tag":185,"props":3146,"children":3148},{"class":187,"line":3147},65,[3149,3153,3157],{"type":18,"tag":185,"props":3150,"children":3151},{"style":742},[3152],{"type":24,"value":3037},{"type":18,"tag":185,"props":3154,"children":3155},{"style":249},[3156],{"type":24,"value":764},{"type":18,"tag":185,"props":3158,"children":3159},{"style":218},[3160],{"type":24,"value":3046},{"type":18,"tag":185,"props":3162,"children":3164},{"class":187,"line":3163},66,[3165,3170,3174,3178],{"type":18,"tag":185,"props":3166,"children":3167},{"style":742},[3168],{"type":24,"value":3169},"      VpcId",{"type":18,"tag":185,"props":3171,"children":3172},{"style":249},[3173],{"type":24,"value":764},{"type":18,"tag":185,"props":3175,"children":3176},{"style":435},[3177],{"type":24,"value":1772},{"type":18,"tag":185,"props":3179,"children":3180},{"style":218},[3181],{"type":24,"value":3182}," FargateVPC\n",{"type":18,"tag":185,"props":3184,"children":3186},{"class":187,"line":3185},67,[3187,3191],{"type":18,"tag":185,"props":3188,"children":3189},{"style":742},[3190],{"type":24,"value":3055},{"type":18,"tag":185,"props":3192,"children":3193},{"style":249},[3194],{"type":24,"value":750},{"type":18,"tag":185,"props":3196,"children":3198},{"class":187,"line":3197},68,[3199,3203,3207,3211],{"type":18,"tag":185,"props":3200,"children":3201},{"style":249},[3202],{"type":24,"value":1797},{"type":18,"tag":185,"props":3204,"children":3205},{"style":742},[3206],{"type":24,"value":3072},{"type":18,"tag":185,"props":3208,"children":3209},{"style":249},[3210],{"type":24,"value":764},{"type":18,"tag":185,"props":3212,"children":3213},{"style":218},[3214],{"type":24,"value":3081},{"type":18,"tag":185,"props":3216,"children":3218},{"class":187,"line":3217},69,[3219,3223,3227,3231],{"type":18,"tag":185,"props":3220,"children":3221},{"style":742},[3222],{"type":24,"value":3090},{"type":18,"tag":185,"props":3224,"children":3225},{"style":249},[3226],{"type":24,"value":764},{"type":18,"tag":185,"props":3228,"children":3229},{"style":435},[3230],{"type":24,"value":1772},{"type":18,"tag":185,"props":3232,"children":3233},{"style":218},[3234],{"type":24,"value":2363},{"type":18,"tag":185,"props":3236,"children":3238},{"class":187,"line":3237},70,[3239,3244],{"type":18,"tag":185,"props":3240,"children":3241},{"style":742},[3242],{"type":24,"value":3243},"  FargateIGW",{"type":18,"tag":185,"props":3245,"children":3246},{"style":249},[3247],{"type":24,"value":750},{"type":18,"tag":185,"props":3249,"children":3251},{"class":187,"line":3250},71,[3252,3256,3260],{"type":18,"tag":185,"props":3253,"children":3254},{"style":742},[3255],{"type":24,"value":1649},{"type":18,"tag":185,"props":3257,"children":3258},{"style":249},[3259],{"type":24,"value":764},{"type":18,"tag":185,"props":3261,"children":3262},{"style":218},[3263],{"type":24,"value":3264},"\"AWS::EC2::InternetGateway\"\n",{"type":18,"tag":185,"props":3266,"children":3268},{"class":187,"line":3267},72,[3269,3273],{"type":18,"tag":185,"props":3270,"children":3271},{"style":742},[3272],{"type":24,"value":1666},{"type":18,"tag":185,"props":3274,"children":3275},{"style":249},[3276],{"type":24,"value":750},{"type":18,"tag":185,"props":3278,"children":3280},{"class":187,"line":3279},73,[3281,3285],{"type":18,"tag":185,"props":3282,"children":3283},{"style":742},[3284],{"type":24,"value":3055},{"type":18,"tag":185,"props":3286,"children":3287},{"style":249},[3288],{"type":24,"value":750},{"type":18,"tag":185,"props":3290,"children":3292},{"class":187,"line":3291},74,[3293,3297,3301,3305],{"type":18,"tag":185,"props":3294,"children":3295},{"style":249},[3296],{"type":24,"value":1797},{"type":18,"tag":185,"props":3298,"children":3299},{"style":742},[3300],{"type":24,"value":3072},{"type":18,"tag":185,"props":3302,"children":3303},{"style":249},[3304],{"type":24,"value":764},{"type":18,"tag":185,"props":3306,"children":3307},{"style":218},[3308],{"type":24,"value":3081},{"type":18,"tag":185,"props":3310,"children":3312},{"class":187,"line":3311},75,[3313,3317,3321,3325],{"type":18,"tag":185,"props":3314,"children":3315},{"style":742},[3316],{"type":24,"value":3090},{"type":18,"tag":185,"props":3318,"children":3319},{"style":249},[3320],{"type":24,"value":764},{"type":18,"tag":185,"props":3322,"children":3323},{"style":435},[3324],{"type":24,"value":1772},{"type":18,"tag":185,"props":3326,"children":3327},{"style":218},[3328],{"type":24,"value":2363},{"type":18,"tag":185,"props":3330,"children":3332},{"class":187,"line":3331},76,[3333,3338],{"type":18,"tag":185,"props":3334,"children":3335},{"style":742},[3336],{"type":24,"value":3337},"  FargateAttachGateway",{"type":18,"tag":185,"props":3339,"children":3340},{"style":249},[3341],{"type":24,"value":750},{"type":18,"tag":185,"props":3343,"children":3345},{"class":187,"line":3344},77,[3346,3350,3354],{"type":18,"tag":185,"props":3347,"children":3348},{"style":742},[3349],{"type":24,"value":1649},{"type":18,"tag":185,"props":3351,"children":3352},{"style":249},[3353],{"type":24,"value":764},{"type":18,"tag":185,"props":3355,"children":3356},{"style":218},[3357],{"type":24,"value":3358},"AWS::EC2::VPCGatewayAttachment\n",{"type":18,"tag":185,"props":3360,"children":3362},{"class":187,"line":3361},78,[3363,3367],{"type":18,"tag":185,"props":3364,"children":3365},{"style":742},[3366],{"type":24,"value":1666},{"type":18,"tag":185,"props":3368,"children":3369},{"style":249},[3370],{"type":24,"value":750},{"type":18,"tag":185,"props":3372,"children":3374},{"class":187,"line":3373},79,[3375,3379,3383,3387],{"type":18,"tag":185,"props":3376,"children":3377},{"style":742},[3378],{"type":24,"value":3169},{"type":18,"tag":185,"props":3380,"children":3381},{"style":249},[3382],{"type":24,"value":764},{"type":18,"tag":185,"props":3384,"children":3385},{"style":435},[3386],{"type":24,"value":1772},{"type":18,"tag":185,"props":3388,"children":3389},{"style":218},[3390],{"type":24,"value":3182},{"type":18,"tag":185,"props":3392,"children":3394},{"class":187,"line":3393},80,[3395,3400,3404,3408],{"type":18,"tag":185,"props":3396,"children":3397},{"style":742},[3398],{"type":24,"value":3399},"      InternetGatewayId",{"type":18,"tag":185,"props":3401,"children":3402},{"style":249},[3403],{"type":24,"value":764},{"type":18,"tag":185,"props":3405,"children":3406},{"style":435},[3407],{"type":24,"value":1772},{"type":18,"tag":185,"props":3409,"children":3410},{"style":218},[3411],{"type":24,"value":3412}," FargateIGW\n",{"type":18,"tag":185,"props":3414,"children":3416},{"class":187,"line":3415},81,[3417,3422],{"type":18,"tag":185,"props":3418,"children":3419},{"style":742},[3420],{"type":24,"value":3421},"  FargateRouteTable",{"type":18,"tag":185,"props":3423,"children":3424},{"style":249},[3425],{"type":24,"value":750},{"type":18,"tag":185,"props":3427,"children":3429},{"class":187,"line":3428},82,[3430,3434,3438],{"type":18,"tag":185,"props":3431,"children":3432},{"style":742},[3433],{"type":24,"value":1649},{"type":18,"tag":185,"props":3435,"children":3436},{"style":249},[3437],{"type":24,"value":764},{"type":18,"tag":185,"props":3439,"children":3440},{"style":218},[3441],{"type":24,"value":3442},"\"AWS::EC2::RouteTable\"\n",{"type":18,"tag":185,"props":3444,"children":3446},{"class":187,"line":3445},83,[3447,3451],{"type":18,"tag":185,"props":3448,"children":3449},{"style":742},[3450],{"type":24,"value":1666},{"type":18,"tag":185,"props":3452,"children":3453},{"style":249},[3454],{"type":24,"value":750},{"type":18,"tag":185,"props":3456,"children":3458},{"class":187,"line":3457},84,[3459,3463,3467,3471],{"type":18,"tag":185,"props":3460,"children":3461},{"style":742},[3462],{"type":24,"value":3169},{"type":18,"tag":185,"props":3464,"children":3465},{"style":249},[3466],{"type":24,"value":764},{"type":18,"tag":185,"props":3468,"children":3469},{"style":435},[3470],{"type":24,"value":1772},{"type":18,"tag":185,"props":3472,"children":3473},{"style":218},[3474],{"type":24,"value":3182},{"type":18,"tag":185,"props":3476,"children":3478},{"class":187,"line":3477},85,[3479,3483],{"type":18,"tag":185,"props":3480,"children":3481},{"style":742},[3482],{"type":24,"value":3055},{"type":18,"tag":185,"props":3484,"children":3485},{"style":249},[3486],{"type":24,"value":750},{"type":18,"tag":185,"props":3488,"children":3490},{"class":187,"line":3489},86,[3491,3495,3499,3503],{"type":18,"tag":185,"props":3492,"children":3493},{"style":249},[3494],{"type":24,"value":1797},{"type":18,"tag":185,"props":3496,"children":3497},{"style":742},[3498],{"type":24,"value":3072},{"type":18,"tag":185,"props":3500,"children":3501},{"style":249},[3502],{"type":24,"value":764},{"type":18,"tag":185,"props":3504,"children":3505},{"style":218},[3506],{"type":24,"value":3081},{"type":18,"tag":185,"props":3508,"children":3510},{"class":187,"line":3509},87,[3511,3515,3519,3523],{"type":18,"tag":185,"props":3512,"children":3513},{"style":742},[3514],{"type":24,"value":3090},{"type":18,"tag":185,"props":3516,"children":3517},{"style":249},[3518],{"type":24,"value":764},{"type":18,"tag":185,"props":3520,"children":3521},{"style":435},[3522],{"type":24,"value":1772},{"type":18,"tag":185,"props":3524,"children":3525},{"style":218},[3526],{"type":24,"value":2363},{"type":18,"tag":185,"props":3528,"children":3530},{"class":187,"line":3529},88,[3531,3536],{"type":18,"tag":185,"props":3532,"children":3533},{"style":742},[3534],{"type":24,"value":3535},"  FargateRoute",{"type":18,"tag":185,"props":3537,"children":3538},{"style":249},[3539],{"type":24,"value":750},{"type":18,"tag":185,"props":3541,"children":3543},{"class":187,"line":3542},89,[3544,3548,3552],{"type":18,"tag":185,"props":3545,"children":3546},{"style":742},[3547],{"type":24,"value":1649},{"type":18,"tag":185,"props":3549,"children":3550},{"style":249},[3551],{"type":24,"value":764},{"type":18,"tag":185,"props":3553,"children":3554},{"style":218},[3555],{"type":24,"value":3556},"\"AWS::EC2::Route\"\n",{"type":18,"tag":185,"props":3558,"children":3560},{"class":187,"line":3559},90,[3561,3566,3570],{"type":18,"tag":185,"props":3562,"children":3563},{"style":742},[3564],{"type":24,"value":3565},"    DependsOn",{"type":18,"tag":185,"props":3567,"children":3568},{"style":249},[3569],{"type":24,"value":764},{"type":18,"tag":185,"props":3571,"children":3572},{"style":218},[3573],{"type":24,"value":3574},"FargateAttachGateway\n",{"type":18,"tag":185,"props":3576,"children":3578},{"class":187,"line":3577},91,[3579,3583],{"type":18,"tag":185,"props":3580,"children":3581},{"style":742},[3582],{"type":24,"value":1666},{"type":18,"tag":185,"props":3584,"children":3585},{"style":249},[3586],{"type":24,"value":750},{"type":18,"tag":185,"props":3588,"children":3590},{"class":187,"line":3589},92,[3591,3596,3600,3604],{"type":18,"tag":185,"props":3592,"children":3593},{"style":742},[3594],{"type":24,"value":3595},"      RouteTableId",{"type":18,"tag":185,"props":3597,"children":3598},{"style":249},[3599],{"type":24,"value":764},{"type":18,"tag":185,"props":3601,"children":3602},{"style":435},[3603],{"type":24,"value":1772},{"type":18,"tag":185,"props":3605,"children":3606},{"style":218},[3607],{"type":24,"value":3608}," FargateRouteTable\n",{"type":18,"tag":185,"props":3610,"children":3612},{"class":187,"line":3611},93,[3613,3618,3622],{"type":18,"tag":185,"props":3614,"children":3615},{"style":742},[3616],{"type":24,"value":3617},"      DestinationCidrBlock",{"type":18,"tag":185,"props":3619,"children":3620},{"style":249},[3621],{"type":24,"value":764},{"type":18,"tag":185,"props":3623,"children":3624},{"style":218},[3625],{"type":24,"value":3626},"0.0.0.0/0\n",{"type":18,"tag":185,"props":3628,"children":3630},{"class":187,"line":3629},94,[3631,3636,3640,3644],{"type":18,"tag":185,"props":3632,"children":3633},{"style":742},[3634],{"type":24,"value":3635},"      GatewayId",{"type":18,"tag":185,"props":3637,"children":3638},{"style":249},[3639],{"type":24,"value":764},{"type":18,"tag":185,"props":3641,"children":3642},{"style":435},[3643],{"type":24,"value":1772},{"type":18,"tag":185,"props":3645,"children":3646},{"style":218},[3647],{"type":24,"value":3412},{"type":18,"tag":185,"props":3649,"children":3651},{"class":187,"line":3650},95,[3652,3657],{"type":18,"tag":185,"props":3653,"children":3654},{"style":742},[3655],{"type":24,"value":3656},"  FargateSubnetRouteTableAssociation",{"type":18,"tag":185,"props":3658,"children":3659},{"style":249},[3660],{"type":24,"value":750},{"type":18,"tag":185,"props":3662,"children":3664},{"class":187,"line":3663},96,[3665,3669,3673],{"type":18,"tag":185,"props":3666,"children":3667},{"style":742},[3668],{"type":24,"value":1649},{"type":18,"tag":185,"props":3670,"children":3671},{"style":249},[3672],{"type":24,"value":764},{"type":18,"tag":185,"props":3674,"children":3675},{"style":218},[3676],{"type":24,"value":3677},"AWS::EC2::SubnetRouteTableAssociation\n",{"type":18,"tag":185,"props":3679,"children":3681},{"class":187,"line":3680},97,[3682,3686],{"type":18,"tag":185,"props":3683,"children":3684},{"style":742},[3685],{"type":24,"value":1666},{"type":18,"tag":185,"props":3687,"children":3688},{"style":249},[3689],{"type":24,"value":750},{"type":18,"tag":185,"props":3691,"children":3693},{"class":187,"line":3692},98,[3694,3698,3702,3706],{"type":18,"tag":185,"props":3695,"children":3696},{"style":742},[3697],{"type":24,"value":3595},{"type":18,"tag":185,"props":3699,"children":3700},{"style":249},[3701],{"type":24,"value":764},{"type":18,"tag":185,"props":3703,"children":3704},{"style":435},[3705],{"type":24,"value":1772},{"type":18,"tag":185,"props":3707,"children":3708},{"style":218},[3709],{"type":24,"value":3608},{"type":18,"tag":185,"props":3711,"children":3713},{"class":187,"line":3712},99,[3714,3719,3723,3727],{"type":18,"tag":185,"props":3715,"children":3716},{"style":742},[3717],{"type":24,"value":3718},"      SubnetId",{"type":18,"tag":185,"props":3720,"children":3721},{"style":249},[3722],{"type":24,"value":764},{"type":18,"tag":185,"props":3724,"children":3725},{"style":435},[3726],{"type":24,"value":1772},{"type":18,"tag":185,"props":3728,"children":3729},{"style":218},[3730],{"type":24,"value":3731}," FargateSubnet\n",{"type":18,"tag":185,"props":3733,"children":3735},{"class":187,"line":3734},100,[3736,3741],{"type":18,"tag":185,"props":3737,"children":3738},{"style":742},[3739],{"type":24,"value":3740},"  FargateSG",{"type":18,"tag":185,"props":3742,"children":3743},{"style":249},[3744],{"type":24,"value":750},{"type":18,"tag":185,"props":3746,"children":3748},{"class":187,"line":3747},101,[3749,3753,3757],{"type":18,"tag":185,"props":3750,"children":3751},{"style":742},[3752],{"type":24,"value":1649},{"type":18,"tag":185,"props":3754,"children":3755},{"style":249},[3756],{"type":24,"value":764},{"type":18,"tag":185,"props":3758,"children":3759},{"style":218},[3760],{"type":24,"value":3761},"\"AWS::EC2::SecurityGroup\"\n",{"type":18,"tag":185,"props":3763,"children":3765},{"class":187,"line":3764},102,[3766,3770],{"type":18,"tag":185,"props":3767,"children":3768},{"style":742},[3769],{"type":24,"value":1666},{"type":18,"tag":185,"props":3771,"children":3772},{"style":249},[3773],{"type":24,"value":750},{"type":18,"tag":185,"props":3775,"children":3777},{"class":187,"line":3776},103,[3778,3783,3787],{"type":18,"tag":185,"props":3779,"children":3780},{"style":742},[3781],{"type":24,"value":3782},"      GroupDescription",{"type":18,"tag":185,"props":3784,"children":3785},{"style":249},[3786],{"type":24,"value":764},{"type":18,"tag":185,"props":3788,"children":3789},{"style":218},[3790],{"type":24,"value":3791},"\"Generated by Serverless\"\n",{"type":18,"tag":185,"props":3793,"children":3795},{"class":187,"line":3794},104,[3796,3801],{"type":18,"tag":185,"props":3797,"children":3798},{"style":742},[3799],{"type":24,"value":3800},"      SecurityGroupIngress",{"type":18,"tag":185,"props":3802,"children":3803},{"style":249},[3804],{"type":24,"value":750},{"type":18,"tag":185,"props":3806,"children":3808},{"class":187,"line":3807},105,[3809,3813,3818,3822],{"type":18,"tag":185,"props":3810,"children":3811},{"style":249},[3812],{"type":24,"value":1797},{"type":18,"tag":185,"props":3814,"children":3815},{"style":742},[3816],{"type":24,"value":3817},"IpProtocol",{"type":18,"tag":185,"props":3819,"children":3820},{"style":249},[3821],{"type":24,"value":764},{"type":18,"tag":185,"props":3823,"children":3824},{"style":198},[3825],{"type":24,"value":3826},"-1\n",{"type":18,"tag":185,"props":3828,"children":3830},{"class":187,"line":3829},106,[3831,3836,3840],{"type":18,"tag":185,"props":3832,"children":3833},{"style":742},[3834],{"type":24,"value":3835},"          CidrIp",{"type":18,"tag":185,"props":3837,"children":3838},{"style":249},[3839],{"type":24,"value":764},{"type":18,"tag":185,"props":3841,"children":3842},{"style":218},[3843],{"type":24,"value":3844},"127.0.0.1/32\n",{"type":18,"tag":185,"props":3846,"children":3848},{"class":187,"line":3847},107,[3849,3853],{"type":18,"tag":185,"props":3850,"children":3851},{"style":742},[3852],{"type":24,"value":3055},{"type":18,"tag":185,"props":3854,"children":3855},{"style":249},[3856],{"type":24,"value":750},{"type":18,"tag":185,"props":3858,"children":3860},{"class":187,"line":3859},108,[3861,3865,3869,3873],{"type":18,"tag":185,"props":3862,"children":3863},{"style":249},[3864],{"type":24,"value":1797},{"type":18,"tag":185,"props":3866,"children":3867},{"style":742},[3868],{"type":24,"value":3072},{"type":18,"tag":185,"props":3870,"children":3871},{"style":249},[3872],{"type":24,"value":764},{"type":18,"tag":185,"props":3874,"children":3875},{"style":218},[3876],{"type":24,"value":3081},{"type":18,"tag":185,"props":3878,"children":3880},{"class":187,"line":3879},109,[3881,3885,3889,3893],{"type":18,"tag":185,"props":3882,"children":3883},{"style":742},[3884],{"type":24,"value":3090},{"type":18,"tag":185,"props":3886,"children":3887},{"style":249},[3888],{"type":24,"value":764},{"type":18,"tag":185,"props":3890,"children":3891},{"style":435},[3892],{"type":24,"value":1772},{"type":18,"tag":185,"props":3894,"children":3895},{"style":218},[3896],{"type":24,"value":2363},{"type":18,"tag":185,"props":3898,"children":3900},{"class":187,"line":3899},110,[3901,3905,3909,3913],{"type":18,"tag":185,"props":3902,"children":3903},{"style":742},[3904],{"type":24,"value":3169},{"type":18,"tag":185,"props":3906,"children":3907},{"style":249},[3908],{"type":24,"value":764},{"type":18,"tag":185,"props":3910,"children":3911},{"style":435},[3912],{"type":24,"value":1772},{"type":18,"tag":185,"props":3914,"children":3915},{"style":218},[3916],{"type":24,"value":3182},{"type":18,"tag":185,"props":3918,"children":3920},{"class":187,"line":3919},111,[3921],{"type":18,"tag":185,"props":3922,"children":3923},{"emptyLinePlaceholder":981},[3924],{"type":24,"value":984},{"type":18,"tag":185,"props":3926,"children":3928},{"class":187,"line":3927},112,[3929,3934],{"type":18,"tag":185,"props":3930,"children":3931},{"style":742},[3932],{"type":24,"value":3933},"  FargateECSRepo",{"type":18,"tag":185,"props":3935,"children":3936},{"style":249},[3937],{"type":24,"value":750},{"type":18,"tag":185,"props":3939,"children":3941},{"class":187,"line":3940},113,[3942,3946,3950],{"type":18,"tag":185,"props":3943,"children":3944},{"style":742},[3945],{"type":24,"value":1649},{"type":18,"tag":185,"props":3947,"children":3948},{"style":249},[3949],{"type":24,"value":764},{"type":18,"tag":185,"props":3951,"children":3952},{"style":218},[3953],{"type":24,"value":3954},"\"AWS::ECR::Repository\"\n",{"type":18,"tag":185,"props":3956,"children":3958},{"class":187,"line":3957},114,[3959,3963],{"type":18,"tag":185,"props":3960,"children":3961},{"style":742},[3962],{"type":24,"value":1666},{"type":18,"tag":185,"props":3964,"children":3965},{"style":249},[3966],{"type":24,"value":750},{"type":18,"tag":185,"props":3968,"children":3970},{"class":187,"line":3969},115,[3971,3976],{"type":18,"tag":185,"props":3972,"children":3973},{"style":742},[3974],{"type":24,"value":3975},"      LifecyclePolicy",{"type":18,"tag":185,"props":3977,"children":3978},{"style":249},[3979],{"type":24,"value":750},{"type":18,"tag":185,"props":3981,"children":3983},{"class":187,"line":3982},116,[3984,3989,3993],{"type":18,"tag":185,"props":3985,"children":3986},{"style":742},[3987],{"type":24,"value":3988},"        LifecyclePolicyText",{"type":18,"tag":185,"props":3990,"children":3991},{"style":249},[3992],{"type":24,"value":764},{"type":18,"tag":185,"props":3994,"children":3995},{"style":435},[3996],{"type":24,"value":3997},"|\n",{"type":18,"tag":185,"props":3999,"children":4001},{"class":187,"line":4000},117,[4002],{"type":18,"tag":185,"props":4003,"children":4004},{"style":218},[4005],{"type":24,"value":4006},"          {\n",{"type":18,"tag":185,"props":4008,"children":4010},{"class":187,"line":4009},118,[4011],{"type":18,"tag":185,"props":4012,"children":4013},{"style":218},[4014],{"type":24,"value":4015},"            \"rules\": [\n",{"type":18,"tag":185,"props":4017,"children":4019},{"class":187,"line":4018},119,[4020],{"type":18,"tag":185,"props":4021,"children":4022},{"style":218},[4023],{"type":24,"value":4024},"            {\n",{"type":18,"tag":185,"props":4026,"children":4028},{"class":187,"line":4027},120,[4029],{"type":18,"tag":185,"props":4030,"children":4031},{"style":218},[4032],{"type":24,"value":4033},"              \"rulePriority\": 1,\n",{"type":18,"tag":185,"props":4035,"children":4037},{"class":187,"line":4036},121,[4038],{"type":18,"tag":185,"props":4039,"children":4040},{"style":218},[4041],{"type":24,"value":4042},"              \"description\": \"Only keep 8 images\",\n",{"type":18,"tag":185,"props":4044,"children":4046},{"class":187,"line":4045},122,[4047],{"type":18,"tag":185,"props":4048,"children":4049},{"style":218},[4050],{"type":24,"value":4051},"              \"selection\": {\n",{"type":18,"tag":185,"props":4053,"children":4055},{"class":187,"line":4054},123,[4056],{"type":18,"tag":185,"props":4057,"children":4058},{"style":218},[4059],{"type":24,"value":4060},"                \"tagStatus\": \"any\",\n",{"type":18,"tag":185,"props":4062,"children":4064},{"class":187,"line":4063},124,[4065],{"type":18,"tag":185,"props":4066,"children":4067},{"style":218},[4068],{"type":24,"value":4069},"                \"countType\": \"imageCountMoreThan\",\n",{"type":18,"tag":185,"props":4071,"children":4073},{"class":187,"line":4072},125,[4074],{"type":18,"tag":185,"props":4075,"children":4076},{"style":218},[4077],{"type":24,"value":4078},"                \"countNumber\": 8\n",{"type":18,"tag":185,"props":4080,"children":4082},{"class":187,"line":4081},126,[4083],{"type":18,"tag":185,"props":4084,"children":4085},{"style":218},[4086],{"type":24,"value":4087},"              },\n",{"type":18,"tag":185,"props":4089,"children":4091},{"class":187,"line":4090},127,[4092],{"type":18,"tag":185,"props":4093,"children":4094},{"style":218},[4095],{"type":24,"value":4096},"              \"action\": { \"type\": \"expire\" }\n",{"type":18,"tag":185,"props":4098,"children":4100},{"class":187,"line":4099},128,[4101],{"type":18,"tag":185,"props":4102,"children":4103},{"style":218},[4104],{"type":24,"value":4105},"            }]\n",{"type":18,"tag":185,"props":4107,"children":4109},{"class":187,"line":4108},129,[4110],{"type":18,"tag":185,"props":4111,"children":4112},{"style":218},[4113],{"type":24,"value":4114},"          }\n",{"type":18,"tag":185,"props":4116,"children":4118},{"class":187,"line":4117},130,[4119],{"type":18,"tag":185,"props":4120,"children":4121},{"emptyLinePlaceholder":981},[4122],{"type":24,"value":984},{"type":18,"tag":185,"props":4124,"children":4126},{"class":187,"line":4125},131,[4127,4132],{"type":18,"tag":185,"props":4128,"children":4129},{"style":742},[4130],{"type":24,"value":4131},"  FargateECSTaskDefinition",{"type":18,"tag":185,"props":4133,"children":4134},{"style":249},[4135],{"type":24,"value":750},{"type":18,"tag":185,"props":4137,"children":4139},{"class":187,"line":4138},132,[4140,4144,4148],{"type":18,"tag":185,"props":4141,"children":4142},{"style":742},[4143],{"type":24,"value":1649},{"type":18,"tag":185,"props":4145,"children":4146},{"style":249},[4147],{"type":24,"value":764},{"type":18,"tag":185,"props":4149,"children":4150},{"style":218},[4151],{"type":24,"value":4152},"\"AWS::ECS::TaskDefinition\"\n",{"type":18,"tag":185,"props":4154,"children":4156},{"class":187,"line":4155},133,[4157,4161],{"type":18,"tag":185,"props":4158,"children":4159},{"style":742},[4160],{"type":24,"value":1666},{"type":18,"tag":185,"props":4162,"children":4163},{"style":249},[4164],{"type":24,"value":750},{"type":18,"tag":185,"props":4166,"children":4168},{"class":187,"line":4167},134,[4169,4174,4178],{"type":18,"tag":185,"props":4170,"children":4171},{"style":742},[4172],{"type":24,"value":4173},"      Cpu",{"type":18,"tag":185,"props":4175,"children":4176},{"style":249},[4177],{"type":24,"value":764},{"type":18,"tag":185,"props":4179,"children":4180},{"style":198},[4181],{"type":24,"value":4182},"512\n",{"type":18,"tag":185,"props":4184,"children":4186},{"class":187,"line":4185},135,[4187,4192,4196],{"type":18,"tag":185,"props":4188,"children":4189},{"style":742},[4190],{"type":24,"value":4191},"      Memory",{"type":18,"tag":185,"props":4193,"children":4194},{"style":249},[4195],{"type":24,"value":764},{"type":18,"tag":185,"props":4197,"children":4198},{"style":218},[4199],{"type":24,"value":4200},"1GB\n",{"type":18,"tag":185,"props":4202,"children":4204},{"class":187,"line":4203},136,[4205,4210,4214],{"type":18,"tag":185,"props":4206,"children":4207},{"style":742},[4208],{"type":24,"value":4209},"      NetworkMode",{"type":18,"tag":185,"props":4211,"children":4212},{"style":249},[4213],{"type":24,"value":764},{"type":18,"tag":185,"props":4215,"children":4216},{"style":218},[4217],{"type":24,"value":4218},"awsvpc\n",{"type":18,"tag":185,"props":4220,"children":4222},{"class":187,"line":4221},137,[4223,4228],{"type":18,"tag":185,"props":4224,"children":4225},{"style":742},[4226],{"type":24,"value":4227},"      RequiresCompatibilities",{"type":18,"tag":185,"props":4229,"children":4230},{"style":249},[4231],{"type":24,"value":750},{"type":18,"tag":185,"props":4233,"children":4235},{"class":187,"line":4234},138,[4236,4240],{"type":18,"tag":185,"props":4237,"children":4238},{"style":249},[4239],{"type":24,"value":1797},{"type":18,"tag":185,"props":4241,"children":4242},{"style":218},[4243],{"type":24,"value":4244},"\"FARGATE\"\n",{"type":18,"tag":185,"props":4246,"children":4248},{"class":187,"line":4247},139,[4249,4254,4258,4263],{"type":18,"tag":185,"props":4250,"children":4251},{"style":742},[4252],{"type":24,"value":4253},"      ExecutionRoleArn",{"type":18,"tag":185,"props":4255,"children":4256},{"style":249},[4257],{"type":24,"value":764},{"type":18,"tag":185,"props":4259,"children":4260},{"style":435},[4261],{"type":24,"value":4262},"!GetAtt",{"type":18,"tag":185,"props":4264,"children":4265},{"style":218},[4266],{"type":24,"value":4267}," FargateExecutionRole.Arn\n",{"type":18,"tag":185,"props":4269,"children":4271},{"class":187,"line":4270},140,[4272,4277,4281,4285],{"type":18,"tag":185,"props":4273,"children":4274},{"style":742},[4275],{"type":24,"value":4276},"      TaskRoleArn",{"type":18,"tag":185,"props":4278,"children":4279},{"style":249},[4280],{"type":24,"value":764},{"type":18,"tag":185,"props":4282,"children":4283},{"style":435},[4284],{"type":24,"value":4262},{"type":18,"tag":185,"props":4286,"children":4287},{"style":218},[4288],{"type":24,"value":4289}," FargateTaskRole.Arn\n",{"type":18,"tag":185,"props":4291,"children":4293},{"class":187,"line":4292},141,[4294,4299],{"type":18,"tag":185,"props":4295,"children":4296},{"style":742},[4297],{"type":24,"value":4298},"      ContainerDefinitions",{"type":18,"tag":185,"props":4300,"children":4301},{"style":249},[4302],{"type":24,"value":750},{"type":18,"tag":185,"props":4304,"children":4306},{"class":187,"line":4305},142,[4307,4311,4316,4320],{"type":18,"tag":185,"props":4308,"children":4309},{"style":249},[4310],{"type":24,"value":1797},{"type":18,"tag":185,"props":4312,"children":4313},{"style":742},[4314],{"type":24,"value":4315},"Name",{"type":18,"tag":185,"props":4317,"children":4318},{"style":249},[4319],{"type":24,"value":764},{"type":18,"tag":185,"props":4321,"children":4322},{"style":218},[4323],{"type":24,"value":4324},"scraper_container\n",{"type":18,"tag":185,"props":4326,"children":4328},{"class":187,"line":4327},143,[4329,4334,4338],{"type":18,"tag":185,"props":4330,"children":4331},{"style":742},[4332],{"type":24,"value":4333},"          Image",{"type":18,"tag":185,"props":4335,"children":4336},{"style":249},[4337],{"type":24,"value":764},{"type":18,"tag":185,"props":4339,"children":4340},{"style":435},[4341],{"type":24,"value":1853},{"type":18,"tag":185,"props":4343,"children":4345},{"class":187,"line":4344},144,[4346,4350],{"type":18,"tag":185,"props":4347,"children":4348},{"style":249},[4349],{"type":24,"value":1831},{"type":18,"tag":185,"props":4351,"children":4352},{"style":218},[4353],{"type":24,"value":4354},"\"#{AccountId}.dkr.ecr.#{Region}.amazonaws.com/#{Repo}\"\n",{"type":18,"tag":185,"props":4356,"children":4358},{"class":187,"line":4357},145,[4359,4363,4368,4372,4376],{"type":18,"tag":185,"props":4360,"children":4361},{"style":249},[4362],{"type":24,"value":1831},{"type":18,"tag":185,"props":4364,"children":4365},{"style":742},[4366],{"type":24,"value":4367},"AccountId",{"type":18,"tag":185,"props":4369,"children":4370},{"style":249},[4371],{"type":24,"value":764},{"type":18,"tag":185,"props":4373,"children":4374},{"style":435},[4375],{"type":24,"value":1772},{"type":18,"tag":185,"props":4377,"children":4378},{"style":218},[4379],{"type":24,"value":4380}," AWS::AccountId\n",{"type":18,"tag":185,"props":4382,"children":4384},{"class":187,"line":4383},146,[4385,4390,4394,4398],{"type":18,"tag":185,"props":4386,"children":4387},{"style":742},[4388],{"type":24,"value":4389},"              Region",{"type":18,"tag":185,"props":4391,"children":4392},{"style":249},[4393],{"type":24,"value":764},{"type":18,"tag":185,"props":4395,"children":4396},{"style":435},[4397],{"type":24,"value":1772},{"type":18,"tag":185,"props":4399,"children":4400},{"style":218},[4401],{"type":24,"value":4402}," AWS::Region\n",{"type":18,"tag":185,"props":4404,"children":4406},{"class":187,"line":4405},147,[4407,4412,4416,4420],{"type":18,"tag":185,"props":4408,"children":4409},{"style":742},[4410],{"type":24,"value":4411},"              Repo",{"type":18,"tag":185,"props":4413,"children":4414},{"style":249},[4415],{"type":24,"value":764},{"type":18,"tag":185,"props":4417,"children":4418},{"style":435},[4419],{"type":24,"value":1772},{"type":18,"tag":185,"props":4421,"children":4422},{"style":218},[4423],{"type":24,"value":4424}," FargateECSRepo\n",{"type":18,"tag":185,"props":4426,"children":4428},{"class":187,"line":4427},148,[4429,4434],{"type":18,"tag":185,"props":4430,"children":4431},{"style":742},[4432],{"type":24,"value":4433},"          LogConfiguration",{"type":18,"tag":185,"props":4435,"children":4436},{"style":249},[4437],{"type":24,"value":750},{"type":18,"tag":185,"props":4439,"children":4441},{"class":187,"line":4440},149,[4442,4447,4451],{"type":18,"tag":185,"props":4443,"children":4444},{"style":742},[4445],{"type":24,"value":4446},"            LogDriver",{"type":18,"tag":185,"props":4448,"children":4449},{"style":249},[4450],{"type":24,"value":764},{"type":18,"tag":185,"props":4452,"children":4453},{"style":218},[4454],{"type":24,"value":4455},"awslogs\n",{"type":18,"tag":185,"props":4457,"children":4459},{"class":187,"line":4458},150,[4460,4465],{"type":18,"tag":185,"props":4461,"children":4462},{"style":742},[4463],{"type":24,"value":4464},"            Options",{"type":18,"tag":185,"props":4466,"children":4467},{"style":249},[4468],{"type":24,"value":750},{"type":18,"tag":185,"props":4470,"children":4472},{"class":187,"line":4471},151,[4473,4478,4482,4486],{"type":18,"tag":185,"props":4474,"children":4475},{"style":742},[4476],{"type":24,"value":4477},"              awslogs-group",{"type":18,"tag":185,"props":4479,"children":4480},{"style":249},[4481],{"type":24,"value":764},{"type":18,"tag":185,"props":4483,"children":4484},{"style":435},[4485],{"type":24,"value":1772},{"type":18,"tag":185,"props":4487,"children":4488},{"style":218},[4489],{"type":24,"value":4490}," FargateLogGroup\n",{"type":18,"tag":185,"props":4492,"children":4494},{"class":187,"line":4493},152,[4495,4500,4504,4508],{"type":18,"tag":185,"props":4496,"children":4497},{"style":742},[4498],{"type":24,"value":4499},"              awslogs-region",{"type":18,"tag":185,"props":4501,"children":4502},{"style":249},[4503],{"type":24,"value":764},{"type":18,"tag":185,"props":4505,"children":4506},{"style":435},[4507],{"type":24,"value":1772},{"type":18,"tag":185,"props":4509,"children":4510},{"style":218},[4511],{"type":24,"value":4402},{"type":18,"tag":185,"props":4513,"children":4515},{"class":187,"line":4514},153,[4516,4521,4525,4529],{"type":18,"tag":185,"props":4517,"children":4518},{"style":742},[4519],{"type":24,"value":4520},"              awslogs-stream-prefix",{"type":18,"tag":185,"props":4522,"children":4523},{"style":249},[4524],{"type":24,"value":764},{"type":18,"tag":185,"props":4526,"children":4527},{"style":435},[4528],{"type":24,"value":1772},{"type":18,"tag":185,"props":4530,"children":4531},{"style":218},[4532],{"type":24,"value":4533}," AWS::StackName\n",{"type":18,"tag":185,"props":4535,"children":4537},{"class":187,"line":4536},154,[4538,4543],{"type":18,"tag":185,"props":4539,"children":4540},{"style":742},[4541],{"type":24,"value":4542},"Outputs",{"type":18,"tag":185,"props":4544,"children":4545},{"style":249},[4546],{"type":24,"value":750},{"type":18,"tag":185,"props":4548,"children":4550},{"class":187,"line":4549},155,[4551,4556],{"type":18,"tag":185,"props":4552,"children":4553},{"style":742},[4554],{"type":24,"value":4555},"  ECRRepo",{"type":18,"tag":185,"props":4557,"children":4558},{"style":249},[4559],{"type":24,"value":750},{"type":18,"tag":185,"props":4561,"children":4563},{"class":187,"line":4562},156,[4564,4569,4573],{"type":18,"tag":185,"props":4565,"children":4566},{"style":742},[4567],{"type":24,"value":4568},"    Value",{"type":18,"tag":185,"props":4570,"children":4571},{"style":249},[4572],{"type":24,"value":764},{"type":18,"tag":185,"props":4574,"children":4575},{"style":435},[4576],{"type":24,"value":1853},{"type":18,"tag":185,"props":4578,"children":4580},{"class":187,"line":4579},157,[4581,4586],{"type":18,"tag":185,"props":4582,"children":4583},{"style":249},[4584],{"type":24,"value":4585},"      - ",{"type":18,"tag":185,"props":4587,"children":4588},{"style":218},[4589],{"type":24,"value":4354},{"type":18,"tag":185,"props":4591,"children":4593},{"class":187,"line":4592},158,[4594,4598,4602,4606,4610],{"type":18,"tag":185,"props":4595,"children":4596},{"style":249},[4597],{"type":24,"value":4585},{"type":18,"tag":185,"props":4599,"children":4600},{"style":742},[4601],{"type":24,"value":4367},{"type":18,"tag":185,"props":4603,"children":4604},{"style":249},[4605],{"type":24,"value":764},{"type":18,"tag":185,"props":4607,"children":4608},{"style":435},[4609],{"type":24,"value":1772},{"type":18,"tag":185,"props":4611,"children":4612},{"style":218},[4613],{"type":24,"value":4380},{"type":18,"tag":185,"props":4615,"children":4617},{"class":187,"line":4616},159,[4618,4623,4627,4631],{"type":18,"tag":185,"props":4619,"children":4620},{"style":742},[4621],{"type":24,"value":4622},"        Region",{"type":18,"tag":185,"props":4624,"children":4625},{"style":249},[4626],{"type":24,"value":764},{"type":18,"tag":185,"props":4628,"children":4629},{"style":435},[4630],{"type":24,"value":1772},{"type":18,"tag":185,"props":4632,"children":4633},{"style":218},[4634],{"type":24,"value":4402},{"type":18,"tag":185,"props":4636,"children":4638},{"class":187,"line":4637},160,[4639,4644,4648,4652],{"type":18,"tag":185,"props":4640,"children":4641},{"style":742},[4642],{"type":24,"value":4643},"        Repo",{"type":18,"tag":185,"props":4645,"children":4646},{"style":249},[4647],{"type":24,"value":764},{"type":18,"tag":185,"props":4649,"children":4650},{"style":435},[4651],{"type":24,"value":1772},{"type":18,"tag":185,"props":4653,"children":4654},{"style":218},[4655],{"type":24,"value":4424},{"type":18,"tag":27,"props":4657,"children":4658},{},[4659,4661,4668],{"type":24,"value":4660},"Credit to ",{"type":18,"tag":33,"props":4662,"children":4665},{"href":4663,"rel":4664},"https://github.com/jolexa/fargate-from-lambda",[37],[4666],{"type":24,"value":4667},"github.com/jolexa/fargate-from-lambda",{"type":24,"value":4669}," who inspired this CF template.",{"type":18,"tag":27,"props":4671,"children":4672},{},[4673],{"type":24,"value":4674},"Next, we create a file with a handler to start the Fargate task",{"type":18,"tag":174,"props":4676,"children":4678},{"code":4677,"language":195,"meta":10,"className":332,"style":10},"# launch_fargate.py\nimport os\nimport json\n\nimport boto3\n\n\ndef launch_fargate(event, context):\n    client = boto3.client(\"ecs\")\n\n    ECSCluster = os.environ[\"ECS_CLUSTER\"]\n    ECSSecGroup = os.environ[\"ECS_SEC_GROUP\"]\n    ECSSubnet = os.environ[\"ECS_SUBNET\"]\n    ECSTaskArn = os.environ[\"ECS_TASK_ARN\"]\n    CONTAINER_NAME = os.environ[\"CONTAINER_NAME\"]\n\n    run_task_response = client.run_task(\n        cluster=ECSCluster,\n        taskDefinition=ECSTaskArn,\n        count=1,\n        launchType=\"FARGATE\",\n        overrides={\n            \"containerOverrides\": [\n                {\n                    \"name\": CONTAINER_NAME,\n                    # We override the command so that we can pass some arguments\n                    # e.g. for running different spiders.\n                    \"command\": [\n                        \"python\",\n                        \"launcher.py\",\n                        json.dumps(event),\n                    ],\n                    \"environment\": [\n                        {\"name\": \"FEED_BUCKET_NAME\", \"value\": os.environ[\"FEED_BUCKET_NAME\"]},\n                    ]\n                }\n            ],\n        },\n        networkConfiguration={\n            \"awsvpcConfiguration\": {\n                \"subnets\": [\n                    ECSSubnet,\n                ],\n                \"securityGroups\": [\n                    ECSSecGroup,\n                ],\n                \"assignPublicIp\": \"ENABLED\"\n            },\n        },\n    )\n    return json.dumps(run_task_response, default=str)\n",[4679],{"type":18,"tag":181,"props":4680,"children":4681},{"__ignoreMap":10},[4682],{"type":24,"value":4677},{"type":18,"tag":27,"props":4684,"children":4685},{},[4686,4688,4692,4694,4699,4701,4706],{"type":24,"value":4687},"We also need to update our ",{"type":18,"tag":181,"props":4689,"children":4690},{"className":10},[4691],{"type":24,"value":710},{"type":24,"value":4693}," to add some new IAM role statemants, import the CloudFormation template in ",{"type":18,"tag":181,"props":4695,"children":4696},{"className":10},[4697],{"type":24,"value":4698},"fargate-cf-yml",{"type":24,"value":4700},", add some env variables, include the ",{"type":18,"tag":181,"props":4702,"children":4703},{"className":10},[4704],{"type":24,"value":4705},"launch_fargate.py",{"type":24,"value":4707}," file, and finally add a new function for launching a Fargate task.",{"type":18,"tag":174,"props":4709,"children":4711},{"code":4710,"language":715,"meta":10,"className":716,"style":10},"# serverless.yml\nservice: my-sls-scraper\n\nprovider:\n  name: aws\n  runtime: python3.7\n  logRetentionInDays: 1\n\n  environment:\n    FEED_BUCKET_NAME: !Ref ScraperFeedBucket\n    ECS_CLUSTER: !GetAtt FargateECSCluster.Arn\n    ECS_TASK_ARN: !Ref FargateECSTaskDefinition\n    ECS_SUBNET: !Ref FargateSubnet\n    ECS_SEC_GROUP: !Ref FargateSG\n    CONTAINER_NAME: \"scraper_container\"\n\n  iamRoleStatements:\n    - Effect: \"Allow\"\n      Action:\n        - \"s3:PutObject\"\n      Resource: !Sub\n        - \"arn:aws:s3:::#{BucketName}/*\"\n        - BucketName: !Ref ScraperFeedBucket\n\n    - Effect: Allow\n      Action:\n        - ecs:RunTask\n      Resource:\n        - !Ref FargateECSTaskDefinition\n    - Effect: Allow\n      Action:\n        - iam:PassRole\n      Resource:\n        - !GetAtt FargateExecutionRole.Arn\n    - Effect: Allow\n      Action:\n        - iam:PassRole\n      Resource:\n        - !GetAtt FargateTaskRole.Arn\n\nfunctions:\n  hello:\n    handler: handler.hello\n  lambdaScrape:\n    handler: launcher.scrape\n  fargateScrape:\n    handler: launch_fargate.launch_fargate\n\n# We include files by whitelisting to reduce the deployment time.\n# Just remember to add any files you create!\npackage:\n  include:\n    - handler.py\n    - launcher.py\n    - launch_fargate.py\n    - my_sls_scraper/**\n    - scrapy.cfg\n  exclude:\n    - \"./**\"\n\nresources:\n  - AWSTemplateFormatVersion: \"2010-09-09\"\n    Transform: \"AWS::Serverless-2016-10-31\"\n  - ${file(./s3-template.yml)}\n  - ${file(./fargate-template.yml)}\n\nplugins:\n  - serverless-python-requirements\n  - serverless-cloudformation-sub-variables\ncustom:\n  pythonRequirements:\n    slim: true # Omits tests, __pycache__, *.pyc etc from dependencies\n    fileName: requirements.txt\n",[4712],{"type":18,"tag":181,"props":4713,"children":4714},{"__ignoreMap":10},[4715,4722,4737,4744,4755,4770,4785,4800,4807,4819,4839,4860,4881,4901,4922,4939,4946,4958,4977,4989,5000,5016,5027,5050,5057,5076,5087,5099,5110,5125,5144,5155,5167,5178,5193,5212,5223,5234,5245,5260,5267,5278,5289,5304,5315,5330,5342,5358,5365,5372,5379,5390,5401,5412,5423,5435,5446,5457,5468,5479,5486,5497,5516,5531,5542,5554,5561,5572,5583,5595,5606,5617,5636],{"type":18,"tag":185,"props":4716,"children":4717},{"class":187,"line":188},[4718],{"type":18,"tag":185,"props":4719,"children":4720},{"style":204},[4721],{"type":24,"value":728},{"type":18,"tag":185,"props":4723,"children":4724},{"class":187,"line":210},[4725,4729,4733],{"type":18,"tag":185,"props":4726,"children":4727},{"style":742},[4728],{"type":24,"value":966},{"type":18,"tag":185,"props":4730,"children":4731},{"style":249},[4732],{"type":24,"value":764},{"type":18,"tag":185,"props":4734,"children":4735},{"style":218},[4736],{"type":24,"value":975},{"type":18,"tag":185,"props":4738,"children":4739},{"class":187,"line":288},[4740],{"type":18,"tag":185,"props":4741,"children":4742},{"emptyLinePlaceholder":981},[4743],{"type":24,"value":984},{"type":18,"tag":185,"props":4745,"children":4746},{"class":187,"line":753},[4747,4751],{"type":18,"tag":185,"props":4748,"children":4749},{"style":742},[4750],{"type":24,"value":745},{"type":18,"tag":185,"props":4752,"children":4753},{"style":249},[4754],{"type":24,"value":750},{"type":18,"tag":185,"props":4756,"children":4757},{"class":187,"line":772},[4758,4762,4766],{"type":18,"tag":185,"props":4759,"children":4760},{"style":742},[4761],{"type":24,"value":759},{"type":18,"tag":185,"props":4763,"children":4764},{"style":249},[4765],{"type":24,"value":764},{"type":18,"tag":185,"props":4767,"children":4768},{"style":218},[4769],{"type":24,"value":769},{"type":18,"tag":185,"props":4771,"children":4772},{"class":187,"line":790},[4773,4777,4781],{"type":18,"tag":185,"props":4774,"children":4775},{"style":742},[4776],{"type":24,"value":1018},{"type":18,"tag":185,"props":4778,"children":4779},{"style":249},[4780],{"type":24,"value":764},{"type":18,"tag":185,"props":4782,"children":4783},{"style":218},[4784],{"type":24,"value":787},{"type":18,"tag":185,"props":4786,"children":4787},{"class":187,"line":808},[4788,4792,4796],{"type":18,"tag":185,"props":4789,"children":4790},{"style":742},[4791],{"type":24,"value":1034},{"type":18,"tag":185,"props":4793,"children":4794},{"style":249},[4795],{"type":24,"value":764},{"type":18,"tag":185,"props":4797,"children":4798},{"style":198},[4799],{"type":24,"value":1043},{"type":18,"tag":185,"props":4801,"children":4802},{"class":187,"line":1046},[4803],{"type":18,"tag":185,"props":4804,"children":4805},{"emptyLinePlaceholder":981},[4806],{"type":24,"value":984},{"type":18,"tag":185,"props":4808,"children":4809},{"class":187,"line":1054},[4810,4815],{"type":18,"tag":185,"props":4811,"children":4812},{"style":742},[4813],{"type":24,"value":4814},"  environment",{"type":18,"tag":185,"props":4816,"children":4817},{"style":249},[4818],{"type":24,"value":750},{"type":18,"tag":185,"props":4820,"children":4821},{"class":187,"line":1067},[4822,4827,4831,4835],{"type":18,"tag":185,"props":4823,"children":4824},{"style":742},[4825],{"type":24,"value":4826},"    FEED_BUCKET_NAME",{"type":18,"tag":185,"props":4828,"children":4829},{"style":249},[4830],{"type":24,"value":764},{"type":18,"tag":185,"props":4832,"children":4833},{"style":435},[4834],{"type":24,"value":1772},{"type":18,"tag":185,"props":4836,"children":4837},{"style":218},[4838],{"type":24,"value":1777},{"type":18,"tag":185,"props":4840,"children":4841},{"class":187,"line":1080},[4842,4847,4851,4855],{"type":18,"tag":185,"props":4843,"children":4844},{"style":742},[4845],{"type":24,"value":4846},"    ECS_CLUSTER",{"type":18,"tag":185,"props":4848,"children":4849},{"style":249},[4850],{"type":24,"value":764},{"type":18,"tag":185,"props":4852,"children":4853},{"style":435},[4854],{"type":24,"value":4262},{"type":18,"tag":185,"props":4856,"children":4857},{"style":218},[4858],{"type":24,"value":4859}," FargateECSCluster.Arn\n",{"type":18,"tag":185,"props":4861,"children":4862},{"class":187,"line":1098},[4863,4868,4872,4876],{"type":18,"tag":185,"props":4864,"children":4865},{"style":742},[4866],{"type":24,"value":4867},"    ECS_TASK_ARN",{"type":18,"tag":185,"props":4869,"children":4870},{"style":249},[4871],{"type":24,"value":764},{"type":18,"tag":185,"props":4873,"children":4874},{"style":435},[4875],{"type":24,"value":1772},{"type":18,"tag":185,"props":4877,"children":4878},{"style":218},[4879],{"type":24,"value":4880}," FargateECSTaskDefinition\n",{"type":18,"tag":185,"props":4882,"children":4883},{"class":187,"line":1111},[4884,4889,4893,4897],{"type":18,"tag":185,"props":4885,"children":4886},{"style":742},[4887],{"type":24,"value":4888},"    ECS_SUBNET",{"type":18,"tag":185,"props":4890,"children":4891},{"style":249},[4892],{"type":24,"value":764},{"type":18,"tag":185,"props":4894,"children":4895},{"style":435},[4896],{"type":24,"value":1772},{"type":18,"tag":185,"props":4898,"children":4899},{"style":218},[4900],{"type":24,"value":3731},{"type":18,"tag":185,"props":4902,"children":4903},{"class":187,"line":1128},[4904,4909,4913,4917],{"type":18,"tag":185,"props":4905,"children":4906},{"style":742},[4907],{"type":24,"value":4908},"    ECS_SEC_GROUP",{"type":18,"tag":185,"props":4910,"children":4911},{"style":249},[4912],{"type":24,"value":764},{"type":18,"tag":185,"props":4914,"children":4915},{"style":435},[4916],{"type":24,"value":1772},{"type":18,"tag":185,"props":4918,"children":4919},{"style":218},[4920],{"type":24,"value":4921}," FargateSG\n",{"type":18,"tag":185,"props":4923,"children":4924},{"class":187,"line":1136},[4925,4930,4934],{"type":18,"tag":185,"props":4926,"children":4927},{"style":742},[4928],{"type":24,"value":4929},"    CONTAINER_NAME",{"type":18,"tag":185,"props":4931,"children":4932},{"style":249},[4933],{"type":24,"value":764},{"type":18,"tag":185,"props":4935,"children":4936},{"style":218},[4937],{"type":24,"value":4938},"\"scraper_container\"\n",{"type":18,"tag":185,"props":4940,"children":4941},{"class":187,"line":1145},[4942],{"type":18,"tag":185,"props":4943,"children":4944},{"emptyLinePlaceholder":981},[4945],{"type":24,"value":984},{"type":18,"tag":185,"props":4947,"children":4948},{"class":187,"line":1154},[4949,4954],{"type":18,"tag":185,"props":4950,"children":4951},{"style":742},[4952],{"type":24,"value":4953},"  iamRoleStatements",{"type":18,"tag":185,"props":4955,"children":4956},{"style":249},[4957],{"type":24,"value":750},{"type":18,"tag":185,"props":4959,"children":4960},{"class":187,"line":1167},[4961,4965,4969,4973],{"type":18,"tag":185,"props":4962,"children":4963},{"style":249},[4964],{"type":24,"value":1186},{"type":18,"tag":185,"props":4966,"children":4967},{"style":742},[4968],{"type":24,"value":1802},{"type":18,"tag":185,"props":4970,"children":4971},{"style":249},[4972],{"type":24,"value":764},{"type":18,"tag":185,"props":4974,"children":4975},{"style":218},[4976],{"type":24,"value":1811},{"type":18,"tag":185,"props":4978,"children":4979},{"class":187,"line":1180},[4980,4985],{"type":18,"tag":185,"props":4981,"children":4982},{"style":742},[4983],{"type":24,"value":4984},"      Action",{"type":18,"tag":185,"props":4986,"children":4987},{"style":249},[4988],{"type":24,"value":750},{"type":18,"tag":185,"props":4990,"children":4991},{"class":187,"line":1194},[4992,4996],{"type":18,"tag":185,"props":4993,"children":4994},{"style":249},[4995],{"type":24,"value":1797},{"type":18,"tag":185,"props":4997,"children":4998},{"style":218},[4999],{"type":24,"value":1836},{"type":18,"tag":185,"props":5001,"children":5002},{"class":187,"line":1207},[5003,5008,5012],{"type":18,"tag":185,"props":5004,"children":5005},{"style":742},[5006],{"type":24,"value":5007},"      Resource",{"type":18,"tag":185,"props":5009,"children":5010},{"style":249},[5011],{"type":24,"value":764},{"type":18,"tag":185,"props":5013,"children":5014},{"style":435},[5015],{"type":24,"value":1853},{"type":18,"tag":185,"props":5017,"children":5018},{"class":187,"line":1220},[5019,5023],{"type":18,"tag":185,"props":5020,"children":5021},{"style":249},[5022],{"type":24,"value":1797},{"type":18,"tag":185,"props":5024,"children":5025},{"style":218},[5026],{"type":24,"value":1865},{"type":18,"tag":185,"props":5028,"children":5029},{"class":187,"line":1233},[5030,5034,5038,5042,5046],{"type":18,"tag":185,"props":5031,"children":5032},{"style":249},[5033],{"type":24,"value":1797},{"type":18,"tag":185,"props":5035,"children":5036},{"style":742},[5037],{"type":24,"value":1877},{"type":18,"tag":185,"props":5039,"children":5040},{"style":249},[5041],{"type":24,"value":764},{"type":18,"tag":185,"props":5043,"children":5044},{"style":435},[5045],{"type":24,"value":1772},{"type":18,"tag":185,"props":5047,"children":5048},{"style":218},[5049],{"type":24,"value":1777},{"type":18,"tag":185,"props":5051,"children":5052},{"class":187,"line":1246},[5053],{"type":18,"tag":185,"props":5054,"children":5055},{"emptyLinePlaceholder":981},[5056],{"type":24,"value":984},{"type":18,"tag":185,"props":5058,"children":5059},{"class":187,"line":1259},[5060,5064,5068,5072],{"type":18,"tag":185,"props":5061,"children":5062},{"style":249},[5063],{"type":24,"value":1186},{"type":18,"tag":185,"props":5065,"children":5066},{"style":742},[5067],{"type":24,"value":1802},{"type":18,"tag":185,"props":5069,"children":5070},{"style":249},[5071],{"type":24,"value":764},{"type":18,"tag":185,"props":5073,"children":5074},{"style":218},[5075],{"type":24,"value":2533},{"type":18,"tag":185,"props":5077,"children":5078},{"class":187,"line":1267},[5079,5083],{"type":18,"tag":185,"props":5080,"children":5081},{"style":742},[5082],{"type":24,"value":4984},{"type":18,"tag":185,"props":5084,"children":5085},{"style":249},[5086],{"type":24,"value":750},{"type":18,"tag":185,"props":5088,"children":5089},{"class":187,"line":1280},[5090,5094],{"type":18,"tag":185,"props":5091,"children":5092},{"style":249},[5093],{"type":24,"value":1797},{"type":18,"tag":185,"props":5095,"children":5096},{"style":218},[5097],{"type":24,"value":5098},"ecs:RunTask\n",{"type":18,"tag":185,"props":5100,"children":5101},{"class":187,"line":1294},[5102,5106],{"type":18,"tag":185,"props":5103,"children":5104},{"style":742},[5105],{"type":24,"value":5007},{"type":18,"tag":185,"props":5107,"children":5108},{"style":249},[5109],{"type":24,"value":750},{"type":18,"tag":185,"props":5111,"children":5112},{"class":187,"line":1302},[5113,5117,5121],{"type":18,"tag":185,"props":5114,"children":5115},{"style":249},[5116],{"type":24,"value":1797},{"type":18,"tag":185,"props":5118,"children":5119},{"style":435},[5120],{"type":24,"value":1772},{"type":18,"tag":185,"props":5122,"children":5123},{"style":218},[5124],{"type":24,"value":4880},{"type":18,"tag":185,"props":5126,"children":5127},{"class":187,"line":1315},[5128,5132,5136,5140],{"type":18,"tag":185,"props":5129,"children":5130},{"style":249},[5131],{"type":24,"value":1186},{"type":18,"tag":185,"props":5133,"children":5134},{"style":742},[5135],{"type":24,"value":1802},{"type":18,"tag":185,"props":5137,"children":5138},{"style":249},[5139],{"type":24,"value":764},{"type":18,"tag":185,"props":5141,"children":5142},{"style":218},[5143],{"type":24,"value":2533},{"type":18,"tag":185,"props":5145,"children":5146},{"class":187,"line":1328},[5147,5151],{"type":18,"tag":185,"props":5148,"children":5149},{"style":742},[5150],{"type":24,"value":4984},{"type":18,"tag":185,"props":5152,"children":5153},{"style":249},[5154],{"type":24,"value":750},{"type":18,"tag":185,"props":5156,"children":5157},{"class":187,"line":1351},[5158,5162],{"type":18,"tag":185,"props":5159,"children":5160},{"style":249},[5161],{"type":24,"value":1797},{"type":18,"tag":185,"props":5163,"children":5164},{"style":218},[5165],{"type":24,"value":5166},"iam:PassRole\n",{"type":18,"tag":185,"props":5168,"children":5169},{"class":187,"line":2691},[5170,5174],{"type":18,"tag":185,"props":5171,"children":5172},{"style":742},[5173],{"type":24,"value":5007},{"type":18,"tag":185,"props":5175,"children":5176},{"style":249},[5177],{"type":24,"value":750},{"type":18,"tag":185,"props":5179,"children":5180},{"class":187,"line":2704},[5181,5185,5189],{"type":18,"tag":185,"props":5182,"children":5183},{"style":249},[5184],{"type":24,"value":1797},{"type":18,"tag":185,"props":5186,"children":5187},{"style":435},[5188],{"type":24,"value":4262},{"type":18,"tag":185,"props":5190,"children":5191},{"style":218},[5192],{"type":24,"value":4267},{"type":18,"tag":185,"props":5194,"children":5195},{"class":187,"line":2717},[5196,5200,5204,5208],{"type":18,"tag":185,"props":5197,"children":5198},{"style":249},[5199],{"type":24,"value":1186},{"type":18,"tag":185,"props":5201,"children":5202},{"style":742},[5203],{"type":24,"value":1802},{"type":18,"tag":185,"props":5205,"children":5206},{"style":249},[5207],{"type":24,"value":764},{"type":18,"tag":185,"props":5209,"children":5210},{"style":218},[5211],{"type":24,"value":2533},{"type":18,"tag":185,"props":5213,"children":5214},{"class":187,"line":2734},[5215,5219],{"type":18,"tag":185,"props":5216,"children":5217},{"style":742},[5218],{"type":24,"value":4984},{"type":18,"tag":185,"props":5220,"children":5221},{"style":249},[5222],{"type":24,"value":750},{"type":18,"tag":185,"props":5224,"children":5225},{"class":187,"line":2746},[5226,5230],{"type":18,"tag":185,"props":5227,"children":5228},{"style":249},[5229],{"type":24,"value":1797},{"type":18,"tag":185,"props":5231,"children":5232},{"style":218},[5233],{"type":24,"value":5166},{"type":18,"tag":185,"props":5235,"children":5236},{"class":187,"line":2770},[5237,5241],{"type":18,"tag":185,"props":5238,"children":5239},{"style":742},[5240],{"type":24,"value":5007},{"type":18,"tag":185,"props":5242,"children":5243},{"style":249},[5244],{"type":24,"value":750},{"type":18,"tag":185,"props":5246,"children":5247},{"class":187,"line":2778},[5248,5252,5256],{"type":18,"tag":185,"props":5249,"children":5250},{"style":249},[5251],{"type":24,"value":1797},{"type":18,"tag":185,"props":5253,"children":5254},{"style":435},[5255],{"type":24,"value":4262},{"type":18,"tag":185,"props":5257,"children":5258},{"style":218},[5259],{"type":24,"value":4289},{"type":18,"tag":185,"props":5261,"children":5262},{"class":187,"line":2791},[5263],{"type":18,"tag":185,"props":5264,"children":5265},{"emptyLinePlaceholder":981},[5266],{"type":24,"value":984},{"type":18,"tag":185,"props":5268,"children":5269},{"class":187,"line":2807},[5270,5274],{"type":18,"tag":185,"props":5271,"children":5272},{"style":742},[5273],{"type":24,"value":1060},{"type":18,"tag":185,"props":5275,"children":5276},{"style":249},[5277],{"type":24,"value":750},{"type":18,"tag":185,"props":5279,"children":5280},{"class":187,"line":2819},[5281,5285],{"type":18,"tag":185,"props":5282,"children":5283},{"style":742},[5284],{"type":24,"value":1073},{"type":18,"tag":185,"props":5286,"children":5287},{"style":249},[5288],{"type":24,"value":750},{"type":18,"tag":185,"props":5290,"children":5291},{"class":187,"line":2832},[5292,5296,5300],{"type":18,"tag":185,"props":5293,"children":5294},{"style":742},[5295],{"type":24,"value":1086},{"type":18,"tag":185,"props":5297,"children":5298},{"style":249},[5299],{"type":24,"value":764},{"type":18,"tag":185,"props":5301,"children":5302},{"style":218},[5303],{"type":24,"value":1095},{"type":18,"tag":185,"props":5305,"children":5306},{"class":187,"line":2845},[5307,5311],{"type":18,"tag":185,"props":5308,"children":5309},{"style":742},[5310],{"type":24,"value":1104},{"type":18,"tag":185,"props":5312,"children":5313},{"style":249},[5314],{"type":24,"value":750},{"type":18,"tag":185,"props":5316,"children":5317},{"class":187,"line":2857},[5318,5322,5326],{"type":18,"tag":185,"props":5319,"children":5320},{"style":742},[5321],{"type":24,"value":1086},{"type":18,"tag":185,"props":5323,"children":5324},{"style":249},[5325],{"type":24,"value":764},{"type":18,"tag":185,"props":5327,"children":5328},{"style":218},[5329],{"type":24,"value":1125},{"type":18,"tag":185,"props":5331,"children":5332},{"class":187,"line":2873},[5333,5338],{"type":18,"tag":185,"props":5334,"children":5335},{"style":742},[5336],{"type":24,"value":5337},"  fargateScrape",{"type":18,"tag":185,"props":5339,"children":5340},{"style":249},[5341],{"type":24,"value":750},{"type":18,"tag":185,"props":5343,"children":5344},{"class":187,"line":2885},[5345,5349,5353],{"type":18,"tag":185,"props":5346,"children":5347},{"style":742},[5348],{"type":24,"value":1086},{"type":18,"tag":185,"props":5350,"children":5351},{"style":249},[5352],{"type":24,"value":764},{"type":18,"tag":185,"props":5354,"children":5355},{"style":218},[5356],{"type":24,"value":5357},"launch_fargate.launch_fargate\n",{"type":18,"tag":185,"props":5359,"children":5360},{"class":187,"line":2905},[5361],{"type":18,"tag":185,"props":5362,"children":5363},{"emptyLinePlaceholder":981},[5364],{"type":24,"value":984},{"type":18,"tag":185,"props":5366,"children":5367},{"class":187,"line":2921},[5368],{"type":18,"tag":185,"props":5369,"children":5370},{"style":204},[5371],{"type":24,"value":1142},{"type":18,"tag":185,"props":5373,"children":5374},{"class":187,"line":2933},[5375],{"type":18,"tag":185,"props":5376,"children":5377},{"style":204},[5378],{"type":24,"value":1151},{"type":18,"tag":185,"props":5380,"children":5381},{"class":187,"line":2945},[5382,5386],{"type":18,"tag":185,"props":5383,"children":5384},{"style":742},[5385],{"type":24,"value":1160},{"type":18,"tag":185,"props":5387,"children":5388},{"style":249},[5389],{"type":24,"value":750},{"type":18,"tag":185,"props":5391,"children":5392},{"class":187,"line":2957},[5393,5397],{"type":18,"tag":185,"props":5394,"children":5395},{"style":742},[5396],{"type":24,"value":1173},{"type":18,"tag":185,"props":5398,"children":5399},{"style":249},[5400],{"type":24,"value":750},{"type":18,"tag":185,"props":5402,"children":5403},{"class":187,"line":2969},[5404,5408],{"type":18,"tag":185,"props":5405,"children":5406},{"style":249},[5407],{"type":24,"value":1186},{"type":18,"tag":185,"props":5409,"children":5410},{"style":218},[5411],{"type":24,"value":1191},{"type":18,"tag":185,"props":5413,"children":5414},{"class":187,"line":2981},[5415,5419],{"type":18,"tag":185,"props":5416,"children":5417},{"style":249},[5418],{"type":24,"value":1186},{"type":18,"tag":185,"props":5420,"children":5421},{"style":218},[5422],{"type":24,"value":1204},{"type":18,"tag":185,"props":5424,"children":5425},{"class":187,"line":2989},[5426,5430],{"type":18,"tag":185,"props":5427,"children":5428},{"style":249},[5429],{"type":24,"value":1186},{"type":18,"tag":185,"props":5431,"children":5432},{"style":218},[5433],{"type":24,"value":5434},"launch_fargate.py\n",{"type":18,"tag":185,"props":5436,"children":5437},{"class":187,"line":3002},[5438,5442],{"type":18,"tag":185,"props":5439,"children":5440},{"style":249},[5441],{"type":24,"value":1186},{"type":18,"tag":185,"props":5443,"children":5444},{"style":218},[5445],{"type":24,"value":1217},{"type":18,"tag":185,"props":5447,"children":5448},{"class":187,"line":3019},[5449,5453],{"type":18,"tag":185,"props":5450,"children":5451},{"style":249},[5452],{"type":24,"value":1186},{"type":18,"tag":185,"props":5454,"children":5455},{"style":218},[5456],{"type":24,"value":1230},{"type":18,"tag":185,"props":5458,"children":5459},{"class":187,"line":3031},[5460,5464],{"type":18,"tag":185,"props":5461,"children":5462},{"style":742},[5463],{"type":24,"value":1239},{"type":18,"tag":185,"props":5465,"children":5466},{"style":249},[5467],{"type":24,"value":750},{"type":18,"tag":185,"props":5469,"children":5470},{"class":187,"line":3049},[5471,5475],{"type":18,"tag":185,"props":5472,"children":5473},{"style":249},[5474],{"type":24,"value":1186},{"type":18,"tag":185,"props":5476,"children":5477},{"style":218},[5478],{"type":24,"value":1256},{"type":18,"tag":185,"props":5480,"children":5481},{"class":187,"line":3062},[5482],{"type":18,"tag":185,"props":5483,"children":5484},{"emptyLinePlaceholder":981},[5485],{"type":24,"value":984},{"type":18,"tag":185,"props":5487,"children":5488},{"class":187,"line":3084},[5489,5493],{"type":18,"tag":185,"props":5490,"children":5491},{"style":742},[5492],{"type":24,"value":1904},{"type":18,"tag":185,"props":5494,"children":5495},{"style":249},[5496],{"type":24,"value":750},{"type":18,"tag":185,"props":5498,"children":5499},{"class":187,"line":3105},[5500,5504,5508,5512],{"type":18,"tag":185,"props":5501,"children":5502},{"style":249},[5503],{"type":24,"value":1286},{"type":18,"tag":185,"props":5505,"children":5506},{"style":742},[5507],{"type":24,"value":1920},{"type":18,"tag":185,"props":5509,"children":5510},{"style":249},[5511],{"type":24,"value":764},{"type":18,"tag":185,"props":5513,"children":5514},{"style":218},[5515],{"type":24,"value":1929},{"type":18,"tag":185,"props":5517,"children":5518},{"class":187,"line":3118},[5519,5523,5527],{"type":18,"tag":185,"props":5520,"children":5521},{"style":742},[5522],{"type":24,"value":1937},{"type":18,"tag":185,"props":5524,"children":5525},{"style":249},[5526],{"type":24,"value":764},{"type":18,"tag":185,"props":5528,"children":5529},{"style":218},[5530],{"type":24,"value":1946},{"type":18,"tag":185,"props":5532,"children":5533},{"class":187,"line":3135},[5534,5538],{"type":18,"tag":185,"props":5535,"children":5536},{"style":249},[5537],{"type":24,"value":1286},{"type":18,"tag":185,"props":5539,"children":5540},{"style":218},[5541],{"type":24,"value":1958},{"type":18,"tag":185,"props":5543,"children":5544},{"class":187,"line":3147},[5545,5549],{"type":18,"tag":185,"props":5546,"children":5547},{"style":249},[5548],{"type":24,"value":1286},{"type":18,"tag":185,"props":5550,"children":5551},{"style":218},[5552],{"type":24,"value":5553},"${file(./fargate-template.yml)}\n",{"type":18,"tag":185,"props":5555,"children":5556},{"class":187,"line":3163},[5557],{"type":18,"tag":185,"props":5558,"children":5559},{"emptyLinePlaceholder":981},[5560],{"type":24,"value":984},{"type":18,"tag":185,"props":5562,"children":5563},{"class":187,"line":3185},[5564,5568],{"type":18,"tag":185,"props":5565,"children":5566},{"style":742},[5567],{"type":24,"value":1273},{"type":18,"tag":185,"props":5569,"children":5570},{"style":249},[5571],{"type":24,"value":750},{"type":18,"tag":185,"props":5573,"children":5574},{"class":187,"line":3197},[5575,5579],{"type":18,"tag":185,"props":5576,"children":5577},{"style":249},[5578],{"type":24,"value":1286},{"type":18,"tag":185,"props":5580,"children":5581},{"style":218},[5582],{"type":24,"value":1291},{"type":18,"tag":185,"props":5584,"children":5585},{"class":187,"line":3217},[5586,5590],{"type":18,"tag":185,"props":5587,"children":5588},{"style":249},[5589],{"type":24,"value":1286},{"type":18,"tag":185,"props":5591,"children":5592},{"style":218},[5593],{"type":24,"value":5594},"serverless-cloudformation-sub-variables\n",{"type":18,"tag":185,"props":5596,"children":5597},{"class":187,"line":3237},[5598,5602],{"type":18,"tag":185,"props":5599,"children":5600},{"style":742},[5601],{"type":24,"value":1308},{"type":18,"tag":185,"props":5603,"children":5604},{"style":249},[5605],{"type":24,"value":750},{"type":18,"tag":185,"props":5607,"children":5608},{"class":187,"line":3250},[5609,5613],{"type":18,"tag":185,"props":5610,"children":5611},{"style":742},[5612],{"type":24,"value":1321},{"type":18,"tag":185,"props":5614,"children":5615},{"style":249},[5616],{"type":24,"value":750},{"type":18,"tag":185,"props":5618,"children":5619},{"class":187,"line":3267},[5620,5624,5628,5632],{"type":18,"tag":185,"props":5621,"children":5622},{"style":742},[5623],{"type":24,"value":1334},{"type":18,"tag":185,"props":5625,"children":5626},{"style":249},[5627],{"type":24,"value":764},{"type":18,"tag":185,"props":5629,"children":5630},{"style":198},[5631],{"type":24,"value":1343},{"type":18,"tag":185,"props":5633,"children":5634},{"style":204},[5635],{"type":24,"value":1348},{"type":18,"tag":185,"props":5637,"children":5638},{"class":187,"line":3279},[5639,5643,5647],{"type":18,"tag":185,"props":5640,"children":5641},{"style":742},[5642],{"type":24,"value":1357},{"type":18,"tag":185,"props":5644,"children":5645},{"style":249},[5646],{"type":24,"value":764},{"type":18,"tag":185,"props":5648,"children":5649},{"style":218},[5650],{"type":24,"value":1366},{"type":18,"tag":27,"props":5652,"children":5653},{},[5654],{"type":24,"value":5655},"Once again we'll deploy and make a test run with",{"type":18,"tag":174,"props":5657,"children":5659},{"code":5658,"language":177,"meta":10,"className":178,"style":10},"sls deploy -v\nsls invoke -f fargateScrape --log\n",[5660],{"type":18,"tag":181,"props":5661,"children":5662},{"__ignoreMap":10},[5663,5678],{"type":18,"tag":185,"props":5664,"children":5665},{"class":187,"line":188},[5666,5670,5674],{"type":18,"tag":185,"props":5667,"children":5668},{"style":192},[5669],{"type":24,"value":636},{"type":18,"tag":185,"props":5671,"children":5672},{"style":218},[5673],{"type":24,"value":641},{"type":18,"tag":185,"props":5675,"children":5676},{"style":198},[5677],{"type":24,"value":2049},{"type":18,"tag":185,"props":5679,"children":5680},{"class":187,"line":210},[5681,5685,5689,5693,5698],{"type":18,"tag":185,"props":5682,"children":5683},{"style":192},[5684],{"type":24,"value":636},{"type":18,"tag":185,"props":5686,"children":5687},{"style":218},[5688],{"type":24,"value":864},{"type":18,"tag":185,"props":5690,"children":5691},{"style":198},[5692],{"type":24,"value":646},{"type":18,"tag":185,"props":5694,"children":5695},{"style":218},[5696],{"type":24,"value":5697}," fargateScrape",{"type":18,"tag":185,"props":5699,"children":5700},{"style":198},[5701],{"type":24,"value":877},{"type":18,"tag":27,"props":5703,"children":5704},{},[5705,5707,5714,5716,5723,5725,5731,5733,5739],{"type":24,"value":5706},"The function should execute, but the Fargate task will fail, as we haven't uploaded our Docker image to the repository we created.\nYou can look at what we created in the ",{"type":18,"tag":33,"props":5708,"children":5711},{"href":5709,"rel":5710},"https://console.aws.amazon.com/ecs/home",[37],[5712],{"type":24,"value":5713},"ECS console",{"type":24,"value":5715}," and the ",{"type":18,"tag":33,"props":5717,"children":5720},{"href":5718,"rel":5719},"https://console.aws.amazon.com/vpc/home",[37],[5721],{"type":24,"value":5722},"VPC console",{"type":24,"value":5724},". You can see the failed task we started on ",{"type":18,"tag":33,"props":5726,"children":5729},{"href":5727,"rel":5728},"https://console.aws.amazon.com/ecs/home?region=us-east-1#/clusters/fargate-my-sls-scraper-dev/tasks",[37],[5730],{"type":24,"value":5727},{"type":24,"value":5732}," if you toggle ",{"type":18,"tag":5734,"props":5735,"children":5736},"strong",{},[5737],{"type":24,"value":5738},"Stopped",{"type":24,"value":5740}," and change regions if you're not in the default us-east-1.",{"type":18,"tag":27,"props":5742,"children":5743},{},[5744,5746,5751],{"type":24,"value":5745},"The final piece in the puzzle is to upload the container image, so let's create a ",{"type":18,"tag":149,"props":5747,"children":5748},{},[5749],{"type":24,"value":5750},"Makefile",{"type":24,"value":5752}," to make it easy to update it in the future. Maybe you need to change the variables according to your setup.",{"type":18,"tag":174,"props":5754,"children":5758},{"code":5755,"language":5756,"meta":10,"className":5757,"style":10},"# Makefile\nSTACKNAME_BASE=\"my-sls-scraper-dev\"\n# This is a region that supports AWS Fargate\nREGION=\"us-east-1\"\nPROFILE=\"my-sls-admin\"\nIMAGE_NAME=\"my_sls_scraper\"\n\nbuild:\n    docker build -t $(IMAGE_NAME):latest .\n\nretag:\n    docker tag $(IMAGE_NAME):latest \\\n        $(shell aws cloudformation --region $(REGION) --profile $(PROFILE) describe-stacks --stack-name $(STACKNAME_BASE) --query \"Stacks[0].Outputs[?OutputKey=='ECRRepo'].OutputValue\" --output text):latest\n    @exec $(shell aws ecr --region $(REGION) --profile $(PROFILE) get-login --no-include-email)\n    docker push $(shell aws cloudformation --region $(REGION) --profile $(PROFILE) describe-stacks --stack-name $(STACKNAME_BASE) --query \"Stacks[0].Outputs[?OutputKey=='ECRRepo'].OutputValue\" --output text):latest\n","makefile","language-makefile",[5759],{"type":18,"tag":181,"props":5760,"children":5761},{"__ignoreMap":10},[5762],{"type":24,"value":5755},{"type":18,"tag":27,"props":5764,"children":5765},{},[5766],{"type":24,"value":5767},"We've already build the image, so we just need to upload it with",{"type":18,"tag":174,"props":5769,"children":5771},{"code":5770,"language":177,"meta":10,"className":178,"style":10},"make retag\n",[5772],{"type":18,"tag":181,"props":5773,"children":5774},{"__ignoreMap":10},[5775],{"type":18,"tag":185,"props":5776,"children":5777},{"class":187,"line":188},[5778,5782],{"type":18,"tag":185,"props":5779,"children":5780},{"style":192},[5781],{"type":24,"value":121},{"type":18,"tag":185,"props":5783,"children":5784},{"style":218},[5785],{"type":24,"value":5786}," retag\n",{"type":18,"tag":27,"props":5788,"children":5789},{},[5790],{"type":24,"value":5791},"The first time pushing, this might take some time depending on how fast your internet connection is.\nYou should see an output similar to",{"type":18,"tag":174,"props":5793,"children":5795},{"code":5794},"18:17 $ make retag\ndocker tag \"my_sls_scraper\":latest \\\n    459015585648.dkr.ecr.us-east-1.amazonaws.com/my-sl-farga-afj2n785due0:latest\nLogin Succeeded\ndocker push 459015585648.dkr.ecr.us-east-1.amazonaws.com/my-sl-farga-afj2n785due0:latest\nThe push refers to a repository [459015585648.dkr.ecr.us-east-1.amazonaws.com/my-sl-farga-afj2n785due0]\n6b325179a37f: Pushed\n7c486f7d4e0e: Pushed\n5a14878ee86f: Pushed\nfb71908672f7: Pushed\nc028dbad8bfd: Pushed\n424cdf061e9d: Pushed\nbd648e09c386: Pushed\n69d95271719a: Pushed\nf88be44e4bd8: Pushed\ne505c7600391: Pushed\n4d2fd1bf072c: Pushed\n6e302bbcacce: Pushed\n97e8dd85db4e: Pushed\n74e2ede3b29c: Pushed\n6d5a64ea8f37: Pushed\n660314270d76: Pushed\nlatest: digest: sha256:f64c0ed0e5296b03645e5aed927b3af1d75faa226382ac389651519a0b14381c size: 3678\n",[5796],{"type":18,"tag":181,"props":5797,"children":5798},{"__ignoreMap":10},[5799],{"type":24,"value":5794},{"type":18,"tag":27,"props":5801,"children":5802},{},[5803],{"type":24,"value":5804},"and, if successful, it should be possible to scrape in Fargate by just invoking a Lambda function. Try it with",{"type":18,"tag":174,"props":5806,"children":5808},{"code":5807,"language":177,"meta":10,"className":178,"style":10},"sls invoke -f fargateScrape --log\n",[5809],{"type":18,"tag":181,"props":5810,"children":5811},{"__ignoreMap":10},[5812],{"type":18,"tag":185,"props":5813,"children":5814},{"class":187,"line":188},[5815,5819,5823,5827,5831],{"type":18,"tag":185,"props":5816,"children":5817},{"style":192},[5818],{"type":24,"value":636},{"type":18,"tag":185,"props":5820,"children":5821},{"style":218},[5822],{"type":24,"value":864},{"type":18,"tag":185,"props":5824,"children":5825},{"style":198},[5826],{"type":24,"value":646},{"type":18,"tag":185,"props":5828,"children":5829},{"style":218},[5830],{"type":24,"value":5697},{"type":18,"tag":185,"props":5832,"children":5833},{"style":198},[5834],{"type":24,"value":877},{"type":18,"tag":27,"props":5836,"children":5837},{},[5838,5840,5847],{"type":24,"value":5839},"It should execute successfully and exit. The logs of the crawler comes from our Fargate task and not the Lambda function, and can be seen in the ",{"type":18,"tag":33,"props":5841,"children":5844},{"href":5842,"rel":5843},"https://console.aws.amazon.com/cloudwatch/home?region=us-east-1#logs:",[37],[5845],{"type":24,"value":5846},"CloudWatch console",{"type":24,"value":74},{"type":18,"tag":27,"props":5849,"children":5850},{},[5851],{"type":24,"value":5852},"Well done if you've made it thus far. We've made the basics of a quite sophisticated scraping infrastructure with a lot of potential. The last steps from here are optional.\nWe will set up an S3 bucket for caching responses, and in the end we'll use AWS CloudWatch to schedule automatic crawls and discuss some methods to better automate and control crawl scheduling.",{"type":18,"tag":19,"props":5854,"children":5856},{"id":5855},"using-s3-as-http-cache",[5857],{"type":24,"value":5858},"Using S3 as HTTP cache",{"type":18,"tag":27,"props":5860,"children":5861},{},[5862],{"type":24,"value":5863},"Caching responses from our spider is good for faster crawls and to avoid getting banned, as well as a store of html responses that can be used for things like machine learning further down the data processing pipeline.\nScrapy comes with a file storage caching system by default, but because of the framework's great extensibility, we can quite easily make our own cache handler. Using persistent file storage is not possible in Lambda or Fargate, so we have to use an object storage like S3 or a database. We will use S3 because it's relatively easy to set up and maintain.",{"type":18,"tag":27,"props":5865,"children":5866},{},[5867,5869,5873,5875,5880,5881,5885,5887,5891],{"type":24,"value":5868},"To do this, we first have to add a bucket to our ",{"type":18,"tag":181,"props":5870,"children":5871},{"className":10},[5872],{"type":24,"value":1600},{"type":24,"value":5874}," and add IAM role permissions to our ",{"type":18,"tag":181,"props":5876,"children":5877},{"className":10},[5878],{"type":24,"value":5879},"fargate-template.yml",{"type":24,"value":477},{"type":18,"tag":181,"props":5882,"children":5883},{"className":10},[5884],{"type":24,"value":710},{"type":24,"value":5886},", as well as an environment variable to the latter and to ",{"type":18,"tag":181,"props":5888,"children":5889},{"className":10},[5890],{"type":24,"value":4705},{"type":24,"value":74},{"type":18,"tag":27,"props":5893,"children":5894},{},[5895],{"type":24,"value":5896},"Add an S3 bucket in the S3 template like this",{"type":18,"tag":174,"props":5898,"children":5900},{"code":5899,"language":715,"meta":10,"className":716,"style":10},"# s3-template.yml\nResources:\n  ScraperFeedBucket:\n    Type: AWS::S3::Bucket\n    Properties:\n      VersioningConfiguration:\n        Status: \"Enabled\"\n  HttpCacheBucket:\n    Type: AWS::S3::Bucket\n",[5901],{"type":18,"tag":181,"props":5902,"children":5903},{"__ignoreMap":10},[5904,5911,5922,5933,5948,5959,5970,5985,5997],{"type":18,"tag":185,"props":5905,"children":5906},{"class":187,"line":188},[5907],{"type":18,"tag":185,"props":5908,"children":5909},{"style":204},[5910],{"type":24,"value":1617},{"type":18,"tag":185,"props":5912,"children":5913},{"class":187,"line":210},[5914,5918],{"type":18,"tag":185,"props":5915,"children":5916},{"style":742},[5917],{"type":24,"value":1625},{"type":18,"tag":185,"props":5919,"children":5920},{"style":249},[5921],{"type":24,"value":750},{"type":18,"tag":185,"props":5923,"children":5924},{"class":187,"line":288},[5925,5929],{"type":18,"tag":185,"props":5926,"children":5927},{"style":742},[5928],{"type":24,"value":1637},{"type":18,"tag":185,"props":5930,"children":5931},{"style":249},[5932],{"type":24,"value":750},{"type":18,"tag":185,"props":5934,"children":5935},{"class":187,"line":753},[5936,5940,5944],{"type":18,"tag":185,"props":5937,"children":5938},{"style":742},[5939],{"type":24,"value":1649},{"type":18,"tag":185,"props":5941,"children":5942},{"style":249},[5943],{"type":24,"value":764},{"type":18,"tag":185,"props":5945,"children":5946},{"style":218},[5947],{"type":24,"value":1658},{"type":18,"tag":185,"props":5949,"children":5950},{"class":187,"line":772},[5951,5955],{"type":18,"tag":185,"props":5952,"children":5953},{"style":742},[5954],{"type":24,"value":1666},{"type":18,"tag":185,"props":5956,"children":5957},{"style":249},[5958],{"type":24,"value":750},{"type":18,"tag":185,"props":5960,"children":5961},{"class":187,"line":790},[5962,5966],{"type":18,"tag":185,"props":5963,"children":5964},{"style":742},[5965],{"type":24,"value":1678},{"type":18,"tag":185,"props":5967,"children":5968},{"style":249},[5969],{"type":24,"value":750},{"type":18,"tag":185,"props":5971,"children":5972},{"class":187,"line":808},[5973,5977,5981],{"type":18,"tag":185,"props":5974,"children":5975},{"style":742},[5976],{"type":24,"value":1690},{"type":18,"tag":185,"props":5978,"children":5979},{"style":249},[5980],{"type":24,"value":764},{"type":18,"tag":185,"props":5982,"children":5983},{"style":218},[5984],{"type":24,"value":1699},{"type":18,"tag":185,"props":5986,"children":5987},{"class":187,"line":1046},[5988,5993],{"type":18,"tag":185,"props":5989,"children":5990},{"style":742},[5991],{"type":24,"value":5992},"  HttpCacheBucket",{"type":18,"tag":185,"props":5994,"children":5995},{"style":249},[5996],{"type":24,"value":750},{"type":18,"tag":185,"props":5998,"children":5999},{"class":187,"line":1054},[6000,6004,6008],{"type":18,"tag":185,"props":6001,"children":6002},{"style":742},[6003],{"type":24,"value":1649},{"type":18,"tag":185,"props":6005,"children":6006},{"style":249},[6007],{"type":24,"value":764},{"type":18,"tag":185,"props":6009,"children":6010},{"style":218},[6011],{"type":24,"value":1658},{"type":18,"tag":27,"props":6013,"children":6014},{},[6015],{"type":24,"value":6016},"Add a policy to the Fargate template",{"type":18,"tag":174,"props":6018,"children":6020},{"code":6019,"language":715,"meta":10,"className":716,"style":10},"# fargate-template.yml\n# ...\n    FargateTaskRole:\n        Type: AWS::IAM::Role\n        Properties:\n            # ...\n            Policies:\n                - PolicyName: HttpCacheBucketPolicy\n                  PolicyDocument:\n                    Statement:\n                      - PolicyName: HttpCacheBucketPolicy\n                          PolicyDocument:\n                            Statement:\n                              - Effect: \"Allow\"\n                                Action:\n                                  - \"s3:GetObject\"\n                                  - \"s3:PutObject\"\n                                  - \"s3:ListBucket\"\n                                Resource:\n                                  - !Sub\n                                    - \"arn:aws:s3:::#{BucketName}/*\"\n                                    - BucketName: !Ref HttpCacheBucket\n                                  - !Sub\n                                    - \"arn:aws:s3:::#{BucketName}\"\n                                    - BucketName: !Ref HttpCacheBucket\n",[6021],{"type":18,"tag":181,"props":6022,"children":6023},{"__ignoreMap":10},[6024,6031,6038,6050,6066,6078,6086,6098,6118,6130,6142,6162,6174,6186,6206,6218,6231,6242,6254,6266,6277,6289,6313,6324,6336],{"type":18,"tag":185,"props":6025,"children":6026},{"class":187,"line":188},[6027],{"type":18,"tag":185,"props":6028,"children":6029},{"style":204},[6030],{"type":24,"value":2260},{"type":18,"tag":185,"props":6032,"children":6033},{"class":187,"line":210},[6034],{"type":18,"tag":185,"props":6035,"children":6036},{"style":204},[6037],{"type":24,"value":736},{"type":18,"tag":185,"props":6039,"children":6040},{"class":187,"line":288},[6041,6046],{"type":18,"tag":185,"props":6042,"children":6043},{"style":742},[6044],{"type":24,"value":6045},"    FargateTaskRole",{"type":18,"tag":185,"props":6047,"children":6048},{"style":249},[6049],{"type":24,"value":750},{"type":18,"tag":185,"props":6051,"children":6052},{"class":187,"line":753},[6053,6058,6062],{"type":18,"tag":185,"props":6054,"children":6055},{"style":742},[6056],{"type":24,"value":6057},"        Type",{"type":18,"tag":185,"props":6059,"children":6060},{"style":249},[6061],{"type":24,"value":764},{"type":18,"tag":185,"props":6063,"children":6064},{"style":218},[6065],{"type":24,"value":2460},{"type":18,"tag":185,"props":6067,"children":6068},{"class":187,"line":772},[6069,6074],{"type":18,"tag":185,"props":6070,"children":6071},{"style":742},[6072],{"type":24,"value":6073},"        Properties",{"type":18,"tag":185,"props":6075,"children":6076},{"style":249},[6077],{"type":24,"value":750},{"type":18,"tag":185,"props":6079,"children":6080},{"class":187,"line":790},[6081],{"type":18,"tag":185,"props":6082,"children":6083},{"style":204},[6084],{"type":24,"value":6085},"            # ...\n",{"type":18,"tag":185,"props":6087,"children":6088},{"class":187,"line":808},[6089,6094],{"type":18,"tag":185,"props":6090,"children":6091},{"style":742},[6092],{"type":24,"value":6093},"            Policies",{"type":18,"tag":185,"props":6095,"children":6096},{"style":249},[6097],{"type":24,"value":750},{"type":18,"tag":185,"props":6099,"children":6100},{"class":187,"line":1046},[6101,6105,6109,6113],{"type":18,"tag":185,"props":6102,"children":6103},{"style":249},[6104],{"type":24,"value":2582},{"type":18,"tag":185,"props":6106,"children":6107},{"style":742},[6108],{"type":24,"value":2636},{"type":18,"tag":185,"props":6110,"children":6111},{"style":249},[6112],{"type":24,"value":764},{"type":18,"tag":185,"props":6114,"children":6115},{"style":218},[6116],{"type":24,"value":6117},"HttpCacheBucketPolicy\n",{"type":18,"tag":185,"props":6119,"children":6120},{"class":187,"line":1054},[6121,6126],{"type":18,"tag":185,"props":6122,"children":6123},{"style":742},[6124],{"type":24,"value":6125},"                  PolicyDocument",{"type":18,"tag":185,"props":6127,"children":6128},{"style":249},[6129],{"type":24,"value":750},{"type":18,"tag":185,"props":6131,"children":6132},{"class":187,"line":1067},[6133,6138],{"type":18,"tag":185,"props":6134,"children":6135},{"style":742},[6136],{"type":24,"value":6137},"                    Statement",{"type":18,"tag":185,"props":6139,"children":6140},{"style":249},[6141],{"type":24,"value":750},{"type":18,"tag":185,"props":6143,"children":6144},{"class":187,"line":1080},[6145,6150,6154,6158],{"type":18,"tag":185,"props":6146,"children":6147},{"style":249},[6148],{"type":24,"value":6149},"                      - ",{"type":18,"tag":185,"props":6151,"children":6152},{"style":742},[6153],{"type":24,"value":2636},{"type":18,"tag":185,"props":6155,"children":6156},{"style":249},[6157],{"type":24,"value":764},{"type":18,"tag":185,"props":6159,"children":6160},{"style":218},[6161],{"type":24,"value":6117},{"type":18,"tag":185,"props":6163,"children":6164},{"class":187,"line":1098},[6165,6170],{"type":18,"tag":185,"props":6166,"children":6167},{"style":742},[6168],{"type":24,"value":6169},"                          PolicyDocument",{"type":18,"tag":185,"props":6171,"children":6172},{"style":249},[6173],{"type":24,"value":750},{"type":18,"tag":185,"props":6175,"children":6176},{"class":187,"line":1111},[6177,6182],{"type":18,"tag":185,"props":6178,"children":6179},{"style":742},[6180],{"type":24,"value":6181},"                            Statement",{"type":18,"tag":185,"props":6183,"children":6184},{"style":249},[6185],{"type":24,"value":750},{"type":18,"tag":185,"props":6187,"children":6188},{"class":187,"line":1128},[6189,6194,6198,6202],{"type":18,"tag":185,"props":6190,"children":6191},{"style":249},[6192],{"type":24,"value":6193},"                              - ",{"type":18,"tag":185,"props":6195,"children":6196},{"style":742},[6197],{"type":24,"value":1802},{"type":18,"tag":185,"props":6199,"children":6200},{"style":249},[6201],{"type":24,"value":764},{"type":18,"tag":185,"props":6203,"children":6204},{"style":218},[6205],{"type":24,"value":1811},{"type":18,"tag":185,"props":6207,"children":6208},{"class":187,"line":1136},[6209,6214],{"type":18,"tag":185,"props":6210,"children":6211},{"style":742},[6212],{"type":24,"value":6213},"                                Action",{"type":18,"tag":185,"props":6215,"children":6216},{"style":249},[6217],{"type":24,"value":750},{"type":18,"tag":185,"props":6219,"children":6220},{"class":187,"line":1145},[6221,6226],{"type":18,"tag":185,"props":6222,"children":6223},{"style":249},[6224],{"type":24,"value":6225},"                                  - ",{"type":18,"tag":185,"props":6227,"children":6228},{"style":218},[6229],{"type":24,"value":6230},"\"s3:GetObject\"\n",{"type":18,"tag":185,"props":6232,"children":6233},{"class":187,"line":1154},[6234,6238],{"type":18,"tag":185,"props":6235,"children":6236},{"style":249},[6237],{"type":24,"value":6225},{"type":18,"tag":185,"props":6239,"children":6240},{"style":218},[6241],{"type":24,"value":1836},{"type":18,"tag":185,"props":6243,"children":6244},{"class":187,"line":1167},[6245,6249],{"type":18,"tag":185,"props":6246,"children":6247},{"style":249},[6248],{"type":24,"value":6225},{"type":18,"tag":185,"props":6250,"children":6251},{"style":218},[6252],{"type":24,"value":6253},"\"s3:ListBucket\"\n",{"type":18,"tag":185,"props":6255,"children":6256},{"class":187,"line":1180},[6257,6262],{"type":18,"tag":185,"props":6258,"children":6259},{"style":742},[6260],{"type":24,"value":6261},"                                Resource",{"type":18,"tag":185,"props":6263,"children":6264},{"style":249},[6265],{"type":24,"value":750},{"type":18,"tag":185,"props":6267,"children":6268},{"class":187,"line":1194},[6269,6273],{"type":18,"tag":185,"props":6270,"children":6271},{"style":249},[6272],{"type":24,"value":6225},{"type":18,"tag":185,"props":6274,"children":6275},{"style":435},[6276],{"type":24,"value":1853},{"type":18,"tag":185,"props":6278,"children":6279},{"class":187,"line":1207},[6280,6285],{"type":18,"tag":185,"props":6281,"children":6282},{"style":249},[6283],{"type":24,"value":6284},"                                    - ",{"type":18,"tag":185,"props":6286,"children":6287},{"style":218},[6288],{"type":24,"value":1865},{"type":18,"tag":185,"props":6290,"children":6291},{"class":187,"line":1220},[6292,6296,6300,6304,6308],{"type":18,"tag":185,"props":6293,"children":6294},{"style":249},[6295],{"type":24,"value":6284},{"type":18,"tag":185,"props":6297,"children":6298},{"style":742},[6299],{"type":24,"value":1877},{"type":18,"tag":185,"props":6301,"children":6302},{"style":249},[6303],{"type":24,"value":764},{"type":18,"tag":185,"props":6305,"children":6306},{"style":435},[6307],{"type":24,"value":1772},{"type":18,"tag":185,"props":6309,"children":6310},{"style":218},[6311],{"type":24,"value":6312}," HttpCacheBucket\n",{"type":18,"tag":185,"props":6314,"children":6315},{"class":187,"line":1233},[6316,6320],{"type":18,"tag":185,"props":6317,"children":6318},{"style":249},[6319],{"type":24,"value":6225},{"type":18,"tag":185,"props":6321,"children":6322},{"style":435},[6323],{"type":24,"value":1853},{"type":18,"tag":185,"props":6325,"children":6326},{"class":187,"line":1246},[6327,6331],{"type":18,"tag":185,"props":6328,"children":6329},{"style":249},[6330],{"type":24,"value":6284},{"type":18,"tag":185,"props":6332,"children":6333},{"style":218},[6334],{"type":24,"value":6335},"\"arn:aws:s3:::#{BucketName}\"\n",{"type":18,"tag":185,"props":6337,"children":6338},{"class":187,"line":1259},[6339,6343,6347,6351,6355],{"type":18,"tag":185,"props":6340,"children":6341},{"style":249},[6342],{"type":24,"value":6284},{"type":18,"tag":185,"props":6344,"children":6345},{"style":742},[6346],{"type":24,"value":1877},{"type":18,"tag":185,"props":6348,"children":6349},{"style":249},[6350],{"type":24,"value":764},{"type":18,"tag":185,"props":6352,"children":6353},{"style":435},[6354],{"type":24,"value":1772},{"type":18,"tag":185,"props":6356,"children":6357},{"style":218},[6358],{"type":24,"value":6312},{"type":18,"tag":27,"props":6360,"children":6361},{},[6362],{"type":24,"value":6363},"and statements and env variable to our lambda functions",{"type":18,"tag":174,"props":6365,"children":6367},{"code":6366,"language":715,"meta":10,"className":716,"style":10},"# serverless.yml\nprovider:\n    # ...\n    environment:\n        HTTP_CACHE_BUCKET_NAME: !Ref HttpCacheBucket\n        # ...\n    iamRoleStatements:\n        - Effect: \"Allow\"\n          Action:\n            - \"s3:GetObject\"\n            - \"s3:PutObject\"\n            - \"s3:ListBucket\"\n          Resource:\n            - !Sub\n              - \"arn:aws:s3:::#{BucketName}/*\"\n              - BucketName: !Ref HttpCacheBucket\n            - !Sub\n              - \"arn:aws:s3:::#{BucketName}\"\n              - BucketName: !Ref HttpCacheBucket\n        # ...\n",[6368],{"type":18,"tag":181,"props":6369,"children":6370},{"__ignoreMap":10},[6371,6378,6389,6396,6407,6427,6435,6446,6465,6476,6487,6498,6509,6520,6531,6542,6565,6576,6587,6610],{"type":18,"tag":185,"props":6372,"children":6373},{"class":187,"line":188},[6374],{"type":18,"tag":185,"props":6375,"children":6376},{"style":204},[6377],{"type":24,"value":728},{"type":18,"tag":185,"props":6379,"children":6380},{"class":187,"line":210},[6381,6385],{"type":18,"tag":185,"props":6382,"children":6383},{"style":742},[6384],{"type":24,"value":745},{"type":18,"tag":185,"props":6386,"children":6387},{"style":249},[6388],{"type":24,"value":750},{"type":18,"tag":185,"props":6390,"children":6391},{"class":187,"line":288},[6392],{"type":18,"tag":185,"props":6393,"children":6394},{"style":204},[6395],{"type":24,"value":1743},{"type":18,"tag":185,"props":6397,"children":6398},{"class":187,"line":753},[6399,6403],{"type":18,"tag":185,"props":6400,"children":6401},{"style":742},[6402],{"type":24,"value":1751},{"type":18,"tag":185,"props":6404,"children":6405},{"style":249},[6406],{"type":24,"value":750},{"type":18,"tag":185,"props":6408,"children":6409},{"class":187,"line":772},[6410,6415,6419,6423],{"type":18,"tag":185,"props":6411,"children":6412},{"style":742},[6413],{"type":24,"value":6414},"        HTTP_CACHE_BUCKET_NAME",{"type":18,"tag":185,"props":6416,"children":6417},{"style":249},[6418],{"type":24,"value":764},{"type":18,"tag":185,"props":6420,"children":6421},{"style":435},[6422],{"type":24,"value":1772},{"type":18,"tag":185,"props":6424,"children":6425},{"style":218},[6426],{"type":24,"value":6312},{"type":18,"tag":185,"props":6428,"children":6429},{"class":187,"line":790},[6430],{"type":18,"tag":185,"props":6431,"children":6432},{"style":204},[6433],{"type":24,"value":6434},"        # ...\n",{"type":18,"tag":185,"props":6436,"children":6437},{"class":187,"line":808},[6438,6442],{"type":18,"tag":185,"props":6439,"children":6440},{"style":742},[6441],{"type":24,"value":1785},{"type":18,"tag":185,"props":6443,"children":6444},{"style":249},[6445],{"type":24,"value":750},{"type":18,"tag":185,"props":6447,"children":6448},{"class":187,"line":1046},[6449,6453,6457,6461],{"type":18,"tag":185,"props":6450,"children":6451},{"style":249},[6452],{"type":24,"value":1797},{"type":18,"tag":185,"props":6454,"children":6455},{"style":742},[6456],{"type":24,"value":1802},{"type":18,"tag":185,"props":6458,"children":6459},{"style":249},[6460],{"type":24,"value":764},{"type":18,"tag":185,"props":6462,"children":6463},{"style":218},[6464],{"type":24,"value":1811},{"type":18,"tag":185,"props":6466,"children":6467},{"class":187,"line":1054},[6468,6472],{"type":18,"tag":185,"props":6469,"children":6470},{"style":742},[6471],{"type":24,"value":1819},{"type":18,"tag":185,"props":6473,"children":6474},{"style":249},[6475],{"type":24,"value":750},{"type":18,"tag":185,"props":6477,"children":6478},{"class":187,"line":1067},[6479,6483],{"type":18,"tag":185,"props":6480,"children":6481},{"style":249},[6482],{"type":24,"value":1831},{"type":18,"tag":185,"props":6484,"children":6485},{"style":218},[6486],{"type":24,"value":6230},{"type":18,"tag":185,"props":6488,"children":6489},{"class":187,"line":1080},[6490,6494],{"type":18,"tag":185,"props":6491,"children":6492},{"style":249},[6493],{"type":24,"value":1831},{"type":18,"tag":185,"props":6495,"children":6496},{"style":218},[6497],{"type":24,"value":1836},{"type":18,"tag":185,"props":6499,"children":6500},{"class":187,"line":1098},[6501,6505],{"type":18,"tag":185,"props":6502,"children":6503},{"style":249},[6504],{"type":24,"value":1831},{"type":18,"tag":185,"props":6506,"children":6507},{"style":218},[6508],{"type":24,"value":6253},{"type":18,"tag":185,"props":6510,"children":6511},{"class":187,"line":1111},[6512,6516],{"type":18,"tag":185,"props":6513,"children":6514},{"style":742},[6515],{"type":24,"value":1844},{"type":18,"tag":185,"props":6517,"children":6518},{"style":249},[6519],{"type":24,"value":750},{"type":18,"tag":185,"props":6521,"children":6522},{"class":187,"line":1128},[6523,6527],{"type":18,"tag":185,"props":6524,"children":6525},{"style":249},[6526],{"type":24,"value":1831},{"type":18,"tag":185,"props":6528,"children":6529},{"style":435},[6530],{"type":24,"value":1853},{"type":18,"tag":185,"props":6532,"children":6533},{"class":187,"line":1136},[6534,6538],{"type":18,"tag":185,"props":6535,"children":6536},{"style":249},[6537],{"type":24,"value":2607},{"type":18,"tag":185,"props":6539,"children":6540},{"style":218},[6541],{"type":24,"value":1865},{"type":18,"tag":185,"props":6543,"children":6544},{"class":187,"line":1145},[6545,6549,6553,6557,6561],{"type":18,"tag":185,"props":6546,"children":6547},{"style":249},[6548],{"type":24,"value":2607},{"type":18,"tag":185,"props":6550,"children":6551},{"style":742},[6552],{"type":24,"value":1877},{"type":18,"tag":185,"props":6554,"children":6555},{"style":249},[6556],{"type":24,"value":764},{"type":18,"tag":185,"props":6558,"children":6559},{"style":435},[6560],{"type":24,"value":1772},{"type":18,"tag":185,"props":6562,"children":6563},{"style":218},[6564],{"type":24,"value":6312},{"type":18,"tag":185,"props":6566,"children":6567},{"class":187,"line":1154},[6568,6572],{"type":18,"tag":185,"props":6569,"children":6570},{"style":249},[6571],{"type":24,"value":1831},{"type":18,"tag":185,"props":6573,"children":6574},{"style":435},[6575],{"type":24,"value":1853},{"type":18,"tag":185,"props":6577,"children":6578},{"class":187,"line":1167},[6579,6583],{"type":18,"tag":185,"props":6580,"children":6581},{"style":249},[6582],{"type":24,"value":2607},{"type":18,"tag":185,"props":6584,"children":6585},{"style":218},[6586],{"type":24,"value":6335},{"type":18,"tag":185,"props":6588,"children":6589},{"class":187,"line":1180},[6590,6594,6598,6602,6606],{"type":18,"tag":185,"props":6591,"children":6592},{"style":249},[6593],{"type":24,"value":2607},{"type":18,"tag":185,"props":6595,"children":6596},{"style":742},[6597],{"type":24,"value":1877},{"type":18,"tag":185,"props":6599,"children":6600},{"style":249},[6601],{"type":24,"value":764},{"type":18,"tag":185,"props":6603,"children":6604},{"style":435},[6605],{"type":24,"value":1772},{"type":18,"tag":185,"props":6607,"children":6608},{"style":218},[6609],{"type":24,"value":6312},{"type":18,"tag":185,"props":6611,"children":6612},{"class":187,"line":1194},[6613],{"type":18,"tag":185,"props":6614,"children":6615},{"style":204},[6616],{"type":24,"value":6434},{"type":18,"tag":27,"props":6618,"children":6619},{},[6620],{"type":24,"value":6621},"and lastly pass the new env variable when launching the crawler task",{"type":18,"tag":174,"props":6623,"children":6625},{"code":6624,"language":195,"meta":10,"className":332,"style":10},"# launch_fargate.py\n# ...\n\"environment\": [\n   {\"name\": \"FEED_BUCKET_NAME\",\n       \"value\": os.environ[\"FEED_BUCKET_NAME\"]},\n   {\"name\": \"HTTP_CACHE_BUCKET_NAME\",\n       \"value\": os.environ[\"HTTP_CACHE_BUCKET_NAME\"]},\n],\n# ...\n",[6626],{"type":18,"tag":181,"props":6627,"children":6628},{"__ignoreMap":10},[6629],{"type":24,"value":6624},{"type":18,"tag":27,"props":6631,"children":6632},{},[6633,6635,6640,6642,6647,6649,6654],{"type":24,"value":6634},"To use all this configuration for some caching, we create a module with our cache implementation in the ",{"type":18,"tag":181,"props":6636,"children":6637},{"className":10},[6638],{"type":24,"value":6639},"my_sls_scraper",{"type":24,"value":6641}," folder, and don't forget to add an ",{"type":18,"tag":181,"props":6643,"children":6644},{"className":10},[6645],{"type":24,"value":6646},"__init__.py",{"type":24,"value":6648}," file in the newly created ",{"type":18,"tag":181,"props":6650,"children":6651},{"className":10},[6652],{"type":24,"value":6653},"extensions",{"type":24,"value":6655}," folder.",{"type":18,"tag":174,"props":6657,"children":6659},{"code":6658,"language":195,"meta":10,"className":332,"style":10},"# my_sls_scraper/extensions/s3cache.py\nimport boto3\nimport gzip\nimport json\nimport logging\nimport os\nfrom botocore.exceptions import ClientError\nfrom botocore.stub import Stubber\nfrom time import time\nfrom datetime import datetime\nfrom six.moves import cPickle as pickle\nfrom six.moves.urllib.parse import urlparse\nfrom scrapy.exceptions import NotConfigured\nfrom scrapy.http import Headers\nfrom scrapy.responsetypes import responsetypes\nfrom scrapy.utils.request import request_fingerprint\nfrom w3lib.http import headers_raw_to_dict, headers_dict_to_raw\n\nfrom botocore.exceptions import ClientError\nimport sys\n\nlogger = logging.getLogger(__name__)\n\n\nclass S3CacheStorage(object):\n    def __init__(self, settings):\n        urifmt = settings.get('S3CACHE_URI', '')\n        if not urifmt:\n            raise NotConfigured('S3CACHE_URI must be specified')\n\n        # Parse URI\n        u = urlparse(urifmt)\n        self.keypath_fmt = u.path[1:]\n        if not self.keypath_fmt:\n            raise NotConfigured('Could not get key path from S3CACHE_URI')\n\n        self.bucket_name = u.hostname\n        if self.bucket_name is None:\n            raise NotConfigured('Could not get bucket name from S3CACHE_URI')\n\n        self.use_gzip = settings.getbool('HTTPCACHE_GZIP')\n        self.dont_retrieve = settings.getbool('S3CACHE_DONT_RETRIEVE')\n\n        self._client = None\n        self._spider = None\n        self._keypath = None\n        self.cached_requests = []\n\n    @property\n    def _client_stubber(self):\n        return Stubber(self.client)\n\n    @property\n    def client(self):\n        \"\"\" Connect to S3 and return the connection \"\"\"\n\n        if self._client is None:\n            self._client = boto3.client('s3')\n        return self._client\n\n    @property\n    def keypath(self):\n        \"\"\" Get the keypath as specified in S3CACHE_URI \"\"\"\n        def get_uri_params(obj):\n            \"\"\"Convert an object to a dict\"\"\"\n            params = {}\n            for k in dir(obj):\n                params[k] = getattr(obj, k)\n            params['day'] = datetime.utcnow().strftime('%Y-%m-%d')\n            params['time'] = datetime.utcnow().replace(\n                microsecond=0).isoformat().replace(':', '-')\n            return params\n        if not self._keypath:\n            self._keypath = self.keypath_fmt % get_uri_params(self.spider)\n        return self._keypath\n\n    @property\n    def spider(self):\n        if not self._spider:\n            raise NotConfigured('Could not get spider! Aborting...')\n        return self._spider\n\n    def put_object_to_key(self, obj, bucket, key):\n        try:\n            obj = gzip.compress(obj) if self.use_gzip else obj\n            self.client.put_object(Body=obj, Bucket=bucket, Key=key)\n        except ClientError as e:\n            logger.warning(\n                'Failed to store cache on key {key}: {e}'.format(key=key, e=e))\n            response_code = e.response.get('Error', {}).get('Code')\n            if response_code == 'AccessDenied' or response_code == 'InvalidAccessKeyId':\n                logger.exception(\"Access denied to http cache bucket\")\n                sys.exit(1)\n\n    def get_object_from_key(self, bucket, key):\n        try:\n            response = self.client.get_object(Bucket=bucket, Key=key)\n            obj = response['Body'].read()\n            return gzip.decompress(obj) if self.use_gzip else obj\n        except ClientError as e:\n            logger.debug(\n                'Failed to retrieve cache on key {key}: {e}'.format(key=key, e=e))\n            response_code = e.response.get('Error', {}).get('Code')\n            if response_code == 'AccessDenied' or response_code == 'InvalidAccessKeyId':\n                logger.exception(\"Access denied to http cache bucket\")\n                sys.exit(1)\n\n    def open_spider(self, spider):\n        logger.debug('Using s3 cache storage in %(bucket_name)s' % {'bucket_name': self.bucket_name},\n                     extra={'spider': spider})\n        # Update spider reference\n        self._spider = spider\n\n    def close_spider(self, spider):\n        logger.info(\n            'Cache on s3 bucket {bucket} on key path {keypath}'.format(\n                bucket=self.bucket_name, keypath=self.keypath),\n            extra={'spider': spider}\n        )\n\n    def retrieve_response(self, spider, request):\n        \"\"\"Return response if present in cache, or None otherwise.\"\"\"\n        if self.dont_retrieve:\n            return\n        keyname = self._get_request_path(request)\n        keydata = self.get_object_from_key(self.bucket_name, keyname)\n        if not keydata:\n            return  # not cached\n        keydata = pickle.loads(keydata)\n        metadata = keydata['meta']\n        body = keydata['response_body']\n        rawheaders = keydata['response_headers']\n        url = metadata.get('response_url')\n        status = metadata['status']\n        headers = Headers(headers_raw_to_dict(rawheaders))\n        respcls = responsetypes.from_args(headers=headers, url=url)\n        response = respcls(url=url, headers=headers, status=status, body=body)\n        return response\n\n    def store_response(self, spider, request, response):\n        # TODO: Use a buffer instead of sending the cache files one by one\n        \"\"\"Store the given response in the cache.\"\"\"\n        keyname = self._get_request_path(request)\n        metadata = {\n            'url': request.url,\n            'method': request.method,\n            'status': response.status,\n            'response_url': response.url,\n            'timestamp': time(),\n        }\n        keydata = {\n            'meta': metadata,\n            'response_headers': headers_dict_to_raw(response.headers),\n            'response_body': response.body,\n            'request_headers': headers_dict_to_raw(request.headers),\n            'request_body': request.body\n        }\n        self.put_object_to_key(pickle.dumps(\n            keydata), self.bucket_name, keyname)\n\n    def _get_request_path(self, request):\n        key = request_fingerprint(request)\n        return '{keypath}/{key}'.format(keypath=self.keypath, key=key)\n\n",[6660],{"type":18,"tag":181,"props":6661,"children":6662},{"__ignoreMap":10},[6663],{"type":24,"value":6658},{"type":18,"tag":27,"props":6665,"children":6666},{},[6667,6669,6676],{"type":24,"value":6668},"The code is a slightly modified version of ",{"type":18,"tag":33,"props":6670,"children":6673},{"href":6671,"rel":6672},"https://github.com/heylouiz/scrapy-s3-http-cache",[37],[6674],{"type":24,"value":6675},"github.com/heylouiz/scrapy-s3-http-cache",{"type":24,"value":6677}," to work natively with AWS.",{"type":18,"tag":27,"props":6679,"children":6680},{},[6681,6683,6688],{"type":24,"value":6682},"We'll add the necessary settings in ",{"type":18,"tag":181,"props":6684,"children":6685},{"className":10},[6686],{"type":24,"value":6687},"crawl.py",{"type":24,"value":6689}," so that we can dynamically decide which cache storage to use.",{"type":18,"tag":174,"props":6691,"children":6693},{"code":6692,"language":195,"meta":10,"className":332,"style":10},"# my_sls_scraper/crawl.py\ndef crawl(settings={}, spider_name=\"header_spider\", spider_kwargs={}):\n# ...\n    if (is_in_aws() and os.getenv(\"USE_S3_CACHE\") !=  \"0\") or os.getenv(\"USE_S3_CACHE\"):\n        settings[\"HTTPCACHE_STORAGE\"] =  \"my_sls_scraper.extensions.s3cache.S3CacheStorage\"\n        settings[\"S3CACHE_URI\"] =  f\"s3://{os.environ['HTTP_CACHE_BUCKET_NAME']}/cache\"\n# ...\n",[6694],{"type":18,"tag":181,"props":6695,"children":6696},{"__ignoreMap":10},[6697],{"type":24,"value":6692},{"type":18,"tag":27,"props":6699,"children":6700},{},[6701],{"type":24,"value":6702},"Now we need to do a full deploy by both deploying with Serverless, and rebuild and upload our Docker image. Do that and launch the crawler using S3 as cache storage with",{"type":18,"tag":174,"props":6704,"children":6706},{"code":6705,"language":177,"meta":10,"className":178,"style":10},"sls deploy -v\nmake build && make retag\nsls invoke -f fargateScrape --log\n",[6707],{"type":18,"tag":181,"props":6708,"children":6709},{"__ignoreMap":10},[6710,6725,6748],{"type":18,"tag":185,"props":6711,"children":6712},{"class":187,"line":188},[6713,6717,6721],{"type":18,"tag":185,"props":6714,"children":6715},{"style":192},[6716],{"type":24,"value":636},{"type":18,"tag":185,"props":6718,"children":6719},{"style":218},[6720],{"type":24,"value":641},{"type":18,"tag":185,"props":6722,"children":6723},{"style":198},[6724],{"type":24,"value":2049},{"type":18,"tag":185,"props":6726,"children":6727},{"class":187,"line":210},[6728,6732,6736,6740,6744],{"type":18,"tag":185,"props":6729,"children":6730},{"style":192},[6731],{"type":24,"value":121},{"type":18,"tag":185,"props":6733,"children":6734},{"style":218},[6735],{"type":24,"value":2172},{"type":18,"tag":185,"props":6737,"children":6738},{"style":249},[6739],{"type":24,"value":252},{"type":18,"tag":185,"props":6741,"children":6742},{"style":192},[6743],{"type":24,"value":121},{"type":18,"tag":185,"props":6745,"children":6746},{"style":218},[6747],{"type":24,"value":5786},{"type":18,"tag":185,"props":6749,"children":6750},{"class":187,"line":288},[6751,6755,6759,6763,6767],{"type":18,"tag":185,"props":6752,"children":6753},{"style":192},[6754],{"type":24,"value":636},{"type":18,"tag":185,"props":6756,"children":6757},{"style":218},[6758],{"type":24,"value":864},{"type":18,"tag":185,"props":6760,"children":6761},{"style":198},[6762],{"type":24,"value":646},{"type":18,"tag":185,"props":6764,"children":6765},{"style":218},[6766],{"type":24,"value":5697},{"type":18,"tag":185,"props":6768,"children":6769},{"style":198},[6770],{"type":24,"value":877},{"type":18,"tag":27,"props":6772,"children":6773},{},[6774,6776,6781,6783,6788,6790,6795],{"type":24,"value":6775},"It's probably wise to run the crawler locally after ",{"type":18,"tag":181,"props":6777,"children":6778},{"className":10},[6779],{"type":24,"value":6780},"sls deploy -v",{"type":24,"value":6782}," to verify that things work as they should, so you don't need to redeploy 15 times because of various typos (talking from experience).\nRun the crawler locally after finding your cache bucket name in the ",{"type":18,"tag":33,"props":6784,"children":6786},{"href":2080,"rel":6785},[37],[6787],{"type":24,"value":2084},{"type":24,"value":6789}," (should be similar to ",{"type":18,"tag":181,"props":6791,"children":6792},{"className":10},[6793],{"type":24,"value":6794},"my-sls-scraper-dev-httpcachebucket-y2mbtieyeju3",{"type":24,"value":6796},")",{"type":18,"tag":174,"props":6798,"children":6800},{"code":6799,"language":177,"meta":10,"className":178,"style":10},"sls invoke local -f lambdaScrape --log -e USE_S3_CACHE=1 -e HTTP_CACHE_BUCKET_NAME=\u003CYOUR_CACHE_BUCKET_NAME>\n",[6801],{"type":18,"tag":181,"props":6802,"children":6803},{"__ignoreMap":10},[6804],{"type":18,"tag":185,"props":6805,"children":6806},{"class":187,"line":188},[6807,6811,6815,6820,6824,6828,6833,6838,6843,6848,6852,6857,6862,6867,6872],{"type":18,"tag":185,"props":6808,"children":6809},{"style":192},[6810],{"type":24,"value":636},{"type":18,"tag":185,"props":6812,"children":6813},{"style":218},[6814],{"type":24,"value":864},{"type":18,"tag":185,"props":6816,"children":6817},{"style":218},[6818],{"type":24,"value":6819}," local",{"type":18,"tag":185,"props":6821,"children":6822},{"style":198},[6823],{"type":24,"value":646},{"type":18,"tag":185,"props":6825,"children":6826},{"style":218},[6827],{"type":24,"value":1502},{"type":18,"tag":185,"props":6829,"children":6830},{"style":198},[6831],{"type":24,"value":6832}," --log",{"type":18,"tag":185,"props":6834,"children":6835},{"style":198},[6836],{"type":24,"value":6837}," -e",{"type":18,"tag":185,"props":6839,"children":6840},{"style":218},[6841],{"type":24,"value":6842}," USE_S3_CACHE=",{"type":18,"tag":185,"props":6844,"children":6845},{"style":198},[6846],{"type":24,"value":6847},"1",{"type":18,"tag":185,"props":6849,"children":6850},{"style":198},[6851],{"type":24,"value":6837},{"type":18,"tag":185,"props":6853,"children":6854},{"style":218},[6855],{"type":24,"value":6856}," HTTP_CACHE_BUCKET_NAME=",{"type":18,"tag":185,"props":6858,"children":6859},{"style":435},[6860],{"type":24,"value":6861},"\u003C",{"type":18,"tag":185,"props":6863,"children":6864},{"style":218},[6865],{"type":24,"value":6866},"YOUR_CACHE_BUCKET_NAM",{"type":18,"tag":185,"props":6868,"children":6869},{"style":249},[6870],{"type":24,"value":6871},"E",{"type":18,"tag":185,"props":6873,"children":6874},{"style":435},[6875],{"type":24,"value":6876},">\n",{"type":18,"tag":27,"props":6878,"children":6879},{},[6880],{"type":24,"value":6881},"You should now see objects appearing in the http cache S3 bucket as we run the crawler.",{"type":18,"tag":19,"props":6883,"children":6885},{"id":6884},"scheduling-and-configuring-crawls",[6886],{"type":24,"value":6887},"Scheduling and Configuring Crawls",{"type":18,"tag":27,"props":6889,"children":6890},{},[6891],{"type":24,"value":6892},"One of the advantages of using the AWS ecosystem is that it contains solutions for all common and uncommon tasks such as scheduling, event notifications, message queues, etc. The Serverless framework even makes some of this easy for beginners, so let's use it to schedule a weekly crawl with our spider.",{"type":18,"tag":27,"props":6894,"children":6895},{},[6896,6898,6902],{"type":24,"value":6897},"Add a key to our function config in ",{"type":18,"tag":181,"props":6899,"children":6900},{"className":10},[6901],{"type":24,"value":710},{"type":24,"value":6903}," (pay damn close attention to the indentation here, or it will not work and no warning will be given)",{"type":18,"tag":174,"props":6905,"children":6907},{"code":6906,"language":715,"meta":10,"className":716,"style":10},"# serverless.yml\n# ...\nfunctions:\n  fargateScraper:\n    handler: launch_fargate.launch_fargate\nevents:\n  - schedule:\n      rate: cron(0 6 ? * MON *)\n      enabled: true\n      description:\n        Header spider every Monday morning at 6 AM UTC\n        # The input is key-value pairs accessed in the root of the event parameter of every handler function, i.e. event.get(\"spider_name\")\n      input:\n        spider_name: header_spider\n        # ...\n",[6908],{"type":18,"tag":181,"props":6909,"children":6910},{"__ignoreMap":10},[6911,6918,6925,6936,6948,6963,6975,6991,7008,7025,7037,7045,7053,7065,7082],{"type":18,"tag":185,"props":6912,"children":6913},{"class":187,"line":188},[6914],{"type":18,"tag":185,"props":6915,"children":6916},{"style":204},[6917],{"type":24,"value":728},{"type":18,"tag":185,"props":6919,"children":6920},{"class":187,"line":210},[6921],{"type":18,"tag":185,"props":6922,"children":6923},{"style":204},[6924],{"type":24,"value":736},{"type":18,"tag":185,"props":6926,"children":6927},{"class":187,"line":288},[6928,6932],{"type":18,"tag":185,"props":6929,"children":6930},{"style":742},[6931],{"type":24,"value":1060},{"type":18,"tag":185,"props":6933,"children":6934},{"style":249},[6935],{"type":24,"value":750},{"type":18,"tag":185,"props":6937,"children":6938},{"class":187,"line":753},[6939,6944],{"type":18,"tag":185,"props":6940,"children":6941},{"style":742},[6942],{"type":24,"value":6943},"  fargateScraper",{"type":18,"tag":185,"props":6945,"children":6946},{"style":249},[6947],{"type":24,"value":750},{"type":18,"tag":185,"props":6949,"children":6950},{"class":187,"line":772},[6951,6955,6959],{"type":18,"tag":185,"props":6952,"children":6953},{"style":742},[6954],{"type":24,"value":1086},{"type":18,"tag":185,"props":6956,"children":6957},{"style":249},[6958],{"type":24,"value":764},{"type":18,"tag":185,"props":6960,"children":6961},{"style":218},[6962],{"type":24,"value":5357},{"type":18,"tag":185,"props":6964,"children":6965},{"class":187,"line":790},[6966,6971],{"type":18,"tag":185,"props":6967,"children":6968},{"style":742},[6969],{"type":24,"value":6970},"events",{"type":18,"tag":185,"props":6972,"children":6973},{"style":249},[6974],{"type":24,"value":750},{"type":18,"tag":185,"props":6976,"children":6977},{"class":187,"line":808},[6978,6982,6987],{"type":18,"tag":185,"props":6979,"children":6980},{"style":249},[6981],{"type":24,"value":1286},{"type":18,"tag":185,"props":6983,"children":6984},{"style":742},[6985],{"type":24,"value":6986},"schedule",{"type":18,"tag":185,"props":6988,"children":6989},{"style":249},[6990],{"type":24,"value":750},{"type":18,"tag":185,"props":6992,"children":6993},{"class":187,"line":1046},[6994,6999,7003],{"type":18,"tag":185,"props":6995,"children":6996},{"style":742},[6997],{"type":24,"value":6998},"      rate",{"type":18,"tag":185,"props":7000,"children":7001},{"style":249},[7002],{"type":24,"value":764},{"type":18,"tag":185,"props":7004,"children":7005},{"style":218},[7006],{"type":24,"value":7007},"cron(0 6 ? * MON *)\n",{"type":18,"tag":185,"props":7009,"children":7010},{"class":187,"line":1054},[7011,7016,7020],{"type":18,"tag":185,"props":7012,"children":7013},{"style":742},[7014],{"type":24,"value":7015},"      enabled",{"type":18,"tag":185,"props":7017,"children":7018},{"style":249},[7019],{"type":24,"value":764},{"type":18,"tag":185,"props":7021,"children":7022},{"style":198},[7023],{"type":24,"value":7024},"true\n",{"type":18,"tag":185,"props":7026,"children":7027},{"class":187,"line":1067},[7028,7033],{"type":18,"tag":185,"props":7029,"children":7030},{"style":742},[7031],{"type":24,"value":7032},"      description",{"type":18,"tag":185,"props":7034,"children":7035},{"style":249},[7036],{"type":24,"value":750},{"type":18,"tag":185,"props":7038,"children":7039},{"class":187,"line":1080},[7040],{"type":18,"tag":185,"props":7041,"children":7042},{"style":218},[7043],{"type":24,"value":7044},"        Header spider every Monday morning at 6 AM UTC\n",{"type":18,"tag":185,"props":7046,"children":7047},{"class":187,"line":1098},[7048],{"type":18,"tag":185,"props":7049,"children":7050},{"style":204},[7051],{"type":24,"value":7052},"        # The input is key-value pairs accessed in the root of the event parameter of every handler function, i.e. event.get(\"spider_name\")\n",{"type":18,"tag":185,"props":7054,"children":7055},{"class":187,"line":1111},[7056,7061],{"type":18,"tag":185,"props":7057,"children":7058},{"style":742},[7059],{"type":24,"value":7060},"      input",{"type":18,"tag":185,"props":7062,"children":7063},{"style":249},[7064],{"type":24,"value":750},{"type":18,"tag":185,"props":7066,"children":7067},{"class":187,"line":1128},[7068,7073,7077],{"type":18,"tag":185,"props":7069,"children":7070},{"style":742},[7071],{"type":24,"value":7072},"        spider_name",{"type":18,"tag":185,"props":7074,"children":7075},{"style":249},[7076],{"type":24,"value":764},{"type":18,"tag":185,"props":7078,"children":7079},{"style":218},[7080],{"type":24,"value":7081},"header_spider\n",{"type":18,"tag":185,"props":7083,"children":7084},{"class":187,"line":1136},[7085],{"type":18,"tag":185,"props":7086,"children":7087},{"style":204},[7088],{"type":24,"value":6434},{"type":18,"tag":27,"props":7090,"children":7091},{},[7092],{"type":24,"value":7093},"After deploying, you can verify that a CloudWatch Events tab appears under triggers in the Lambda console.",{"type":18,"tag":27,"props":7095,"children":7096},{},[7097],{"type":18,"tag":7098,"props":7099,"children":7104},"img",{"alt":7100,"src":7101,"title":7100,"style":7102},"Lambda console triggers","/posts/scrapy-fargate-sls-guide/lambda-console-triggers.png",{"aspectRatio":7103},"1263/812",[],{"type":18,"tag":27,"props":7106,"children":7107},{},[7108,7110,7114],{"type":24,"value":7109},"If you have a few spiders, configuring all the launches as scheduled events in ",{"type":18,"tag":181,"props":7111,"children":7112},{"className":10},[7113],{"type":24,"value":710},{"type":24,"value":7115}," works fine. If you have a bunch of spiders, you might want to launch several spiders at the same time from a single Lambda function.",{"type":18,"tag":27,"props":7117,"children":7118},{},[7119,7121],{"type":24,"value":7120},"We can implement behaviour like that in another Lambda function. Let's remove the dummy function in ",{"type":18,"tag":181,"props":7122,"children":7123},{"className":10},[7124],{"type":24,"value":7125},"handler.py",{"type":18,"tag":174,"props":7127,"children":7129},{"code":7128,"language":195,"meta":10,"className":332,"style":10},"# handler.py\nimport json\nfrom datetime import datetime, timedelta\nimport logging\n\nfrom launch_fargate import launch_fargate\n\n\ndef run_crawlers(event, context):\n    result = []\n    for x in filter(should_crawl, get_crawler_config()):\n        try:\n            if x.get(\"run_in_lambda\"):\n                # TODO Implement function to invoke crawl in new Lambda function\n                pass\n            else:\n                fargate_launch_response = launch_fargate(dict(\n                    spider_name=x.get(\"spider_name\"),\n                    spider_kwargs=x.get(\"spider_kwargs\"),\n                ), {})\n                result.append(fargate_launch_response)\n        except Exception:\n            logging.exception(\n                f\"Could not launch spider {x.get('spider_name')}\"\n            )\n    return result\n\n\ndef get_crawler_config():\n    # This function could make an API call to a CMS like AirTable,\n    # Strapi or DynamoDB.\n    return [\n        {\n            \"spider_name\": \"header_spider\",\n            \"spider_kwargs\": {\n                \"start_urls\": [\"https://example.com\"],\n            },\n            \"previous_crawl\": {\n                \"success_state\": True,\n                \"items_crawled\": 100,\n                \"finish_date\": datetime.now() - timedelta(days=3),\n            },\n        },\n        {\n            \"spider_name\": \"header_spider\",\n            \"spider_kwargs\": {\n                \"start_urls\": [\"https://www.ietf.org\"],\n            },\n            \"previous_crawl\": {\n                \"success_state\": True,\n                \"items_crawled\": 100,\n                \"finish_date\": datetime.now() - timedelta(hours=16),\n            },\n            \"crawl_interval_hours\": 12,\n            \"settings\": {\n                \"AUTOTHROTTLE_ENABLED\": True,\n            }|\n        },\n        {\n            \"spider_name\": \"header_spider\",\n            \"spider_kwargs\": {\n                \"start_urls\": [\"https://bitcoin.org\"],\n            },\n        },\n        {\n            \"spider_name\": \"other_spider\",\n            \"previous_crawl\": None\n        },\n    ]\n\n\ndef should_crawl(x):\n    previous_crawl = x.get(\"previous_crawl\")\n    if previous_crawl:\n        time_interval_hours = x.get(\"crawl_interval_hours\", 24*7)\n        return previous_crawl.get(\"finish_date\") + timedelta(hours=time_interval_hours) \u003C datetime.now() or not previous_crawl.get(\"success_state\")\n    return True\n",[7130],{"type":18,"tag":181,"props":7131,"children":7132},{"__ignoreMap":10},[7133],{"type":24,"value":7128},{"type":18,"tag":27,"props":7135,"children":7136},{},[7137,7139,7144],{"type":24,"value":7138},"This function makes it possible to run crawls quite intelligently. It also assumes we have more spiders and that our ",{"type":18,"tag":181,"props":7140,"children":7141},{"className":10},[7142],{"type":24,"value":7143},"header_spider",{"type":24,"value":7145}," can take arguments in its constructor. Let's change it to do so",{"type":18,"tag":174,"props":7147,"children":7149},{"code":7148,"language":195,"meta":10,"className":332,"style":10},"# my_sls_scraper/spiders/header_spider.py\nfrom urllib.parse import urlparse\n\nfrom scrapy.spiders import CrawlSpider, Rule\nfrom scrapy.linkextractors import LinkExtractor\n\n\nclass HeaderSpider(CrawlSpider):\n    name = \"header_spider\"\n\n    start_urls = [\"https://scrapy.org\"]\n    allowed_domains = [\"scrapy.org\"]\n\n    def __init__(self, **kwargs):\n        # Enables overriding attributes for a flexible spider\n        if kwargs.get(\"start_urls\"):\n            self.start_urls = kwargs.get(\"start_urls\")\n            self.allowed_domains = list(\n                urlparse(x).hostname for x in self.start_urls\n            )\n\n        super().__init__(\n            **{k: v for k, v in kwargs.items() if not hasattr(self, k)}\n        )\n\n    rules = [  # Get all links on start url\n        Rule(\n            link_extractor=LinkExtractor(\n                deny=r\"\\?\",\n            ),\n            follow=False,\n            callback=\"parse_page\",\n        )\n    ]\n\n    def parse_start_url(self, response):\n        return self.parse_page(response)\n\n    def parse_page(self, response):\n        header = response.css(\"h1, h2\").extract_first(\n        ) or response.css(\"title\").extract_first() or response.url\n        return {\n            \"header\": remove_tags(header),\n            \"url\": response.url,\n        }\n",[7150],{"type":18,"tag":181,"props":7151,"children":7152},{"__ignoreMap":10},[7153],{"type":24,"value":7148},{"type":18,"tag":27,"props":7155,"children":7156},{},[7157,7159,7164,7166,7170],{"type":24,"value":7158},"It can now scrape the headers on any site with the ",{"type":18,"tag":181,"props":7160,"children":7161},{"className":10},[7162],{"type":24,"value":7163},"start_urls",{"type":24,"value":7165}," argument.\nWe also have to replace the hello function in ",{"type":18,"tag":181,"props":7167,"children":7168},{"className":10},[7169],{"type":24,"value":710},{"type":24,"value":7171}," to the following",{"type":18,"tag":174,"props":7173,"children":7175},{"code":7174,"language":715,"meta":10,"className":716,"style":10},"# serverless.py\n# ...\nfunctions:\n  pollSpidersScrape:\n    handler: handler.run_crawlers\n    events:\n      - schedule:\n          rate: rate(2 hours)\n          enabled: true\n          description: Poll spiders every 2 hours\n  # ...\n",[7176],{"type":18,"tag":181,"props":7177,"children":7178},{"__ignoreMap":10},[7179,7187,7194,7205,7217,7233,7245,7260,7277,7293,7310],{"type":18,"tag":185,"props":7180,"children":7181},{"class":187,"line":188},[7182],{"type":18,"tag":185,"props":7183,"children":7184},{"style":204},[7185],{"type":24,"value":7186},"# serverless.py\n",{"type":18,"tag":185,"props":7188,"children":7189},{"class":187,"line":210},[7190],{"type":18,"tag":185,"props":7191,"children":7192},{"style":204},[7193],{"type":24,"value":736},{"type":18,"tag":185,"props":7195,"children":7196},{"class":187,"line":288},[7197,7201],{"type":18,"tag":185,"props":7198,"children":7199},{"style":742},[7200],{"type":24,"value":1060},{"type":18,"tag":185,"props":7202,"children":7203},{"style":249},[7204],{"type":24,"value":750},{"type":18,"tag":185,"props":7206,"children":7207},{"class":187,"line":753},[7208,7213],{"type":18,"tag":185,"props":7209,"children":7210},{"style":742},[7211],{"type":24,"value":7212},"  pollSpidersScrape",{"type":18,"tag":185,"props":7214,"children":7215},{"style":249},[7216],{"type":24,"value":750},{"type":18,"tag":185,"props":7218,"children":7219},{"class":187,"line":772},[7220,7224,7228],{"type":18,"tag":185,"props":7221,"children":7222},{"style":742},[7223],{"type":24,"value":1086},{"type":18,"tag":185,"props":7225,"children":7226},{"style":249},[7227],{"type":24,"value":764},{"type":18,"tag":185,"props":7229,"children":7230},{"style":218},[7231],{"type":24,"value":7232},"handler.run_crawlers\n",{"type":18,"tag":185,"props":7234,"children":7235},{"class":187,"line":790},[7236,7241],{"type":18,"tag":185,"props":7237,"children":7238},{"style":742},[7239],{"type":24,"value":7240},"    events",{"type":18,"tag":185,"props":7242,"children":7243},{"style":249},[7244],{"type":24,"value":750},{"type":18,"tag":185,"props":7246,"children":7247},{"class":187,"line":808},[7248,7252,7256],{"type":18,"tag":185,"props":7249,"children":7250},{"style":249},[7251],{"type":24,"value":4585},{"type":18,"tag":185,"props":7253,"children":7254},{"style":742},[7255],{"type":24,"value":6986},{"type":18,"tag":185,"props":7257,"children":7258},{"style":249},[7259],{"type":24,"value":750},{"type":18,"tag":185,"props":7261,"children":7262},{"class":187,"line":1046},[7263,7268,7272],{"type":18,"tag":185,"props":7264,"children":7265},{"style":742},[7266],{"type":24,"value":7267},"          rate",{"type":18,"tag":185,"props":7269,"children":7270},{"style":249},[7271],{"type":24,"value":764},{"type":18,"tag":185,"props":7273,"children":7274},{"style":218},[7275],{"type":24,"value":7276},"rate(2 hours)\n",{"type":18,"tag":185,"props":7278,"children":7279},{"class":187,"line":1054},[7280,7285,7289],{"type":18,"tag":185,"props":7281,"children":7282},{"style":742},[7283],{"type":24,"value":7284},"          enabled",{"type":18,"tag":185,"props":7286,"children":7287},{"style":249},[7288],{"type":24,"value":764},{"type":18,"tag":185,"props":7290,"children":7291},{"style":198},[7292],{"type":24,"value":7024},{"type":18,"tag":185,"props":7294,"children":7295},{"class":187,"line":1067},[7296,7301,7305],{"type":18,"tag":185,"props":7297,"children":7298},{"style":742},[7299],{"type":24,"value":7300},"          description",{"type":18,"tag":185,"props":7302,"children":7303},{"style":249},[7304],{"type":24,"value":764},{"type":18,"tag":185,"props":7306,"children":7307},{"style":218},[7308],{"type":24,"value":7309},"Poll spiders every 2 hours\n",{"type":18,"tag":185,"props":7311,"children":7312},{"class":187,"line":1080},[7313],{"type":18,"tag":185,"props":7314,"children":7315},{"style":204},[7316],{"type":24,"value":7317},"  # ...\n",{"type":18,"tag":27,"props":7319,"children":7320},{},[7321],{"type":24,"value":7322},"Do a full deploy and see if it works.",{"type":18,"tag":174,"props":7324,"children":7326},{"code":7325,"language":177,"meta":10,"className":178,"style":10},"sls deploy -v\nmake build && make retag\nsls invoke -f pollSpidersScrape --log\n",[7327],{"type":18,"tag":181,"props":7328,"children":7329},{"__ignoreMap":10},[7330,7345,7368],{"type":18,"tag":185,"props":7331,"children":7332},{"class":187,"line":188},[7333,7337,7341],{"type":18,"tag":185,"props":7334,"children":7335},{"style":192},[7336],{"type":24,"value":636},{"type":18,"tag":185,"props":7338,"children":7339},{"style":218},[7340],{"type":24,"value":641},{"type":18,"tag":185,"props":7342,"children":7343},{"style":198},[7344],{"type":24,"value":2049},{"type":18,"tag":185,"props":7346,"children":7347},{"class":187,"line":210},[7348,7352,7356,7360,7364],{"type":18,"tag":185,"props":7349,"children":7350},{"style":192},[7351],{"type":24,"value":121},{"type":18,"tag":185,"props":7353,"children":7354},{"style":218},[7355],{"type":24,"value":2172},{"type":18,"tag":185,"props":7357,"children":7358},{"style":249},[7359],{"type":24,"value":252},{"type":18,"tag":185,"props":7361,"children":7362},{"style":192},[7363],{"type":24,"value":121},{"type":18,"tag":185,"props":7365,"children":7366},{"style":218},[7367],{"type":24,"value":5786},{"type":18,"tag":185,"props":7369,"children":7370},{"class":187,"line":288},[7371,7375,7379,7383,7388],{"type":18,"tag":185,"props":7372,"children":7373},{"style":192},[7374],{"type":24,"value":636},{"type":18,"tag":185,"props":7376,"children":7377},{"style":218},[7378],{"type":24,"value":864},{"type":18,"tag":185,"props":7380,"children":7381},{"style":198},[7382],{"type":24,"value":646},{"type":18,"tag":185,"props":7384,"children":7385},{"style":218},[7386],{"type":24,"value":7387}," pollSpidersScrape",{"type":18,"tag":185,"props":7389,"children":7390},{"style":198},[7391],{"type":24,"value":877},{"type":18,"tag":27,"props":7393,"children":7394},{},[7395,7397,7404,7406,7411],{"type":24,"value":7396},"You should now see output files for scraping ",{"type":18,"tag":33,"props":7398,"children":7401},{"href":7399,"rel":7400},"http://www.ietf.org",[37],[7402],{"type":24,"value":7403},"www.ietf.org",{"type":24,"value":7405}," and bitcoin.org in S3, while one container will fail because we don't have a spider called ",{"type":18,"tag":181,"props":7407,"children":7408},{"className":10},[7409],{"type":24,"value":7410},"other_spider",{"type":24,"value":74},{"type":18,"tag":27,"props":7413,"children":7414},{},[7415,7420],{"type":18,"tag":5734,"props":7416,"children":7417},{},[7418],{"type":24,"value":7419},"WARNING",{"type":24,"value":7421},"\nDon't forget to remove or stop that last function from running, as starting 3 Fargate containers every 2 hours will cost some money.\nYou can remove all resources* with",{"type":18,"tag":174,"props":7423,"children":7425},{"code":7424,"language":177,"meta":10,"className":178,"style":10},"sls remove -v\n",[7426],{"type":18,"tag":181,"props":7427,"children":7428},{"__ignoreMap":10},[7429],{"type":18,"tag":185,"props":7430,"children":7431},{"class":187,"line":188},[7432,7436,7441],{"type":18,"tag":185,"props":7433,"children":7434},{"style":192},[7435],{"type":24,"value":636},{"type":18,"tag":185,"props":7437,"children":7438},{"style":218},[7439],{"type":24,"value":7440}," remove",{"type":18,"tag":185,"props":7442,"children":7443},{"style":198},[7444],{"type":24,"value":2049},{"type":18,"tag":27,"props":7446,"children":7447},{},[7448],{"type":24,"value":7449},"... and rebuild it all with another command. Infrastructure as code is pretty neat.",{"type":18,"tag":27,"props":7451,"children":7452},{},[7453],{"type":24,"value":7454},"* Serverless will fail to delete the buckets and ECR repository if they are not empty. So you have to manually delete all images from the repository and all objects from the scraper feed bucket and http cache bucket first.",{"type":18,"tag":19,"props":7456,"children":7458},{"id":7457},"conclusion",[7459],{"type":24,"value":7460},"Conclusion",{"type":18,"tag":27,"props":7462,"children":7463},{},[7464],{"type":24,"value":7465},"This concludes this guide. I hope it was useful for understanding scraping and serverless a little better. The next part will be about setting up a Lambda function that reacts whenever a crawler feed is created in S3, do some processing on that data before it's stored in a database.\nAny feedback is welcome and don't hesitate to contact me if you're interested in the price comparison framework I'm creating.",{"type":18,"tag":7467,"props":7468,"children":7469},"style",{},[7470],{"type":24,"value":7471},"html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}",{"title":10,"searchDepth":210,"depth":210,"links":7473},[7474,7478,7481,7482,7483,7487,7488,7489],{"id":21,"depth":210,"text":25,"children":7475},[7476,7477],{"id":78,"depth":288,"text":81},{"id":139,"depth":288,"text":142},{"id":158,"depth":210,"text":161,"children":7479},[7480],{"id":169,"depth":288,"text":172},{"id":537,"depth":210,"text":540},{"id":1514,"depth":210,"text":1517},{"id":2097,"depth":210,"text":2100,"children":7484},[7485,7486],{"id":2124,"depth":288,"text":2127},{"id":2237,"depth":288,"text":2240},{"id":5855,"depth":210,"text":5858},{"id":6884,"depth":210,"text":6887},{"id":7457,"depth":210,"text":7460},"markdown","content:posts:scrapy-fargate-sls-guide:index.md","content","posts/scrapy-fargate-sls-guide/index.md","md",{"loc":7,"images":7496},[],"page",["ShallowRef",7499],["ShallowReactive",7500],{"/posts/scrapy-fargate-sls-guide":7501},[7502,7519],{"_path":7503,"_dir":8,"_draft":9,"_partial":9,"_locale":10,"title":7504,"description":7505,"date":7506,"tags":7507,"lang":7514,"_type":7490,"_id":7515,"_source":7492,"_file":7516,"_extension":7494,"sitemap":7517},"/posts/qe-og-aksjepriser","Kvantitativ lettelse og aksjepriser","Kvantitativ lettelse (QE) er når sentralbanken kjøper finansielle eierdeler som gjeld og obligasjoner. Det fører til økning av penger i markedene. Mer penger med samme antall varer betyr høyere priser.","2020-03-29T04:45:49.000Z",[7508,7509,7510,7511,7512,7513],"aksjer","qe","marked","økonomi","korona","finanskrise","norwegian","content:posts:qe-og-aksjepriser:index.md","posts/qe-og-aksjepriser/index.md",{"loc":7503,"images":7518},[],{"_path":7520,"_dir":8,"_draft":9,"_partial":9,"_locale":10,"title":7521,"description":7522,"date":7523,"language":13,"draft":9,"_type":7490,"_id":7524,"_source":7492,"_file":7525,"_extension":7494,"sitemap":7526},"/posts/serverless-strapi-4-guide","AWS Lambda Serverless Strapi 4 Guide","The code for this guide is in this Github repo.","2022-06-14T01:25:06.000Z","content:posts:serverless-strapi-4-guide:index.md","posts/serverless-strapi-4-guide/index.md",{"loc":7520,"images":7527},[],["ShallowRef",7529],{},{"preference":7531,"value":7531,"unknown":981,"forced":9},"system",[7533,7536,7540],{"title":7534,"_path":7535,"layout":7497},"Home","/",{"title":7537,"_path":7538,"layout":7539},"Contact","/contact","default",{"title":7541,"_path":7542,"children":7543,"layout":7497},"Archive","/posts",[7544,7548,7551,7554,7559,7564,7569,7572,7578,7581,7584,7589,7594,7599,7604,7605,7608,7613,7618,7621,7624,7627,7632,7635,7640,7643,7648,7651,7654,7659],{"title":7545,"_path":7546,"layout":7547},"EU, e-bikes and premature regulation","/posts/2018-07-25-eu-e-bikes-and-premature-regulation","post",{"title":7549,"_path":7550},"AI to the masses with Google APIs","/posts/ai-to-the-masses-with-google-apis",{"title":7552,"_path":7553},"How to build a small and manageable website cheaply and with flexibility","/posts/build-small-website",{"title":7555,"_path":7556,"children":7557,"layout":7547},"Start a Conversation With Yourself on Messenger","/posts/conversation-with-yourself-on-messenger",[7558],{"title":7555,"_path":7556,"layout":7547},{"title":7560,"_path":7561,"children":7562},"E-handel i Norden før Amazon","/posts/e-handel-i-norden-for-amazon",[7563],{"title":7560,"_path":7561},{"title":7565,"_path":7566,"children":7567},"GDPR og dine kvitteringer","/posts/gdpr-kvitteringer",[7568],{"title":7565,"_path":7566},{"title":7570,"_path":7571},"Getting Started With CD","/posts/getting-started-with-cd",{"title":7573,"_path":7574,"children":7575,"layout":7577},"Google Product Search vs Vertex AI multimodal embeddings","/posts/google-ai-product-search-vs-vertex-multimodal-embedding",[7576],{"title":7573,"_path":7574,"layout":7577},"article",{"title":7579,"_path":7580},"Google as your language coach","/posts/google-as-your-language-coach",{"title":7582,"_path":7583},"Holding Grin","/posts/holding-grin",{"title":7585,"_path":7586,"children":7587},"How to use your own email in Google Workspace without paying for a license","/posts/how-to-use-your-own-email-in-google-workspace-without-paying-for-a-license",[7588],{"title":7585,"_path":7586},{"title":7590,"_path":7591,"children":7592},"Complete guide to withdrawing Grin from Bitforex with HTTPS","/posts/how-to-withdraw-grin-from-bitforex",[7593],{"title":7590,"_path":7591},{"title":7595,"_path":7596,"children":7597,"layout":7547},"How to fix \"syntax error, unexpected '|'\" error in Symfony Polyfill in Wordpress plugins","/posts/how-to-fix-php-error-in-wordpress-plugin",[7598],{"title":7595,"_path":7596,"layout":7547},{"title":7600,"_path":7601,"children":7602,"layout":7577},"Hvordan finne på navn til din nye ting","/posts/hvordan-finne-navn",[7603],{"title":7600,"_path":7601,"layout":7577},{"title":7541,"_path":7542,"layout":7497},{"title":7606,"_path":7607},"Kan jeg bestille varer til under 350 kroner?","/posts/kan-jeg-bestille-varer-til-under-350-kroner",{"title":7609,"_path":7610,"children":7611},"Norges Amazon er satt på vent, men kan Kolonial gripe muligheten?","/posts/kolonial-norges-amazon",[7612],{"title":7609,"_path":7610},{"title":7614,"_path":7615,"children":7616},"Make Medium readable and less frustrating","/posts/make-medium-readable-and-not-annoying",[7617],{"title":7614,"_path":7615},{"title":7504,"_path":7503,"children":7619},[7620],{"title":7504,"_path":7503},{"title":11,"_path":7,"children":7622},[7623],{"title":11,"_path":7},{"title":7521,"_path":7520,"children":7625},[7626],{"title":7521,"_path":7520},{"title":7628,"_path":7629,"children":7630},"Serverless Strapi Tutorial","/posts/serverless-strapi-tutorial",[7631],{"title":7628,"_path":7629},{"title":7633,"_path":7634},"Begynne i det små med smarte hjem","/posts/smarte-hjem",{"title":7636,"_path":7637,"children":7638,"layout":7547},"Social media preview by url get","/posts/social-media-preview-by-url-get",[7639],{"title":7636,"_path":7637,"layout":7547},{"title":7641,"_path":7642},"Spotify Social Jukeboxes","/posts/spotify-social-jukeboxes",{"title":7644,"_path":7645,"children":7646},"Stock buybacks og aksjepriser","/posts/stock-buybacks-og-aksjepriser",[7647],{"title":7644,"_path":7645},{"title":7649,"_path":7650},"Supermarket Price Lookup","/posts/supermarket-price-lookup",{"title":7652,"_path":7653},"Using Your Own Data for Value","/posts/using-your-own-data-for-value",{"title":7655,"_path":7656,"children":7657},"Verden og responsen til koronaviruset","/posts/verden-og-responsen-til-koronaviruset",[7658],{"title":7655,"_path":7656},{"title":7660,"_path":7661},"Why isn't Bitcoin banned?","/posts/why-isn-t-bitcoin-banned",{"uil:twitter":7663,"uil:instagram":7666,"uil:linkedin":7668,"ph:copy":7670},{"left":7664,"top":7664,"width":1246,"height":1246,"rotate":7664,"vFlip":9,"hFlip":9,"body":7665},0,"\u003Cpath fill=\"currentColor\" d=\"M22 5.8a8.49 8.49 0 0 1-2.36.64a4.13 4.13 0 0 0 1.81-2.27a8.21 8.21 0 0 1-2.61 1a4.1 4.1 0 0 0-7 3.74a11.64 11.64 0 0 1-8.45-4.29a4.16 4.16 0 0 0-.55 2.07a4.09 4.09 0 0 0 1.82 3.41a4.05 4.05 0 0 1-1.86-.51v.05a4.1 4.1 0 0 0 3.3 4a3.93 3.93 0 0 1-1.1.17a4.9 4.9 0 0 1-.77-.07a4.11 4.11 0 0 0 3.83 2.84A8.22 8.22 0 0 1 3 18.34a7.93 7.93 0 0 1-1-.06a11.57 11.57 0 0 0 6.29 1.85A11.59 11.59 0 0 0 20 8.45v-.53a8.43 8.43 0 0 0 2-2.12Z\"/>",{"left":7664,"top":7664,"width":1246,"height":1246,"rotate":7664,"vFlip":9,"hFlip":9,"body":7667},"\u003Cpath fill=\"currentColor\" d=\"M17.34 5.46a1.2 1.2 0 1 0 1.2 1.2a1.2 1.2 0 0 0-1.2-1.2Zm4.6 2.42a7.59 7.59 0 0 0-.46-2.43a4.94 4.94 0 0 0-1.16-1.77a4.7 4.7 0 0 0-1.77-1.15a7.3 7.3 0 0 0-2.43-.47C15.06 2 14.72 2 12 2s-3.06 0-4.12.06a7.3 7.3 0 0 0-2.43.47a4.78 4.78 0 0 0-1.77 1.15a4.7 4.7 0 0 0-1.15 1.77a7.3 7.3 0 0 0-.47 2.43C2 8.94 2 9.28 2 12s0 3.06.06 4.12a7.3 7.3 0 0 0 .47 2.43a4.7 4.7 0 0 0 1.15 1.77a4.78 4.78 0 0 0 1.77 1.15a7.3 7.3 0 0 0 2.43.47C8.94 22 9.28 22 12 22s3.06 0 4.12-.06a7.3 7.3 0 0 0 2.43-.47a4.7 4.7 0 0 0 1.77-1.15a4.85 4.85 0 0 0 1.16-1.77a7.59 7.59 0 0 0 .46-2.43c0-1.06.06-1.4.06-4.12s0-3.06-.06-4.12ZM20.14 16a5.61 5.61 0 0 1-.34 1.86a3.06 3.06 0 0 1-.75 1.15a3.19 3.19 0 0 1-1.15.75a5.61 5.61 0 0 1-1.86.34c-1 .05-1.37.06-4 .06s-3 0-4-.06a5.73 5.73 0 0 1-1.94-.3a3.27 3.27 0 0 1-1.1-.75a3 3 0 0 1-.74-1.15a5.54 5.54 0 0 1-.4-1.9c0-1-.06-1.37-.06-4s0-3 .06-4a5.54 5.54 0 0 1 .35-1.9A3 3 0 0 1 5 5a3.14 3.14 0 0 1 1.1-.8A5.73 5.73 0 0 1 8 3.86c1 0 1.37-.06 4-.06s3 0 4 .06a5.61 5.61 0 0 1 1.86.34a3.06 3.06 0 0 1 1.19.8a3.06 3.06 0 0 1 .75 1.1a5.61 5.61 0 0 1 .34 1.9c.05 1 .06 1.37.06 4s-.01 3-.06 4ZM12 6.87A5.13 5.13 0 1 0 17.14 12A5.12 5.12 0 0 0 12 6.87Zm0 8.46A3.33 3.33 0 1 1 15.33 12A3.33 3.33 0 0 1 12 15.33Z\"/>",{"left":7664,"top":7664,"width":1246,"height":1246,"rotate":7664,"vFlip":9,"hFlip":9,"body":7669},"\u003Cpath fill=\"currentColor\" d=\"M20.47 2H3.53a1.45 1.45 0 0 0-1.47 1.43v17.14A1.45 1.45 0 0 0 3.53 22h16.94a1.45 1.45 0 0 0 1.47-1.43V3.43A1.45 1.45 0 0 0 20.47 2ZM8.09 18.74h-3v-9h3ZM6.59 8.48a1.56 1.56 0 1 1 0-3.12a1.57 1.57 0 1 1 0 3.12Zm12.32 10.26h-3v-4.83c0-1.21-.43-2-1.52-2A1.65 1.65 0 0 0 12.85 13a2 2 0 0 0-.1.73v5h-3v-9h3V11a3 3 0 0 1 2.71-1.5c2 0 3.45 1.29 3.45 4.06Z\"/>",{"left":7664,"top":7664,"width":7671,"height":7671,"rotate":7664,"vFlip":9,"hFlip":9,"body":7672},256,"\u003Cpath fill=\"currentColor\" d=\"M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8Zm-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z\"/>",{"defaultLocale":7674,"env":7675,"indexable":981,"name":7676,"trailingSlash":9,"url":7677},"en","production","alpine-starter","https://blog.vikfand.com",["Reactive",7679],{},1699925188483]</script>
<script>window.__NUXT__={};window.__NUXT__.config={public:{FORMSPREE_URL:"",plausible:{hashMode:false,trackLocalhost:false,domain:"",apiHost:"https://plausible.io",autoPageviews:true,autoOutboundTracking:false},studio:{apiURL:"https://api.nuxt.studio"},mdc:{components:{prose:true,map:{p:"prose-p",a:"prose-a",blockquote:"prose-blockquote","code-inline":"prose-code-inline",code:"ProseCodeInline",em:"prose-em",h1:"prose-h1",h2:"prose-h2",h3:"prose-h3",h4:"prose-h4",h5:"prose-h5",h6:"prose-h6",hr:"prose-hr",img:"prose-img",ul:"prose-ul",ol:"prose-ol",li:"prose-li",strong:"prose-strong",table:"prose-table",thead:"prose-thead",tbody:"prose-tbody",td:"prose-td",th:"prose-th",tr:"prose-tr"}},headings:{anchorLinks:{h1:false,h2:true,h3:true,h4:true,h5:false,h6:false}}},content:{locales:[],defaultLocale:"",integrity:1699925158783,experimental:{stripQueryParameters:false,advanceQuery:false,clientDB:false},respectPathCase:false,api:{baseURL:"/api/_content"},navigation:{fields:["navTitle","layout"]},tags:{p:"prose-p",a:"prose-a",blockquote:"prose-blockquote","code-inline":"prose-code-inline",code:"ProseCodeInline",em:"prose-em",h1:"prose-h1",h2:"prose-h2",h3:"prose-h3",h4:"prose-h4",h5:"prose-h5",h6:"prose-h6",hr:"prose-hr",img:"prose-img",ul:"prose-ul",ol:"prose-ol",li:"prose-li",strong:"prose-strong",table:"prose-table",thead:"prose-thead",tbody:"prose-tbody",td:"prose-td",th:"prose-th",tr:"prose-tr"},highlight:{theme:{default:"github-light",dark:"github-dark"},preload:["json","js","ts","html","css","vue","diff","shell","markdown","yaml","bash","ini","c","cpp"]},wsUrl:"",documentDriven:{page:true,navigation:true,surround:true,globals:{},layoutFallbacks:["theme"],injectPage:true},host:"",trailingSlash:false,search:"",contentHead:true,anchorLinks:{depth:4,exclude:[1]}}},app:{baseURL:"/",buildAssetsDir:"/_nuxt/",cdnURL:""}}</script></body>
</html>